////////////////////////////////////////////////////////////////////////////////
// СТАРЫЕ АЛГОРИТМЫ

////////////////////////////////////////////////////////////////////////////////
// КОРРЕКТИРОВКА СУММ СПИСАНИЙ, ВЫПОЛНЕННЫХ В ТЕЧЕНИЕ МЕСЯЦА (ТОЛЬКО СУММОВЫЕ ДВИЖЕНИЯ)

// Процедура вызывается из документа КорректировкаСтоимостиСписания и выполняет корректировку порциями по 100 элементов
//
// Параметры:
//	ДатаНач - дата начала корректировки,
//	ДатаКон - дата окончания корректировки,
//	МассивВидовУчета - массив видов учета, по которым нужно выполнять корректировку,
//	Ссылка - ссылка на документ КорректировкаСтоимостиСписания,
//	Организация - организация, по которой выполняется корректировка.
//

Процедура ВыполнитьКорректировкуСтоимостиСписанияНаСервере(ДатаНач, ДатаКон, МассивВидовУчета, Ссылка, 
	Организация,
	ПРГ_ТаблТоваров = Неопределено,
	ПРГ_НоменклатураПорции   = Неопределено
	) Экспорт
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("ДатаНач", ДатаНач);
	Запрос.УстановитьПараметр("ДатаКон", ДатаКон);

	//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  
	ПРГ_ДопПараметры = Неопределено;
	//конец изменений 
	
	Для Каждого Элемент из МассивВидовУчета Цикл
		
		НазваниеРегистраНаСкладах  = "ПартииТоваровНаСкладах"+Элемент;
		НазваниеРегистраПереданные = "ПартииТоваровПереданные"+Элемент;
		//начало изменений
		текНоменклатура 		   = ПРГ_НоменклатураПорции;
		//конец изменений
		текДокументОприходования   = Неопределено;
		//начало изменений Ожиганов 26.02.2016 б/н оптизация выборки по перемещениям  
		ПРГ_Порядок = -1;
		//конец изменений 
		
		//начало изменений
		ЭтоРегламУчет = Ложь;
		ПРГ_МенеджерВрТабл  = Неопределено;
		Если Нрег(Элемент) = "бухгалтерскийучет" 
			или Нрег(Элемент) = "налоговыйучет" 
			Тогда
			Запрос.МенеджерВременныхТаблиц = ПРГ_ПолучитьВременнуюТаблицуВыпуска(ДатаНач,ДатаКон,НазваниеРегистраНаСкладах,Организация);
			ЭтоРегламУчет = Истина;
		КонецЕсли;	
		
		//конец изменений
		
		НомерПорции = 0;
		
		Пока Истина Цикл
			НомерПорции = НомерПорции + 1;
			
			Запрос.УстановитьПараметр("ВидДвижения", ВидДвиженияНакопления.Расход);
			Запрос.УстановитьПараметр("Номенклатура", текНоменклатура);
			Запрос.УстановитьПараметр("ДокументОприходования", текДокументОприходования);
			//начало изменений Ожиганов 26.02.2016 б/н оптизация выборки по перемещениям 
			Запрос.УстановитьПараметр("Организация", Организация);
			Запрос.УстановитьПараметр("Порядок", ПРГ_Порядок);
			//конец изменений 
			
			//начало изменений
			Если ЭтоРегламУчет Тогда
				//начало изменений Ожиганов 19.02.2016 б/н оптизация выборки по перемещениям  
				//начало изменений Ожиганов 03.03.2016 для отладки
				Если НомерПорции = 1  и ПРГ_ТаблТоваров <> Неопределено Тогда
					
					Запрос.Текст = ПРГ_ПолучитьПодготовЗапросДляРеглУчетаОтладка();
					Запрос.УстановитьПараметр("СписокИсключаемыхСчетовУчета",ПолучитьМассивИсключаемыхСчетов());
					Запрос.УстановитьПараметр("ТаблТоваров",ПРГ_ТаблТоваров);
					Запрос.Выполнить();
					
				ИначеЕсли НомерПорции = 1 Тогда
				//конец изменений 
					ТекстПодготовительный = ПРГ_ПолучитьПодготовЗапросДляРеглУчета();
					ТекстПодготовительный = СтрЗаменить(ТекстПодготовительный, "ПартииТоваровНаСкладах",НазваниеРегистраНаСкладах);
					ТекстПодготовительный = СтрЗаменить(ТекстПодготовительный, "ПартииТоваровПереданные",НазваниеРегистраПереданные);
					Если Запрос.МенеджерВременныхТаблиц = Неопределено Тогда
						Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
					КонецЕслИ;
					Запрос.Текст = ТекстПодготовительный;
					Запрос.УстановитьПараметр("СписокИсключаемыхСчетовУчета",ПолучитьМассивИсключаемыхСчетов());
					Запрос.Выполнить();
					
					
				Иначе // формируется временная таблица 
					//ПРГ_Фильтр сыы ее будем удалять каждый раз
					Запрос.Текст = "Уничтожить ПРГ_ФильтрПоТоварам;
					| Уничтожить ПРГ_ФильтрТолькоПоТоварам; ";
					
					Запрос.Выполнить();
				КонецЕсли;;	
				//конец изменений 
				//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  
				Если ПРГ_ДопПараметры = Неопределено Тогда
					ПРГ_ДопПараметры = Новый Структура;
					ПРГ_ДопПараметры.Вставить("ПРГ_ФильтрПоТоварам");
				КонецЕсли;	
				//конец изменений 
				Текст = ПРГ_ПолучитьЗапросДляРеглУчета();
				//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  
				//Запрос.УстановитьПараметр("СписокИсключаемыхСчетовУчета",ПолучитьМассивИсключаемыхСчетов());	
				//конец изменений 
			Иначе	
				Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 100
						|	Подзапрос.Номенклатура КАК Номенклатура,
						|	Подзапрос.ДокументОприходования КАК ДокументОприходования
						|ИЗ
						|	(ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 100
						|		ПодзапросНаСкладах.Номенклатура КАК Номенклатура,
						|		ПодзапросНаСкладах.ДокументОприходования КАК ДокументОприходования
						|	ИЗ
						|		(ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 100
						|			НаСкладах.Номенклатура КАК Номенклатура,
						|			НаСкладах.ДокументОприходования КАК ДокументОприходования
						|		ИЗ
						|			РегистрНакопления.ПартииТоваровНаСкладах КАК НаСкладах
						|		ГДЕ
						|			НаСкладах.Период МЕЖДУ &ДатаНач И &ДатаКон
						|			И (НаСкладах.Номенклатура > &Номенклатура
						|					ИЛИ НаСкладах.Номенклатура = &Номенклатура
						|						И НаСкладах.ДокументОприходования > &ДокументОприходования)
						|			И ((НаСкладах.ВидДвижения = &ВидДвижения) ИЛИ (НаСкладах.ДокументОприходования ССЫЛКА Документ.КомплектацияНоменклатуры))
						|		
						|		УПОРЯДОЧИТЬ ПО
						|			Номенклатура,
						|			ДокументОприходования) КАК ПодзапросНаСкладах
						|	
						|	ОБЪЕДИНИТЬ ВСЕ
						|	
						|	ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 100
						|		ПодзапросПереданные.Номенклатура,
						|		ПодзапросПереданные.ДокументОприходования
						|	ИЗ
						|		(ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 100
						|			Переданные.Номенклатура КАК Номенклатура,
						|			Переданные.ДокументОприходования КАК ДокументОприходования
						|		ИЗ
						|			РегистрНакопления.ПартииТоваровПереданные КАК Переданные
						|		ГДЕ
						|			Переданные.Период МЕЖДУ &ДатаНач И &ДатаКон
						|			И (Переданные.Номенклатура > &Номенклатура
						|					ИЛИ Переданные.Номенклатура = &Номенклатура
						|						И Переданные.ДокументОприходования > &ДокументОприходования)
						|			И ((Переданные.ВидДвижения = &ВидДвижения) ИЛИ (Переданные.ДокументОприходования ССЫЛКА Документ.КомплектацияНоменклатуры))
						|		
						|		УПОРЯДОЧИТЬ ПО
						|			Номенклатура,
						|			ДокументОприходования) КАК ПодзапросПереданные) КАК Подзапрос
						|
						|УПОРЯДОЧИТЬ ПО
						|	Номенклатура,
						|	ДокументОприходования";
			КонецЕсли;			
			
			Если НазваниеРегистраНаСкладах <> "ПартииТоваровНаСкладах" тогда
				
				Текст = СтрЗаменить(Текст, "ПартииТоваровНаСкладах",НазваниеРегистраНаСкладах);
				Текст = СтрЗаменить(Текст, "ПартииТоваровПереданные",НазваниеРегистраПереданные);
				
			КонецЕсли;

			Запрос.Текст = Текст;
			//начало изменений для тестов
			//начало изменений Ожиганов 03.03.2016 приведем к единому знаменателю
			Если ПРГ_ТаблТоваров <> Неопределено и Не ЭтоРегламУчет  Тогда
				Таблица  = ПРГ_ТаблТоваров;
			Иначе
			//конец изменений 	
				Таблица = Запрос.Выполнить().Выгрузить();
				//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  
				Если ПРГ_ДопПараметры.Свойство("ПРГ_ФильтрПоТоварам") Тогда
					ПРГ_ДопПараметры.Вставить("ПРГ_ФильтрПоТоварам",Запрос.МенеджерВременныхТаблиц);
					//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  
					ПРГ_ДопПараметры.Вставить("КорректироватьКомплектыПродукции");
					//конец изменений вставим комплектацию
				КонецЕсли;	
				//конец изменений 
			КонецЕсли;	
			
			
			КоличествоСтрок = Таблица.Количество();
			// Если строки кончились, прерываем цикл
			Если КоличествоСтрок = 0 Тогда
				Прервать;
			КонецЕсли;
			
			текНоменклатура = Таблица[КоличествоСтрок-1].Номенклатура;
			текДокументОприходования = Таблица[КоличествоСтрок-1].ДокументОприходования;
			//начало изменений Ожиганов 26.02.2016 б/н оптизация выборки по перемещениям  
			Если ПРГ_ДопПараметры.Свойство("ПРГ_ФильтрПоТоварам") Тогда
				ПРГ_Порядок = Таблица[КоличествоСтрок-1].Порядок;
			КонецЕсли;	
			//конец изменений 
			
			Если Элемент = "" тогда
				ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВУправленческомУчете;
			КонецЕсли;
			
			Если Элемент = "БухгалтерскийУчет" тогда
				ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВБухгалтерскомУчете;
			КонецЕсли;
			
			Если Элемент = "НалоговыйУчет" тогда
				ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВНалоговомУчете;
			КонецЕсли;
			
			Если Элемент = "МеждународныйУчет" тогда
				ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВМеждународномУчете;
			КонецЕсли;
			
			//начало изменений оптимазация
			Если Элемент = "НалоговыйУчет" ИЛИ Элемент = "БухгалтерскийУчет" Тогда
				
				КорректировкаСтоимости.КорректировкаСписания(ДатаНач, ДатаКон, Таблица, Ссылка,
					Организация,
					ВидОтраженияВУчете,
					Ложь,
					//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  
					//Неопределено,
					ПРГ_ДопПараметры,
					//конец изменений 
					Ложь,,
					//начало изменений 
					ПРГ_ТаблТоваров <> Неопределено
					//конец изменений 
					);
				
			Иначе
				
				// Корректировка списания по-средней
				КорректировкаСтоимости.КорректировкаСписания(ДатаНач, ДатаКон, Таблица, Ссылка,
					Организация,
					ВидОтраженияВУчете,
					Ложь,
					Неопределено,
					// is ЯннуровВФ нач 20150114
					//Истина,,
					Ложь,,
					// is ЯннуровВФ кон 20150114
					//начало изменений 
					ПРГ_ТаблТоваров <> Неопределено
					//конец изменений 
					);
				
			КонецЕсли;
			//конец изменений	
				
			//начало изменений
			Если ПРГ_ТаблТоваров <> Неопределено Тогда
				 прервать;
			КонецЕсли;	
			Если ПРГ_НоменклатураПорции <> Неопределено Тогда
				прервать;
			КонецЕсли;	
			//конец изменений 
		КонецЦикла;
		
	КонецЦикла;	
	
	//начало изменений оптим
	Для Каждого Элемент из МассивВидовУчета Цикл	
		Если Элемент = "НалоговыйУчет" ИЛИ Элемент = "БухгалтерскийУчет" тогда
				ПРГ_КорректировкаСписанияКомплВозрваты(ДатаНач, ДатаКон, Таблица, Ссылка,
					Организация,
					ВидОтраженияВУчете,
					Ложь,
					Неопределено,
					Истина,,
					//начало изменений 
					ПРГ_ТаблТоваров <> Неопределено,
					//начало изменений Ожиганов 26.02.2016 б/н оптизация выборки по перемещениям  
					//ПРГ_ПолучитьВременнуюТаблицуВыпуска(ДатаНач,ДатаКон,НазваниеРегистраНаСкладах,Организация)
					Запрос.МенеджерВременныхТаблиц,
					НомерПорции
					//конец изменений 
					//конец изменений 
					);
					
            //начало изменений Ожиганов 21.04.2016 б/н приравнять движения по материалам БУ к НУ  					
			Если Элемент = "НалоговыйУчет" Тогда		
				ПРГ_ПопытатьсяПриравнятьНУкБУПоТМЦ(ДатаНач, ДатаКон, Организация, 
						ПРГ_ТаблТоваров, 
						Элемент, 
						Ссылка, 
						Запрос.МенеджерВременныхТаблиц, 
						//начало изменений Ожиганов 30.05.2016 выравнивание копеек по НУ, приведение остатков к БУ 
						Неопределено,
						1 ); // материалы, товары и ПФ не выпускаемые
			КонецЕсли;			
			//конец изменений 	
		КонецЕсли;	
	КонецЦикла;	
	//конец изменений
	
КонецПроцедуры	

// Функция-оболочка, вызывающая корректировку списания. Вызывается из документов:
// ПогашениеСтоимости, РасчетСебестоимостиВыпуска, КорректировкаСтоимостиСписанияТоваров
//
// Параметры:
//	ВидОтраженияВУчете - ПеречислениеСсылка.ВидыОтраженияВУчете - Вид отаржения в учете
//
Процедура КорректировкаСписания(ДатаНач, ДатаКон, ТаблицаТоваров, РегламентныйДокумент,
								Организация, 
								ВидОтраженияВУчете,
								НеСписыватьНаПостоянныеЗатраты = Ложь, ДопПараметры = Неопределено, ПоследнийПередел = Ложь,
								ВстречныйВыпуск = Ложь,
								ОтладочныйРежим = Ложь
								) Экспорт
	
	//Признак того, что в параметр ДопПараметры передана структура и ее необходимо вернуть из процедуры
	
	флТребуетсяВозвратДопПараметров = истина;
	Если ТипЗнч(ДопПараметры) <> Тип("Структура") Тогда
		флТребуетсяВозвратДопПараметров = Ложь;
		ДопПараметры = Новый Структура;
	//начало изменений оптим р/с
	ИначеЕсли ДопПараметры.Свойство("НеВозвращатьДопПарметры") Тогда
		флТребуетсяВозвратДопПараметров = Ложь;
	//конец изменений
	КонецЕсли;
	
	//+ДС 10.01.14
	Если ДопПараметры.Свойство("СтрокаДействия") Тогда
		флТребуетсяВозвратДопПараметров = Истина;
	КонецЕсли;
	//-ДС

	Если ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВУправленческомУчете Тогда
		СпособВеденияПартионногоУчетаПоОрганизации = УправлениеЗапасами.ПолучитьСпособВеденияПартионногоУчетаПоОрганизации(Организация, ДатаКон);
		ДопПараметры.Вставить("Организация", УправлениеЗапасами.ПолучитьОрганизациюВСоответствииСоСпособомВеденияПартионногоУчетаПоОрганизациям(Организация,СпособВеденияПартионногоУчетаПоОрганизации));
	Иначе
		ДопПараметры.Вставить("Организация", Организация);
	КонецЕсли;	
	
	ДопПараметры.Вставить("НеСписыватьНаПостоянныеЗатраты", НеСписыватьНаПостоянныеЗатраты);
	
	
	// Приведение структуры доп.параметров к виду структуры параметров из основного алгоритма списания партий
	//
	ДопПараметры.Вставить("ОтражатьВУправленческомУчете" , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВУправленческомУчете));
	ДопПараметры.Вставить("ОтражатьВБухгалтерскомУчете"  , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВБухгалтерскомУчете));
	ДопПараметры.Вставить("ОтражатьВНалоговомУчете"      , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВНалоговомУчете));
	ДопПараметры.Вставить("ОтражатьВМеждународномУчете"  , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВМеждународномУчете));
	
	ДопПараметры.Вставить("ЕстьСтрокиОтражатьВУправленческомУчете" , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВУправленческомУчете));
	ДопПараметры.Вставить("ЕстьСтрокиОтражатьВБухгалтерскомУчете"  , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВБухгалтерскомУчете));
	ДопПараметры.Вставить("ЕстьСтрокиОтражатьВНалоговомУчете"      , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВНалоговомУчете));
	ДопПараметры.Вставить("ЕстьСтрокиОтражатьВМеждународномУчете"  , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВМеждународномУчете));
	
	ДопПараметры.Вставить("КэшПоВидамСубконто", Новый Соответствие);
	
	Если НЕ ДопПараметры.Свойство("КодыОпераций") тогда
		ДопПараметры.Вставить("КодыОпераций", Перечисления.КодыОперацийПартииТоваров);
	КонецЕсли;
	
	Если НЕ РегламентныйДокумент = Неопределено тогда
		ДопПараметры.Вставить("ТипЗначенияРегистратора", ТипЗнч(РегламентныйДокумент));
	КонецЕсли;
	
	ДопПараметры.Вставить("ВстречныйВыпуск",ВстречныйВыпуск);
	
	//начало изменений
	//Будем считать способ в течение периода не будет меняться для бух и нал
	ДопПараметры.Вставить("СпособВеденияПартионногоУчетаПоОрганизации",УправлениеЗапасами.ПолучитьСпособВеденияПартионногоУчетаПоОрганизации(Организация,ДатаКон));
	//конец изменений 
	
	//начало изменений Ожиганов 26.02.2016 б/н оптизация выборки по перемещениям  
	//вставим чтобы комплектация сразу учитывалась пр р/с
	Если (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВБухгалтерскомУчете
		или ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВНалоговомУчете)
		и ТипЗнч(РегламентныйДокумент) = Тип("ДокументСсылка.РасчетСебестоимостиВыпуска") Тогда
		
		 ДопПараметры.Вставить("КорректироватьКомплектыПродукции");
		
	КонецЕслИ;	
	//конец изменений 
	
	СкорректироватьСписание(ДатаНач, ДатаКон, ТаблицаТоваров, РегламентныйДокумент, ДопПараметры);
	
	// Корректировка стоимости реализации комплектов продукции должна выполняться только после последнего передела,
	// когда известна себестоимость всей продукции
	// Получим список номенклатуры появившейся в результате комплектации
	// Это упрощенный способ, имеющий свои ограничения
	// Так можно рассчитать только себестоимость реализации комплектов, скомплектованных одним документом "комплектация"
	// Более сложные схемы с многоуровневыми комплектациями - разукомплектациями и передачами комплектов в производство
	// обслуживаются только специализированными производственными документами
	
	Если ПоследнийПередел тогда
		
		//начало изменений  
		Если ОтладочныйРежим Тогда
			ТаблицаКомплектов = ПолучитьТаблицуПартийПоКодуОперации(ДатаНач,ДатаКон,ДопПараметры,Перечисления.КодыОперацийПартииТоваров.Комплектация,ВидДвиженияНакопления.Приход,ТаблицаТоваров.ВыгрузитьКолонку("Номенклатура"));
		//начало изменений
		ИначеЕсли ТипЗнч(РегламентныйДокумент) = Тип("ДокументСсылка.РасчетСебестоимостиВыпуска")  Тогда
		//конец изменений
		// is ЯннуровВФ нач 20150122
		// is ЯннуровВФ нач 20141014
		// И Не ДопПараметры.ОтражатьВМеждународномУчете Тогда 
		// is ЯннуровВФ кон 20141014
			Если ДопПараметры.ОтражатьВМеждународномУчете Тогда 
				ТаблицаКомплектов =  ПолучитьКомплектыМУ(ДатаНач,ДатаКон,РегламентныйДокумент,ДопПараметры);
			Иначе
		// is ЯннуровВФ нач 20150122
				ТаблицаКомплектов =  ПРГ_ПолучитьКомплекты(ДатаНач,ДатаКон,РегламентныйДокумент,ДопПараметры)
			КонецЕсли;
		Иначе
			ТаблицаКомплектов = ПолучитьТаблицуПартийПоКодуОперации(ДатаНач,ДатаКон,ДопПараметры,Перечисления.КодыОперацийПартииТоваров.Комплектация,ВидДвиженияНакопления.Приход);
		КонецЕсли;	
		//конец изменений  
		
		// Если комплектов нет - корректировать нечего
		Если ТаблицаКомплектов <> Неопределено тогда
			ДопПараметры.Вставить("КорректироватьКомплектыПродукции");
			//начало изменений Ожиганов 01.03.2016 себестоимость продукции, на которую не распределяются косвенные затраты 
			//СкорректироватьСписание(ДатаНач, ДатаКон, ТаблицаКомплектов, РегламентныйДокумент, ДопПараметры);
			Если  ТипЗнч(ТаблицаКомплектов) = Тип("Массив") Тогда
				Для Каждого ПРГ_Элемент Из ТаблицаКомплектов Цикл
					СкорректироватьСписание(ДатаНач, ДатаКон, ПРГ_Элемент, РегламентныйДокумент, ДопПараметры);
				КонецЦикла;	
			Иначе
				СкорректироватьСписание(ДатаНач, ДатаКон, ТаблицаКомплектов, РегламентныйДокумент, ДопПараметры);
			КонецЕсли;	
			//конец изменений 
			
		КонецЕсли;
		
		// Если возврат от покупателя текущего месяца осуществляется по документу поступления - стоимость соответствующего состояния
		// может быть уменьшена документом списания и стоимость возврата может не соотвествовать стоимости реализации
		// Поэтому корректировка стоимости возвратов от покупателя текущего месяца должна выполняться последней
		
		//начало измененйи оптим р/с
		Если ДопПараметры.ЕстьСтрокиОтражатьВБухгалтерскомУчете или ДопПараметры.ЕстьСтрокиОтражатьВНалоговомУчете Тогда
			ТаблицаВозвратов  = Неопределено;
		Иначе
			//начало изменений  
			Если ОтладочныйРежим Тогда
				ТаблицаВозвратов = ПолучитьТаблицуПартийПоКодуОперации(ДатаНач,ДатаКон,ДопПараметры,Перечисления.КодыОперацийПартииТоваров.ВозвратОтПокупателяТекущийМесяц,ВидДвиженияНакопления.Расход,ТаблицаТоваров.ВыгрузитьКолонку("Номенклатура"));
			Иначе 	
				ТаблицаВозвратов = ПолучитьТаблицуПартийПоКодуОперации(ДатаНач,ДатаКон,ДопПараметры,Перечисления.КодыОперацийПартииТоваров.ВозвратОтПокупателяТекущийМесяц,ВидДвиженияНакопления.Расход);
			КонецЕсли;
		КонецЕсли;	
		//конец изменений
		
		Если ТаблицаВозвратов <> Неопределено тогда
			ДопПараметры.Вставить("КорректироватьСтоимостьВозвратовТекущегоМесяца");
			СкорректироватьСписание(ДатаНач, ДатаКон, ТаблицаВозвратов, РегламентныйДокумент, ДопПараметры);
		КонецЕсли;
		
	КонецЕсли;
	
	Если  флТребуетсяВозвратДопПараметров Тогда
		// Последних переделов может быть несколько 
		Если ДопПараметры.Свойство("КорректироватьКомплектыПродукции") тогда
			ДопПараметры.Удалить("КорректироватьКомплектыПродукции");
		КонецЕсли;
		
		Если ДопПараметры.Свойство("КорректироватьСтоимостьВозвратовТекущегоМесяца") тогда
			ДопПараметры.Удалить("КорректироватьСтоимостьВозвратовТекущегоМесяца");
		КонецЕсли;
	Иначе
		//необходимо для того, чтобы предотвратить возврат из процедуры мутабельных значений.
		//Если в ДопПараметры не надо ничего возвращать, то переменную необходимо удалить
		ДопПараметры = неопределено;
	КонецЕсли;
КонецПроцедуры // КорректировкаСписания

// Возвращает таблицу партий по переданному коду операции
//
// Параметры:
//	ДатаНач 		- дата начала периода, за который получаются данные, 
//	ДатаКон 		- дата окончания периода, 
//	ДопПараметры 	- структура, содержащая параметры для установки отборов, 
//	КодОперации 	- код операции, по которому производиться отбор партий,
//	ВидДвижения 	- вид движения, по которому производиться отбор партий.
//	
//	Возвращает таблицу партий
Функция ПолучитьТаблицуПартийПоКодуОперации(ДатаНач, ДатаКон,ДопПараметры,КодОперации,ВидДвижения,
	МассНом = Неопределено
	)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
				   |	НаСкладах.Номенклатура КАК Номенклатура,
				   |	НаСкладах.ДокументОприходования КАК ДокументОприходования
				   |ИЗ
				   |	РегистрНакопления.ПартииТоваровНаСкладах КАК НаСкладах
				   |ГДЕ
				   |	НаСкладах.Период МЕЖДУ &ДатаНач И &ДатаКон
				   |	И НаСкладах.ВидДвижения = &ВидДвижения
//начало изменений Ожиганов 28.01.2016 б/н исключение неактивных записей из р/с и корректировки стоимости 
 				   |	И НаСкладах.Активность
//конец изменений 
				   |	И НаСкладах.КодОперации = &КодОперации  
				   | "+?(МассНом=Неопределено,""," И НаСкладах.Номенклатура в (&МассНом)") +"
				   |";
				   
	//начало изменений 
	Запрос.УстановитьПараметр("МассНом", МассНом);
	//конец изменений 
	
	Запрос.УстановитьПараметр("КодОперации", КодОперации);
	Запрос.УстановитьПараметр("ВидДвижения", ВидДвижения);
	Запрос.УстановитьПараметр("ДатаНач", ДатаНач);
	Запрос.УстановитьПараметр("ДатаКон", ДатаКон);
	
	Если ДопПараметры.ОтражатьВБухгалтерскомУчете тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"ПартииТоваровНаСкладах", "ПартииТоваровНаСкладахБухгалтерскийУчет");	
	ИначеЕсли ДопПараметры.ОтражатьВНалоговомУчете тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"ПартииТоваровНаСкладах", "ПартииТоваровНаСкладахНалоговыйУчет");	
	ИначеЕсли ДопПараметры.ОтражатьВМеждународномУчете тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"ПартииТоваровНаСкладах", "ПартииТоваровНаСкладахМеждународныйУчет");	
	ИначеЕсли Не ДопПараметры.ОтражатьВУправленческомУчете тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос.Текст = Запрос.Текст + "
	|	И НаСкладах.Организация = &Организация";
	Запрос.УстановитьПараметр("Организация", ДопПараметры.Организация);		
	
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() тогда 
		Возврат Неопределено;
	Иначе
		Возврат РезультатЗапроса.Выгрузить();
	КонецЕсли;
	
КонецФункции	


////////////////////////////////////////////////////////////////////////////////
// Процедуры списания по-средней, не зависящие от структуры данных конфигурации

Функция ПолучитьСтруктруТаблицыСписанныхПартийСпецодежды(Учет)
	ТаблицаСписанныхПартий = УправлениеЗатратами.СформироватьТаблицуЗатрат();
	ТаблицаСписанныхПартий.Колонки.Добавить("Стоимость", Новый ОписаниеТипов("Число"), Новый КвалификаторыЧисла(15,2));
	ТаблицаСписанныхПартий.Колонки.Добавить("КодОперацииПартииТоваров", Новый ОписаниеТипов("ПеречислениеСсылка.КодыОперацийПартииТоваров"));
	
	ТаблицаСписанныхПартий.Колонки.Добавить("ОтражатьВУправленческомУчете", Новый ОписаниеТипов("Булево"));
	ТаблицаСписанныхПартий.Колонки.Добавить("ОтражатьВБухгалтерскомУчете", Новый ОписаниеТипов("Булево"));
	ТаблицаСписанныхПартий.Колонки.Добавить("ОтражатьВНалоговомУчете", Новый ОписаниеТипов("Булево"));
	ТаблицаСписанныхПартий.Колонки.Добавить("ОтражатьВМеждународномУчете", Новый ОписаниеТипов("Булево"));
	
	ТаблицаСписанныхПартий.Колонки.Добавить("ФизЛицо", Новый ОписаниеТипов("СправочникСсылка.ФизическиеЛица"));
	ТаблицаСписанныхПартий.Колонки.Добавить("ДокументПередачи", Новый ОписаниеТипов("ДокументСсылка.ПередачаМатериаловВЭксплуатацию"));
	ТаблицаСписанныхПартий.Колонки.Добавить("НазначениеИспользования", Новый ОписаниеТипов("СправочникСсылка.НазначенияИспользования"));
	ТаблицаСписанныхПартий.Колонки.Добавить("Склад", Новый ОписаниеТипов("СправочникСсылка.Склады"));
	
	Если Учет = "Бух" ИЛИ Учет = "Нал" Тогда
		ТаблицаСписанныхПартий.Колонки.Добавить("КорСчетБУ", Новый ОписаниеТипов("ПланСчетовСсылка.Хозрасчетный"));
		ТаблицаСписанныхПартий.Колонки.Добавить("КорСубконтоБУ1");
		ТаблицаСписанныхПартий.Колонки.Добавить("КорСубконтоБУ2");
		ТаблицаСписанныхПартий.Колонки.Добавить("КорСубконтоБУ3");
		
		Если Учет = "Нал" Тогда
			ТаблицаСписанныхПартий.Колонки.Добавить("КорСчетНУ", Новый ОписаниеТипов("ПланСчетовСсылка.Налоговый"));
			ТаблицаСписанныхПартий.Колонки.Добавить("КорСубконтоНУ1");
			ТаблицаСписанныхПартий.Колонки.Добавить("КорСубконтоНУ2");
			ТаблицаСписанныхПартий.Колонки.Добавить("КорСубконтоНУ3");			
		КонецЕсли;	
	КонецЕсли;	
	Возврат ТаблицаСписанныхПартий;
КонецФункции	

// СписаниеПоСредней
//
// Параметры:
//	ТаблицаТоваров - содержит товары, списание которых необходимо усреднить. 
//	Каждая колонка соответствует одному из постоянных параметров товара, не изменяемых в ходе перемещений. 
//	По остальным параметрам выполняется усреднение
//
Процедура РассчитатьСписаниеПоСредней(ТаблицаТоваров, ДатаНач, ДатаКон, СтруктураДопПараметров)
	
	// Основное допущение данного метода - игнорирование замкнутой цепочки перемещений между состояниями ("холостого хода"):
	// считаем, что если товар в ходе перемещений снова попал в исходное состояние, то он как бы не перемещался, 
	// это движение можно исключить из общего оборота, а стоимость движения принять равной 0. Цепочки перемещений 
	// таким образом размыкаются, что позволяет рассчитать стоимости движений, начиная от конца цепочки.
	
	// Получим все состояния для товара, которые он принимал за период в виде таблицы
	//	---------------------------------------------------------------------------------------------------------------------------------
	// |Состояние 1 (Источник) |Состояние 2 (Приемник)| Перемещаемое количество| Стоимость (нужна для упрощения последующей корректировки)
	
	// Последовательно обходя состояния, выделим контуры (пути, начала и концы которых совпадают)
	// В каждом контуре найдем количество, которое совершило перемещение по замкнутому кругу ("холостой ход"), 
	// и уменьшим каждое движение из контура на данное количество.
	// Будем выбирать другие состояния для получения всех контуров и применим к ним то же правило.
	
	// После нахождения контуров в графах перемещений и сокращения "холостого хода" получаем совокупность разомкнутых 
	// путей перехода товара между состояниями (остовные деревья). Внутри каждой такой цепочки выполняем расчет.
	// Важно:  в общем случае результат сокращения зависит от последовательности обхода контуров, поэтому
	// для повторяемости результата она должна подчиняться какому-либо правилу (например, чтобы сводные перемещения
	// упорядочивались по возрастанию даты первого перемещения)
	
	// Получим таблицу перемещений, содержащую суммарные перемещения между состояниями
	
	// Получаемая таблица должна содержать колонку "Количество", "Стоимость" и колонки, описывающие старое и новое состояние,
	// причем имена колонок нового состояния заканчиваются на ПрефиксПараметровНовогоСостояния
	ПрефиксПараметровНовогоСостояния="_НовоеСостояние";
	
	Таб = ПолучитьТаблицуПеремещений(ТаблицаТоваров, ДатаНач, ДатаКон, ПрефиксПараметровНовогоСостояния, СтруктураДопПараметров);
	
	СтруктураДопПараметров.Вставить("ТаблицаСписанныхПартийСпецодежды", ПолучитьСтруктруТаблицыСписанныхПартийСпецодежды(СтруктураДопПараметров.Учет));
	
	//1. Приведем переданную таблицу перемещений к требуемому виду:
	// Таблица имеет колонки Источник, Приемник, Количество
	// строка таблицы соответствует перемещению из состояния 1 в состояние 2, перемещения не повторяются.
	
	// Количество колонок без ПрефиксПараметровНовогоСостояния должно быть равно количеству колонок с ПрефиксПараметровНовогоСостояния
	// Сформируем также структуру, которая содержит параметры состояния товара
	СтруктураСостояния = Новый Структура;
	
	МассивСумм = Неопределено;
	СтруктураДопПараметров.Свойство("МассивСумм", МассивСумм);
	
	Если ТипЗнч(МассивСумм) <> Тип("Массив") Тогда
		МассивСумм = Новый Массив;
		МассивСумм.Добавить("Стоимость");
	КонецЕсли;
	
	
	// То же самое, но в соответствии - для удобства поиска
	СоотвСумм = Новый Соответствие;
	
	Для Каждого ЭлементСумм Из МассивСумм Цикл
		СоотвСумм.Вставить(ЭлементСумм, ЭлементСумм);
	КонецЦикла;
	
	Инд=0;
	Пока Инд< Таб.Колонки.Количество() Цикл
		
		Колонка = Таб.Колонки[Инд];
		
		// Имя колонки не совпадает с количеством и колонками стоимости
		Если ВРег(Колонка.Имя) <> ВРег("Количество") Тогда
			
			// Это колонка суммы
			Если СоотвСумм[Колонка.Имя] <> Неопределено Тогда
				Инд = Инд+1;
				Продолжить;
			КонецЕсли;
			
			// Колонки, оканчивающиеся на ПрефиксПараметровНовогоСостояния - правые (новое состояние), им должны соответствовать такие же левые, оканчивающиеся на ПрефиксПараметровНовогоСостояния
			Если Прав(Колонка.Имя, СтрДлина(ПрефиксПараметровНовогоСостояния)) = ПрефиксПараметровНовогоСостояния  Тогда
				ИмяСоответствующейКолонки=Лев(Колонка.Имя, СтрДлина(Колонка.Имя)-СтрДлина(ПрефиксПараметровНовогоСостояния));
				Если Таб.Колонки.Найти(ИмяСоответствующейКолонки)=Неопределено Тогда
					Таб.Колонки.Добавить(ИмяСоответствующейКолонки, Колонка.ТипЗначения)
				КонецЕсли;
				// И наоборот, колонки, не оканчивающиеся на ПрефиксПараметровНовогоСостояния - левые (новое состояние), им должны соответствовать такие же правые, оканчивающиеся на ПрефиксПараметровНовогоСостояния
			Иначе
				ИмяСоответствующейКолонки=Колонка.Имя+ПрефиксПараметровНовогоСостояния;
				Если Таб.Колонки.Найти(ИмяСоответствующейКолонки)=Неопределено Тогда
					Таб.Колонки.Добавить(ИмяСоответствующейКолонки, Колонка.ТипЗначения)
				КонецЕсли;
				
				СтруктураСостояния.Вставить(Колонка.Имя);
			КонецЕсли;
		КонецЕсли;
		
		Инд=Инд+1;
	КонецЦикла;
	
	// В таблице перемещений заменим параметры состояний индексами состояний, сами параметры будут храниться в СоотвПараметровСостояний
	
	Таб.Колонки.Добавить("Источник", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(9,0)));
	Таб.Колонки.Добавить("Приемник", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(9,0)));
	
	СоотвПараметровСостояний = Новый Соответствие;
	
	Для Каждого Строка Из Таб Цикл // поиск выплняется полным перебором
		
		// Состояния-источники
		// Найдем состояние в соответсвии				
		НайденоСостояние=Ложь;
		Для Каждого ЭлементСостояние Из СоотвПараметровСостояний Цикл
			
			НайденоСостояние=Истина;
			Для Каждого Элемент Из СтруктураСостояния Цикл
				
				Если Элемент.Ключ = "ВременнаяРазница" или Элемент.Ключ = "ПостояннаяРазница" тогда
					Продолжить;
				КонецЕсли;
				Если НЕ (ЭлементСостояние.Значение[Элемент.Ключ] = Строка[Элемент.Ключ]) Тогда
					
					НайденоСостояние = Ложь; // состояния различны
					
					Прервать; // дальше можно не проверять
				КонецЕсли;
			КонецЦикла;
			
			Если НайденоСостояние Тогда
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Если НайденоСостояние Тогда
			ИндексСостояния = ЭлементСостояние.Ключ;
		Иначе
			// Переносим в соответствие
			СтрСост = Новый Структура;
			Для Каждого Элемент Из СтруктураСостояния Цикл
				Если Элемент.Ключ = "ВременнаяРазница" или Элемент.Ключ = "ПостояннаяРазница" тогда
					Продолжить;
				КонецЕсли;
				СтрСост.Вставить(Элемент.Ключ, Строка[Элемент.Ключ]);
			КонецЦикла;
			
			ИндексСостояния = СоотвПараметровСостояний.Количество();
			СоотвПараметровСостояний.Вставить(ИндексСостояния, СтрСост);
		КонецЕсли;
		
		// Оставим в таблице ссылку на состояние
		Строка.Источник = ИндексСостояния;
		
		
		// То же самое для состояний-приемников
		// Найдем состояние в соответсвии				
		НайденоСостояние=Ложь;
		Для Каждого ЭлементСостояние Из СоотвПараметровСостояний Цикл
			
			НайденоСостояние=Истина;
			Для Каждого Элемент Из СтруктураСостояния Цикл
				
				Если Элемент.Ключ = "ВременнаяРазница" или Элемент.Ключ = "ПостояннаяРазница" тогда
					Продолжить;
				КонецЕсли;
				
				Если НЕ (ЭлементСостояние.Значение[Элемент.Ключ] = Строка[Элемент.Ключ+ПрефиксПараметровНовогоСостояния]) Тогда
					
					НайденоСостояние = Ложь; // состояния различны
					
					Прервать; // дальше можно не проверять
				КонецЕсли;
			КонецЦикла;
			
			Если НайденоСостояние Тогда
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Если НайденоСостояние Тогда
			ИндексСостояния = ЭлементСостояние.Ключ;
		Иначе
			// Переносим в соответствие
			СтрСост = Новый Структура;
			Для Каждого Элемент Из СтруктураСостояния Цикл
				СтрСост.Вставить(Элемент.Ключ, Строка[Элемент.Ключ+ПрефиксПараметровНовогоСостояния]);
			КонецЦикла;
			
			ИндексСостояния = СоотвПараметровСостояний.Количество();
			СоотвПараметровСостояний.Вставить(ИндексСостояния, СтрСост);
		КонецЕсли;
		
		// Оставим в таблице ссылку на состояние
		Строка.Приемник = ИндексСостояния;
		
	КонецЦикла;
	
	// "Свернем" встречные перемещения: вместо двух перемещений типа 1->2 и 2->1 оставим одно 
	// с количеством |Кол12 - Кол21| в направлении большего перемещения.
	
	// Проведем следующее преобразование: повернем пары так, чтобы количество перемещения стало положительным
	Для Каждого Строка Из Таб Цикл
		
		Если Строка.Количество<0 Тогда
			Буф=Строка.Приемник;
			Строка.Приемник = Строка.Источник;
			Строка.Источник = Буф;
			Строка.Количество = - Строка.Количество;
			Для Каждого КолСумма Из МассивСумм Цикл
				Строка[КолСумма] = - Строка[КолСумма];
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
	// "Свертка" встречных перемещений
	Инд=0;
	КолВо = Таб.Количество();
	
	Пока Инд<КолВо Цикл
		
		Инд2 = Инд+1;
		Пока Инд2<КолВо Цикл
			
			Строка2 = Таб[Инд2];
			Строка  = Таб[Инд];
			
			// Если найдено соответствующее встречное перемещение
			Если Строка.Источник = Строка2.Приемник
				И Строка.Приемник = Строка2.Источник Тогда
				
				Если Строка.Количество>Строка2.Количество Тогда
					УменьшитьНаКоличество = Строка2.Количество;
				Иначе
					УменьшитьНаКоличество = Строка.Количество;
				КонецЕсли;
				
				Строка.Количество  = Строка.Количество  - УменьшитьНаКоличество;
				Строка2.Количество = Строка2.Количество - УменьшитьНаКоличество;
				
				Для Каждого КолСумма Из МассивСумм Цикл
					
					Если Строка.Количество>Строка2.Количество Тогда
						УменьшитьНаСтоимость = Строка2[КолСумма];
					Иначе
						УменьшитьНаСтоимость = Строка[КолСумма];
					КонецЕсли;
					
					// То же самое - со стоимостью
					Строка[КолСумма]  = Строка[КолСумма]  - УменьшитьНаСтоимость;
					Строка2[КолСумма] = Строка2[КолСумма]  - УменьшитьНаСтоимость;
				КонецЦикла;
				
				// На этом обход можно прервать: быть не более одной пары встречных перемещений
				Прервать;
				
			Иначе
				Инд2 = Инд2+1;
			КонецЕсли;
			
		КонецЦикла; 
		
		Инд = Инд+1;
		
	КонецЦикла; 
	
	// Удалим обнулившиеся строки
	// Удаляем только строки со всеми нулевыми суммами и нулевым количеством
	
	КолВо = Таб.Количество();
	Инд=0;
	Пока Инд<КолВо Цикл
		
		Строка  = Таб[Инд];
		
		НеНужноУдалять = Строка.Количество<>0;
		
		Если Не НеНужноУдалять Тогда
		
			Для Каждого КолСумма Из МассивСумм Цикл
						
				НеНужноУдалять = НеНужноУдалять Или Строка[КолСумма]<>0;
				
			КонецЦикла;
		
		КонецЕсли;
		
		Если Не НеНужноУдалять Тогда
			Таб.Удалить(Строка);
			
			КолВо = КолВо-1;
		Иначе
			Инд=Инд+1;
		КонецЕсли;
		
	КонецЦикла;
	
	// Получили таблицу перемещений в требуемом формате
	ТаблицаПеремещений = Таб;	
	
	// Таблица перемещений содержит несколько несвязанных частей, относящихся к отдельным партиям - строкам таблицы ТаблицаТоваров
	
	// Обработка перемещений: разрыв контуров
	// Получим наборы смежных вершин для каждой вершины
	// Соотв СмежныеВершины Вершина, СмежныеВершины
	
	Источники = Новый Соответствие;
	Приемники = Новый Соответствие;
	МассивНачалДеревьев = Новый Массив;
	
	Для Каждого Строка Из ТаблицаПеремещений Цикл
		
		ПараметрыИсточника = Источники[Строка.Источник];
		Если ПараметрыИсточника = Неопределено Тогда
			СмежныеВершины= Новый Соответствие;
			ПараметрыИсточника = Новый Структура("Пройден, СмежныеВершины", Ложь, СмежныеВершины);
		КонецЕсли;
		
		ПараметрыИсточника.СмежныеВершины.Вставить(Строка.Приемник, ТаблицаПеремещений.Индекс(Строка)); // во вложенной структуре храним смежную вершину и номер строки перемещения
		
		Источники.Вставить(Строка.Источник, ПараметрыИсточника);
		
	КонецЦикла;
	
	// Чтобы рассчитать перемещения, заменим каждый связный граф перемещений его остовным деревом
	// Для этого обойдем их все, найдем и разорвем все контуры по предложенному выше правилу.
	Для Каждого Элемент Из Источники Цикл
		Если НЕ Элемент.Значение.Пройден Тогда // если от вершины еще не строился контур, обрабатываем
			
			//ПройденныеВершины = Новый Соответствие;
			//НомерВершины = Элемент.Ключ;
			//ПройденныеВершины.Вставить(НомерВершины, -1);
			
			ПройденныеВершины = Новый ТаблицаЗначений;
			ПройденныеВершины.Колонки.Добавить("Ключ");
			ПройденныеВершины.Колонки.Добавить("Значение");
			
			НоваяСтрока = ПройденныеВершины.Добавить();
			НоваяСтрока.Ключ = Элемент.Ключ;
			НоваяСтрока.Значение = -1;
			
			НомерВершины = Элемент.Ключ;
			
			РазорватьКонтуры(НомерВершины, Источники, ПройденныеВершины, ТаблицаПеремещений);
		КонецЕсли;
	КонецЦикла;
	
	// После этого таблица содержит незамкнутую последовательность перемещений. 
	// Стоимость перемещений с количеством = 0 в таблице тоже должна быть приведена к 0.
	СтСумм = Новый Структура; // структура сумм
	
	Для Каждого Строка Из ТаблицаПеремещений Цикл
		
		Если Строка.Количество=0 Тогда
			
			Для Каждого КолСумма Из МассивСумм Цикл
				СтСумм.Вставить(КолСумма, -Строка[КолСумма]);
			КонецЦикла;
			
			ДобавитьЗаписиПоПеремещению(СоотвПараметровСостояний[Строка.Источник], СоотвПараметровСостояний[Строка.Приемник], СтСумм, СтруктураДопПараметров)
			
		Иначе
			
			Приемники.Вставить(Строка.Приемник, Строка.Приемник);
			
		КонецЕсли;
		
	КонецЦикла;
	
	// Теперь нужно выделить отдельные деревья, определить среднюю стоимость для каждого дерева, 
	// и начиная с самого начала каждого дерева последовательно рассчитать стоимость для каждого состояния/перемещения
	
	// Найдем начало каждого дерева - его нет в приемниках
	Для каждого Строка Из ТаблицаПеремещений Цикл
		
		// Анализируем только ненулевые дуги
		Если Строка.Количество<>0 Тогда
			
			// Если источника нет среди приемников, значит это начало дерева
			Если Приемники[Строка.Источник]=Неопределено Тогда
				
				ВершинаНайдена = Ложь; // признак того, что вершина уже есть в массиве
				Для Каждого НачалоДерева Из МассивНачалДеревьев Цикл
					
					// Такая вершина уже имеется в списке начал
					Если Строка.Источник = НачалоДерева Тогда
						ВершинаНайдена = Истина;
						Прервать;
					КонецЕсли;
				КонецЦикла;
				
				Если НЕ ВершинаНайдена Тогда
					МассивНачалДеревьев.Добавить(Строка.Источник);
				КонецЕсли;
			
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	// На данном этапе нужна информация о начальном состоянии и внешнем поступлении в каждую вершину
	
	// Будем использовать список вершин, для каждой из которых указаны смежные вершины - приемники и 
	Вершины = Новый Соответствие; // здесь нам понадобится общее количество источников, приемники
	Для Каждого Строка Из ТаблицаПеремещений Цикл
		
		Если Строка.Количество=0 Тогда
			Продолжить;
		КонецЕсли;
		
		// Обработаем источник
		ПодчСтруктура = Вершины[Строка.Источник];
		Если ПодчСтруктура=Неопределено Тогда
			ПодчСтруктура = Новый Структура("КоличествоИсточников, Приемники, КоличествоРассчитанныхВходов", 0, Новый Соответствие, 0);
		КонецЕсли;
		
		СтСумм = Новый Структура; // структура сумм
		Для Каждого КолСумма Из МассивСумм Цикл
			СтСумм.Вставить(КолСумма, Строка[КолСумма]);
		КонецЦикла;
		
		ПодчСтруктура.Приемники.Вставить(Строка.Приемник, Новый Структура("Количество, СтруктураСумм", Строка.Количество, СтСумм)); // Вместе с вершиной-приемником запоминаем количество перемещения
		
		Вершины.Вставить(Строка.Источник, ПодчСтруктура);
		
		// Обработаем приемник
		ПодчСтруктура = Вершины[Строка.Приемник];
		Если ПодчСтруктура=Неопределено Тогда
			ПодчСтруктура = Новый Структура("КоличествоИсточников, Приемники, КоличествоРассчитанныхВходов", 1, Новый Соответствие, 0);
		Иначе
			ПодчСтруктура.КоличествоИсточников = ПодчСтруктура.КоличествоИсточников+1;
		КонецЕсли;
		
		Вершины.Вставить(Строка.Приемник, ПодчСтруктура);
	КонецЦикла;
	
	// В структуру Вершины нужно добавить данные о начальном остатке и внешнем поступлении для каждого из состояний,
	// Можно также добавить состояний, не участвовавших в перемещениях, тогда для них тоже будет рассчитано внешнее списание
	МассивДобавленныеВершины = Новый Массив;
	ДобавитьНачальныйОстатокИВнешнееПоступление(ТаблицаТоваров, Вершины, СоотвПараметровСостояний, ДатаНач, ДатаКон, СтруктураДопПараметров, МассивДобавленныеВершины);
	
	// Добавдленные состояния возвращаются специальным массивом, который добавляется к началам деревьев
	Для Каждого Элемент Из МассивДобавленныеВершины Цикл
		МассивНачалДеревьев.Добавить(Элемент)
	КонецЦикла;
	
	// Теперь будем обходить деревья с начала, и рассчитывать состояния и переходы между ними
	Для Каждого НачалоДерева Из МассивНачалДеревьев Цикл
		РассчитатьПуть(НачалоДерева, Вершины, СоотвПараметровСостояний, СтруктураДопПараметров);
	КонецЦикла;
	
	// Сформируем движения по спецодежде
	ПроцедурыПогашенияСтоимости.ПогашениеСтоимостиПриПередачеВЭксплуатацию(СтруктураДопПараметров, СтруктураДопПараметров.ТаблицаСписанныхПартийСпецодежды);
	
КонецПроцедуры // СписаниеПоСредней()

// Находит контуры и разрывает их, сокращая на минимальное количество
//
// Параметры:
//	Нет.
//
Процедура РазорватьКонтуры(НомерИсхВершины, Источники, ПройденныеВершины, ТаблицаПеремещений)
	
	Приемники = Источники[НомерИсхВершины].СмежныеВершины;
	
	Для Каждого ЭлементВершина Из Приемники Цикл
		
		НомерВершины=ЭлементВершина.Ключ;
		ИндСтрокиПеремещения=ЭлементВершина.Значение;
		
		// Найдем каждую вершину-приемник в списке источников
		ПараметрыИсточника = Источники[НомерВершины];
		Если ПараметрыИсточника = Неопределено Тогда
			Продолжить; // это висячая вершина (степени 1)
		КонецЕсли;
		СмежныеВершины = ПараметрыИсточника.СмежныеВершины;
		
		// Неплохо бы запоминать уже пройденные контуры, чтобы не разбирать уже разобранные
		// Контур нужно идентифицировать последовательностью входящих в него вершин.
		
		// Проверим на замыкание
		Если ПройденныеВершины.Найти(НомерВершины,"Ключ")<> Неопределено тогда
		//Если ПройденныеВершины[НомерВершины]<>Неопределено Тогда
			
			// Контур найден: можно сокращать на мин. количество перемещения
			
			// Найдем дугу контура с мин. количеством
			
			// Начнем с текущей
			СтрокаЗамыкающая=ТаблицаПеремещений[ИндСтрокиПеремещения];
			МинКоличество=СтрокаЗамыкающая.Количество;
			ИндСтрокиСМинКоличеством = ИндСтрокиПеремещения;
			
			Инд=0;
			НачалсяКонтур = Ложь; // флаг начала контура
			Для Каждого Элемент Из ПройденныеВершины Цикл
				
				// Найдем начало контура
				НачалсяКонтур = НачалсяКонтур ИЛИ (Элемент.Ключ = НомерВершины);
				
				Если НачалсяКонтур Тогда
					Если Инд>0 Тогда // в первом элементе нет ссылки на строку
						Строка=ТаблицаПеремещений[Элемент.Значение];
						Если Строка.Количество < МинКоличество Тогда 
							МинКоличество = Строка.Количество;
							ИндСтрокиСМинКоличеством = Элемент.Значение;
						КонецЕсли;
					КонецЕсли;
					Инд=Инд+1;
				КонецЕсли;
			КонецЦикла;
			
			// Вычтем найденное минимальное количество из всех дуг контура
			
			// ... из замыкающей дуги
			СтрокаЗамыкающая.Количество = СтрокаЗамыкающая.Количество - МинКоличество;
			
			// ... из всех пройденных дуг
			Инд=0;
			НачалсяКонтур = Ложь; // флаг начала контура
			Для Каждого Элемент Из ПройденныеВершины Цикл
				
				// Найдем начало контура
				НачалсяКонтур = НачалсяКонтур ИЛИ (Элемент.Ключ = НомерВершины);
				
				Если НачалсяКонтур Тогда
					Если Инд>0 Тогда // в первом элементе нет ссылки на строку
						Строка=ТаблицаПеремещений[Элемент.Значение];
						Строка.Количество = Строка.Количество - МинКоличество;
					КонецЕсли;
					Инд=Инд+1;
				КонецЕсли;
				
			КонецЦикла;
			
			// Если контур разорван, для повторяющейся вершины процедуру не запускаем, пеерходим к следующему приемнику
			Продолжить;
			
		КонецЕсли;
		
		// Сделаем копию ПройденныеВершины и добавим пройденную вершину
//		КопияПройденныеВершины=Новый Соответствие;
		КопияПройденныеВершины =ПройденныеВершины.Скопировать();
		//Для Каждого Элемент Из ПройденныеВершины Цикл
		//	КопияПройденныеВершины.Вставить(Элемент.Ключ, Элемент.Значение);
		//КонецЦикла;
		
		НоваяСтрока = КопияПройденныеВершины.Добавить();
		НоваяСтрока.Ключ = НомерВершины;
		НоваяСтрока.Значение = ИндСтрокиПеремещения;
		
		//КопияПройденныеВершины.Вставить(НомерВершины, ИндСтрокиПеремещения);
		
		РазорватьКонтуры(НомерВершины, Источники, КопияПройденныеВершины, ТаблицаПеремещений);
		
		// Отметим, что от вершины уже строился контур, чтобы не вызывать аналогичную процедуру повторно
		Источники[НомерВершины].Пройден = Истина;
		
	КонецЦикла;
	
КонецПроцедуры // РазорватьКонтуры()

// Рассчитывает отрезки пути в состояния, в которые есть переход из данной вершины
//
// Параметры:
//	Источник - номер состояния-источника.
//	Состояния - соответствие, содержащее состояния, приемники и т.д.
//	СоотвПараметровСостояний - соответствие, содержащее параметры состояния, как они представлены в БД (измерения, счета, субконто и т.д.)
//
Процедура РассчитатьПуть(Источник, Состояния, СоотвПараметровСостояний, СтруктураДопПараметров)
	
	// Состояние в начале:
	// ............
	// ............
	
	// Расчет состояния.
	// Стоимость в состоянии складывается из:
	// Начального остатка + Внешнего прихода (определяется сразу)
	// Прихода из других состояний (входящих стрелок - оперделяется сложением стрелок)
	
	// Приход из других состояний определяем по таблице перемещений
	
	// Расчет перемещения в другие состояния
	// В каждом состоянии-приемнике КоличествоРассчитанныхВходов = КоличествоРассчитанныхВходов+1
	
	СостояниеИсточник=Состояния[Источник];
	
	СтКорректировка = Новый Структура; // структура корректировок
	СтСуммы = Новый Структура; // структура сумм в сстоянии
		
	// Состояние можно использовать в расчете, если рассчитаны все входящие стрелки
	Если СостояниеИсточник.КоличествоИсточников=СостояниеИсточник.КоличествоРассчитанныхВходов Тогда
		
		СоотвПриемники=СостояниеИсточник.Приемники; // соответствие  - примники
		
		// Рассчитаем перемещения между состояниями
		Для Каждого ЭлементПриемник Из СоотвПриемники Цикл
			
			Приемник = ЭлементПриемник.Ключ;
			Количество = ЭлементПриемник.Значение.Количество;
			
			Состояние = Состояния[Приемник];
			
			// Заполним структуру корректировки сумм
			Для Каждого ЭлементСумма Из ЭлементПриемник.Значение.СтруктураСумм Цикл
				
				Если СостояниеИсточник.Количество > Количество Тогда
					СтКорректировка.Вставить(ЭлементСумма.Ключ, Окр(СостояниеИсточник.СтруктураСумм[ЭлементСумма.Ключ]*Количество /СостояниеИсточник.Количество, 2));
				Иначе
					СтКорректировка.Вставить(ЭлементСумма.Ключ, СостояниеИсточник.СтруктураСумм[ЭлементСумма.Ключ]);
				КонецЕсли;
				
				// Суммы в новом состоянии
				СтСуммы.Вставить(ЭлементСумма.Ключ, СтКорректировка[ЭлементСумма.Ключ]);
				
				// Корректировка равна разности между правильным движением и уже выполненным движением
				СтКорректировка[ЭлементСумма.Ключ] = СтКорректировка[ЭлементСумма.Ключ] - ЭлементСумма.Значение;
				
			КонецЦикла;
			
			// Теперь можно сформировать записи по перемещению между состояниями
			// Передаем разницу между первоначальным движением и рассчитанным
			ДобавитьЗаписиПоПеремещению(СоотвПараметровСостояний[Источник], СоотвПараметровСостояний[Приемник], СтКорректировка, СтруктураДопПараметров);
			
			// Поступление в состояние
			Состояние.Количество = Состояние.Количество + Количество;
			СостояниеИсточник.Количество = СостояниеИсточник.Количество - Количество;
			
			// Поступление в состояние: добавим суммы
			Для Каждого ЭлементСумма Из СтСуммы Цикл
				
				Состояние.СтруктураСумм[ЭлементСумма.Ключ]         = Состояние.СтруктураСумм[ЭлементСумма.Ключ]         + ЭлементСумма.Значение;
				СостояниеИсточник.СтруктураСумм[ЭлементСумма.Ключ] = СостояниеИсточник.СтруктураСумм[ЭлементСумма.Ключ] - ЭлементСумма.Значение;
				
			КонецЦикла;
			
			Состояние.КоличествоРассчитанныхВходов = Состояние.КоличествоРассчитанныхВходов+1;
			
			// Расчет пути из этой точки
			РассчитатьПуть(Приемник, Состояния, СоотвПараметровСостояний, СтруктураДопПараметров);
			
		КонецЦикла;
		
		// Остаток в состоянии после перемещений: суммы
		СтОстаток = Новый Структура;
		Для Каждого ЭлементСумма Из СостояниеИсточник.СтруктураСумм Цикл
			СтОстаток.Вставить(ЭлементСумма.Ключ, ЭлементСумма.Значение);
		КонецЦикла;
		
		// Теперь можем рассчитать внешние выходы:
		// сформируем записи по внешнему списанию из состояния Источник
		ДобавитьЗаписиПоВнешнемуСписанию(СоотвПараметровСостояний[Источник], СостояниеИсточник.Количество, СтОстаток, СтруктураДопПараметров);
		
		// Все выходы из данного состояния рассчитаны.
		
	КонецЕсли;
	
КонецПроцедуры // РассчитатьПуть()

////////////////////////////////////////////////////////////////////////////////
// Процедуры списания по-средней, зависящие от структуры данных конфигурации


Функция ПолучитьМассивИсключаемыхСчетов()
	МассивСчетов = Новый Массив();
	МассивСчетов.Добавить(ПланыСчетов.Хозрасчетный.ТараПодТоваромИПорожняя);
	МассивСчетов.Добавить(ПланыСчетов.Налоговый.ТараПодТоваромИПорожняя);
	МассивСчетов.Добавить(ПланыСчетов.Международный.Тара);
	
	МассивСчетов.Добавить(ПланыСчетов.Хозрасчетный.ТоварыНаСкладе);
	МассивСчетов.Добавить(ПланыСчетов.Хозрасчетный.ТоварыПереданныеНаКомиссию);
	МассивСчетов.Добавить(ПланыСчетов.Хозрасчетный.ПереданныеОбъектыНедвижимости);
	
	//m.ionov@a-prof.ru 09.04.2014
	МассивСчетов.Добавить(ПланыСчетов.Хозрасчетный.ТМЦпринятыеНаОтветственноеХранение);
	//----m.ionov@a-prof.ru---
	
	МассивСчетов.Добавить(ПланыСчетов.Налоговый.ТоварыНаСкладе);
	МассивСчетов.Добавить(ПланыСчетов.Налоговый.ТоварыПереданныеНаКомиссию);
	МассивСчетов.Добавить(ПланыСчетов.Налоговый.ПереданныеОбъектыНедвижимости);
	
	Возврат МассивСчетов;
КонецФункции	

Функция ПолучитьМассивИсключаемыхСтатусовПартий()
	МассивСтатусовПартий = Новый Массив();
	
	МассивСтатусовПартий.Добавить(Перечисления.СтатусыПартийТоваров.НаКомиссию);
	МассивСтатусовПартий.Добавить(Перечисления.СтатусыПартийТоваров.ВозвратнаяТара);
	
	Возврат МассивСтатусовПартий;
КонецФункции	

Процедура ДобавитьВЗапросОтборПоКодуОперации(ЗапросНачОстПлюсПриход)
	ЗапросНачОстПлюсПриход.Текст = СтрЗаменить(ЗапросНачОстПлюсПриход.Текст,"Номенклатура В (&МассивНоменклатуры)","Номенклатура В (&МассивНоменклатуры) И (НЕ СтатусПартии В (&ИсключаемыеСтатусыПартий))");
	ЗапросНачОстПлюсПриход.УстановитьПараметр("ИсключаемыеСтатусыПартий",ПолучитьМассивИсключаемыхСтатусовПартий());
КонецПроцедуры	

Процедура ДобавитьВЗапросОтборПоСчету(ЗапросНачОстПлюсПриход)
	ЗапросНачОстПлюсПриход.Текст = СтрЗаменить(ЗапросНачОстПлюсПриход.Текст,"Номенклатура В (&МассивНоменклатуры)","Номенклатура В (&МассивНоменклатуры) И (НЕ СчетУчета В (&СписокИсключаемыхСчетовУчета))");
	ЗапросНачОстПлюсПриход.УстановитьПараметр("СписокИсключаемыхСчетовУчета",ПолучитьМассивИсключаемыхСчетов());
КонецПроцедуры	

Функция ДобавитьОтборПоВидуУчета(ИмяТаблицы,Учет)
	Если Учет = "Упр" Тогда
		Возврат "И " + ИмяТаблицы + ".ОтражатьВУправленческомУчете";
	ИначеЕсли Учет = "Бух" Тогда	
		Возврат "И " + ИмяТаблицы + ".ОтражатьВБухгалтерскомУчете";
	ИначеЕсли Учет = "Нал" Тогда	
		Возврат "И " + ИмяТаблицы + ".ОтражатьВНалоговомУчете";
	ИначеЕсли Учет = "Меж" Тогда	
		Возврат "И " + ИмяТаблицы + ".ОтражатьВМеждународномУчете";		
	Иначе
		Возврат "";
	КонецЕсли;
КонецФункции	

// Возвращает таблицу перемещений товаров между состояниями
// Зависит от конкретной структуры данных конфигурации
//
// Параметры:
//	Нет.
//
Функция ПолучитьТаблицуПеремещений(ТаблицаТоваров, ДатаНач, ДатаКон, ПрефиксПараметровНовогоСостояния, СтруктураДопПараметров)
	
	Таб = Новый ТаблицаЗначений;
	
	// Если таблица товаров не задана, перемещений нет
	Если ТаблицаТоваров.Количество()=0 Тогда
		Возврат Таб;
	КонецЕсли;
	
	//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  
	УжеСформированныйЗапрос  = Неопределено;
	Если СтруктураДопПараметров.Свойство("ПРГ_Запрос_Таб_Перемещения",УжеСформированныйЗапрос) и УжеСформированныйЗапрос <> Неопределено Тогда
		Если СтруктураДопПараметров.Свойство("ПРГ_ФильтрПоТоварам") Тогда
			УжеСформированныйЗапрос.МенеджерВременныхТаблиц = СтруктураДопПараметров.ПРГ_ФильтрПоТоварам;
		КонецЕслИ;
		возврат УжеСформированныйЗапрос.Выполнить().Выгрузить();
		///Если ТипЗнч(УжеСформированныйЗапрос) = Тип("Запрос")
	КонецЕсли;		
	//конец изменений 
	
	// Из структуры доп параметров добудем дополнительные параметры
	Учет = СтруктураДопПараметров.Учет;
	
	//Состояния в УПП:
	// Номенклатура
	// ХарактеристикаНоменклатуры
	// СерияНоменклатуры
	// СтатусПартии (у)
	// СчетУчета (б)
	// Организация (б)
	// ДокументОприходования
	// Качество
	// Склад
	// Заказ
	
	// Перемещения между состояниями в УПП записываются в регистры ПартииТоваровНаСкладах и ПартииТоваровПереданные
	СтруктураИзмерений=Новый Структура;
	
	ИмяРегистра = СтруктураДопПараметров.ИмяРегистраСклад;
	СтруктураИзмерений.Вставить(ИмяРегистра, Новый Массив);
	Для Каждого Изм Из Метаданные.РегистрыНакопления[ИмяРегистра].Измерения Цикл
		СтруктураИзмерений[ИмяРегистра].Добавить(Изм.Имя);
	КонецЦикла;
	
	ИмяРегистра = СтруктураДопПараметров.ИмяРегистраПереданные;
	СтруктураИзмерений.Вставить(ИмяРегистра, Новый Массив);
	Для Каждого Изм Из Метаданные.РегистрыНакопления[ИмяРегистра].Измерения Цикл
		СтруктураИзмерений[ИмяРегистра].Добавить(Изм.Имя);
	КонецЦикла;
	
	Если СтруктураДопПараметров.Свойство("ИмяРегистраВЭксплуатации") Тогда
		ИмяРегистра = СтруктураДопПараметров.ИмяРегистраВЭксплуатации;
		СтруктураИзмерений.Вставить(ИмяРегистра, Новый Массив);
		Для Каждого Изм Из Метаданные.РегистрыНакопления[ИмяРегистра].Измерения Цикл
			СтруктураИзмерений[ИмяРегистра].Добавить(Изм.Имя);
		КонецЦикла;
	КонецЕсли;
	
	КодыОперацийПеремещенияСклад = Новый Массив;
	КодыОперацийПеремещенияСклад.Добавить(Перечисления.КодыОперацийПартииТоваров.ПеремещениеМеждуСкладами);
	КодыОперацийПеремещенияСклад.Добавить(Перечисления.КодыОперацийПартииТоваров.КорректировкаСерийИХарактеристик);
	КодыОперацийПеремещенияСклад.Добавить(Перечисления.КодыОперацийПартииТоваров.КорректировкаКачества);
	КодыОперацийПеремещенияСклад.Добавить(Перечисления.КодыОперацийПартииТоваров.РезервированиеПодЗаказ);
	КодыОперацийПеремещенияСклад.Добавить(Перечисления.КодыОперацийПартииТоваров.СнятиеРезерваПодЗаказ);
	
	КодыОперацийПередача = Новый Массив;
	КодыОперацийПередача.Добавить(Перечисления.КодыОперацийПартииТоваров.ПередачаНаКомиссию);
	КодыОперацийПередача.Добавить(Перечисления.КодыОперацийПартииТоваров.ПередачаТарыКонтрагенту);
	КодыОперацийПередача.Добавить(Перечисления.КодыОперацийПартииТоваров.ПередачаВПереработку);
	
	КодыОперацийВозвратПереданных = Новый Массив;
	КодыОперацийВозвратПереданных.Добавить(Перечисления.КодыОперацийПартииТоваров.ВозвратОтКомиссионера);
	КодыОперацийВозвратПереданных.Добавить(Перечисления.КодыОперацийПартииТоваров.ВозвратТарыОтКонтрагента);
	КодыОперацийВозвратПереданных.Добавить(Перечисления.КодыОперацийПартииТоваров.ВозвратОтПереработчика);
	
	КодыОперацийПеремещенияВЭксплуатации = Новый Массив;
	//начало изменений Ожиганов 03.03.2016 исправление ошибки если передача и перемещение в одном месяце по ну
	//движения по перемещению формируются в погашениях стоимости
	//КодыОперацийПеремещенияВЭксплуатации.Добавить(Перечисления.КодыОперацийПартииМатериаловВЭксплуатации.ПеремещениеВЭксплуатации);
	//конец изменений 
	
	КодыОперацийПередачаВЭксплуатацию = Новый Массив;
	КодыОперацийПередачаВЭксплуатацию.Добавить(Перечисления.КодыОперацийПартииТоваров.ПередачаМатериаловВЭксплуатацию);
	
	КодыОперацийВозвратИзЭксплуатации = Новый Массив;
	//Возврат обслуживается производственным учетом
	//КодыОперацийВозвратИзЭксплуатации.Добавить(Перечисления.КодыОперацийПартииМатериаловВЭксплуатации.ВозвратИзЭксплуатации);
	
	КодыОперацийПустойМассив = Новый Массив;
		
	СтруктураВсехИзмерений= Новый Структура; // содержит все измерения
	
	Для Каждого Элемент Из СтруктураИзмерений Цикл
		Для Каждого Измерение Из Элемент.Значение Цикл
			
			// Вставляем сразу два поля - источник и приемник
			СтруктураВсехИзмерений.Вставить(Измерение);
			СтруктураВсехИзмерений.Вставить(Измерение+ПрефиксПараметровНовогоСостояния);
			
		КонецЦикла;
	КонецЦикла;
	// В соответствии с метаданными регистров генерируется текст запроса
	ПараметрыОтбораТоваров=Новый Массив;
	
	Запрос = Новый Запрос;
	
	// Для налогового учета процедура может быть использована для расчета постоянных и временных разниц
	ДопРесурсы = "";
	Если Учет = "Нал" Тогда
		
		ДопРесурсы = ", Источник.ПостояннаяРазница КАК ПостояннаяРазница, Источник.ВременнаяРазница КАК ВременнаяРазница";
		ДопАгрегРесурсы = ", СУММА(ПостояннаяРазница) КАК ПостояннаяРазница, СУММА(ВременнаяРазница) КАК ВременнаяРазница";
	КонецЕсли;
	
	// Заполним структуры измерений в соответствии с метаданными регистров:
	// Если в учете перемешений товаров могут участвовать n регистров, запрос будет состоять
	// из объединения n запросов, в каждом из которых используются n+1 таблица регистра 
	// (таблица i-го регистра, соединеная с таблицами всех регистров)
	ТекстОбщий="";
	Сч=1;
	Инд=0;
	Для Каждого Элемент Из СтруктураИзмерений Цикл
		
		Для Каждого ПодчЭлемент Из СтруктураИзмерений Цикл
			
			Текст="";
			
			// Условия отбора по ТаблицаТоваров
			ТекстОтборТоваров="";
			
			// Занулим значения измерений
			Для Каждого ЭлементИзмерение Из СтруктураВсехИзмерений Цикл
				СтруктураВсехИзмерений[ЭлементИзмерение.Ключ] = "NULL";
			КонецЦикла;
			
			// Откуда
			Для Каждого Измерение Из Элемент.Значение Цикл
				СтруктураВсехИзмерений[Измерение]="Источник."+Измерение;
				
				// Заполним отбор - только по тем полям, которые совпадают
				Если ТаблицаТоваров.Колонки.Найти(Измерение) <> Неопределено Тогда
					
					Если Измерение = "СчетУчета" Тогда
						
						Продолжить;
						
					КонецЕсли; 
					
					ПараметрыОтбораТоваров.Добавить(Измерение);
					
					ТекстОтборТоваров=ТекстОтборТоваров+" И Источник."+ Измерение+" В (&Массив"+Измерение+")";
					
					Запрос.УстановитьПараметр("Массив"+Измерение, ТаблицаТоваров.ВыгрузитьКолонку(Измерение));
					
				КонецЕсли;
			КонецЦикла;
			
			// Если таблица такая, что все ее колонки не совпадают с измерениями, то ничего не выбираем
			Если ТекстОтборТоваров="" Тогда
				Возврат Таб;
			КонецЕсли;
			
			// Куда - через соединения
			ТекстСоединения="";
			Для Каждого Измерение Из ПодчЭлемент.Значение Цикл
				СтруктураВсехИзмерений[Измерение+ПрефиксПараметровНовогоСостояния]="Приемник."+Измерение;
			КонецЦикла;;
			
			Для каждого ЭлементИзмерение Из СтруктураВсехИзмерений Цикл
				Текст=Текст+", " + Символы.ПС + Символы.Таб + ЭлементИзмерение.Значение + " КАК " + ЭлементИзмерение.Ключ;
			КонецЦикла;
			
			// Если  таблицы - одинаковые, нужно вставить условие на неравенство полей
			// Добавим условие на неравенство текущего и нового состояния
			ТекстУсловияНаНеравенствоПолей = "";
			
			Если Элемент.Ключ = ПодчЭлемент.Ключ Тогда
				Для Каждого ИмяПоля Из ПодчЭлемент.Значение Цикл
					
					ТекстУсловияНаНеравенствоПолей=ТекстУсловияНаНеравенствоПолей+
					Символы.ПС + "ИЛИ Источник." + ИмяПоля + " <> Приемник." + ИмяПоля;
				КонецЦикла;
				
				ТекстУсловияНаНеравенствоПолей = "И ( " + Сред(ТекстУсловияНаНеравенствоПолей, 5) + " )";
			КонецЕсли;
			
			Текст="
			|ОБЪЕДИНИТЬ ВСЕ 
			|ВЫБРАТЬ "+Сред(Текст+", Источник.Количество КАК Количество, Источник.Стоимость КАК Стоимость, Источник.Период КАК Период" + ДопРесурсы, 2) + "
//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  			
//			|	ИЗ РегистрНакопления."+Элемент.Ключ+" КАК Источник
            |"+?(СтруктураДопПараметров.Свойство("ПРГ_ФильтрПоТоварам"),"
			|	ИЗ ПРГ_"+Элемент.Ключ+" КАК Источник","
			|	ИЗ РегистрНакопления."+Элемент.Ключ+" КАК Источник")+"
//конец изменений 			
			|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления."+ ПодчЭлемент.Ключ +" КАК Приемник
			|	ПО Источник.Регистратор = Приемник.Регистратор
			|	И Источник.НомерКорСтроки = Приемник.НомерСтроки 
//начало изменений Ожиганов 28.01.2016 б/н исключение неактивных записей из р/с и корректировки стоимости 
			|	И Источник.Активность И  Приемник.Активность
//конец изменений 
			|	И Источник.КодОперации В (&КодыОпераций"+Инд+")" + "
			|ГДЕ
			|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон И
			|	Источник.ВидДвижения = &ВидДвиженияРасход 
//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  			
//			|" + ТекстУсловияНаНеравенствоПолей + ТекстОтборТоваров; // Количество при перемещении обязательно должно совпадать
			|" + ТекстУсловияНаНеравенствоПолей + ?(СтруктураДопПараметров.Свойство("ПРГ_ФильтрПоТоварам"),"",ТекстОтборТоваров);
//конец изменений 			
			
			Если Учет = "Бух" ИЛИ Учет = "Нал" ИЛИ Учет = "Меж" Тогда
				Текст = Текст  + "
				|	И (НЕ Источник.СчетУчета В (&СписокИсключаемыхСчетовУчета))
				|	И Источник.Организация = &Организация";
			ИначеЕсли Учет = "Упр"  И Элемент.Ключ <> СтруктураДопПараметров.ИмяРегистраВЭксплуатации Тогда
				Текст = Текст  + "
				|	И (НЕ Источник.СтатусПартии В (&ИсключаемыеСтатусыПартий))";
			КонецЕсли;	
			
			ТекстОбщий = ТекстОбщий+Текст;
			
			Инд=Инд+1;
		КонецЦикла;
	КонецЦикла;
	
	ТекстПоля = "";
	Для каждого ЭлементИзмерение Из СтруктураВсехИзмерений Цикл
		ТекстПоля=ТекстПоля + ", 
		|	"+ЭлементИзмерение.Ключ;
	КонецЦикла;
	
	//начало изменений Ожиганов 19.10.2015 изменении качества при комплектации, учтем как перемещение
	ПРГ_УчитыватьКомплКакПеремИзмКачества = Ложь;
	Если СтруктураДопПараметров.Свойство("ПРГ_УчитыватьКомплКакПеремИзмКачества",ПРГ_УчитыватьКомплКакПеремИзмКачества) и ПРГ_УчитыватьКомплКакПеремИзмКачества Тогда
		Для каждого Элем  Из СтруктураВсехИзмерений Цикл
			СтруктураВсехИзмерений[Элем.Ключ] = "NULL";
		КонецЦикла;
		
		МассивПолей  = СтруктураИзмерений [СтруктураДопПараметров.ИмяРегистраСклад];
		
		Для Каждого ТекЭлем Из МассивПолей Цикл
			СтруктураВсехИзмерений[ТекЭлем] = "Источник."+ТекЭлем;
			СтруктураВсехИзмерений[ТекЭлем+ПрефиксПараметровНовогоСостояния] = "Приемник."+ТекЭлем;
		КонецЦикла;	
		
		ТекстПолей = "";
		Для Каждого ТекЭлем Из СтруктураВсехИзмерений Цикл
			ТекстПолей = ТекстПолей + ?(ПустаяСтрока(ТекстПолей),"",Символы.ПС+",")+ТекЭлем.Значение + " как  "+ТекЭлем.Ключ;
		КонецЦикла;	
		
		// Откуда
		ТекстОтборТоваров			   = "";
		Для Каждого Измерение Из Элемент.Значение Цикл
			СтруктураВсехИзмерений[Измерение]="Источник."+Измерение;
			
			// Заполним отбор - только по тем полям, которые совпадают
			Если ТаблицаТоваров.Колонки.Найти(Измерение) <> Неопределено Тогда
				
				Если Измерение = "СчетУчета" Тогда
					
					Продолжить;
					
				КонецЕсли; 
				
				ПараметрыОтбораТоваров.Добавить(Измерение);
				
				ТекстОтборТоваров=ТекстОтборТоваров+" И Источник."+ Измерение+" В (&Массив"+Измерение+")";
				
				Запрос.УстановитьПараметр("Массив"+Измерение, ТаблицаТоваров.ВыгрузитьКолонку(Измерение));
				
			КонецЕсли;
		КонецЦикла;
		
	  ТекстУсловияНаНеравенствоПолей = "";
	  Для Каждого ИмяПоля Из МассивПолей Цикл
		  
		  Если ИмяПоля = "Организация" или ИмяПоля = "Номенклатура" Тогда
			  
		  Иначе
				ТекстУсловияНаНеравенствоПолей=ТекстУсловияНаНеравенствоПолей+
				Символы.ПС + "ИЛИ Источник." + ИмяПоля + " <> Приемник." + ИмяПоля;
		  КонецЕсли; 
	  КонецЦикла;
			
	  ТекстУсловияНаНеравенствоПолей = "И ( " + Сред(ТекстУсловияНаНеравенствоПолей, 5) + " )";
		  
		
			Текст="
			|ОБЪЕДИНИТЬ ВСЕ 
			|ВЫБРАТЬ "+ТекстПолей+", Источник.Количество КАК Количество, Источник.Стоимость КАК Стоимость, Источник.Период КАК Период" + ДопРесурсы + "
//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  			
//			|	ИЗ РегистрНакопления."+СтруктураДопПараметров.ИмяРегистраСклад+" КАК Источник
            |"+?(СтруктураДопПараметров.Свойство("ПРГ_ФильтрПоТоварам"),"
			|	ИЗ ПРГ_"+СтруктураДопПараметров.ИмяРегистраСклад+" КАК Источник","
			|	ИЗ РегистрНакопления."+СтруктураДопПараметров.ИмяРегистраСклад+" КАК Источник")+"

//конец изменений 			
			|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления."+ СтруктураДопПараметров.ИмяРегистраСклад +" КАК Приемник
			|	ПО Источник.Регистратор = Приемник.Регистратор
			|	И Источник.НомерКорСтроки = Приемник.НомерСтроки
//начало изменений Ожиганов 28.01.2016 б/н исключение неактивных записей из р/с и корректировки стоимости 
			|	И Источник.Активность И  Приемник.Активность
//конец изменений 
			|	И Источник.КодОперации В (&КодыОпераций"+"40"+")" + "
			|ГДЕ
			|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон 	  И
			//начало изменений Ожиганов 21.10.2015 изменении качества при комплектации, учтем как перемещение 
			//|	Источник.Количество = Источник.Количество     И
			//конец изменений 
			//начало изменений Ожиганов 27.11.2015 исправление ошибки перепутаны источник и приемник
			|	Источник.Организация = Приемник.Организация   И
			|	Источник.Номенклатура = Приемник.Номенклатура И
			//конец изменений 
			|	Источник.ВидДвижения = &ВидДвиженияРасход 
//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  			
//			|" + ТекстУсловияНаНеравенствоПолей + ТекстОтборТоваров; // Количество при перемещении обязательно должно совпадать
			|" + ТекстУсловияНаНеравенствоПолей + ?(СтруктураДопПараметров.Свойство("ПРГ_ФильтрПоТоварам"),"",ТекстОтборТоваров);
//конец изменений 			
			
			Если Учет = "Бух" ИЛИ Учет = "Нал" ИЛИ Учет = "Меж" Тогда
				Текст = Текст  + "
				|	И (НЕ Источник.СчетУчета В (&СписокИсключаемыхСчетовУчета))
				|	И Источник.Организация = &Организация";
			КонецЕсли;	
		
		//Сообщить(Текст);
		ТекстОбщий = ТекстОбщий+"
		|"+ Текст;
		
		Запрос.УстановитьПараметр("КодыОпераций40", Перечисления.КодыОперацийПартииТоваров.Комплектация); 
	КонецЕсли;
	//конец изменений 
	
	
	ТекстПоляРесурсы = ", СУММА(Количество) КАК Количество, СУММА(Стоимость) КАК Стоимость" + ДопАгрегРесурсы;
	ТекстЗапроса = "ВЫБРАТЬ "+Сред(ТекстПоля+ТекстПоляРесурсы, 2)+" ИЗ(" + Сред(ТекстОбщий, 16) + ") КАК Подзапрос
	//|" + ТекстУсловияНаНеравенствоПолей +"
	|СГРУППИРОВАТЬ ПО "+ Сред(ТекстПоля, 2)+"
//начало изменений Ожиганов 31.05.2016 выравнивание копеек по НУ, приведение остатков к БУ 	
//упорядочим еще и по количеству
	|УПОРЯДОЧИТЬ ПО МИНИМУМ(Подзапрос.Период) , Количество УБЫВ "; // Перемещения будут следовать в порядке дат первых движений
//конец изменений 
	
	
	Запрос.Текст = ТекстЗапроса;
	
	//Запрос.УстановитьПараметр("КодыОпераций0", КодыОперацийПеремещенияСклад);
	//Запрос.УстановитьПараметр("КодыОпераций1", КодыОперацийПередача);
	//Запрос.УстановитьПараметр("КодыОпераций2", КодыОперацийВозвратПереданных);
	//Запрос.УстановитьПараметр("КодыОпераций3", КодыОперацийПеремещенияПереданные);
	
	Запрос.УстановитьПараметр("КодыОпераций0", КодыОперацийПеремещенияСклад); 
	Запрос.УстановитьПараметр("КодыОпераций1", КодыОперацийПередача);
	Запрос.УстановитьПараметр("КодыОпераций2", КодыОперацийПередачаВЭксплуатацию);
	Запрос.УстановитьПараметр("КодыОпераций3", КодыОперацийВозвратПереданных);
	Запрос.УстановитьПараметр("КодыОпераций4", КодыОперацийПустойМассив);//Перемещение внутри товаров переданных на комиссию
	Запрос.УстановитьПараметр("КодыОпераций5", КодыОперацийПустойМассив);//Перемещение из переданных на комиссию в эксплуатацию
	Запрос.УстановитьПараметр("КодыОпераций6", КодыОперацийВозвратИзЭксплуатации);
	Запрос.УстановитьПараметр("КодыОпераций7", КодыОперацийПустойМассив);//Перемещение из эксплуатации на комиссию
	Запрос.УстановитьПараметр("КодыОпераций8", КодыОперацийПеремещенияВЭксплуатации);
	
	Запрос.УстановитьПараметр("ВидДвиженияРасход", ВидДвиженияНакопления.Расход);
	Запрос.УстановитьПараметр("ДатаНач", ДатаНач);
	Запрос.УстановитьПараметр("ДатаКон", ДатаКон);
	Запрос.УстановитьПараметр("Организация", СтруктураДопПараметров.Организация);
	Запрос.УстановитьПараметр("СписокИсключаемыхСчетовУчета", ПолучитьМассивИсключаемыхСчетов());
	Запрос.УстановитьПараметр("ИсключаемыеСтатусыПартий",ПолучитьМассивИсключаемыхСтатусовПартий());
	
	//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям
	ТекстУдал = "";
	ПредТекстЗапроса =  ПРГ_ПолучитьТекстЗапросаПредваритТаблицПоПеремещениям(СтруктураДопПараметров,
		СтруктураИзмерений,
		Учет,ДопРесурсы,
		ТекстУдал,
		Запрос,
		КодыОперацийПередачаВЭксплуатацию,
		КодыОперацийПеремещенияВЭксплуатации,
		КодыОперацийВозвратПереданных,
		КодыОперацийПередача,
		КодыОперацийПеремещенияСклад);
	//конец изменений 
	
	//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  
	Запрос .Текст = ПредТекстЗапроса + Запрос .Текст + ?(ПустаяСтрока(ТекстУдал),"","
	|;"+ТекстУдал);	
	//конец изменений 
	
	Таб=Запрос.Выполнить().Выгрузить();
	
	//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  
	Если  СтруктураДопПараметров.Свойство("ПРГ_ФильтрПоТоварам") Тогда
		//Запрос.Текст = ТекстУдал +"
		//|" + Запрос.Текст;	
		//запомним запрос
		СтруктураДопПараметров.Вставить("ПРГ_Запрос_Таб_Перемещения",Запрос);
		// фильтр по номенклатуре применен
		возврат Таб;
	КонецЕсли;	  	
	//конец изменений 
	
	// Удалим из таблицы строки, не соответствующие таблице товаров (если в ней есть несколько строк, то в запросе могут быть 
	// другие комбинации значений в разных колонках)
	СтруктураОтбора = Новый Структура;
	Если ТаблицаТоваров.Количество()>1 Тогда
		Инд=0;
		Пока Инд < Таб.Количество() Цикл;
			Строка = Таб[Инд];
			
			Для каждого Параметр Из ПараметрыОтбораТоваров Цикл
				СтруктураОтбора.Вставить(Параметр, Строка[Параметр]);
			КонецЦикла;
			
			Если ТаблицаТоваров.НайтиСтроки(СтруктураОтбора).Количество()=0 Тогда
				Таб.Удалить(Строка);
			Иначе
				Инд=Инд+1;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Возврат Таб;
	
КонецФункции // ПолучитьТаблицуПеремещений()

// Добавляет данные о начальном остатке и внешнем поступлении в состояниях
//
// Параметры:
//	Нет.
//
Процедура ДобавитьНачальныйОстатокИВнешнееПоступление(ТаблицаТоваров, Состояния, СоотвПараметровСостояний, ДатаНач, ДатаКон, СтруктураДопПараметров, МассивДобавляемыхВершин)
	
	// Из структуры доп параметров получим дополнительные параметры
	
	// Запросом получим данные об остатках в состояниях на начало периода
	КодыОпераций = Перечисления.КодыОперацийПартииТоваров;
	
	МассивНоменклатуры  = Неопределено;
	
	ТабПартий = Неопределено;
	
	МассивСумм = Неопределено; // список суммовых ресурсов, списываемых пропорционально количеству
	СтруктураДопПараметров.Свойство("МассивСумм", МассивСумм);
	
	Если ТипЗнч(МассивСумм) <> Тип("Массив") Тогда
		МассивСумм = Новый Массив;
		МассивСумм.Добавить("Стоимость");
	КонецЕсли;
	
	ЗапросНачОстПлюсПриход = Новый Запрос;
	ЗапросНачОстПлюсПриход.УстановитьПараметр("ВидДвиженияПриход", ВидДвиженияНакопления.Приход);
	ЗапросНачОстПлюсПриход.УстановитьПараметр("ВидДвиженияРасход", ВидДвиженияНакопления.Расход);
	ЗапросНачОстПлюсПриход.УстановитьПараметр("ДатаНач", ДатаНач);
	ЗапросНачОстПлюсПриход.УстановитьПараметр("ДатаКон", ДатаКон);
	//начало изменений для расхода 
	ИсклСписокКодов = Новый Массив;
	ИсклСписокКодов.Добавить(КодыОпераций.ПустаяСсылка());
	ЗапросНачОстПлюсПриход.УстановитьПараметр("ИсклСписокКодов", ИсклСписокКодов);
	ЗапросНачОстПлюсПриход.УстановитьПараметр("СписоксчетовИскл", Новый Массив);
	//конец изменений 
	//начало изменений
	ЗапросНачОстПлюсПриход.УстановитьПараметр("_КодОперацииКоплектации", КодыОпераций.Комплектация);
	//конец изменений
	
	// Массив для отбора товаров в запросе
	ИндСостояния=0;
	
	// Добавим номенклатуру из общего списка
	МассивНоменклатуры = ТаблицаТоваров.ВыгрузитьКолонку("Номенклатура");

	МассивНоменклатуры = ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(МассивНоменклатуры);
	
	// Из структуры доп параметров добудем дополнительные параметры
	Учет = СтруктураДопПараметров.Учет;
	
	ИмяРегистра = СтруктураДопПараметров.ИмяРегистраСклад;
	
	ИмяРегистраПеред = СтруктураДопПараметров.ИмяРегистраПереданные;
	
	// Товары на складах
	Если Учет = "Упр" Тогда
		
		ЗаполнитьЗапросНачОстПлюсПриходУпр(ЗапросНачОстПлюсПриход);
		ДобавитьВЗапросОтборПоКодуОперации(ЗапросНачОстПлюсПриход);
		
	ИначеЕсли Учет = "Бух" Тогда
		
		//начало изменений Ожиганов 20.10.2015 изменении качества при комплектации, учтем как перемещение 
		//ЗаполнитьЗапросНачОстПлюсПриходБух(ЗапросНачОстПлюсПриход);
		ЗаполнитьЗапросНачОстПлюсПриходБух(ЗапросНачОстПлюсПриход,СтруктураДопПараметров);
		//конец изменений 
		ДобавитьВЗапросОтборПоСчету(ЗапросНачОстПлюсПриход);
		
	ИначеЕсли Учет = "Нал" Тогда
		
		//начало изменений Ожиганов 20.10.2015 изменении качества при комплектации, учтем как перемещение 
		//ЗаполнитьЗапросНачОстПлюсПриходНал(ЗапросНачОстПлюсПриход);
		ЗаполнитьЗапросНачОстПлюсПриходНал(ЗапросНачОстПлюсПриход,СтруктураДопПараметров);
		//конец изменений 
		ДобавитьВЗапросОтборПоСчету(ЗапросНачОстПлюсПриход);
		
	ИначеЕсли Учет = "Меж" Тогда
		
		ЗаполнитьЗапросНачОстПлюсПриходМеж(ЗапросНачОстПлюсПриход);
		ДобавитьВЗапросОтборПоСчету(ЗапросНачОстПлюсПриход);
		
	КонецЕсли;
	
	//Начало изменеий
	Если ДатаКон >= '20150301'Тогда
		ЗапросНачОстПлюсПриход.Текст	= СтрЗаменить(ЗапросНачОстПлюсПриход.Текст,"//@ИсклКомпл","");
	КонецЕсли;	
	//конец изменений
	
	ЗапросНачОстПлюсПриход.УстановитьПараметр("МассивНоменклатуры", МассивНоменклатуры);
	
	// Коды операций выбираемых в запросе движений (внешнего поступления)
	СписокКодов = Новый Массив;
	СписокКодов.Добавить(КодыОпераций.Поступление);
	СписокКодов.Добавить(КодыОпераций.ПоступлениеВПереработку);
	СписокКодов.Добавить(КодыОпераций.ВозвратМатериаловИзПроизводстваФикс);
	СписокКодов.Добавить(КодыОпераций.ВозвратМатериаловИзПроизводстваРасч);
	СписокКодов.Добавить(КодыОпераций.ВозвратОтПокупателя);
	СписокКодов.Добавить(КодыОпераций.ВозвратПродукцииИзПроизводстваФикс);
	СписокКодов.Добавить(КодыОпераций.ВыпускПродукцииФиксНаСклад);
	СписокКодов.Добавить(КодыОпераций.ПоступлениеДопРасходов);
	СписокКодов.Добавить(КодыОпераций.ПоступлениеОборудования);
	СписокКодов.Добавить(КодыОпераций.ВыпускПоОперацииСтоимость);
	СписокКодов.Добавить(КодыОпераций.ВозвратТарыОтКонтрагента);
	СписокКодов.Добавить(КодыОпераций.ВозвратМатериаловИзЭксплуатации);
	СписокКодов.Добавить(КодыОпераций.Оприходование);
	СписокКодов.Добавить(КодыОпераций.ВключениеАктиваВСоставМПЗ);
	СписокКодов.Добавить(КодыОпераций.ВключениеНДСВСтоимость);
	//начало изменений
	СписокКодов.Добавить(КодыОпераций.ПередачаТарыКонтрагенту);
	//конец  изменений
	//начало изменений 53363 формирование проводок при возрате тары по залоговой стоимости  
	СписокКодов.Добавить(КодыОпераций.ВозвратТарыЗалогСтоимость);
	//конец изменений 
		
	
	Если СтруктураДопПараметров.Свойство("КорректироватьКомплектыПродукции") тогда
		СписокКодов.Добавить(КодыОпераций.Комплектация);
		//начало изменений для расхода 
		//Если ДатаКон >= ПРГ_ДопФункцииКлиентСервер.ПолучитьДатуНовогоАлгоритмовВСтомости() Тогда
		Если ДатаКон >= '20140201' Тогда
			ИсклСписокКодов = Новый Массив;
			ИсклСписокКодов.Добавить(КодыОпераций.Комплектация);
			//конец изменений 
			ЗапросНачОстПлюсПриход.УстановитьПараметр("ИсклСписокКодов",ИсклСписокКодов );
		КонецЕсли;	
		Если ДатаКон < '20140301' Тогда
			Если Учет = "Бух" Тогда
				ЗапросНачОстПлюсПриход.УстановитьПараметр("СписоксчетовИскл",БухгалтерскийУчет.ПолучитьМассивСчетов("Хозрасчетный", "10,21"));
			ИначеЕсли Учет = "Нал" Тогда
				ЗапросНачОстПлюсПриход.УстановитьПараметр("СписоксчетовИскл",БухгалтерскийУчет.ПолучитьМассивСчетов("Налоговый", "10,21"));
			КонецЕсли;	
		КонецЕсли;	
	КонецЕсли;
	
	// Добавляем коды исключаемого расхода:
	
	// Вычитаем списание по возврату поставщику: оно не должно корректироваться
	//начало изменений Ожиганов 05.05.2015 изменения по браку 
	Если Не СтруктураДопПараметров.ПРГРассчВозвратПост Тогда
		СписокКодов.Добавить(КодыОпераций.ВозвратПоставщику);
	КонецЕсли;	
	//конец изменений 
	//СписокКодов.Добавить(КодыОпераций.ВозвратПоставщику);
	
	Если СтруктураДопПараметров.ВстречныйВыпуск Тогда
	
		// вычитаем встречный выпуск
		ЗапросНачОстПлюсПриход.Текст = СтрЗаменить(ЗапросНачОстПлюсПриход.Текст, "ПартииПриход.КодОперации В(&СписокКодов)",
			"(ПартииПриход.КодОперации В(&СписокКодов)
			|ИЛИ ( 1 В
			|	(ВЫБРАТЬ Первые 1
			|		1
			|	ИЗ
			|		РегистрСведений.КорректировкаВстречногоВыпускаПродукции КАК КорректировкаВстречногоВыпускаПродукции
			|	ГДЕ
			|		ПартииПриход.НомерСтрокиСписанныхТоваров = КорректировкаВстречногоВыпускаПродукции.НомерСтрокиСписанныхТоваров
			|		И ПартииПриход.Регистратор = КорректировкаВстречногоВыпускаПродукции.Документ			
			|		" + ДобавитьОтборПоВидуУчета("КорректировкаВстречногоВыпускаПродукции",Учет) + "
			|	Объединить
			|
			|	ВЫБРАТЬ Первые 1
			|		1
			|	ИЗ
			|		РегистрСведений.КорректировкаВстречногоВыпускаПродукции КАК КорректировкаВстречногоВыпускаПродукции
			|	ГДЕ
			|		ПартииПриход.НомерСтрокиСписанныхТоваров = КорректировкаВстречногоВыпускаПродукции.НомерСтрокиСписанныхТоваров
			|		И КорректировкаВстречногоВыпускаПродукции.ОтражатьВУправленческомУчете
			|		И ПартииПриход.ДокументДвижения = КорректировкаВстречногоВыпускаПродукции.Документ
			|		И ПартииПриход.Период = &Период
			//|		И ПартииПриход.КодОперации = &СписаниеПартийВПроизводствоОперативно
			//|		" + ДобавитьОтборПоВидуУчета("КорректировкаВстречногоВыпускаПродукции",Учет) + "
			|
			|)))");
		// В одной секунде может быть записано несколько документов "Расчет себестоимости"
		// Запись в регистр "КорректировкаВстречногоВыпускаПродукции" сделает только один документ
		Если Учет = "Бух" Тогда
			ЗапросНачОстПлюсПриход.Текст = СтрЗаменить(ЗапросНачОстПлюсПриход.Текст, 
										   "КорректировкаВстречногоВыпускаПродукции.ОтражатьВУправленческомУчете",
										   "КорректировкаВстречногоВыпускаПродукции.ОтражатьВБухгалтерскомУчете");
		ИначеЕсли Учет = "Нал" Тогда
			ЗапросНачОстПлюсПриход.Текст = СтрЗаменить(ЗапросНачОстПлюсПриход.Текст, 
										   "КорректировкаВстречногоВыпускаПродукции.ОтражатьВУправленческомУчете",
										   "КорректировкаВстречногоВыпускаПродукции.ОтражатьВНалоговомУчете");
		ИначеЕсли Учет = "Меж" Тогда
			ЗапросНачОстПлюсПриход.Текст = СтрЗаменить(ЗапросНачОстПлюсПриход.Текст, 
										   "КорректировкаВстречногоВыпускаПродукции.ОтражатьВУправленческомУчете",
										   "КорректировкаВстречногоВыпускаПродукции.ОтражатьВМеждународномУчете");
		КонецЕсли;
			
		ЗапросНачОстПлюсПриход.УстановитьПараметр("СписаниеПартийВПроизводствоОперативно",КодыОпераций.СписаниеПартийВПроизводствоОперативно);
		ЗапросНачОстПлюсПриход.УстановитьПараметр("Период",СтруктураДопПараметров.Период);
		
	КонецЕсли;
	
	ЗапросНачОстПлюсПриход.УстановитьПараметр("СписокКодов", СписокКодов);
	
	ТабПартий = ЗапросНачОстПлюсПриход.Выполнить().Выгрузить();
	ТабПартий.Колонки.Добавить("Найдена", Новый ОписаниеТипов("Булево"));
	
	Для Каждого Состояние Из Состояния Цикл
		
		// Это параметры (значения измерений, счетов, субконто и т.д.), которые имеет состояние
		ПараметрыСостояния = СоотвПараметровСостояний[Состояние.Ключ];
		
		Количество=0;
		СтруктураСумм = Новый Структура; // структура, хранящая суммы
		
		// Заполнение сумм
		Для Каждого ЭлементСумма Из МассивСумм Цикл
			СтруктураСумм.Вставить(ЭлементСумма, 0);
		КонецЦикла;
		
		// Тут должны определяться КолНачОст + КолПриход (внеш), СумНачОст + СумПриход(внеш) по данным из базы
		Парам=Новый Структура;
		Для Каждого Колонка Из ТабПартий.Колонки Цикл
			Если ПараметрыСостояния.Свойство(Колонка.Имя) Тогда
				
				// Не используем постоянные и временные разницы
				Если Колонка.Имя = "ПостояннаяРазница" 
					 ИЛИ Колонка.Имя = "ВременнаяРазница" тогда
					
					Продолжить;
				КонецЕсли;
				
				Парам.Вставить(Колонка.Имя, ПараметрыСостояния[Колонка.Имя]);
				
			КонецЕсли;
		КонецЦикла;
		
		// Не используем колонки со значениями ресурсов в состоянии (например, Стоимость)
		Для Каждого ЭлементСумма Из МассивСумм Цикл
			Если Парам.Свойство(ЭлементСумма) Тогда
				Парам.Удалить(ЭлементСумма);
			КонецЕсли;
		КонецЦикла;
		
		НайдСтроки=ТабПартий.НайтиСтроки(Парам);

		Для Каждого СтрокаПартии Из НайдСтроки Цикл
			Количество = Количество + СтрокаПартии.Количество;
			
			// Заполнение сумм
			Для Каждого ЭлементСумма Из МассивСумм Цикл
				СтруктураСумм.Вставить(ЭлементСумма, СтруктураСумм[ЭлементСумма] + СтрокаПартии[ЭлементСумма]);
			КонецЦикла;
			
			СтрокаПартии.Найдена = Истина;
		КонецЦикла;
		
		Состояние.Значение.Вставить("Количество", Количество);
		
		Состояние.Значение.Вставить("СтруктураСумм", СтруктураСумм);
	КонецЦикла;
	
	// Теперь добавим состояния не участвующие в перемещениях (обособленные вершины) - тем, 
	//по которым не было перемещений, чтобы по ним внешнее списание рассчиталось той же процедурой, что и для перемещений
	ИндСостояния = СоотвПараметровСостояний.Количество();
	Для Каждого СтрокаТаблицы Из ТабПартий Цикл
		Если НЕ СтрокаТаблицы.Найдена Тогда
			
			СтруктураСумм = Новый Структура; // структура, хранящая суммы
			
			Количество = СтрокаТаблицы.Количество;
			
			// Заполнение сумм
			Для Каждого ЭлементСумма Из МассивСумм Цикл
				СтруктураСумм.Вставить(ЭлементСумма, СтрокаТаблицы[ЭлементСумма]);
			КонецЦикла;
					   
			ИндСостояния=ИндСостояния+1;
			
			// Добавим состояние со всеми необходимыми параметрами
			Состояния.Вставить(ИндСостояния, 
			Новый Структура("КоличествоИсточников, КоличествоРассчитанныхВходов, Приемники, Количество, СтруктураСумм", 0, 0, Новый Соответствие, Количество, СтруктураСумм));
			
			Если Учет = "Упр" Тогда
				
				СоотвПараметровСостояний.Вставить(ИндСостояния, 
				Новый Структура("Номенклатура, ХарактеристикаНоменклатуры, СерияНоменклатуры, ДокументОприходования, СтатусПартии, Склад, Заказ, ДоговорКонтрагента, ДокументПередачи, СтатусПередачи, Качество, Организация, Подразделение, ФизЛицо, НазначениеИспользования", 
				СтрокаТаблицы.Номенклатура, 
				СтрокаТаблицы.ХарактеристикаНоменклатуры, 
				СтрокаТаблицы.СерияНоменклатуры, 
				СтрокаТаблицы.ДокументОприходования,
				СтрокаТаблицы.СтатусПартии,
				СтрокаТаблицы.Склад,
				СтрокаТаблицы.Заказ,
				СтрокаТаблицы.ДоговорКонтрагента,
				СтрокаТаблицы.ДокументПередачи,
				СтрокаТаблицы.СтатусПередачи,
				СтрокаТаблицы.Качество,
				СтрокаТаблицы.Организация,
				СтрокаТаблицы.Подразделение,
				СтрокаТаблицы.ФизЛицо,
				СтрокаТаблицы.НазначениеИспользования));
				
			ИначеЕсли Учет = "Меж" Тогда	
				
				//В международном учете стоимость спецодежды не корректируется
				
				СоотвПараметровСостояний.Вставить(ИндСостояния, 
				Новый Структура("Номенклатура, ХарактеристикаНоменклатуры, СерияНоменклатуры, ДокументОприходования, СчетУчета, Организация, Склад, Заказ, ДоговорКонтрагента, ДокументПередачи, Качество", 
				СтрокаТаблицы.Номенклатура, 
				СтрокаТаблицы.ХарактеристикаНоменклатуры, 
				СтрокаТаблицы.СерияНоменклатуры, 
				СтрокаТаблицы.ДокументОприходования,
				СтрокаТаблицы.СчетУчета,
				СтрокаТаблицы.Организация,
				СтрокаТаблицы.Склад,
				СтрокаТаблицы.Заказ,
				СтрокаТаблицы.ДоговорКонтрагента,
				СтрокаТаблицы.ДокументПередачи,
				СтрокаТаблицы.Качество));
				
			Иначе
				//Если 
				//Учет = "Бух" 
				//ИЛИ 
				//Учет = "Нал" 
				//ИЛИ 
				//Учет = "Меж" 
				//Тогда
				
				СоотвПараметровСостояний.Вставить(ИндСостояния, 
				Новый Структура("Номенклатура, ХарактеристикаНоменклатуры, СерияНоменклатуры, ДокументОприходования, СчетУчета, Организация, Склад, Заказ, ДоговорКонтрагента, ДокументПередачи, Качество, Подразделение, ФизЛицо, НазначениеИспользования", 
				СтрокаТаблицы.Номенклатура, 
				СтрокаТаблицы.ХарактеристикаНоменклатуры, 
				СтрокаТаблицы.СерияНоменклатуры, 
				СтрокаТаблицы.ДокументОприходования,
				СтрокаТаблицы.СчетУчета,
				СтрокаТаблицы.Организация,
				СтрокаТаблицы.Склад,
				СтрокаТаблицы.Заказ,
				СтрокаТаблицы.ДоговорКонтрагента,
				СтрокаТаблицы.ДокументПередачи,
				СтрокаТаблицы.Качество,
				СтрокаТаблицы.Подразделение,
				СтрокаТаблицы.ФизЛицо,
				СтрокаТаблицы.НазначениеИспользования));
			КонецЕсли;
			
			МассивДобавляемыхВершин.Добавить(ИндСостояния);
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры // ДобавитьНачальныйОстатокИВнешнееПоступление()

// Заполняет текст запроса, выбирающего остаток и поступление по упр учету
//
// Параметры:
//	Нет.
//
Процедура ЗаполнитьЗапросНачОстПлюсПриходУпр(ЗапросНачОстПлюсПриход)
	
	Текст = 
	// Партии на складах
	"ВЫБРАТЬ
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.СерияНоменклатуры,
	|	ОстПлюсПрих.ДокументОприходования,
	|	ОстПлюсПрих.Склад,
	|	ОстПлюсПрих.Заказ,
	|	ОстПлюсПрих.Качество,
	|	NULL КАК ДоговорКонтрагента,
	|	NULL КАК ДокументПередачи,
	|	ОстПлюсПрих.СтатусПартии,
	|	NULL КАК СтатусПередачи,
	|	СУММА(ОстПлюсПрих.Количество) КАК Количество,
	|	СУММА(ОстПлюсПрих.Стоимость) КАК Стоимость,
	|	ОстПлюсПрих.Организация,
	|	NULL КАК Подразделение,
	|	NULL КАК ФизЛицо,
	|	NULL КАК НазначениеИспользования
	|ИЗ
	|	(ВЫБРАТЬ
	|		ПартииОстатки.Номенклатура КАК Номенклатура,
	|		ПартииОстатки.Склад КАК Склад,
	|		ПартииОстатки.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|		ПартииОстатки.СерияНоменклатуры КАК СерияНоменклатуры,
	|		ПартииОстатки.ДокументОприходования КАК ДокументОприходования,
	|		ПартииОстатки.Заказ КАК Заказ,
	|		ПартииОстатки.Качество КАК Качество,
	|		ПартииОстатки.СтатусПартии КАК СтатусПартии,
	|		ПартииОстатки.КоличествоОстаток КАК Количество,
	|		ПартииОстатки.СтоимостьОстаток КАК Стоимость,
	|		ПартииОстатки.Организация КАК Организация
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровНаСкладах.Остатки(&ДатаНач, Номенклатура В (&МассивНоменклатуры)) КАК ПартииОстатки
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ПартииПриход.Номенклатура,
	|		ПартииПриход.Склад,
	|		ПартииПриход.ХарактеристикаНоменклатуры,
	|		ПартииПриход.СерияНоменклатуры,
	|		ПартииПриход.ДокументОприходования,
	|		ПартииПриход.Заказ,
	|		ПартииПриход.Качество,
	|		ПартииПриход.СтатусПартии,
	|		ВЫБОР
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПриход.Количество
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПриход.Количество
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПриход.Стоимость
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПриход.Стоимость
	|		КОНЕЦ,
	|		ПартииПриход.Организация
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровНаСкладах КАК ПартииПриход
	|	ГДЕ
	|		ПартииПриход.Номенклатура В(&МассивНоменклатуры)
	|		И ПартииПриход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|		И ПартииПриход.КодОперации В(&СписокКодов)
	|		И ПартииПриход.Активность = ИСТИНА) КАК ОстПлюсПрих
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.Склад,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.СерияНоменклатуры,
	|	ОстПлюсПрих.ДокументОприходования,
	|	ОстПлюсПрих.Заказ,
	|	ОстПлюсПрих.Качество,
	|	ОстПлюсПрих.СтатусПартии,
	|	ОстПлюсПрих.Организация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	NULL,
	|	ОстПлюсПрих.ДокументОприходования,
	|	NULL,
	|	NULL,
	|	NULL,
	|	ОстПлюсПрих.ДоговорКонтрагента,
	|	ОстПлюсПрих.ДокументПередачи,
	|	ОстПлюсПрих.СтатусПартии,
	|	ОстПлюсПрих.СтатусПередачи,
	|	СУММА(ОстПлюсПрих.Количество),
	|	СУММА(ОстПлюсПрих.Стоимость),
	|	ОстПлюсПрих.Организация,
	|	NULL КАК Подразделение,
	|	NULL КАК ФизЛицо,
	|	NULL КАК НазначениеИспользования
	|ИЗ
	|	(ВЫБРАТЬ
	|		ПартииПередОстатки.Номенклатура КАК Номенклатура,
	|		ПартииПередОстатки.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|		ПартииПередОстатки.ДокументОприходования КАК ДокументОприходования,
	|		ПартииПередОстатки.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|		ПартииПередОстатки.ДокументПередачи КАК ДокументПередачи,
	|		ПартииПередОстатки.КоличествоОстаток КАК Количество,
	|		ПартииПередОстатки.СтоимостьОстаток КАК Стоимость,
	|		ПартииПередОстатки.СтатусПартии КАК СтатусПартии,
	|		ПартииПередОстатки.СтатусПередачи КАК СтатусПередачи,
	|		ПартииПередОстатки.Организация КАК Организация
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровПереданные.Остатки(&ДатаНач, Номенклатура В (&МассивНоменклатуры)) КАК ПартииПередОстатки
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ПартииПередПриход.Номенклатура,
	|		ПартииПередПриход.ХарактеристикаНоменклатуры,
	|		ПартииПередПриход.ДокументОприходования,
	|		ПартииПередПриход.ДоговорКонтрагента,
	|		ПартииПередПриход.ДокументПередачи,
	|		ВЫБОР
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПередПриход.Количество
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПередПриход.Количество
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПередПриход.Стоимость
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПередПриход.Стоимость
	|		КОНЕЦ,
	|		ПартииПередПриход.СтатусПартии,
	|		ПартииПередПриход.СтатусПередачи,
	|		ПартииПередПриход.Организация
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровПереданные КАК ПартииПередПриход
	|	ГДЕ
	|		ПартииПередПриход.Номенклатура В(&МассивНоменклатуры)
	|		И ПартииПередПриход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|		И ПартииПередПриход.КодОперации В(&СписокКодов)
	|		И ПартииПередПриход.Активность = ИСТИНА) КАК ОстПлюсПрих
	|СГРУППИРОВАТЬ ПО
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ДокументОприходования,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.ДоговорКонтрагента,
	|	ОстПлюсПрих.ДокументПередачи,
	|	ОстПлюсПрих.СтатусПартии,
	|	ОстПлюсПрих.СтатусПередачи,
	|	ОстПлюсПрих.Организация	
	//Партии материалов в эксплуатации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.СерияНоменклатуры,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	ОстПлюсПрих.ДокументПередачи,
	|	NULL,
	|	NULL,
	|	СУММА(ОстПлюсПрих.Количество),
	|	СУММА(ОстПлюсПрих.Стоимость),
	|	NULL,
	|	ОстПлюсПрих.Подразделение,
	|	ОстПлюсПрих.ФизЛицо,
	|	ОстПлюсПрих.НазначениеИспользования
	|ИЗ
	|	(ВЫБРАТЬ
	|		ПартииВЭксплуатацииОстатки.Номенклатура КАК Номенклатура,
	|		ПартииВЭксплуатацииОстатки.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|		ПартииВЭксплуатацииОстатки.СерияНоменклатуры КАК СерияНоменклатуры,
	|		ПартииВЭксплуатацииОстатки.ДокументПередачи КАК ДокументПередачи,
	|		ПартииВЭксплуатацииОстатки.ФизЛицо КАК ФизЛицо,
	|		ПартииВЭксплуатацииОстатки.КоличествоОстаток КАК Количество,
	|		ПартииВЭксплуатацииОстатки.СтоимостьОстаток КАК Стоимость,
	|		ПартииВЭксплуатацииОстатки.НазначениеИспользования КАК НазначениеИспользования,
	|		ПартииВЭксплуатацииОстатки.Подразделение КАК Подразделение
	|	ИЗ
	|		РегистрНакопления.ПартииМатериаловВЭксплуатации.Остатки(&ДатаНач, Номенклатура в (&МассивНоменклатуры)) КАК ПартииВЭксплуатацииОстатки
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ПартииВЭксплуатацииПриход.Номенклатура,
	|		ПартииВЭксплуатацииПриход.ХарактеристикаНоменклатуры,
	|		ПартииВЭксплуатацииПриход.СерияНоменклатуры,
	|		ПартииВЭксплуатацииПриход.ДокументПередачи,
	|		ПартииВЭксплуатацииПриход.ФизЛицо,
	|		ВЫБОР
	|			КОГДА ПартииВЭксплуатацииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииВЭксплуатацииПриход.Количество
	|			КОГДА ПартииВЭксплуатацииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииВЭксплуатацииПриход.Количество
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ПартииВЭксплуатацииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииВЭксплуатацииПриход.Стоимость
	|			КОГДА ПартииВЭксплуатацииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииВЭксплуатацииПриход.Стоимость
	|		КОНЕЦ,
	|		ПартииВЭксплуатацииПриход.НазначениеИспользования,
	|		ПартииВЭксплуатацииПриход.Подразделение
	|	ИЗ
	|		РегистрНакопления.ПартииМатериаловВЭксплуатации КАК ПартииВЭксплуатацииПриход
	|	ГДЕ
	|		ПартииВЭксплуатацииПриход.Номенклатура В(&МассивНоменклатуры)
	|		И ПартииВЭксплуатацииПриход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|		И ПартииВЭксплуатацииПриход.КодОперации В(&СписокКодов)
	|		И ПартииВЭксплуатацииПриход.Активность = ИСТИНА) КАК ОстПлюсПрих
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.СерияНоменклатуры,
	|	ОстПлюсПрих.ДокументПередачи,
	|	ОстПлюсПрих.Подразделение,
	|	ОстПлюсПрих.ФизЛицо,
	|	ОстПлюсПрих.НазначениеИспользования";
	
	ЗапросНачОстПлюсПриход.Текст = Текст;
	
КонецПроцедуры // ЗаполнитьЗапросНачОстПлюсПриходУпр()

// Заполняет текст запроса, выбирающего остаток и поступление по бух учету
//
// Параметры:
//	ЗапросНачОстПлюсПриход - Запрос
//
Процедура ЗаполнитьЗапросНачОстПлюсПриходБух(ЗапросНачОстПлюсПриход,СтруктураДопПараметров)
	
	Текст = 
	// Партии на складах
	"
	//начало изменений
	|//@ИсклКомпл   ВЫБРАТЬ
	|//@ИсклКомпл   	Приход.Регистратор КАК Регистратор,
	|//@ИсклКомпл   	Приход.НомерСтроки КАК НомерСтроки
	|//@ИсклКомпл   ПОМЕСТИТЬ ТаблИсклКомпл
	|//@ИсклКомпл   ИЗ
	|//@ИсклКомпл   	РегистрНакопления.ПартииТоваровНаСкладахБухгалтерскийУчет КАК Расход
	|//@ИсклКомпл   		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладахБухгалтерскийУчет КАК Приход
	|//@ИсклКомпл   		ПО Расход.Регистратор = Приход.Регистратор
	//начало изменений Ожиганов 20.10.2015 изменении качества при комплектации, учтем как перемещение 
	|//@ИсклКомпл   			И Расход.Номенклатура = Приход.Номенклатура"+
	?(Не СтруктураДопПараметров.ПРГ_УчитыватьКомплКакПеремИзмКачества,"
	|//@ИсклКомпл   			И Расход.СчетУчета = Приход.СчетУчета
	|//@ИсклКомпл   			И Расход.Склад = Приход.Склад
	|//@ИсклКомпл   			И Расход.ДокументОприходования = Приход.ДокументОприходования
	|//@ИсклКомпл   			И Расход.ХарактеристикаНоменклатуры = Приход.ХарактеристикаНоменклатуры
	|//@ИсклКомпл   			И Расход.СерияНоменклатуры = Приход.СерияНоменклатуры
	|//@ИсклКомпл   			И Расход.Качество = Приход.Качество	
	|//@ИсклКомпл   			И Расход.Количество = Приход.Количество"
	,"")+"
	//конец изменений 
	//начало изменений Ожиганов 21.10.2015 изменении качества при комплектации, учтем как перемещение 
	//|//@ИсклКомпл   			И Расход.Количество = Приход.Количество
	//конец изменений 
	|//@ИсклКомпл   			И (Расход.КодОперации = &_КодОперацииКоплектации)
	|//@ИсклКомпл   			И (Расход.КодОперации = &_КодОперацииКоплектации)
	|//@ИсклКомпл   			И Расход.Организация = Приход.Организация
	|//@ИсклКомпл   			И Расход.НомерКорСтроки = Приход.НомерСтроки
	|//@ИсклКомпл   			И (Расход.Активность)
	|//@ИсклКомпл   			И (Приход.Активность)
	|//@ИсклКомпл   ГДЕ
	|//@ИсклКомпл   	Расход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|//@ИсклКомпл   	И Приход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|//@ИсклКомпл       И  Расход.Номенклатура //@ИсклКомпл В (&МассивНоменклатуры)
	|//@ИсклКомпл   ИНДЕКСИРОВАТЬ ПО
	|//@ИсклКомпл   	Регистратор,
	|//@ИсклКомпл   	НомерСтроки
	|//@ИсклКомпл   ;
	//конец изменений
	|ВЫБРАТЬ
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.СерияНоменклатуры,
	|	ОстПлюсПрих.ДокументОприходования,
	|	ОстПлюсПрих.Склад,
	|	ОстПлюсПрих.Заказ,
	|	ОстПлюсПрих.Качество,
	|	NULL КАК ДоговорКонтрагента,
	|	NULL КАК ДокументПередачи,
	|	СУММА(ОстПлюсПрих.Количество) КАК Количество,
	|	СУММА(ОстПлюсПрих.Стоимость) КАК Стоимость,
	|	ОстПлюсПрих.СчетУчета,
	|	ОстПлюсПрих.Организация,
	|	NULL КАК Подразделение,
	|	NULL КАК ФизЛицо,
	|	NULL КАК НазначениеИспользования
	|ИЗ
	|	(ВЫБРАТЬ
	|		ПартииОстатки.Номенклатура КАК Номенклатура,
	|		ПартииОстатки.Склад КАК Склад,
	|		ПартииОстатки.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|		ПартииОстатки.СерияНоменклатуры КАК СерияНоменклатуры,
	|		ПартииОстатки.ДокументОприходования КАК ДокументОприходования,
	|		ПартииОстатки.Заказ КАК Заказ,
	|		ПартииОстатки.Качество КАК Качество,
	|		ПартииОстатки.КоличествоОстаток КАК Количество,
	|		ПартииОстатки.СтоимостьОстаток КАК Стоимость,
	|		ПартииОстатки.СчетУчета КАК СчетУчета,
	|		ПартииОстатки.Организация КАК Организация
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровНаСкладахБухгалтерскийУчет.Остатки(&ДатаНач, Номенклатура В (&МассивНоменклатуры)) КАК ПартииОстатки
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ПартииПриход.Номенклатура,
	|		ПартииПриход.Склад,
	|		ПартииПриход.ХарактеристикаНоменклатуры,
	|		ПартииПриход.СерияНоменклатуры,
	|		ПартииПриход.ДокументОприходования,
	|		ПартииПриход.Заказ,
	|		ПартииПриход.Качество,
	|		ВЫБОР
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПриход.Количество
	//начало изменений
	|           Когда ПартииПриход.ВидДвижения = &ВидДвиженияРасход и ПартииПриход.КодОперации В(&ИсклСписокКодов) и Не (ПартииПриход.СчетУчета в (&СписоксчетовИскл))  Тогда
	|					0
	//конец изменений						
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПриход.Количество
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПриход.Стоимость
	//начало изменений  
	|           Когда ПартииПриход.ВидДвижения = &ВидДвиженияРасход и ПартииПриход.КодОперации В(&ИсклСписокКодов)  и Не (ПартииПриход.СчетУчета в (&СписоксчетовИскл)) Тогда
	|				0
	//конец изменений 
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПриход.Стоимость
	|		КОНЕЦ,
	|		ПартииПриход.СчетУчета,
	|		ПартииПриход.Организация
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровНаСкладахБухгалтерскийУчет КАК ПартииПриход
	|	ГДЕ
	//начало изменений 
	|		ПартииПриход.Номенклатура В (&МассивНоменклатуры)
	|		И ПартииПриход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|		И ПартииПриход.КодОперации В(&СписокКодов)
	|		И ПартииПриход.Активность = ИСТИНА
	|//@ИсклКомпл	И НЕ ( 1 В
	|//@ИсклКомпл			(ВЫБРАТЬ Первые 1
	|//@ИсклКомпл		1
	|//@ИсклКомпл	ИЗ
	|//@ИсклКомпл	ТаблИсклКомпл КАК ТаблИсклКомпл	
	|//@ИсклКомпл	Где	
	|//@ИсклКомпл	ТаблИсклКомпл.Регистратор =ПартииПриход.Регистратор
	|//@ИсклКомпл	И ТаблИсклКомпл.НомерСтроки =ПартииПриход.НомерСтроки))
	|	
	|) КАК ОстПлюсПрих
	//конец изменений
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.Склад,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.СерияНоменклатуры,
	|	ОстПлюсПрих.ДокументОприходования,
	|	ОстПлюсПрих.Заказ,
	|	ОстПлюсПрих.Качество,
	|	ОстПлюсПрих.СчетУчета,
	|	ОстПлюсПрих.Организация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	NULL,
	|	ОстПлюсПрих.ДокументОприходования,
	|	NULL,
	|	NULL,
	|	NULL,
	|	ОстПлюсПрих.ДоговорКонтрагента,
	|	ОстПлюсПрих.ДокументПередачи,
	|	СУММА(ОстПлюсПрих.Количество),
	|	СУММА(ОстПлюсПрих.Стоимость),
	|	ОстПлюсПрих.СчетУчета,
	|	ОстПлюсПрих.Организация,
	|	NULL КАК Подразделение,
	|	NULL КАК ФизЛицо,
	|	NULL КАК НазначениеИспользования
	|ИЗ
	|	(ВЫБРАТЬ
	|		ПартииПередОстатки.Номенклатура КАК Номенклатура,
	|		ПартииПередОстатки.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|		ПартииПередОстатки.ДокументОприходования КАК ДокументОприходования,
	|		ПартииПередОстатки.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|		ПартииПередОстатки.ДокументПередачи КАК ДокументПередачи,
	|		ПартииПередОстатки.КоличествоОстаток КАК Количество,
	|		ПартииПередОстатки.СтоимостьОстаток КАК Стоимость,
	|		ПартииПередОстатки.СчетУчета КАК СчетУчета,
	|		ПартииПередОстатки.Организация КАК Организация
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровПереданныеБухгалтерскийУчет.Остатки(&ДатаНач, Номенклатура В (&МассивНоменклатуры)) КАК ПартииПередОстатки
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ПартииПередПриход.Номенклатура,
	|		ПартииПередПриход.ХарактеристикаНоменклатуры,
	|		ПартииПередПриход.ДокументОприходования,
	|		ПартииПередПриход.ДоговорКонтрагента,
	|		ПартииПередПриход.ДокументПередачи,
	|		ВЫБОР
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПередПриход.Количество
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПередПриход.Количество
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПередПриход.Стоимость
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПередПриход.Стоимость
	|		КОНЕЦ,
	|		ПартииПередПриход.СчетУчета,
	|		ПартииПередПриход.Организация
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровПереданныеБухгалтерскийУчет КАК ПартииПередПриход
	|	ГДЕ
	//начало изменений 
	|		ПартииПередПриход.Номенклатура В (&МассивНоменклатуры)
	//конец изменений 
	|		И ПартииПередПриход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|		И ПартииПередПриход.КодОперации В(&СписокКодов)
	|		И ПартииПередПриход.Активность = ИСТИНА) КАК ОстПлюсПрих
	|СГРУППИРОВАТЬ ПО
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.ДокументОприходования,
	|	ОстПлюсПрих.ДокументПередачи,
	|	ОстПлюсПрих.ДоговорКонтрагента,
	|	ОстПлюсПрих.СчетУчета,
	|	ОстПлюсПрих.Организация
	|
	//Партии материалов в эксплуатации
	|ОБЪЕДИНИТЬ ВСЕ
	|ВЫБРАТЬ
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.СерияНоменклатуры,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL КАК ДоговорКонтрагента,
	|	ОстПлюсПрих.ДокументПередачи КАК ДокументПередачи,
	|	СУММА(ОстПлюсПрих.Количество) КАК Количество,
	|	СУММА(ОстПлюсПрих.Стоимость) КАК Стоимость,
	|	ОстПлюсПрих.СчетУчета,
	|	ОстПлюсПрих.Организация,
	|	ОстПлюсПрих.Подразделение КАК Подразделение,
	|	ОстПлюсПрих.ФизЛицо КАК ФизЛицо,
	|	ОстПлюсПрих.НазначениеИспользования КАК НазначениеИспользования
	|ИЗ
	|	(ВЫБРАТЬ
	|		ПартииОстатки.Номенклатура КАК Номенклатура,
	|		ПартииОстатки.Подразделение КАК Подразделение,
	|		ПартииОстатки.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|		ПартииОстатки.СерияНоменклатуры КАК СерияНоменклатуры,
	|		ПартииОстатки.ДокументПередачи КАК ДокументПередачи,
	|		ПартииОстатки.ФизЛицо КАК ФизЛицо,
	|		ПартииОстатки.НазначениеИспользования КАК НазначениеИспользования,
	|		ПартииОстатки.КоличествоОстаток КАК Количество,
	|		ПартииОстатки.СтоимостьОстаток КАК Стоимость,
	|		ПартииОстатки.СчетУчета КАК СчетУчета,
	|		ПартииОстатки.Организация КАК Организация
	|	ИЗ
	|		РегистрНакопления.ПартииМатериаловВЭксплуатацииБухгалтерскийУчет.Остатки(&ДатаНач, Номенклатура В (&МассивНоменклатуры)) КАК ПартииОстатки
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ПартииПриход.Номенклатура,
	|		ПартииПриход.Подразделение,
	|		ПартииПриход.ХарактеристикаНоменклатуры,
	|		ПартииПриход.СерияНоменклатуры,
	|		ПартииПриход.ДокументПередачи,
	|		ПартииПриход.ФизЛицо,
	|		ПартииПриход.НазначениеИспользования,
	|		ВЫБОР
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПриход.Количество
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПриход.Количество
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПриход.Стоимость
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПриход.Стоимость
	|		КОНЕЦ,
	|		ПартииПриход.СчетУчета,
	|		ПартииПриход.Организация
	|	ИЗ
	|		РегистрНакопления.ПартииМатериаловВЭксплуатацииБухгалтерскийУчет КАК ПартииПриход
	|	ГДЕ
	|		ПартииПриход.Номенклатура В(&МассивНоменклатуры)
	|		И ПартииПриход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|		И ПартииПриход.КодОперации В(&СписокКодов)
	|		И ПартииПриход.Активность = ИСТИНА) КАК ОстПлюсПрих
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ДокументПередачи,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.СерияНоменклатуры,
	|	ОстПлюсПрих.Подразделение,
	|	ОстПлюсПрих.ФизЛицо,
	|	ОстПлюсПрих.НазначениеИспользования,
	|	ОстПлюсПрих.СчетУчета,
	|	ОстПлюсПрих.Организация";
	
	ЗапросНачОстПлюсПриход.Текст = Текст;
	
КонецПроцедуры // ЗаполнитьЗапросНачОстПлюсПриходБух()

// Заполняет текст запроса, выбирающего остаток и поступление по упр учету
//
// Параметры:
//	Нет.
//
Процедура ЗаполнитьЗапросНачОстПлюсПриходНал(ЗапросНачОстПлюсПриход,СтруктураДопПараметров)
	
	Текст = 
	// Партии на складах
	"
	//начало изменений
	|//@ИсклКомпл   ВЫБРАТЬ
	|//@ИсклКомпл   	Приход.Регистратор КАК Регистратор,
	|//@ИсклКомпл   	Приход.НомерСтроки КАК НомерСтроки
	|//@ИсклКомпл   ПОМЕСТИТЬ ТаблИсклКомпл
	|//@ИсклКомпл   ИЗ
	|//@ИсклКомпл   	РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК Расход
	|//@ИсклКомпл   		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК Приход
	|//@ИсклКомпл   		ПО Расход.Регистратор = Приход.Регистратор
	//начало изменений Ожиганов 20.10.2015 изменении качества при комплектации, учтем как перемещение 
	|//@ИсклКомпл   			И Расход.Номенклатура = Приход.Номенклатура"+
	?(Не СтруктураДопПараметров.ПРГ_УчитыватьКомплКакПеремИзмКачества,"
	|//@ИсклКомпл   			И Расход.СчетУчета = Приход.СчетУчета
	|//@ИсклКомпл   			И Расход.Склад = Приход.Склад
	|//@ИсклКомпл   			И Расход.ДокументОприходования = Приход.ДокументОприходования
	|//@ИсклКомпл   			И Расход.ХарактеристикаНоменклатуры = Приход.ХарактеристикаНоменклатуры
	|//@ИсклКомпл   			И Расход.СерияНоменклатуры = Приход.СерияНоменклатуры
	|//@ИсклКомпл   			И Расход.Качество = Приход.Качество
	|//@ИсклКомпл   			И Расход.Количество = Приход.Количество"
	,"")+"
	//конец изменений 
	//начало изменений Ожиганов 21.10.2015 изменении качества при комплектации, учтем как перемещение 
	//|//@ИсклКомпл   			И Расход.Количество = Приход.Количество
	//конец изменений 
	|//@ИсклКомпл   			И (Расход.КодОперации = &_КодОперацииКоплектации)
	|//@ИсклКомпл   			И (Расход.КодОперации = &_КодОперацииКоплектации)
	|//@ИсклКомпл   			И Расход.Организация = Приход.Организация
	|//@ИсклКомпл   			И Расход.НомерКорСтроки = Приход.НомерСтроки
	|//@ИсклКомпл   			И (Расход.Активность)
	|//@ИсклКомпл   			И (Приход.Активность)
	|//@ИсклКомпл   ГДЕ
	|//@ИсклКомпл   	Расход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|//@ИсклКомпл   	И Приход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|//@ИсклКомпл   	И  Расход.Номенклатура //@ИсклКомпл В (&МассивНоменклатуры)
	|//@ИсклКомпл   ИНДЕКСИРОВАТЬ ПО
	|//@ИсклКомпл   	Регистратор,
	|//@ИсклКомпл   	НомерСтроки
	|//@ИсклКомпл   ;
	|ВЫБРАТЬ
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.СерияНоменклатуры,
	|	ОстПлюсПрих.ДокументОприходования,
	|	ОстПлюсПрих.Склад,
	|	ОстПлюсПрих.Заказ,
	|	ОстПлюсПрих.Качество,
	|	NULL КАК ДоговорКонтрагента,
	|	NULL КАК ДокументПередачи,
	|	ОстПлюсПрих.СчетУчета,
	|	ОстПлюсПрих.Организация,
	|	СУММА(ОстПлюсПрих.Количество) КАК Количество,
	|	СУММА(ОстПлюсПрих.Стоимость) КАК Стоимость,
	|	СУММА(ОстПлюсПрих.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(ОстПлюсПрих.ВременнаяРазница) КАК ВременнаяРазница,
	|	NULL КАК Подразделение,
	|	NULL КАК ФизЛицо,
	|	NULL КАК НазначениеИспользования
	|ИЗ
	|	(ВЫБРАТЬ
	|		ПартииОстатки.Номенклатура КАК Номенклатура,
	|		ПартииОстатки.Склад КАК Склад,
	|		ПартииОстатки.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|		ПартииОстатки.СерияНоменклатуры КАК СерияНоменклатуры,
	|		ПартииОстатки.ДокументОприходования КАК ДокументОприходования,
	|		ПартииОстатки.Заказ КАК Заказ,
	|		ПартииОстатки.Качество КАК Качество,
	|		ПартииОстатки.КоличествоОстаток КАК Количество,
	|		ПартииОстатки.СтоимостьОстаток КАК Стоимость,
	|		ПартииОстатки.СчетУчета КАК СчетУчета,
	|		ПартииОстатки.Организация КАК Организация,
	|		ПартииОстатки.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
	|		ПартииОстатки.ВременнаяРазницаОстаток КАК ВременнаяРазница
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет.Остатки(&ДатаНач, Номенклатура В (&МассивНоменклатуры)) КАК ПартииОстатки
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ПартииПриход.Номенклатура,
	|		ПартииПриход.Склад,
	|		ПартииПриход.ХарактеристикаНоменклатуры,
	|		ПартииПриход.СерияНоменклатуры,
	|		ПартииПриход.ДокументОприходования,
	|		ПартииПриход.Заказ,
	|		ПартииПриход.Качество,
	|		ВЫБОР
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПриход.Количество
	//начало изменений	
	|	        Когда ПартииПриход.ВидДвижения = &ВидДвиженияРасход и ПартииПриход.КодОперации В(&ИсклСписокКодов)  и Не (ПартииПриход.СчетУчета в (&СписоксчетовИскл)) Тогда	
	|                0
	//конец изменений 			
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПриход.Количество
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПриход.Стоимость
	//начало изменений	
	|	        Когда ПартииПриход.ВидДвижения = &ВидДвиженияРасход и ПартииПриход.КодОперации В(&ИсклСписокКодов)  и Не (ПартииПриход.СчетУчета в (&СписоксчетовИскл)) Тогда	
	|                0
	//конец изменений 			
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПриход.Стоимость
	|		КОНЕЦ,
	|		ПартииПриход.СчетУчета,
	|		ПартииПриход.Организация,
	|		ВЫБОР
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПриход.ПостояннаяРазница
	//начало изменений	
	|	        Когда ПартииПриход.ВидДвижения = &ВидДвиженияРасход и ПартииПриход.КодОперации В(&ИсклСписокКодов)  и Не (ПартииПриход.СчетУчета в (&СписоксчетовИскл)) Тогда	
	|                0
	//конец изменений 			
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПриход.ПостояннаяРазница
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПриход.ВременнаяРазница
	//начало изменений	
	|	        Когда ПартииПриход.ВидДвижения = &ВидДвиженияРасход и ПартииПриход.КодОперации В(&ИсклСписокКодов)  и Не (ПартииПриход.СчетУчета в (&СписоксчетовИскл)) Тогда	
	|                0
	//конец изменений 			
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПриход.ВременнаяРазница
	|		КОНЕЦ
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК ПартииПриход
	|	ГДЕ
	|		ПартииПриход.Номенклатура В(&МассивНоменклатуры)
	|		И ПартииПриход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|		И ПартииПриход.КодОперации В(&СписокКодов)
	|//@ИсклКомпл	И НЕ ( 1 В
	|//@ИсклКомпл			(ВЫБРАТЬ Первые 1
	|//@ИсклКомпл		1
	|//@ИсклКомпл	ИЗ
	|//@ИсклКомпл	ТаблИсклКомпл КАК ТаблИсклКомпл	
	|//@ИсклКомпл	Где	
	|//@ИсклКомпл	ТаблИсклКомпл.Регистратор =ПартииПриход.Регистратор
	|//@ИсклКомпл	И ТаблИсклКомпл.НомерСтроки =ПартииПриход.НомерСтроки))
	|		И ПартииПриход.Активность = ИСТИНА) КАК ОстПлюсПрих
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.Склад,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.СерияНоменклатуры,
	|	ОстПлюсПрих.ДокументОприходования,
	|	ОстПлюсПрих.Заказ,
	|	ОстПлюсПрих.Качество,
	|	ОстПлюсПрих.СчетУчета,
	|	ОстПлюсПрих.Организация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	NULL,
	|	ОстПлюсПрих.ДокументОприходования,
	|	NULL,
	|	NULL,
	|	NULL,
	|	ОстПлюсПрих.ДоговорКонтрагента,
	|	ОстПлюсПрих.ДокументПередачи,
	|	ОстПлюсПрих.СчетУчета,
	|	ОстПлюсПрих.Организация,
	|	СУММА(ОстПлюсПрих.Количество),
	|	СУММА(ОстПлюсПрих.Стоимость),
	|	СУММА(ОстПлюсПрих.ПостояннаяРазница),
	|	СУММА(ОстПлюсПрих.ВременнаяРазница),
	|	NULL КАК Подразделение,
	|	NULL КАК ФизЛицо,
	|	NULL КАК НазначениеИспользования
	|ИЗ
	|	(ВЫБРАТЬ
	|		ПартииПередОстатки.Номенклатура КАК Номенклатура,
	|		ПартииПередОстатки.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|		ПартииПередОстатки.ДокументОприходования КАК ДокументОприходования,
	|		ПартииПередОстатки.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|		ПартииПередОстатки.ДокументПередачи КАК ДокументПередачи,
	|		ПартииПередОстатки.КоличествоОстаток КАК Количество,
	|		ПартииПередОстатки.СтоимостьОстаток КАК Стоимость,
	|		ПартииПередОстатки.СчетУчета КАК СчетУчета,
	|		ПартииПередОстатки.Организация КАК Организация,
	|		ПартииПередОстатки.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
	|		ПартииПередОстатки.ВременнаяРазницаОстаток КАК ВременнаяРазница
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровПереданныеНалоговыйУчет.Остатки(&ДатаНач, Номенклатура В (&МассивНоменклатуры)) КАК ПартииПередОстатки
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ПартииПередПриход.Номенклатура,
	|		ПартииПередПриход.ХарактеристикаНоменклатуры,
	|		ПартииПередПриход.ДокументОприходования,
	|		ПартииПередПриход.ДоговорКонтрагента,
	|		ПартииПередПриход.ДокументПередачи,
	|		ВЫБОР
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПередПриход.Количество
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПередПриход.Количество
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПередПриход.Стоимость
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПередПриход.Стоимость
	|		КОНЕЦ,
	|		ПартииПередПриход.СчетУчета,
	|		ПартииПередПриход.Организация,
	|		ВЫБОР
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПередПриход.ПостояннаяРазница
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПередПриход.ПостояннаяРазница
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПередПриход.ВременнаяРазница
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПередПриход.ВременнаяРазница
	|		КОНЕЦ
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровПереданныеНалоговыйУчет КАК ПартииПередПриход
	|	ГДЕ
	|		ПартииПередПриход.Номенклатура В(&МассивНоменклатуры)
	|		И ПартииПередПриход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|		И ПартииПередПриход.КодОперации В(&СписокКодов)
	|		И ПартииПередПриход.Активность = ИСТИНА) КАК ОстПлюсПрих
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.ДокументОприходования,
	|	ОстПлюсПрих.ДокументПередачи,
	|	ОстПлюсПрих.ДоговорКонтрагента,
	|	ОстПлюсПрих.СчетУчета,
	|	ОстПлюсПрих.Организация
//Партии материалов в эксплуатации	
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.СерияНоменклатуры,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL КАК ДоговорКонтрагента,
	|	ОстПлюсПрих.ДокументПередачи КАК ДокументПередачи,
	|	ОстПлюсПрих.СчетУчета,
	|	ОстПлюсПрих.Организация,
	|	СУММА(ОстПлюсПрих.Количество) КАК Количество,
	|	СУММА(ОстПлюсПрих.Стоимость) КАК Стоимость,
	|	СУММА(ОстПлюсПрих.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(ОстПлюсПрих.ВременнаяРазница) КАК ВременнаяРазница,
	|	ОстПлюсПрих.Подразделение КАК Подразделение,
	|	ОстПлюсПрих.ФизЛицо КАК ФизЛицо,
	|	ОстПлюсПрих.НазначениеИспользования КАК НазначениеИспользования
	|ИЗ
	|	(ВЫБРАТЬ
	|		ПартииОстатки.Номенклатура КАК Номенклатура,
	|		ПартииОстатки.Подразделение КАК Подразделение,
	|		ПартииОстатки.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|		ПартииОстатки.СерияНоменклатуры КАК СерияНоменклатуры,
	|		ПартииОстатки.ДокументПередачи КАК ДокументПередачи,
	|		ПартииОстатки.ФизЛицо КАК ФизЛицо,
	|		ПартииОстатки.НазначениеИспользования КАК НазначениеИспользования,
	|		ПартииОстатки.КоличествоОстаток КАК Количество,
	|		ПартииОстатки.СтоимостьОстаток КАК Стоимость,
	|		ПартииОстатки.СчетУчета КАК СчетУчета,
	|		ПартииОстатки.Организация КАК Организация,
	|		ПартииОстатки.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
	|		ПартииОстатки.ВременнаяРазницаОстаток КАК ВременнаяРазница
	|	ИЗ
	|		РегистрНакопления.ПартииМатериаловВЭксплуатацииНалоговыйУчет.Остатки(&ДатаНач, Номенклатура В (&МассивНоменклатуры)) КАК ПартииОстатки
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ПартииПриход.Номенклатура,
	|		ПартииПриход.Подразделение КАК Подразделение,	
	|		ПартииПриход.ХарактеристикаНоменклатуры,
	|		ПартииПриход.СерияНоменклатуры,
	|		ПартииПриход.ДокументПередачи,
	|		ПартииПриход.ФизЛицо,
	|		ПартииПриход.НазначениеИспользования,
	|		ВЫБОР
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПриход.Количество
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПриход.Количество
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПриход.Стоимость
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПриход.Стоимость
	|		КОНЕЦ,
	|		ПартииПриход.СчетУчета,
	|		ПартииПриход.Организация,
	|		ВЫБОР
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПриход.ПостояннаяРазница
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПриход.ПостояннаяРазница
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПриход.ВременнаяРазница
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПриход.ВременнаяРазница
	|		КОНЕЦ
	|	ИЗ
	|		РегистрНакопления.ПартииМатериаловВЭксплуатацииНалоговыйУчет КАК ПартииПриход
	|	ГДЕ
	|		ПартииПриход.Номенклатура В(&МассивНоменклатуры)
	|		И ПартииПриход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|		И ПартииПриход.КодОперации В(&СписокКодов)
	|		И ПартииПриход.Активность = ИСТИНА) КАК ОстПлюсПрих
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.Подразделение,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.СерияНоменклатуры,
	|	ОстПлюсПрих.ДокументПередачи,
	|	ОстПлюсПрих.ФизЛицо,
	|	ОстПлюсПрих.НазначениеИспользования,
	|	ОстПлюсПрих.СчетУчета,
	|	ОстПлюсПрих.Организация";
	
	ЗапросНачОстПлюсПриход.Текст = Текст;
	
КонецПроцедуры // ЗаполнитьЗапросНачОстПлюсПриходУпр()

// Заполняет текст запроса, выбирающего остаток и поступление по упр учету
//
// Параметры:
//	Нет.
//
Процедура ЗаполнитьЗапросНачОстПлюсПриходМеж(ЗапросНачОстПлюсПриход)
	
	Текст = 
	// Партии на складах
	"ВЫБРАТЬ
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.СерияНоменклатуры,
	|	ОстПлюсПрих.ДокументОприходования,
	|	ОстПлюсПрих.Склад,
	|	ОстПлюсПрих.Заказ,
	|	ОстПлюсПрих.Качество,
	|	NULL КАК ДоговорКонтрагента,
	|	NULL КАК ДокументПередачи,
	|	ОстПлюсПрих.СчетУчета,
	|	ОстПлюсПрих.Организация,
	|	СУММА(ОстПлюсПрих.Количество) КАК Количество,
	|	СУММА(ОстПлюсПрих.Стоимость) КАК Стоимость
	|ИЗ
	|	(ВЫБРАТЬ
	|		ПартииОстатки.Номенклатура КАК Номенклатура,
	|		ПартииОстатки.Склад КАК Склад,
	|		ПартииОстатки.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|		ПартииОстатки.СерияНоменклатуры КАК СерияНоменклатуры,
	|		ПартииОстатки.ДокументОприходования КАК ДокументОприходования,
	|		ПартииОстатки.Заказ КАК Заказ,
	|		ПартииОстатки.Качество КАК Качество,
	|		ПартииОстатки.КоличествоОстаток КАК Количество,
	|		ПартииОстатки.СтоимостьОстаток КАК Стоимость,
	|		ПартииОстатки.СчетУчета КАК СчетУчета,
	|		ПартииОстатки.Организация КАК Организация
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровНаСкладахМеждународныйУчет.Остатки(&ДатаНач, Номенклатура В (&МассивНоменклатуры)) КАК ПартииОстатки
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ПартииПриход.Номенклатура,
	|		ПартииПриход.Склад,
	|		ПартииПриход.ХарактеристикаНоменклатуры,
	|		ПартииПриход.СерияНоменклатуры,
	|		ПартииПриход.ДокументОприходования,
	|		ПартииПриход.Заказ,
	|		ПартииПриход.Качество,
	|		ВЫБОР
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПриход.Количество
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПриход.Количество
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПриход.Стоимость
	|			КОГДА ПартииПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПриход.Стоимость
	|		КОНЕЦ,
	|		ПартииПриход.СчетУчета,
	|		ПартииПриход.Организация
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровНаСкладахМеждународныйУчет КАК ПартииПриход
	|	ГДЕ
	|		ПартииПриход.Номенклатура В(&МассивНоменклатуры)
	|		И ПартииПриход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|		И ПартииПриход.КодОперации В(&СписокКодов)
	|		И ПартииПриход.Активность = ИСТИНА) КАК ОстПлюсПрих
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.Склад,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.СерияНоменклатуры,
	|	ОстПлюсПрих.ДокументОприходования,
	|	ОстПлюсПрих.Заказ,
	|	ОстПлюсПрих.Качество,
	|	ОстПлюсПрих.СчетУчета,
	|	ОстПлюсПрих.Организация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	NULL,
	|	ОстПлюсПрих.ДокументОприходования,
	|	NULL,
	|	NULL,
	|	NULL,
	|	ОстПлюсПрих.ДоговорКонтрагента,
	|	ОстПлюсПрих.ДокументПередачи,
	|	ОстПлюсПрих.СчетУчета,
	|	ОстПлюсПрих.Организация,
	|	СУММА(ОстПлюсПрих.Количество),
	|	СУММА(ОстПлюсПрих.Стоимость)
	|ИЗ
	|	(ВЫБРАТЬ
	|		ПартииПередОстатки.Номенклатура КАК Номенклатура,
	|		ПартииПередОстатки.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|		ПартииПередОстатки.ДокументОприходования КАК ДокументОприходования,
	|		ПартииПередОстатки.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|		ПартииПередОстатки.ДокументПередачи КАК ДокументПередачи,
	|		ПартииПередОстатки.КоличествоОстаток КАК Количество,
	|		ПартииПередОстатки.СтоимостьОстаток КАК Стоимость,
	|		ПартииПередОстатки.СчетУчета КАК СчетУчета,
	|		ПартииПередОстатки.Организация КАК Организация
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровПереданныеМеждународныйУчет.Остатки(&ДатаНач, Номенклатура В (&МассивНоменклатуры)) КАК ПартииПередОстатки
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ПартииПередПриход.Номенклатура,
	|		ПартииПередПриход.ХарактеристикаНоменклатуры,
	|		ПартииПередПриход.ДокументОприходования,
	|		ПартииПередПриход.ДоговорКонтрагента,
	|		ПартииПередПриход.ДокументПередачи,
	|		ВЫБОР
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПередПриход.Количество
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПередПриход.Количество
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияПриход
	|				ТОГДА ПартииПередПриход.Стоимость
	|			КОГДА ПартииПередПриход.ВидДвижения = &ВидДвиженияРасход
	|				ТОГДА -ПартииПередПриход.Стоимость
	|		КОНЕЦ,
	|		ПартииПередПриход.СчетУчета,
	|		ПартииПередПриход.Организация
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровПереданныеМеждународныйУчет КАК ПартииПередПриход
	|	ГДЕ
	|		ПартииПередПриход.Номенклатура В(&МассивНоменклатуры)
	|		И ПартииПередПриход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|		И ПартииПередПриход.КодОперации В(&СписокКодов)
	|		И ПартииПередПриход.Активность = ИСТИНА) КАК ОстПлюсПрих
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстПлюсПрих.Номенклатура,
	|	ОстПлюсПрих.ХарактеристикаНоменклатуры,
	|	ОстПлюсПрих.ДокументОприходования,
	|	ОстПлюсПрих.ДокументПередачи,
	|	ОстПлюсПрих.ДоговорКонтрагента,
	|	ОстПлюсПрих.СчетУчета,
	|	ОстПлюсПрих.Организация";
	
	ЗапросНачОстПлюсПриход.Текст = Текст;
	
КонецПроцедуры // ЗаполнитьЗапросНачОстПлюсПриходУпр()

// Добавляет в базу данных записи по перемещению в другое состояние
//
// Параметры:
//	Нет.
//
Процедура ДобавитьЗаписиПоПеремещению(ПараметрыСостоянияИсточника, ПараметрыСостоянияПриемника, СтСтоимость, СтруктураДопПараметров)
	
	// Выполним движение по сторнированию перемещения
	
	// Если корректировать нечего, движений не добавляем
	ВыполнятьДвижения = Ложь;
	Для Каждого ЭлСтоимость Из СтСтоимость	Цикл
		Если ЭлСтоимость.Значение<>0 Тогда
			ВыполнятьДвижения=Истина; Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ ВыполнятьДвижения Тогда
		Возврат;
	КонецЕсли;
	
	// Из структуры доп параметров добудем дополнительные параметры
	Учет            = СтруктураДопПараметров.Учет;
	
	// По параметрам источника и приемника определим вид партий
	Договор = Неопределено;
	ПараметрыСостоянияИсточника.Свойство("ДоговорКонтрагента", Договор);
	Подразделение = Неопределено;
	ПараметрыСостоянияИсточника.Свойство("Подразделение", Подразделение);
	Если ЗначениеЗаполнено(Договор) Тогда
		Источник =  "Переданные";
	ИначеЕсли ЗначениеЗаполнено(Подразделение) Тогда
		Источник =  "ВЭксплуатации";
	Иначе
		Источник =  "НаСкладах";
	КонецЕсли;
	
	Договор = Неопределено;
	ПараметрыСостоянияПриемника.Свойство("ДоговорКонтрагента", Договор);
	Подразделение = Неопределено;
	ПараметрыСостоянияПриемника.Свойство("Подразделение", Подразделение);
	Если ЗначениеЗаполнено(Договор) Тогда
		Приемник =  "Переданные";
	ИначеЕсли ЗначениеЗаполнено(Подразделение) Тогда
		Приемник =  "ВЭксплуатации";
	Иначе
		Приемник =  "НаСкладах";
	КонецЕсли;
	
	Если Источник =  "НаСкладах" Тогда
		ИмяРег="ПартииТоваровНаСкладах";
	ИначеЕсли Источник =  "ВЭксплуатации" Тогда
		ИмяРег="ПартииМатериаловВЭксплуатации";
	Иначе
		ИмяРег="ПартииТоваровПереданные";
	КонецЕсли;
	
	
	СтрокаДокумента= Новый Структура;
		
	// Эти параметры добавляются на всякий случай, т.к. они используются процедурой заполнения субконто по счету
	СтрокаДокумента.Вставить("НоменклатураНовая", Неопределено);
	СтрокаДокумента.Вставить("ПодразделениеОрганизации", Неопределено);
	СтрокаДокумента.Вставить("СтатьяЗатрат", Неопределено);
	СтрокаДокумента.Вставить("НоменклатурнаяГруппа", Неопределено);
	СтрокаДокумента.Вставить("Склад", Неопределено);
	СтрокаДокумента.Вставить("СкладПолучатель", Неопределено);
	СтрокаДокумента.Вставить("ДоговорКонтрагента", Неопределено);
	СтрокаДокумента.Вставить("ИзменитьСерию", Ложь);
	СтрокаДокумента.Вставить("ИзменитьХарактеристику", Ложь);
	СтрокаДокумента.Вставить("ИзменитьСклад", Ложь);
	
	СтрокаДокумента.Вставить("ВидТабличнойЧасти");
	
	// Трансляция параметров состояния-источника в формат регистра СписанныеТовары
	СтрокаДокумента.Вставить("Номенклатура", ПараметрыСостоянияИсточника.Номенклатура);
	
	СтруктураРеквизитов = Новый Структура("ВестиПартионныйУчетПоСериям");
	УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(ПараметрыСостоянияИсточника.Номенклатура, СтруктураРеквизитов);
	
	СтрокаДокумента.Вставить("ВестиПартионныйУчетПоСериям", СтруктураРеквизитов.ВестиПартионныйУчетПоСериям);
	
	СтрокаДокумента.Вставить("ХарактеристикаНоменклатуры", ПараметрыСостоянияИсточника.ХарактеристикаНоменклатуры);
	
	Если Источник =  "НаСкладах" Тогда
		СтрокаДокумента.Вставить("Склад", ПараметрыСостоянияИсточника.Склад);
		СтрокаДокумента.Вставить("СерияНоменклатуры", ПараметрыСостоянияИсточника.СерияНоменклатуры);
		СтрокаДокумента.Вставить("Качество", ПараметрыСостоянияИсточника.Качество);
		Если Учет = "Упр" Тогда
			СтрокаДокумента.Вставить("СтатусПартии", ПараметрыСостоянияИсточника.СтатусПартии);
		КонецЕсли;
	ИначеЕсли Источник =  "ВЭксплуатации" Тогда	
		СтрокаДокумента.Вставить("Подразделение", ПараметрыСостоянияИсточника.Подразделение);
		СтрокаДокумента.Вставить("СерияНоменклатуры", ПараметрыСостоянияИсточника.СерияНоменклатуры);
		СтрокаДокумента.Вставить("ДокументПередачи", ПараметрыСостоянияИсточника.ДокументПередачи);
		СтрокаДокумента.Вставить("ФизЛицо", ПараметрыСостоянияИсточника.ФизЛицо);
		СтрокаДокумента.Вставить("НазначениеИспользования", ПараметрыСостоянияИсточника.НазначениеИспользования);
	Иначе
		СтрокаДокумента.Вставить("ДоговорКонтрагента", ПараметрыСостоянияИсточника.ДоговорКонтрагента);
		СтрокаДокумента.Вставить("ДокументПередачи", ПараметрыСостоянияИсточника.ДокументПередачи);
		СтрокаДокумента.Вставить("СерияНоменклатуры", Неопределено);
		Если Учет = "Упр" Тогда
			СтрокаДокумента.Вставить("СтатусПередачи", ПараметрыСостоянияИсточника.СтатусПередачи);
			СтрокаДокумента.Вставить("СтатусПартии", ПараметрыСостоянияИсточника.СтатусПартии);
		КонецЕсли;
	КонецЕсли;
	
	СтрокаДокумента.Вставить("Заказ", ПараметрыСостоянияИсточника.Заказ);
	СтрокаДокумента.Вставить("ДокументОприходования", ПараметрыСостоянияИсточника.ДокументОприходования);
	СтрокаДокумента.Вставить("ДокументОприходованияНовый", ПараметрыСостоянияПриемника.ДокументОприходования);
	СтрокаДокумента.Вставить("Организация", ПараметрыСостоянияИсточника.Организация);
	
	Если Учет = "Бух" Тогда
		СтрокаДокумента.Вставить("СчетУчетаБУ", ПараметрыСостоянияИсточника.СчетУчета);
		
		СтрокаДокумента.Вставить("КорСубконтоБУ1", Неопределено);
		СтрокаДокумента.Вставить("КорСубконтоБУ2", Неопределено);
		СтрокаДокумента.Вставить("КорСубконтоБУ3", Неопределено);
		
		СтрокаДокумента.Вставить("ПринятыеСчетУчетаБУ", Неопределено);
		
	ИначеЕсли Учет = "Нал" Тогда
		СтрокаДокумента.Вставить("СчетУчетаНУ", ПараметрыСостоянияИсточника.СчетУчета);
		
		СтрокаДокумента.Вставить("КорСубконтоНУ1", Неопределено);
		СтрокаДокумента.Вставить("КорСубконтоНУ2", Неопределено);
		СтрокаДокумента.Вставить("КорСубконтоНУ3", Неопределено);
		
		СтрокаДокумента.Вставить("КорСубконтоБУ1", Неопределено);
		СтрокаДокумента.Вставить("КорСубконтоБУ2", Неопределено);
		СтрокаДокумента.Вставить("КорСубконтоБУ3", Неопределено);
		
		СтрокаДокумента.Вставить("ПринятыеСчетУчетаНУ", Неопределено);
		
	ИначеЕсли Учет = "Меж" Тогда
		СтрокаДокумента.Вставить("СчетУчетаМУ", ПараметрыСостоянияИсточника.СчетУчета);
		
		СтрокаДокумента.Вставить("КорСубконтоМУ1", Неопределено);
		СтрокаДокумента.Вставить("КорСубконтоМУ2", Неопределено);
		СтрокаДокумента.Вставить("КорСубконтоМУ3", Неопределено);
		
		СтрокаДокумента.Вставить("ПринятыеСчетУчетаМУ", Неопределено);
		
	КонецЕсли;
	
	// Трансляция параметров состояния-приемника в формат регистра СписанныеТовары
	СтрокаДокумента.Вставить("НоменклатураНовая", ПараметрыСостоянияПриемника.Номенклатура);
	СтрокаДокумента.Вставить("ХарактеристикаНоменклатурыНовая", ПараметрыСостоянияПриемника.ХарактеристикаНоменклатуры);
	СтрокаДокумента.Вставить("СерияНоменклатурыНовая", ПараметрыСостоянияПриемника.СерияНоменклатуры);
	
	СтрокаДокумента.Вставить("ЗаказСписания", ПараметрыСостоянияПриемника.Заказ);
	
	Если Учет="Бух" Тогда
		СтрокаДокумента.Вставить("КорСчетБУ", ПараметрыСостоянияПриемника.СчетУчета);
		СтрокаДокумента.Вставить("ПринятыеКорСчетБУ", ПараметрыСостоянияПриемника.СчетУчета);
		СтрокаДокумента.Вставить("Организация", ПараметрыСостоянияПриемника.Организация);
	ИначеЕсли Учет="Нал" Тогда
		СтрокаДокумента.Вставить("КорСчетНУ", ПараметрыСостоянияПриемника.СчетУчета);
		СтрокаДокумента.Вставить("Организация", ПараметрыСостоянияПриемника.Организация);
	ИначеЕсли Учет="Меж" Тогда
		СтрокаДокумента.Вставить("КорСчетМУ", ПараметрыСостоянияПриемника.СчетУчета);
		СтрокаДокумента.Вставить("Организация", ПараметрыСостоянияПриемника.Организация);
	КонецЕсли;
	
	Если Приемник = "Переданные" Тогда
		СтрокаДокумента.Вставить("ДоговорКонтрагента", ПараметрыСостоянияПриемника.ДоговорКонтрагента);
		СтрокаДокумента.Вставить("ДокументПередачи", ПараметрыСостоянияПриемника.ДокументПередачи);
		Если Учет = "Упр" Тогда
			СтрокаДокумента.Вставить("СтатусПартии", ПараметрыСостоянияПриемника.СтатусПартии);
			СтрокаДокумента.Вставить("СтатусПередачи", ПараметрыСостоянияПриемника.СтатусПередачи);
		КонецЕсли;
	ИначеЕсли Приемник =  "ВЭксплуатации" Тогда	
		СтрокаДокумента.Вставить("Подразделение", ПараметрыСостоянияПриемника.Подразделение);
		СтрокаДокумента.Вставить("ПодразделениеОрганизации", ПараметрыСостоянияПриемника.Подразделение);
		СтрокаДокумента.Вставить("СерияНоменклатуры", ПараметрыСостоянияПриемника.СерияНоменклатуры);
		СтрокаДокумента.Вставить("ДокументПередачи", ПараметрыСостоянияПриемника.ДокументПередачи);
		СтрокаДокумента.Вставить("ФизЛицо", ПараметрыСостоянияПриемника.ФизЛицо);
		СтрокаДокумента.Вставить("НазначениеИспользования", ПараметрыСостоянияПриемника.НазначениеИспользования);		
	ИначеЕсли Приемник="НаСкладах" Тогда
		СтрокаДокумента.Вставить("КачествоНовое", ПараметрыСостоянияПриемника.Качество);
		СтрокаДокумента.Вставить("СкладПолучатель", ПараметрыСостоянияПриемника.Склад);
		Если Учет = "Упр" Тогда
			СтрокаДокумента.Вставить("СтатусПартии", ПараметрыСостоянияПриемника.СтатусПартии);
		КонецЕсли;
	КонецЕсли;
	
	СтрокаДокумента.Вставить("ОтражатьВУправленческомУчете", Истина);
	СтрокаДокумента.Вставить("КоличествоПоступление", 0);

	СтрокаДокумента.Вставить("ОтражатьВУправленческомУчете", Ложь);
	СтрокаДокумента.Вставить("ОтражатьВБухгалтерскомУчете", Ложь);
	СтрокаДокумента.Вставить("ОтражатьВНалоговомУчете", Ложь);
	СтрокаДокумента.Вставить("ОтражатьВМеждународномУчете", Ложь);
	
	Если Учет = "Упр" Тогда
		СтрокаДокумента.Вставить("ОтражатьВУправленческомУчете", Истина);
	ИначеЕсли Учет = "Бух" Тогда
		СтрокаДокумента.Вставить("ОтражатьВБухгалтерскомУчете", Истина);
	ИначеЕсли Учет = "Нал" Тогда
		СтрокаДокумента.Вставить("ОтражатьВНалоговомУчете", Истина);
	ИначеЕсли Учет = "Меж" Тогда
		СтрокаДокумента.Вставить("ОтражатьВМеждународномУчете", Истина);
	КонецЕсли;
	
	Движение              = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров(ИмяРег+Учет, СтруктураДопПараметров);
	Движение.Период       = СтруктураДопПараметров.Период;
	Движение.ВидДвижения  = ВидДвиженияНакопления.Расход;
	
	Движение.Номенклатура = ПараметрыСостоянияИсточника.Номенклатура;
	
	Движение.ХарактеристикаНоменклатуры = ПараметрыСостоянияИсточника.ХарактеристикаНоменклатуры;
	
	Если Источник =  "НаСкладах" Тогда
		Движение.Склад      = ПараметрыСостоянияИсточника.Склад;
		Движение.Заказ      = ПараметрыСостоянияИсточника.Заказ;
		Движение.СерияНоменклатуры = ПараметрыСостоянияИсточника.СерияНоменклатуры;
		Движение.Качество = ПараметрыСостоянияИсточника.Качество;
		Если Учет = "Упр" Тогда
			Движение.СтатусПартии = ПараметрыСостоянияИсточника.СтатусПартии;
		КонецЕсли;
		Движение.ДокументОприходования = ПараметрыСостоянияИсточника.ДокументОприходования;
		Движение.Организация = ПараметрыСостоянияИсточника.Организация;
	ИначеЕсли Источник =  "Переданные" Тогда
		Движение.ДоговорКонтрагента      = ПараметрыСостоянияИсточника.ДоговорКонтрагента;
		Движение.ДокументПередачи = ПараметрыСостоянияИсточника.ДокументПередачи;
		Если Учет = "Упр" Тогда
			Движение.СтатусПередачи = ПараметрыСостоянияИсточника.СтатусПередачи;
			Движение.СтатусПартии = ПараметрыСостоянияИсточника.СтатусПартии;
		КонецЕсли;
		Движение.ДокументОприходования = ПараметрыСостоянияИсточника.ДокументОприходования;
		Движение.Организация = ПараметрыСостоянияИсточника.Организация;
	ИначеЕсли Источник =  "ВЭксплуатации" Тогда
		Движение.ДокументПередачи = ПараметрыСостоянияИсточника.ДокументПередачи;
		Движение.ФизЛицо = ПараметрыСостоянияИсточника.ФизЛицо;
		Движение.НазначениеИспользования = ПараметрыСостоянияИсточника.НазначениеИспользования;
	КонецЕсли;
	
	Если Учет = "Бух" Тогда
		Движение.СчетУчета = ПараметрыСостоянияИсточника.СчетУчета;
	ИначеЕсли Учет = "Нал" Тогда
		Движение.СчетУчета = ПараметрыСостоянияИсточника.СчетУчета;
	ИначеЕсли Учет = "Меж" Тогда
		Движение.СчетУчета = ПараметрыСостоянияИсточника.СчетУчета;
	КонецЕсли;
	
	Движение.Количество   = 0;
	
	// Суммы из структуры
	Для Каждого ЭлСтоимость Из СтСтоимость	Цикл
		Движение[ЭлСтоимость.Ключ]  = ЭлСтоимость.Значение;
	КонецЦикла;
	
	// Коды операций
	СтрокаДокумента.Вставить("КодОперацииПартииТоваров", Перечисления.КодыОперацийПартииТоваров.ПеремещениеМеждуСкладами); // по умолчанию
	Если Источник = "НаСкладах" И Приемник = "Переданные" Тогда
		СтрокаДокумента.Вставить("КодОперацииПартииТоваров", Перечисления.КодыОперацийПартииТоваров.ПередачаНаКомиссию);
	ИначеЕсли Источник = "Переданные" И Приемник = "НаСкладах" Тогда
		СтрокаДокумента.Вставить("КодОперацииПартииТоваров", Перечисления.КодыОперацийПартииТоваров.ВозвратОтКомиссионера);
	ИначеЕсли Источник = "НаСкладах" И Приемник = "ВЭксплуатации" Тогда
		СтрокаДокумента.Вставить("КодОперацииПартииТоваров", Перечисления.КодыОперацийПартииТоваров.ПередачаМатериаловВЭксплуатацию);
	КонецЕсли;
	Движение.КодОперации = СтрокаДокумента.КодОперацииПартииТоваров;
	
	Если НЕ Источник =  "ВЭксплуатации" Тогда
		
		СпособВеденияПартионногоУчетаПоОрганизации = УправлениеЗапасами.ПолучитьСпособВеденияПартионногоУчетаПоОрганизации(Движение.Организация, Движение.Период);
		СтруктураДопПараметров.Вставить("ОрганизацияУпр", УправлениеЗапасами.ПолучитьОрганизациюВСоответствииСоСпособомВеденияПартионногоУчетаПоОрганизациям(Движение.Организация,СпособВеденияПартионногоУчетаПоОрганизации));
		
		ВыполнитьКорДвижение(Источник, СтрокаДокумента, СтруктураДопПараметров, Движение);
		
	Иначе
		
		СтруктураДопПараметров.Вставить("ОрганизацияУпр",Справочники.Организации.ПустаяСсылка());
		
	КонецЕсли;	

	
	Если Приемник =  "ВЭксплуатации" Тогда
		//Вызов специальной процедуры производственного учета для формирования движений
		НоваяСтрока = СтруктураДопПараметров.ТаблицаСписанныхПартийСпецодежды.Добавить();
		
		ЗаполнитьЗначенияСвойств(НоваяСтрока,СтрокаДокумента);
		
		Если Учет = "Упр" Тогда
			НоваяСтрока.ОтражатьВУправленческомУчете = Истина;
		ИначеЕсли Учет = "Бух" Тогда
			НоваяСтрока.ОтражатьВБухгалтерскомУчете = Истина;
		ИначеЕсли Учет = "Нал" Тогда
			НоваяСтрока.ОтражатьВНалоговомУчете = Истина;
		ИначеЕсли Учет = "Меж" Тогда
			НоваяСтрока.ОтражатьВМеждународномУчете = Истина;
		КонецЕсли;
		
		НоваяСтрока.Стоимость = СтСтоимость.Стоимость;
		Если Учет = "Нал" Тогда
			НоваяСтрока.ПостояннаяРазница = СтСтоимость.ПостояннаяРазница;
			НоваяСтрока.ВременнаяРазница = СтСтоимость.ВременнаяРазница;
		КонецЕсли;
		
		НоваяСтрока.Количество = 0;
		НоваяСтрока.КодОперацииПартииТоваров = Перечисления.КодыОперацийПартииТоваров.ПередачаМатериаловВЭксплуатацию;
	КонецЕсли;
	
КонецПроцедуры // ДобавитьЗаписиПоПеремещению()

//начало изменений Ожиганов 20.04.2016 б/н приравнять движения по материалам БУ к НУ  
Процедура ВыполнитьКорДвижение(РегистрУчета, СтрокаДокумента, СтруктураПараметров, Движение) Экспорт 
//конец изменений 	
	
	СтруктураПараметров.Вставить("ФормироватьПроводкиПоСписаниюТМЦ",Истина);
	СтруктураПараметров.Вставить("СписыватьПартииНДС",Истина);
	
	//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  
	Если СтрокаДокумента.ОтражатьВУправленческомУчете Тогда
    //конец изменений 
		НаправлениеСписания = УправлениеЗапасамиПартионныйУчет.ПолучитьНаправлениеСписанияПоКодуОперации(СтрокаДокумента.КодОперацииПартииТоваров, СтрокаДокумента.СтатьяЗатрат);
		УправлениеЗапасамиПартионныйУчет.ВыполнитьКорДвижениеУпр(РегистрУчета, НаправлениеСписания , СтрокаДокумента, СтруктураПараметров, Движение);
	//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  
	КонецЕсли;
	//конец изменений 
	
	Если СтрокаДокумента.ОтражатьВБухгалтерскомУчете Тогда
		ИмяПланСчетов = "Хозрасчетный";
		СчетЗатрат = СтрокаДокумента.КорСчетБУ;
	ИначеЕсли СтрокаДокумента.ОтражатьВНалоговомУчете Тогда
		СчетЗатрат = СтрокаДокумента.КорСчетНУ;
		ИмяПланСчетов = "Налоговый";
	КонецЕсли;
	
	НаправлениеСписания = УправлениеЗапасамиПартионныйУчет.ПолучитьНаправлениеСписанияПоКодуОперации(СтрокаДокумента.КодОперацииПартииТоваров, СтрокаДокумента.СтатьяЗатрат, СчетЗатрат, ИмяПланСчетов);
	//начало изменений Ожиганов 05.05.2015 изменения по браку 
	Если  Движение.КодОперации = Перечисления.КодыОперацийПартииТоваров.ВозвратПоставщику Тогда
		УправлениеЗапасамиПартионныйУчетФормированиеПроводокРегл.ПРГВыполнитьДвиженияПоОтклВСтоимости(РегистрУчета, СтрокаДокумента, СтруктураПараметров, Движение,,НаправлениеСписания);
		возврат;
	//начало изменений 53363 формирование проводок при возрате тары по залоговой стоимости  		
	ИначеЕсли  Движение.КодОперации = Перечисления.КодыОперацийПартииТоваров.ПередачаТарыЗалогСтоимость
		Или Движение.КодОперации = Перечисления.КодыОперацийПартииТоваров.ВозвратТарыЗалогСтоимостьТекущийМесяц
	Тогда
		УправлениеЗапасамиПартионныйУчетФормированиеПроводокРегл.ПРГВыполнитьДвиженияПоОтклВСтоимости(РегистрУчета, СтрокаДокумента, СтруктураПараметров, Движение,,НаправлениеСписания);
		возврат;
	//конец изменений 
	КонецЕсли;	
	//конец изменений 
	
	УправлениеЗапасамиПартионныйУчет.ВыполнитьКорДвижениеРегл(РегистрУчета, НаправлениеСписания, СтрокаДокумента, СтруктураПараметров, Движение);
	Если СтрокаДокумента.ОтражатьВБухгалтерскомУчете ИЛИ СтрокаДокумента.ОтражатьВНалоговомУчете Тогда 
		// Формирование проводок по бух учету
		УправлениеЗапасамиПартионныйУчетФормированиеПроводокРегл.СписаниеНаСчет(РегистрУчета, СтрокаДокумента, СтруктураПараметров, Движение,,НаправлениеСписания);
	КонецЕсли;	
	
	// is ЯннуровВФ нач 20141022
	//НаправлениеСписания = УправлениеЗапасамиПартионныйУчет.ПолучитьНаправлениеСписанияПоКодуОперации(СтрокаДокумента.КодОперацииПартииТоваров, СтрокаДокумента.СтатьяЗатрат);
	//УправлениеЗапасамиПартионныйУчет.ВыполнитьКорДвижениеМеж(РегистрУчета, НаправлениеСписания, СтрокаДокумента, СтруктураПараметров, Движение);
	// is ЯннуровВФ кон 20141022
	Если СтрокаДокумента.ОтражатьВМеждународномУчете Тогда 
		// is ЯннуровВФ нач 20141022
		НаправлениеСписания = УправлениеЗапасамиПартионныйУчет.ПолучитьНаправлениеСписанияПоКодуОперации(СтрокаДокумента.КодОперацииПартииТоваров, СтрокаДокумента.СтатьяЗатрат, СтрокаДокумента.КорСчетМУ, "Международный");
		УправлениеЗапасамиПартионныйУчет.ВыполнитьКорДвижениеМеж(РегистрУчета, НаправлениеСписания, СтрокаДокумента, СтруктураПараметров, Движение);
		// is ЯннуровВФ кон 20141022
		// Формирование проводок по бух учету
		УправлениеЗапасамиПартионныйУчетФормированиеПроводокМежд.СписаниеНаСчетМеж(РегистрУчета, СтрокаДокумента, СтруктураПараметров, Движение,НаправлениеСписания);
	КонецЕсли;	
	
	// Сюда можно добавить вызов процедур для выполнения движений по другим учетам
	
КонецПроцедуры // ВыполнитьКорДвижение()


// Здесь формируются все записи по внешнему списанию из состояния ПараметрыСостоянияИсточника
//
// Параметры:
//	Нет.
//
Процедура ДобавитьЗаписиПоВнешнемуСписанию(ПараметрыСостоянияИсточника, Количество, СтСтоимость, СтруктураДопПараметров)
	
	// Если в состоянии ничего не осталось, ничего не делать
	//начало изменений 
	//Если Количество=0 Тогда
	Количество= ?(Количество = Неопределено,0,Количество);
	//конец изменений 	
	Если Количество=0 Тогда
	
		Возврат;
	КонецЕсли;
	
	ПРГ_НовыеПравила = Ложь;
	Если СтруктураДопПараметров.Период > '20150201' Тогда
		ПРГ_НовыеПравила = Истина;
	КонецЕсли;
	//начало изменений Ожиганов А. 16.02.2017 исправление копеек при равном количество прихода и списания 
	ПРГ_УчитыватьКолВоСознаком = ложь;
	//Если СтруктураДопПараметров.Период > '20161101' Тогда
	Если СтруктураДопПараметров.Период > '20170201' Тогда
		ПРГ_УчитыватьКолВоСознаком  = Истина;
	КонецЕсли;
	//конец изменений 
		
		
	
	// Из структуры доп параметров добудем дополнительные параметры
	Учет            = СтруктураДопПараметров.Учет;
	
	// По параметрам источника и приемника определим вид партий
	Договор = Неопределено;
	ПараметрыСостоянияИсточника.Свойство("ДоговорКонтрагента", Договор);
	Подразделение = Неопределено;
	ПараметрыСостоянияИсточника.Свойство("Подразделение", Подразделение);
	Если ЗначениеЗаполнено(Договор) Тогда
		Источник =  "Переданные";
		ИмяРег = "ПартииТоваровПереданные";
	ИначеЕсли ЗначениеЗаполнено(Подразделение) Тогда
		Источник =  "ВЭксплуатации";
		ИмяРег = "ПартииМатериаловВЭксплуатации";
	Иначе
		Источник =  "НаСкладах";
		ИмяРег = "ПартииТоваровНаСкладах";
	КонецЕсли;
	
	//начало изменений  
	ВычислятьСпособВедения = Истина;
	Если  СтруктураДопПараметров.ОтражатьВБухгалтерскомУчете или СтруктураДопПараметров.ОтражатьВНалоговомУчете Тогда
		СпособВеденияПартионногоУчетаПоОрганизации = СтруктураДопПараметров.СпособВеденияПартионногоУчетаПоОрганизации;
		ВычислятьСпособВедения = Ложь;
	КонецЕсли;			
	//конец изменений 
	
	Ст= Новый Структура;
	
	
	
	// Трансляция параметров состояния-источника в формат регистра СписанныеТовары
	Ст.Вставить("Номенклатура", ПараметрыСостоянияИсточника.Номенклатура);
	Ст.Вставить("ХарактеристикаНоменклатуры", ПараметрыСостоянияИсточника.ХарактеристикаНоменклатуры);
	
	Если Источник =  "НаСкладах" Тогда
		Ст.Вставить("Склад", ПараметрыСостоянияИсточника.Склад);
		Ст.Вставить("СерияНоменклатуры", ПараметрыСостоянияИсточника.СерияНоменклатуры);
		Ст.Вставить("Качество", ПараметрыСостоянияИсточника.Качество);
		Если Учет = "Упр" Тогда
			Ст.Вставить("СтатусПартии", ПараметрыСостоянияИсточника.СтатусПартии);
		КонецЕсли;
	ИначеЕсли Источник =  "ВЭксплуатации" Тогда	
		Если Учет = "Упр" Тогда
			Ст.Вставить("Подразделение", ПараметрыСостоянияИсточника.Подразделение);
		Иначе
			Ст.Вставить("ПодразделениеОрганизации", ПараметрыСостоянияИсточника.Подразделение);
		КонецЕсли;	
		Ст.Вставить("СерияНоменклатуры", ПараметрыСостоянияИсточника.СерияНоменклатуры);
		Ст.Вставить("ДокументПередачи", ПараметрыСостоянияИсточника.ДокументПередачи);
		Ст.Вставить("ФизЛицо", ПараметрыСостоянияИсточника.ФизЛицо);
		Ст.Вставить("НазначениеИспользования", ПараметрыСостоянияИсточника.НазначениеИспользования);
	Иначе
		Ст.Вставить("ДоговорКонтрагента", ПараметрыСостоянияИсточника.ДоговорКонтрагента);
		Ст.Вставить("ДокументПередачи", ПараметрыСостоянияИсточника.ДокументПередачи);
		Если Учет = "Упр" Тогда
			Ст.Вставить("СтатусПередачи", ПараметрыСостоянияИсточника.СтатусПередачи);
			Ст.Вставить("СтатусПартии", ПараметрыСостоянияИсточника.СтатусПартии);
		КонецЕсли;
	КонецЕсли;
	
	Ст.Вставить("ДокументОприходования", ПараметрыСостоянияИсточника.ДокументОприходования);
	Ст.Вставить("Заказ", ПараметрыСостоянияИсточника.Заказ);
	Ст.Вставить("Организация", ПараметрыСостоянияИсточника.Организация);
	
	Если Учет = "Бух" Тогда
		Ст.Вставить("СчетУчетаБУ", ПараметрыСостоянияИсточника.СчетУчета);
	ИначеЕсли Учет = "Нал" Тогда
		Ст.Вставить("СчетУчетаНУ", ПараметрыСостоянияИсточника.СчетУчета);
	ИначеЕсли Учет = "Меж" Тогда
		Ст.Вставить("СчетУчетаМУ", ПараметрыСостоянияИсточника.СчетУчета);
	КонецЕсли;
	
	// Найдем уже выполненные движения по списанию из этого состояния
	ВыпДвижения = СтруктураДопПараметров.ТаблицаВыполненныхДвижений.НайтиСтроки(Ст);
	
	//начало изменений в связ и с исменееия по корректировкам будем уходить в минус
	_КолВоСписано = 0;
	//начало изменений Ожиганов А. 15.02.2017 62276 закрытие транспортных расходов только по ну 
	_КолВоСписаноСучетомЗнака = 0;
	//конец изменений 
	Для Каждого ВыпДвижение Из ВыпДвижения Цикл
		Если ПРГ_НовыеПравила Тогда
			_КолВоСписано = _КолВоСписано + ВыпДвижение.Количество*?(ВыпДвижение.Количество<0,-1,1);
			//начало изменений Ожиганов А. 15.02.2017 исправление копеек при равном количество прихода и списания 
			_КолВоСписаноСучетомЗнака = _КолВоСписаноСучетомЗнака+ВыпДвижение.Количество;
			//конец изменений 
		Иначе	
			_КолВоСписано = _КолВоСписано + ВыпДвижение.Количество;
		КонецЕсли;	
	КонецЦикла;	
	Попытка
		//начало изменений Ожиганов А. 15.02.2017 исправление копеек при равном количество прихода и списания 
		Если ПРГ_УчитыватьКолВоСознаком  Тогда 
			если _КолВоСписано > Количество и Количество > 0 и (_КолВоСписаноСучетомЗнака>Количество) тогда
				 Для Каждого ЭлСтоимость Из СтСтоимость Цикл
					 СтСтоимость[ЭлСтоимость.Ключ] = СтСтоимость[ЭлСтоимость.Ключ]/Количество*_КолВоСписано
				 КонецЦикла;	
			КонецЕсли; 
		//конец изменений 
		//Если _КолВоСписано > Количество и Количество > 0 Тогда
		иначеЕсли _КолВоСписано > Количество и Количество > 0 Тогда
		//конец изменений 			
			Для Каждого ЭлСтоимость Из СтСтоимость Цикл
				 СтСтоимость[ЭлСтоимость.Ключ] = СтСтоимость[ЭлСтоимость.Ключ]/Количество*_КолВоСписано
			КонецЦикла;	
			//СтСтоимость.Стоимость  = СтСтоимость.Стоимость/Количество*_КолВоСписано;
			Количество = _КолВоСписано;
		КонецЕсли;	
	Исключение
		Сообщить(_КолВоСписано);
	КонецПопытки;
	//конец изменений  
	
	Для Каждого ВыпДвижение Из ВыпДвижения Цикл
		
		Если Количество=0 Тогда
			Продолжить;
		КонецЕсли;
		
		//начало изменений 
		Попытка
			Если ВыпДвижение.Количество<Количество Тогда
				КоэффСписания = ВыпДвижение.Количество/Количество;
			Иначе
				КоэффСписания = 1;
			КонецЕсли;
		Исключение
			
		КонецПопытки;
		
		ВыполнятьДвижения = Ложь;	// Если корректировать нечего, движений не добавляем

		СтСредней = Новый Структура; // структура разницы между 
		Для Каждого ЭлСтоимость Из СтСтоимость Цикл
			
			СуммаПоСредней = Окр(СтСтоимость[ЭлСтоимость.Ключ]*КоэффСписания, 2);
			
			СтСредней.Вставить(ЭлСтоимость.Ключ, СуммаПоСредней);
			
			СтСтоимость[ЭлСтоимость.Ключ] = СтСтоимость[ЭлСтоимость.Ключ] - СтСредней[ЭлСтоимость.Ключ]; // уменьшение стоимости в состоянии-источнике
			
			Если СуммаПоСредней - ВыпДвижение[ЭлСтоимость.Ключ]<>0 Тогда  // корректировка на разницу между списание по-средней и фактическим
				ВыполнятьДвижения = Истина;
			КонецЕсли;
			
		КонецЦикла;
		
		Количество = Количество - ВыпДвижение.Количество;
		
		Если НЕ ВыполнятьДвижения Тогда
			Продолжить;
		КонецЕсли;
		
		Если Источник =  "ВЭксплуатации" Тогда
			//Вызов специальной процедуры производственного учета для формирования движений
			СтруктраСумм = Новый Структура();
			// Перенос корректировки сумм в движение
			Для Каждого ЭлСтоимость Из СтСтоимость Цикл
				СтруктраСумм.Вставить(ЭлСтоимость.Ключ, СтСредней[ЭлСтоимость.Ключ] - ВыпДвижение[ЭлСтоимость.Ключ]); // корректировка на разницу между списанием по-средней и фактическим
			КонецЦикла;
			//СформироватьДвиженияСписанияПоМатериаламВЭксплуатации(ПараметрыСостоянияИсточника,ВыпДвижение.КодОперацииПартииТоваров,СтруктраСумм, СтруктураДопПараметров);
		Иначе
		
			Движение              = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров(ИмяРег+Учет, СтруктураДопПараметров);
			Движение.Период       = СтруктураДопПараметров.Период;
			Движение.ВидДвижения  = ВидДвиженияНакопления.Расход;
			
			Движение.Номенклатура = ПараметрыСостоянияИсточника.Номенклатура;
			Движение.ХарактеристикаНоменклатуры = ПараметрыСостоянияИсточника.ХарактеристикаНоменклатуры;
			
			Если Источник =  "НаСкладах" Тогда
				Движение.Склад      = ПараметрыСостоянияИсточника.Склад;
				Движение.Заказ      = ПараметрыСостоянияИсточника.Заказ;
				Движение.СерияНоменклатуры = ПараметрыСостоянияИсточника.СерияНоменклатуры;
				Движение.Качество = ПараметрыСостоянияИсточника.Качество;
				Если Учет = "Упр" Тогда
					Движение.СтатусПартии = ПараметрыСостоянияИсточника.СтатусПартии;
				КонецЕсли;
				
			Иначе
				Движение.ДоговорКонтрагента      = ПараметрыСостоянияИсточника.ДоговорКонтрагента;
				Движение.ДокументПередачи = ПараметрыСостоянияИсточника.ДокументПередачи;
				Если Учет = "Упр" Тогда
					Движение.СтатусПередачи = ПараметрыСостоянияИсточника.СтатусПередачи;
					Движение.СтатусПартии = ПараметрыСостоянияИсточника.СтатусПартии;
				КонецЕсли;
			КонецЕсли;
			
			Движение.ДокументОприходования = ПараметрыСостоянияИсточника.ДокументОприходования;
			Движение.Организация = ПараметрыСостоянияИсточника.Организация;
			
			Если Учет = "Упр" Тогда
				Движение.СтатусПартии = ПараметрыСостоянияИсточника.СтатусПартии;
			ИначеЕсли Учет = "Бух" Тогда
				Движение.СчетУчета = ПараметрыСостоянияИсточника.СчетУчета;
			ИначеЕсли Учет = "Нал" Тогда
				Движение.СчетУчета = ПараметрыСостоянияИсточника.СчетУчета;
			ИначеЕсли Учет = "Меж" Тогда
				Движение.СчетУчета = ПараметрыСостоянияИсточника.СчетУчета;
				
			КонецЕсли;
			
			Движение.Количество   = 0;
			
			// Перенос корректировки сумм в движение
			Для Каждого ЭлСтоимость Из СтСтоимость Цикл
				Движение[ЭлСтоимость.Ключ]    = СтСредней[ЭлСтоимость.Ключ] - ВыпДвижение[ЭлСтоимость.Ключ]; // корректировка на разницу между списанием по-средней и фактическим
			КонецЦикла;
			
			Движение.КодОперации = ВыпДвижение.КодОперацииПартииТоваров;
			
			// При внешнем списании оставляем ссылку на исходное движение
			Движение.ДокументДвиженияПериод = ВыпДвижение.Период;
			Движение.ДокументДвижения = ВыпДвижение.Регистратор;
			Движение.НомерСтрокиСписанныхТоваров = ВыпДвижение.НомерСтрокиСписанныхТоваров;
			
			//начало изменений
			Если   ВычислятьСпособВедения Тогда
				СпособВеденияПартионногоУчетаПоОрганизации = УправлениеЗапасами.ПолучитьСпособВеденияПартионногоУчетаПоОрганизации(Движение.Организация, Движение.Период);
				СтруктураДопПараметров.Вставить("ОрганизацияУпр", УправлениеЗапасами.ПолучитьОрганизациюВСоответствииСоСпособомВеденияПартионногоУчетаПоОрганизациям(Движение.Организация,СпособВеденияПартионногоУчетаПоОрганизации));
			КонецЕсли;	
			//конец изменений 
				
			
			Если НЕ ВыпДвижение.СерияНоменклтатурыНЗП = Неопределено Тогда
				ВыпДвижение.СерияНоменклатуры = ВыпДвижение.СерияНоменклтатурыНЗП;
			КонецЕсли;
			
			ВыполнитьКорДвижение(Источник, ВыпДвижение, СтруктураДопПараметров, Движение);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры // ДобавитьЗаписиПоВнешнемуСписанию()

// Процедура вызова корректировки списания
//
Процедура СкорректироватьСписание(ДатаНач, ДатаКон, ТаблицаТоваров, РегламентныйДокумент, СтруктураПараметров,
	//начало изменений 
	ОтладочныйРежим = Ложь
	//начало изменений  
		)
	
	Перем НеСписыватьНаПостоянныеЗатраты;
	
	ДопПараметры = Новый Структура;
	
	// Перенесем ключи и значения из исходной структуры
	Для Каждого Элемент Из СтруктураПараметров Цикл
		ДопПараметры.Вставить(Элемент.Ключ, Элемент.Значение);
	КонецЦикла;
		
	// Приведение к нужному виду
	ДопПараметры.Свойство("НеСписыватьНаПостоянныеЗатраты", НеСписыватьНаПостоянныеЗатраты);
	Если НеСписыватьНаПостоянныеЗатраты = Истина Тогда
		ДопПараметры.Вставить("НеСписыватьНаПостоянныеЗатраты", Истина);
	Иначе
		ДопПараметры.Вставить("НеСписыватьНаПостоянныеЗатраты", Ложь);
	КонецЕсли;
	
	КодыОпераций = Перечисления.КодыОперацийПартииТоваров;
	
	// Сформируем запрос для получения фактических движений 
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДатаНач", ДатаНач);
	Запрос.УстановитьПараметр("ДатаКон", ДатаКон);
	Запрос.УстановитьПараметр("ВидДвиженияРасход", ВидДвиженияНакопления.Расход);
	
	МассивНоменклатуры = ТаблицаТоваров.ВыгрузитьКолонку("Номенклатура");
		
	МассивДокументовОприходования = ТаблицаТоваров.ВыгрузитьКолонку("ДокументОприходования");
	
	МассивНоменклатуры = ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(МассивНоменклатуры);
	
	Запрос.УстановитьПараметр("МассивНоменклатуры", МассивНоменклатуры);
	Запрос.УстановитьПараметр("МассивДокументовОприходования", МассивДокументовОприходования);
	
	// Формирование запроса по списанию
	
	// Коды операции, применяются во всех учетах
	
	МассивСписаниеВНЗП = Новый Массив;
	МассивСписаниеВНЗП.Добавить(КодыОпераций.СписаниеПартийВПроизводствоОперативно);
	
	Запрос.УстановитьПараметр("КодыСписаниеВНЗП", МассивСписаниеВНЗП);
	
	Запрос.УстановитьПараметр("СписаниеПартийПереданныхВПроизводство", КодыОпераций.СписаниеПартийПереданныхВПроизводство);
	
	МассивСписаниеНаСебестоимость = Новый Массив;
	МассивСписаниеНаСебестоимость.Добавить(КодыОпераций.Реализация);
	МассивСписаниеНаСебестоимость.Добавить(КодыОпераций.РеализацияКомиссия);
	МассивСписаниеНаСебестоимость.Добавить(КодыОпераций.РеализацияРозница);
	Запрос.УстановитьПараметр("КодыСписаниеНаСебестоимость", МассивСписаниеНаСебестоимость);
	
	Запрос.УстановитьПараметр("КодыСписаниеНаЗатраты", КодыОпераций.СписаниеНаЗатраты);
	
	Запрос.УстановитьПараметр("КодыСписаниеНаБрак", КодыОпераций.СписаниеНаБрак);
	
	МассивЗатратыОС = Новый Массив;
	МассивЗатратыОС.Добавить(КодыОпераций.СписаниеНаСтроительствоОбъектовОС);
	МассивЗатратыОС.Добавить(КодыОпераций.СписаниеНаВложенияВоВнеоборотныеАктивы);
	
	Запрос.УстановитьПараметр("КодыСтроительствоОбъектовОС", МассивЗатратыОС);
	Запрос.УстановитьПараметр("КодКомплектация", КодыОпераций.Комплектация);
	
	//начало изменений Ожиганов 05.05.2015 изменения по браку 
	ДопПараметры.Вставить("ПРГРассчВозвратПост",ПРГКорректироватьВозвратыПоставщику(ДопПараметры,ДатаКон));
	//конец изменений 
	
	
	//начало изменений Ожиганов 22.03.2016 оптимизируем запрос 	
	КодыСписаниеИспВсеТабл = Новый Массив;
	КодыСписаниеНеВсеТабл = Новый Массив;
	//конец изменений 
	
	// Все коды внешних списаний
	МассивВнешСписание = Новый Массив;
	
	Если СтруктураПараметров.Свойство("КорректироватьСтоимостьВозвратовТекущегоМесяца") тогда
		// Возврат текущего месяца корректируется как реализация
		МассивВнешСписание.Добавить(КодыОпераций.ВозвратОтПокупателяТекущийМесяц);
		// is ЯннуровВФ нач 20140801 Все возараты расход с минусом
		Если СтруктураПараметров.Свойство("ОтражатьВМеждународномУчете") И СтруктураПараметров.ОтражатьВМеждународномУчете Тогда 
			МассивВнешСписание.Добавить(КодыОпераций.ВозвратОтПокупателя);
		КонецЕсли;
		// is ЯннуровВФ кон 20140801
	Иначе
		МассивВнешСписание.Добавить(КодыОпераций.Комплектация);
		//начало изменений
		//МассивВнешСписание.Добавить(КодыОпераций.ПередачаТарыКонтрагенту);
		//конец изменений
		МассивВнешСписание.Добавить(КодыОпераций.Реализация);
		МассивВнешСписание.Добавить(КодыОпераций.РеализацияКомиссия);
		МассивВнешСписание.Добавить(КодыОпераций.РеализацияРозница);
		
		//начало изменений Ожиганов 05.05.2015 изменения по браку 
		Если ДопПараметры.ПРГРассчВозвратПост Тогда
			МассивВнешСписание.Добавить(КодыОпераций.ВозвратПоставщику);
		КонецЕсли;	
		//конец изменений 

		МассивВнешСписание.Добавить(КодыОпераций.СписаниеПоИнвентаризации);
		МассивВнешСписание.Добавить(КодыОпераций.СписаниеПоОрдеру);
		МассивВнешСписание.Добавить(КодыОпераций.СписаниеПартийВПроизводствоОперативно);
		
		//начало изменений оптим р/с
		Если СтруктураПараметров.ЕстьСтрокиОтражатьВБухгалтерскомУчете
			или СтруктураПараметров.ЕстьСтрокиОтражатьВНалоговомУчете Тогда
		     МассивВнешСписание.Добавить(КодыОпераций.ВозвратОтПокупателяТекущийМесяц);
		КонецЕсли;	
		//конец изменений

		МассивВнешСписание.Добавить(КодыОпераций.СписаниеНаСтроительствоОбъектовОС);
		МассивВнешСписание.Добавить(КодыОпераций.СписаниеНаВложенияВоВнеоборотныеАктивы);
		МассивВнешСписание.Добавить(КодыОпераций.СписаниеПартийПереданныхВПроизводство);
		//МассивВнешСписание.Добавить(КодыОпераций.ПередачаМатериаловВЭксплуатацию);
		МассивВнешСписание.Добавить(КодыОпераций.СписаниеНаБрак);
		МассивВнешСписание.Добавить(КодыОпераций.СписаниеНаЗатраты);
		
		МассивВнешСписание.Добавить(Перечисления.КодыОперацийПартииМатериаловВЭксплуатации.СписаниеИзЭксплуатации);
		//МассивВнешСписание.Добавить(Перечисления.КодыОперацийПартииМатериаловВЭксплуатации.ПогашениеСтоимости);
		
		//начало изменений 53363 формирование проводок при возрате тары по залоговой стоимости  
		МассивВнешСписание.Добавить(КодыОпераций.ПередачаТарыЗалогСтоимость);
		МассивВнешСписание.Добавить(КодыОпераций.ВозвратТарыЗалогСтоимостьТекущийМесяц);
		//конец изменений 
		
		//начало изменений Ожиганов 22.03.2016 оптимизируем запрос 		
		КодыСписаниеИспВсеТабл = Новый Массив;
		КодыСписаниеИспВсеТабл.Добавить(КодыОпераций.СписаниеПоИнвентаризации);
		КодыСписаниеИспВсеТабл.Добавить(КодыОпераций.СписаниеПоОрдеру);
		КодыСписаниеИспВсеТабл.Добавить(КодыОпераций.ВозвратПоставщику);
		КодыСписаниеИспВсеТабл.Добавить(КодыОпераций.Комплектация);
		КодыСписаниеИспВсеТабл.Добавить(КодыОпераций.СписаниеПартийПереданныхВПроизводство);
		//начало изменений 53363 формирование проводок при возрате тары по залоговой стоимости  
		КодыСписаниеИспВсеТабл.Добавить(КодыОпераций.ПередачаТарыЗалогСтоимость);
		КодыСписаниеИспВсеТабл.Добавить(КодыОпераций.ВозвратТарыЗалогСтоимостьТекущийМесяц);
		//конец изменений 
		//КодыСписаниеИспВсеТабл.Добавить(КодыОпераций.ПередачаМатериаловВЭксплуатацию);
		
		КодыСписаниеНеВсеТабл 	= Новый Массив;
		КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.Реализация);
		КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.РеализацияКомиссия);
		КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.РеализацияРозница);
	    КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.ВозвратОтПокупателяТекущийМесяц);
		КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.СписаниеПартийВПроизводствоОперативно);
		КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.СписаниеНаЗатраты);
		КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.СписаниеНаБрак);
		КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.СписаниеНаСтроительствоОбъектовОС);
		КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.СписаниеНаВложенияВоВнеоборотныеАктивы);		
		//конец изменений 
	КонецЕсли;
	
	//начало изменений Ожиганов 22.03.2016 оптимизируем запрос 	
	Запрос.УстановитьПараметр("КодыСписаниеИспВсеТабл", КодыСписаниеИспВсеТабл);
	Запрос.УстановитьПараметр("КодыСписаниеНеВсеТабл", КодыСписаниеНеВсеТабл);	
	//конец изменений 
	Запрос.УстановитьПараметр("КодыСписание", МассивВнешСписание);
	
	Запрос.УстановитьПараметр("КодПередачаМатериалов", КодыОпераций.ПередачаМатериаловВЭксплуатацию);
	//начало изменений
	Запрос.УстановитьПараметр("_КодОперацииКоплектации", КодыОпераций.Комплектация);
	//конец изменений

	ДопПараметры.Вставить("УчетнаяПолитика", 
			УправлениеЗапасамиПартионныйУчет.ПолучитьУчетнуюПолитику(ДатаКон, 
					ДопПараметры.ОтражатьВУправленческомУчете, 
					ДопПараметры.ОтражатьВБухгалтерскомУчете,
					ДопПараметры.ОтражатьВНалоговомУчете,
					ДопПараметры.ОтражатьВМеждународномУчете,
					СтруктураПараметров.Организация));
	Если ДопПараметры.УчетнаяПолитика = Неопределено Тогда
		Возврат;
	КонецЕсли;	
	
	//начало изменений Ожиганов 20.10.2015 изменении качества при комплектации, учтем как перемещение
	ДопПараметры.Вставить("ПРГ_УчитыватьКомплКакПеремИзмКачества",Ложь);
	Если ДопПараметры.ОтражатьВБухгалтерскомУчете или ДопПараметры.ОтражатьВНалоговомУчете 
	 //  или  ДопПараметры.ОтражатьВМеждународномУчете
	 и ДатаКон >='20151001'
	 
	Тогда
	    //вставить ограничение по датам
		ДопПараметры.Вставить("ПРГ_УчитыватьКомплКакПеремИзмКачества",Истина);
	Иначе
	
	КонецЕслИ;
	//конец изменений 
	
 	СкорректироватьСписаниеУпр(Запрос, МассивНоменклатуры, ДатаНач, ДатаКон, ТаблицаТоваров, РегламентныйДокумент, ДопПараметры);
	
	//начало изменений 
	//СкорректироватьСписаниеРегл(Запрос, МассивНоменклатуры, ДатаНач, ДатаКон, ТаблицаТоваров, РегламентныйДокумент, ДопПараметры);
	
	СкорректироватьСписаниеРегл(Запрос, МассивНоменклатуры, ДатаНач, ДатаКон, ТаблицаТоваров, РегламентныйДокумент, ДопПараметры,ОтладочныйРежим);
	//конец изменений  
	//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  
	Если ДопПараметры.Свойство("ПРГ_Запрос_Таб_Перемещения") Тогда
		Если  ТипЗнч(СтруктураПараметров) = Тип("Структура") Тогда
			СтруктураПараметров.Вставить("ПРГ_Запрос_Таб_Перемещения",ДопПараметры.ПРГ_Запрос_Таб_Перемещения);
		КонецЕсли;	
	КонецЕсли;	
	//конец изменений 
	
	СкорректироватьСписаниеМеж(Запрос, МассивНоменклатуры, ДатаНач, ДатаКон, ТаблицаТоваров, РегламентныйДокумент, ДопПараметры);
	
	// Возврат выполненных движений для расчета себестоимости
	Если ТипЗнч(СтруктураПараметров) = Тип("Структура") Тогда
		Если СтруктураПараметров.Свойство("ВернутьДвижения") Тогда
			Для Каждого Регистр Из СтруктураПараметров.ВернутьДвижения Цикл
				
				// В структуре СтруктураПараметров.ВернутьДвижения ключами заданы имена таблиц движений
				Если ДопПараметры.Свойство(Регистр.Ключ) Тогда
					
					ТаблицаДвижений = ДопПараметры[Регистр.Ключ].Скопировать();
					
					// Сворачивание движений
					Если Регистр.Ключ = "ТаблицаДвиженийНезавершенноеПроизводствоБух" Тогда
						ОбщегоНазначения.СвернутьТаблицуДвиженийРегистраНакопления("НезавершенноеПроизводствоБухгалтерскийУчет", ТаблицаДвижений, Истина);
					ИначеЕсли Регистр.Ключ = "ТаблицаДвиженийНезавершенноеПроизводствоУпр" Тогда
						ОбщегоНазначения.СвернутьТаблицуДвиженийРегистраНакопления("НезавершенноеПроизводство",                  ТаблицаДвижений, Истина);
					ИначеЕсли Регистр.Ключ = "ТаблицаДвиженийНезавершенноеПроизводствоНал" Тогда
						ОбщегоНазначения.СвернутьТаблицуДвиженийРегистраНакопления("НезавершенноеПроизводствоНалоговыйУчет",     ТаблицаДвижений, Истина);
					ИначеЕсли Регистр.Ключ = "ТаблицаДвиженийНезавершенноеПроизводствоМеж" Тогда
						ОбщегоНазначения.СвернутьТаблицуДвиженийРегистраНакопления("НезавершенноеПроизводствоМеждународныйУчет", ТаблицаДвижений, Истина);
					КонецЕсли;
					
					СтруктураПараметров.ВернутьДвижения.Вставить(Регистр.Ключ, ТаблицаДвижений);
					
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры//СкорректироватьСписание()

// Приведение таблицы корректировки списания к требуемому виду
//
Процедура ПодготовитьТаблицуКорректировкиСписания(ТаблицаРезультатаЗапроса)
	
	ДобавляемыеПоля = "ОтражатьВУправленческомУчете,ОтражатьВБухгалтерскомУчете,ОтражатьВНалоговомУчете,
					  |ОтражатьВМеждународномУчете,НоменклатураНовая,КоличествоПоступление,СкладПолучатель,
					  |ИзменитьХарактеристику,ИзменитьСерию,ИзменитьСклад,КачествоНовое,СтатусПартииНовый,
					  |ВедениеУчетаПоПроектам, ЗаказПартии";
	СтруктураДобавляемыхПолей = Новый Структура(ДобавляемыеПоля,"Булево","Булево","Булево","Булево",,"Число",,"Булево","Булево","Булево",,,"Булево");
	
	Для Каждого Поле Из СтруктураДобавляемыхПолей цикл 
		Если ТаблицаРезультатаЗапроса.Колонки.Найти(Поле.Ключ) = Неопределено Тогда
			Если НЕ ЗначениеЗаполнено(Поле.Значение) тогда
				ТипПоля = Неопределено;
			Иначе
				ТипПоля = Новый ОписаниеТипов(Поле.Значение);
			КонецЕсли;
			ТаблицаРезультатаЗапроса.Колонки.Добавить(Поле.Ключ, ТипПоля);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры // ПодготовитьТаблицуКорректировкиСписания()

// Корректировка списания по упр учету
//
// Параметры:
//	Нет.
//
Процедура СкорректироватьСписаниеУпр(Запрос, МассивНоменклатуры, ДатаНач, ДатаКон, ТаблицаТоваров, РегламентныйДокумент, ДопПараметры)
	
	Перем ПериодЗаписей;
	
	Если ДопПараметры.ОтражатьВУправленческомУчете Тогда
		
		ЗаполнитьЗапросПоСписаниюУпр(Запрос, МассивНоменклатуры, ДопПараметры);
		
		// Таблица по списанию
		ТаблицаРезультатаЗапроса = Запрос.Выполнить().Выгрузить();
		
		Если ТаблицаРезультатаЗапроса.Количество()=0 Тогда
			// Пустая строка для создния требуемых наборов записей, когда есть перемещения без списания
			ТаблицаРезультатаЗапроса.Добавить();
		КонецЕсли;
		
		ПодготовитьТаблицуКорректировкиСписания(ТаблицаРезультатаЗапроса);
		ТаблицаРезультатаЗапроса.ЗаполнитьЗначения(Истина, "ОтражатьВУправленческомУчете");
		
		// Структура общих параметров
		СтруктураПараметров = ДопПараметры;
		
		// Признак учета, используемый в общих процедурах
		СтруктураПараметров.Вставить("Учет", "Упр");
		СтруктураПараметров.Вставить("ИмяРегистраСклад",      "ПартииТоваровНаСкладах");
		СтруктураПараметров.Вставить("ИмяРегистраПереданные", "ПартииТоваровПереданные");
		СтруктураПараметров.Вставить("ИмяРегистраВЭксплуатации", "ПартииМатериаловВЭксплуатации");
		
		
		СтруктураПараметров.Вставить("ТаблицаВыполненныхДвижений", ТаблицаРезультатаЗапроса);
		СтруктураПараметров.Вставить("ТаблицаТоваров", ТаблицаТоваров);
		
		СтруктураПараметров.Вставить("РегламентныйДокумент", РегламентныйДокумент);
		
		// Движения - наборы записей по регистрам
		УправлениеЗапасамиПартионныйУчет.СоздатьНаборыЗаписей(СтруктураПараметров, ТаблицаРезультатаЗапроса, РегламентныйДокумент);
		
		Если НЕ ДопПараметры.Свойство("Период", ПериодЗаписей) Тогда
			
			Если РегламентныйДокумент.Метаданные().Реквизиты.Найти("ПериодРегистрации") <> Неопределено Тогда
				ПериодЗаписей = КонецМесяца(РегламентныйДокумент.ПериодРегистрации);
			Иначе
				ПериодЗаписей = РегламентныйДокумент.Дата;
			КонецЕсли;
			
		КонецЕсли;
		
		УправлениеЗапасамиПартионныйУчет.ПодготовитьНаборыЗаписей(СтруктураПараметров, ТаблицаРезультатаЗапроса, ПериодЗаписей, РегламентныйДокумент, Ложь);
		
		// Вызов процедуры расчета по средней
		РассчитатьСписаниеПоСредней(ТаблицаТоваров, ДатаНач, ДатаКон, СтруктураПараметров);
		
		УправлениеЗапасамиПартионныйУчет.ЗаписатьДвиженияДокумента(СтруктураПараметров, ТаблицаРезультатаЗапроса, Ложь);
	КонецЕсли;
	
КонецПроцедуры // СкорректироватьСписаниеУпр()

// Корректировка списания по бух и нал учету
//
// Параметры:
//	Нет.
//
Процедура СкорректироватьСписаниеРегл(Запрос, МассивНоменклатуры, ДатаНач, ДатаКон, ТаблицаТоваров, РегламентныйДокумент, ДопПараметры,
	ОтладочныйРежим=Ложь)
	
	Перем ПериодЗаписей;
	
	// Бух
	Если ДопПараметры.ОтражатьВБухгалтерскомУчете Тогда
		
		//начало изменений опти р/с
		ПРГ_ТолькоНаЗатратыВлНаСеб = Ложь;
		Если ДопПараметры.Свойство("ПРГ_ТолькоНаЗатратыВлНаСеб",ПРГ_ТолькоНаЗатратыВлНаСеб) и ПРГ_ТолькоНаЗатратыВлНаСеб Тогда
			ЗаполнитьЗапросПоСписаниюБух(Запрос, МассивНоменклатуры, ДопПараметры,Истина);
			ПРГ_ЗаполнитьДопПарметрыЗапроса(Запрос,Истина);
		//	ДопПараметры.Удалить("ПРГ_ТолькоНаЗатратыВлНаСеб");
		Иначе	
			ЗаполнитьЗапросПоСписаниюБух(Запрос, МассивНоменклатуры, ДопПараметры);
		КонецЕсли;	
		//Начало изменеий
		Если ДатаКон >= '20150301'Тогда
			Запрос.Текст	= СтрЗаменить(Запрос.Текст,"//@ИсклКомпл","");
		КонецЕсли;	
		//конец изменений
		
		//конец изменений 
		
		// Таблица по списанию
		ТаблицаРезультатаЗапроса = Запрос.Выполнить().Выгрузить();
		
		Если ТаблицаРезультатаЗапроса.Количество()=0 Тогда
			// Пустая строка для создния требуемых наборов записей, когда есть перемещения без списания
			ТаблицаРезультатаЗапроса.Добавить();
		КонецЕсли;
		
		
		ПодготовитьТаблицуКорректировкиСписания(ТаблицаРезультатаЗапроса);
		
		ТаблицаРезультатаЗапроса.ЗаполнитьЗначения(Истина, "ОтражатьВБухгалтерскомУчете");
		ТаблицаРезультатаЗапроса.Колонки.Добавить("ПринятыеКорСчетБУ"); // колонка используется только для приведения к стандартному виду
		ТаблицаРезультатаЗапроса.Колонки.Добавить("ПринятыеСчетУчетаБУ"); // колонка используется только для приведения к стандартному виду
		
		// Структура общих параметров
		СтруктураПараметров = ДопПараметры;
		
		// Признак учета, используемый в общих процедурах
		СтруктураПараметров.Вставить("Учет", "Бух");
		СтруктураПараметров.Вставить("ИмяРегистраСклад",      "ПартииТоваровНаСкладахБухгалтерскийУчет");
		СтруктураПараметров.Вставить("ИмяРегистраПереданные", "ПартииТоваровПереданныеБухгалтерскийУчет");
		СтруктураПараметров.Вставить("ИмяРегистраВЭксплуатации", "ПартииМатериаловВЭксплуатацииБухгалтерскийУчет");
		
		СтруктураПараметров.Вставить("ТаблицаВыполненныхДвижений", ТаблицаРезультатаЗапроса);
		СтруктураПараметров.Вставить("ТаблицаТоваров", ТаблицаТоваров);
		
		СтруктураПараметров.Вставить("РегламентныйДокумент", РегламентныйДокумент);
		
		// Движения - наборы записей по регистрам
		УправлениеЗапасамиПартионныйУчет.СоздатьНаборыЗаписей(СтруктураПараметров, ТаблицаРезультатаЗапроса, РегламентныйДокумент);
		
		Если НЕ ДопПараметры.Свойство("Период", ПериодЗаписей) Тогда
			
			Если РегламентныйДокумент.Метаданные().Реквизиты.Найти("ПериодРегистрации") <> Неопределено Тогда
				ПериодЗаписей = КонецМесяца(РегламентныйДокумент.ПериодРегистрации);
			Иначе
				ПериодЗаписей = РегламентныйДокумент.Дата;
			КонецЕсли;
			
		КонецЕсли;
		
		УправлениеЗапасамиПартионныйУчет.ПодготовитьНаборыЗаписей(СтруктураПараметров, ТаблицаРезультатаЗапроса, ПериодЗаписей, РегламентныйДокумент, Ложь);
		
		// Вызов процедуры расчета по средней
		РассчитатьСписаниеПоСредней(ТаблицаТоваров, ДатаНач, ДатаКон, СтруктураПараметров);
		
		УправлениеЗапасамиПартионныйУчет.ЗаписатьДвиженияДокумента(СтруктураПараметров, ТаблицаРезультатаЗапроса, Ложь);
	КонецЕсли;
	
	// Нал
	Если ДопПараметры.ОтражатьВНалоговомУчете Тогда
		
		//начало изменений оптим р/с
		//ЗаполнитьЗапросПоСписаниюНал(Запрос, МассивНоменклатуры, ДопПараметры);
		ПРГ_ТолькоНаЗатратыВлНаСеб = Ложь;
		Если ДопПараметры.Свойство("ПРГ_ТолькоНаЗатратыВлНаСеб",ПРГ_ТолькоНаЗатратыВлНаСеб) и ПРГ_ТолькоНаЗатратыВлНаСеб Тогда
			ЗаполнитьЗапросПоСписаниюНал(Запрос, МассивНоменклатуры, ДопПараметры,Истина);
			ПРГ_ЗаполнитьДопПарметрыЗапроса(Запрос,Ложь);
		//	ДопПараметры.Удалить("ПРГ_ТолькоНаЗатратыВлНаСеб");
		Иначе	
			ЗаполнитьЗапросПоСписаниюНал(Запрос, МассивНоменклатуры, ДопПараметры);
		КонецЕсли;	
		//конец изменений
		
		//Начало изменеий
		Если ДатаКон >= '20150301'Тогда
			Запрос.Текст	= СтрЗаменить(Запрос.Текст,"//@ИсклКомпл","");
		КонецЕсли;	
		//конец изменений
		
		// Таблица по списанию
		ТаблицаРезультатаЗапроса = Запрос.Выполнить().Выгрузить();
		
		Если ТаблицаРезультатаЗапроса.Количество()=0 Тогда
			// Пустая строка для создния требуемых наборов записей, когда есть перемещения без списания
			ТаблицаРезультатаЗапроса.Добавить();
		КонецЕсли;
		
		ПодготовитьТаблицуКорректировкиСписания(ТаблицаРезультатаЗапроса);
		ТаблицаРезультатаЗапроса.ЗаполнитьЗначения(Истина, "ОтражатьВНалоговомУчете");
		ТаблицаРезультатаЗапроса.Колонки.Добавить("ПринятыеСчетУчетаНУ"); // колонка используется только для приведения к стандартному виду
		
		// Структура общих параметров
		СтруктураПараметров = ДопПараметры;
		
		// Признак учета, используемый в общих процедурах
		СтруктураПараметров.Вставить("Учет", "Нал");
		СтруктураПараметров.Вставить("ИмяРегистраСклад",      "ПартииТоваровНаСкладахНалоговыйУчет");
		СтруктураПараметров.Вставить("ИмяРегистраПереданные", "ПартииТоваровПереданныеНалоговыйУчет");
		СтруктураПараметров.Вставить("ИмяРегистраВЭксплуатации", "ПартииМатериаловВЭксплуатацииНалоговыйУчет");
		
		СтруктураПараметров.Вставить("УчетнаяПолитика", 
				УправлениеЗапасамиПартионныйУчет.ПолучитьУчетнуюПолитику(ДатаКон, 
						СтруктураПараметров.ОтражатьВУправленческомУчете, 
						СтруктураПараметров.ОтражатьВБухгалтерскомУчете,
						СтруктураПараметров.ОтражатьВНалоговомУчете,
						СтруктураПараметров.ОтражатьВМеждународномУчете,
						СтруктураПараметров.Организация));
		Если СтруктураПараметров.УчетнаяПолитика = Неопределено Тогда
			Возврат;
		КонецЕсли;	
		
		СтруктураПараметров.Вставить("ТаблицаВыполненныхДвижений", ТаблицаРезультатаЗапроса);
		СтруктураПараметров.Вставить("ТаблицаТоваров", ТаблицаТоваров);
		
		СтруктураПараметров.Вставить("РегламентныйДокумент", РегламентныйДокумент);
		
		МассивСумм = Новый Массив;
		МассивСумм.Добавить("Стоимость");
		МассивСумм.Добавить("ПостояннаяРазница");
		МассивСумм.Добавить("ВременнаяРазница");
		СтруктураПараметров.Вставить("МассивСумм", МассивСумм);
		
		// Движения - наборы записей по регистрам
		УправлениеЗапасамиПартионныйУчет.СоздатьНаборыЗаписей(СтруктураПараметров, ТаблицаРезультатаЗапроса, РегламентныйДокумент);
		
		Если НЕ ДопПараметры.Свойство("Период", ПериодЗаписей) Тогда
			
			Если РегламентныйДокумент.Метаданные().Реквизиты.Найти("ПериодРегистрации") <> Неопределено Тогда
				ПериодЗаписей = КонецМесяца(РегламентныйДокумент.ПериодРегистрации);
			Иначе
				ПериодЗаписей = РегламентныйДокумент.Дата;
			КонецЕсли;
			
		КонецЕсли;
		
		УправлениеЗапасамиПартионныйУчет.ПодготовитьНаборыЗаписей(СтруктураПараметров, ТаблицаРезультатаЗапроса, ПериодЗаписей, РегламентныйДокумент, Ложь);
		
		// Вызов процедуры расчета по средней
		РассчитатьСписаниеПоСредней(ТаблицаТоваров, ДатаНач, ДатаКон, СтруктураПараметров);
		
		УправлениеЗапасамиПартионныйУчет.ЗаписатьДвиженияДокумента(СтруктураПараметров, ТаблицаРезультатаЗапроса, Ложь);
	КонецЕсли;
	
КонецПроцедуры // СкорректироватьСписаниеРегл()

// Корректировка списания по меж учету
//
// Параметры:
//	Нет.
//
Процедура СкорректироватьСписаниеМеж(Запрос, МассивНоменклатуры, ДатаНач, ДатаКон, ТаблицаТоваров, РегламентныйДокумент, ДопПараметры)
	
	Перем ПериодЗаписей;
	
	Если ДопПараметры.ОтражатьВМеждународномУчете Тогда
		
		ЗаполнитьЗапросПоСписаниюМеж(Запрос, МассивНоменклатуры, ДопПараметры);
		
		// Таблица по списанию
		ТаблицаРезультатаЗапроса = Запрос.Выполнить().Выгрузить();
		
		Если ТаблицаРезультатаЗапроса.Количество()=0 Тогда
			// Пустая строка для создния требуемых наборов записей, когда есть перемещения без списания
			ТаблицаРезультатаЗапроса.Добавить();
		КонецЕсли;
		
		ПодготовитьТаблицуКорректировкиСписания(ТаблицаРезультатаЗапроса);

		ТаблицаРезультатаЗапроса.ЗаполнитьЗначения(Истина, "ОтражатьВМеждународномУчете");
		
		// Структура общих параметров
		СтруктураПараметров = ДопПараметры;
		
		// Признак учета, используемый в общих процедурах
		СтруктураПараметров.Вставить("Учет", "Меж");
		СтруктураПараметров.Вставить("ИмяРегистраСклад",      "ПартииТоваровНаСкладахМеждународныйУчет");
		СтруктураПараметров.Вставить("ИмяРегистраПереданные", "ПартииТоваровПереданныеМеждународныйУчет");
		
		СтруктураПараметров.Вставить("ТаблицаВыполненныхДвижений", ТаблицаРезультатаЗапроса);
		
		СтруктураПараметров.Вставить("РегламентныйДокумент", РегламентныйДокумент);
		СтруктураПараметров.Вставить("ТаблицаТоваров", ТаблицаТоваров);
		
		// Движения - наборы записей по регистрам
		УправлениеЗапасамиПартионныйУчет.СоздатьНаборыЗаписей(СтруктураПараметров, ТаблицаРезультатаЗапроса, РегламентныйДокумент);
		
		Если НЕ ДопПараметры.Свойство("Период", ПериодЗаписей) Тогда
			
			Если РегламентныйДокумент.Метаданные().Реквизиты.Найти("ПериодРегистрации") <> Неопределено Тогда
				ПериодЗаписей = КонецМесяца(РегламентныйДокумент.ПериодРегистрации);
			Иначе
				ПериодЗаписей = РегламентныйДокумент.Дата;
			КонецЕсли;
			
		КонецЕсли;
		
		УправлениеЗапасамиПартионныйУчет.ПодготовитьНаборыЗаписей(СтруктураПараметров, ТаблицаРезультатаЗапроса, ПериодЗаписей, РегламентныйДокумент, Ложь);
		
		// Вызов процедуры расчета по средней
		РассчитатьСписаниеПоСредней(ТаблицаТоваров, ДатаНач, ДатаКон, СтруктураПараметров);
		
		УправлениеЗапасамиПартионныйУчет.ЗаписатьДвиженияДокумента(СтруктураПараметров, ТаблицаРезультатаЗапроса, Ложь);
	КонецЕсли;
	
	
КонецПроцедуры // СкорректироватьСписаниеМеж()

// Запрос по списанию: Упр учет
//
// Параметры:
//	Нет.
//
Процедура ЗаполнитьЗапросПоСписаниюУпр(Запрос, МассивНоменклатуры, ДопПараметры)
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	""НаСкладах"" КАК СписаноИз,
	|	Источник.Организация КАК Организация,
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
	|	Источник.СтатусПартии,
	|	Источник.Заказ,
	|	СУММА(Источник.Количество) КАК Количество,
	|	СУММА(Источник.Стоимость) КАК Стоимость,
	|	0 КАК СтоимостьПоступление,
	|	NULL КАК СтатусПередачи,
	//|	NULL КАК ДокументПередачи,
	|	МатериалыВЭксплуатации.ДокументПередачи КАК ДокументПередачи,
	|	NULL КАК ДоговорКонтрагента,
	|	ВЫБОР
	|		КОГДА (НЕ Себестоимость.ЗаказПокупателя ЕСТЬ NULL )
	|			ТОГДА Себестоимость.ЗаказПокупателя
	|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	|			ТОГДА НЗП.Заказ
	|		КОГДА (НЕ Затраты.Заказ ЕСТЬ NULL )
	|			ТОГДА Затраты.Заказ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказСписания,
	|	Источник.КодОперации КАК КодОперацииПартииТоваров,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ КАК Регистратор,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ КАК Период,
	|	Источник.Качество,
	|	ВЫБОР
	|		КОГДА (НЕ Затраты.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА Затраты.СтатьяЗатрат
	|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА НЗП.СтатьяЗатрат
	|		КОГДА (НЕ БракВПроизводстве.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.СтатьяЗатрат
	|		КОГДА (НЕ ЗатратыНаСтроительствоОС.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА ЗатратыНаСтроительствоОС.СтатьяЗатрат
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК СтатьяЗатрат,
	|	ВЫБОР
	|		КОГДА (НЕ Себестоимость.Подразделение ЕСТЬ NULL )
	|			ТОГДА Себестоимость.Подразделение
	|		КОГДА (НЕ Затраты.Подразделение ЕСТЬ NULL )
	|			ТОГДА Затраты.Подразделение
	|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	|			ТОГДА НЗП.Подразделение
	|		КОГДА (НЕ БракВПроизводстве.Подразделение ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.Подразделение
	|		КОГДА (НЕ МатериалыВЭксплуатации.Подразделение ЕСТЬ NULL )
	|			ТОГДА МатериалыВЭксплуатации.Подразделение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Подразделение,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА НЗП.НоменклатурнаяГруппа
	|		КОГДА (НЕ Затраты.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА Затраты.НоменклатурнаяГруппа
	|		КОГДА (НЕ БракВПроизводстве.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.НоменклатурнаяГруппа
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК НоменклатурнаяГруппа,
	|	БракВПроизводстве.Продукция,
	|	ЗатратыНаСтроительствоОС.ОбъектСтроительства,
	|	ВЫБОР
	|		КОГДА (НЕ БракВПроизводстве.ХарактеристикаПродукции ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.ХарактеристикаПродукции
	|		КОГДА (НЕ ИсточникДляКомплектации.ХарактеристикаНоменклатуры ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.ХарактеристикаНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ХарактеристикаНоменклатурыНовая,
	|	ВЫБОР
	|		КОГДА (НЕ БракВПроизводстве.СерияПродукции ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.СерияПродукции
	|		КОГДА (НЕ ИсточникДляКомплектации.СерияНоменклатуры ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.СерияНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК СерияНоменклатурыНовая,
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.Номенклатура ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.Номенклатура
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК НоменклатураНовая,
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.ДокументОприходования ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.ДокументОприходования
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументОприходованияНовый,
	|	ИсточникДляКомплектации.СтатусПартии КАК СтатусПартииНовый,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям КАК ВестиПартионныйУчетПоСериям,
	|	ВЫБОР
	|		КОГДА (НЕ Затраты.Проект ЕСТЬ NULL )
	|			ТОГДА Затраты.Проект
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Проект,
	|	ВЫБОР
	|		КОГДА Себестоимость.Номенклатура <> Источник.Номенклатура
	|			ТОГДА Себестоимость.Номенклатура
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК НоменклатураКомплекта,
	|	ВЫБОР
	|		КОГДА Себестоимость.ХарактеристикаНоменклатуры <> Источник.ХарактеристикаНоменклатуры
	|			ТОГДА Себестоимость.ХарактеристикаНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ХарактеристикаКомплекта,	
	|	СУММА(ВЫБОР
	|		КОГДА Себестоимость.Номенклатура <> Источник.Номенклатура
	|			ТОГДА Себестоимость.Количество
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК КоличествоКомплекта,	
	|	ЕСТЬNULL(МатериалыВЭксплуатации.ФизЛицо, НЕОПРЕДЕЛЕНО) КАК ФизЛицо,
	|	ЕСТЬNULL(МатериалыВЭксплуатации.НазначениеИспользования, НЕОПРЕДЕЛЕНО) КАК НазначениеИспользования,
	|	ЕСТЬNULL(НЗП.СерияЗатраты, НЕОПРЕДЕЛЕНО) КАК СерияНоменклтатурыНЗП,
	|	Источник.НомерСтрокиСписанныхТоваров КАК НомерСтрокиСписанныхТоваров
	|ИЗ
	|	РегистрНакопления.ПартииТоваровНаСкладах КАК Источник
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Затраты КАК Затраты
	|		ПО Источник.Регистратор = Затраты.Регистратор
	|			И Источник.НомерКорСтроки = Затраты.НомерСтроки
	|			И (Источник.КодОперации В (&КодыСписаниеНаЗатраты))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПродажиСебестоимость КАК Себестоимость
	|		ПО Источник.Регистратор = Себестоимость.Регистратор
	|			И Источник.НомерКорСтроки = Себестоимость.НомерСтроки
	|			И (Источник.КодОперации В (&КодыСписаниеНаСебестоимость))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.НезавершенноеПроизводство КАК НЗП
	|		ПО Источник.Регистратор = НЗП.Регистратор
	|			И Источник.НомерКорСтроки = НЗП.НомерСтроки
	|			И (Источник.КодОперации В (&КодыСписаниеВНЗП))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.БракВПроизводстве КАК БракВПроизводстве
	|		ПО Источник.Регистратор = БракВПроизводстве.Регистратор
	|			И Источник.НомерКорСтроки = БракВПроизводстве.НомерСтроки
	|			И (Источник.КодОперации В (&КодыСписаниеНаБрак))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗатратыНаСтроительствоОбъектовОсновныхСредств КАК ЗатратыНаСтроительствоОС
	|		ПО Источник.Регистратор = ЗатратыНаСтроительствоОС.Регистратор
	|			И Источник.НомерКорСтроки = ЗатратыНаСтроительствоОС.НомерСтроки
	|			И (Источник.КодОперации В (&КодыСтроительствоОбъектовОС))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладах КАК ИсточникДляКомплектации
	|		ПО Источник.Регистратор = ИсточникДляКомплектации.Регистратор
	|			И Источник.НомерКорСтроки = ИсточникДляКомплектации.НомерСтроки
	|			И (Источник.КодОперации В (&КодКомплектация))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииМатериаловВЭксплуатации КАК МатериалыВЭксплуатации
	|		ПО Источник.Регистратор = МатериалыВЭксплуатации.Регистратор
	|			И (Источник.КодОперации В (&КодПередачаМатериалов))
	|			И Источник.НомерКорСтроки = МатериалыВЭксплуатации.НомерСтроки
	|ГДЕ
	|//ГДЕ
	|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И Источник.ВидДвижения = &ВидДвиженияРасход
	|	И Источник.КодОперации В(&КодыСписание)
	|
	|СГРУППИРОВАТЬ ПО
	|	Источник.Организация,
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
	|	МатериалыВЭксплуатации.ДокументПередачи,
	|	Источник.СтатусПартии,
	|	Источник.Заказ,
	|	Источник.КодОперации,
	|	Источник.Качество,
	|	БракВПроизводстве.Продукция,
	|	ЗатратыНаСтроительствоОС.ОбъектСтроительства,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ Себестоимость.Подразделение ЕСТЬ NULL )
	|			ТОГДА Себестоимость.Подразделение
	|		КОГДА (НЕ Затраты.Подразделение ЕСТЬ NULL )
	|			ТОГДА Затраты.Подразделение
	|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	|			ТОГДА НЗП.Подразделение
	|		КОГДА (НЕ БракВПроизводстве.Подразделение ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.Подразделение
	|		КОГДА (НЕ МатериалыВЭксплуатации.Подразделение ЕСТЬ NULL )
	|			ТОГДА МатериалыВЭксплуатации.Подразделение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА НЗП.НоменклатурнаяГруппа
	|		КОГДА (НЕ Затраты.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА Затраты.НоменклатурнаяГруппа
	|		КОГДА (НЕ БракВПроизводстве.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.НоменклатурнаяГруппа
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ Себестоимость.ЗаказПокупателя ЕСТЬ NULL )
	|			ТОГДА Себестоимость.ЗаказПокупателя
	|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	|			ТОГДА НЗП.Заказ
	|		КОГДА (НЕ Затраты.Заказ ЕСТЬ NULL )
	|			ТОГДА Затраты.Заказ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ Затраты.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА Затраты.СтатьяЗатрат
	|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА НЗП.СтатьяЗатрат
	|		КОГДА (НЕ БракВПроизводстве.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.СтатьяЗатрат
	|		КОГДА (НЕ ЗатратыНаСтроительствоОС.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА ЗатратыНаСтроительствоОС.СтатьяЗатрат
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ БракВПроизводстве.ХарактеристикаПродукции ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.ХарактеристикаПродукции
	|		КОГДА (НЕ ИсточникДляКомплектации.ХарактеристикаНоменклатуры ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.ХарактеристикаНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ БракВПроизводстве.СерияПродукции ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.СерияПродукции
	|		КОГДА (НЕ ИсточникДляКомплектации.СерияНоменклатуры ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.СерияНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.Номенклатура ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.Номенклатура
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.ДокументОприходования ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.ДокументОприходования
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ИсточникДляКомплектации.СтатусПартии,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	|	ВЫБОР
	|		КОГДА (НЕ Затраты.Проект ЕСТЬ NULL )
	|			ТОГДА Затраты.Проект
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Себестоимость.Номенклатура <> Источник.Номенклатура
	|			ТОГДА Себестоимость.Номенклатура
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Себестоимость.ХарактеристикаНоменклатуры <> Источник.ХарактеристикаНоменклатуры
	|			ТОГДА Себестоимость.ХарактеристикаНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,	
	|	ЕСТЬNULL(МатериалыВЭксплуатации.ФизЛицо, НЕОПРЕДЕЛЕНО),
	|	ЕСТЬNULL(МатериалыВЭксплуатации.НазначениеИспользования, НЕОПРЕДЕЛЕНО),
	|	ЕСТЬNULL(НЗП.СерияЗатраты, НЕОПРЕДЕЛЕНО),
	|	Источник.НомерСтрокиСписанныхТоваров
	|
	|ИМЕЮЩИЕ
	|	СУММА(Источник.Количество) <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Переданные"",
	|	Источник.Организация,
	|	Источник.Номенклатура,
	|	NULL,
	|	Источник.ХарактеристикаНоменклатуры,
	|	NULL,
	|	Источник.ДокументОприходования,
	|	Источник.СтатусПартии,
	|	NULL,
	|	СУММА(Источник.Количество),
	|	СУММА(Источник.Стоимость),
	|	0,
	|	Источник.СтатусПередачи,
	|	Источник.ДокументПередачи,
	|	Источник.ДоговорКонтрагента,
	|	ВЫБОР
	|		КОГДА (НЕ Себестоимость.ЗаказПокупателя ЕСТЬ NULL )
	|			ТОГДА Себестоимость.ЗаказПокупателя
	|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	|			ТОГДА НЗП.Заказ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	Источник.КодОперации,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	|	NULL,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА НЗП.СтатьяЗатрат
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ Себестоимость.Подразделение ЕСТЬ NULL )
	|			ТОГДА Себестоимость.Подразделение
	|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	|			ТОГДА НЗП.Подразделение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА НЗП.НоменклатурнаяГруппа
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	|	NULL,
	|	NULL,
	|	NULL,
	|	0,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL
	|ИЗ
	|	РегистрНакопления.ПартииТоваровПереданные КАК Источник
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПродажиСебестоимость КАК Себестоимость
	|		ПО Источник.Регистратор = Себестоимость.Регистратор
	|			И Источник.НомерКорСтроки = Себестоимость.НомерСтроки
	|			И (Источник.КодОперации В (&КодыСписаниеНаСебестоимость))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.НезавершенноеПроизводство КАК НЗП
	|		ПО Источник.Регистратор = НЗП.Регистратор
	|			И Источник.НомерКорСтроки = НЗП.НомерСтроки
	|			И (Источник.КодОперации В (&СписаниеПартийПереданныхВПроизводство))
	|ГДЕ
	|//ГДЕ
	|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И Источник.ВидДвижения = &ВидДвиженияРасход
	|	И Источник.КодОперации В(&КодыСписание)
	|
	|СГРУППИРОВАТЬ ПО
	|	Источник.Организация,
	|	Источник.Номенклатура,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.ДокументОприходования,
	|	Источник.СтатусПартии,
	|	Источник.СтатусПередачи,
	|	Источник.ДокументПередачи,
	|	Источник.ДоговорКонтрагента,
	|	Источник.КодОперации,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ Себестоимость.Подразделение ЕСТЬ NULL )
	|			ТОГДА Себестоимость.Подразделение
	|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	|			ТОГДА НЗП.Подразделение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА НЗП.СтатьяЗатрат
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА НЗП.НоменклатурнаяГруппа
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ Себестоимость.ЗаказПокупателя ЕСТЬ NULL )
	|			ТОГДА Себестоимость.ЗаказПокупателя
	|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	|			ТОГДА НЗП.Заказ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям
	|
	|ИМЕЮЩИЕ
	|	СУММА(Источник.Количество) <> 0
	|
	//Партии материалов в эксплуатации
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ВЭксплуатации"",
	|	NULL,
	|	Источник.Номенклатура,
	|	NULL,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	NULL,
	|	NULL,
	|	NULL,
	|	СУММА(Источник.Количество),
	|	СУММА(Источник.Стоимость),
	|	0,
	|	NULL,
	|	Источник.ДокументПередачи,
	|	NULL,
	|	NULL,
	|	Источник.КодОперации,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	|	NULL,
	|	NULL,
	|	Источник.Подразделение,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	|	NULL,
	|	NULL,
	|	NULL,
	|	0,
	|	Источник.ФизЛицо,
	|	Источник.НазначениеИспользования,
	|	NULL,
	|	NULL
	|ИЗ
	|	РегистрНакопления.ПартииМатериаловВЭксплуатации КАК Источник
	|ГДЕ
	|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И Источник.ВидДвижения = &ВидДвиженияРасход
	|	И Источник.КодОперации В(&КодыСписание)
	|
	|СГРУППИРОВАТЬ ПО
	|	Источник.Номенклатура,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументПередачи,
	|	Источник.КодОперации,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	|	Источник.Подразделение,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	|	Источник.ФизЛицо,
	|	Источник.НазначениеИспользования
	|
	|ИМЕЮЩИЕ
	|	СУММА(Источник.Количество) <> 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	Период,
	|	Регистратор";

	//Добавим дополнительный отбор по коду операции
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ 
	|	(НЕ Источник.СтатусПартии В (&ИсключаемыеСтатусыПартий)) И ");
	Запрос.УстановитьПараметр("ИсключаемыеСтатусыПартий",ПолучитьМассивИсключаемыхСтатусовПартий());
		
	// Добавим дополнительный отбор по номенклатуре
	Если МассивНоменклатуры <> Неопределено Тогда
		
		ТекстОграничениеНаПартии = "";
		СпособОценкиМПЗ = ВРег(Строка(УправлениеЗапасамиПартионныйУчет.ПолучитьПараметрУчетнойПолитикиПартионногоУчета("СпособОценкиМПЗ", "Упр", ДопПараметры)));
		Если СпособОценкиМПЗ = "ФИФО" 
			ИЛИ СпособОценкиМПЗ = "ЛИФО" Тогда
			
			ТекстОграничениеНаПартии = " И Источник.ДокументОприходования В (&МассивДокументовОприходования) ";
			
		КонецЕсли;
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ 
		|	Источник.Номенклатура В (&МассивНоменклатуры)
		|	" + ТекстОграничениеНаПартии + " И ");
		
	КонецЕсли;
	
	// Встречный выпуск
	Если ДопПараметры.ВстречныйВыпуск Тогда
		
		КодыОпераций = Перечисления.КодыОперацийПартииТоваров;
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ",
			" //ГДЕ 
			|НЕ ( 1 В
			|	(ВЫБРАТЬ Первые 1
			|		1
			|	ИЗ
			|		РегистрСведений.КорректировкаВстречногоВыпускаПродукции КАК КорректировкаВстречногоВыпускаПродукции
			|	ГДЕ
			|		Источник.НомерСтрокиСписанныхТоваров = КорректировкаВстречногоВыпускаПродукции.НомерСтрокиСписанныхТоваров
			|		" + ДобавитьОтборПоВидуУчета("КорректировкаВстречногоВыпускаПродукции","Упр") + "
			|		И Источник.Регистратор = КорректировкаВстречногоВыпускаПродукции.Документ))
			| И");
		Запрос.УстановитьПараметр("СписаниеПартийВПроизводствоОперативно",КодыОпераций.СписаниеПартийВПроизводствоОперативно);
		
	КонецЕсли;

КонецПроцедуры // ЗаполнитьЗапросПоСписанию()


// Запрос по списанию: Бух учет
//
// Параметры:
//	Нет.
//
Процедура ЗаполнитьЗапросПоСписаниюБух(Запрос, МассивНоменклатуры, ДопПараметры,ПРГ_ТолькоНаЗатратыВлНаСеб = Ложь)
	
	Организация = ДопПараметры.Организация;
	
	Запрос.Текст =" 
	|//@ИсклКомплВЫБРАТЬ
	|//@ИсклКомпл	Расход.Регистратор КАК Регистратор,
	|//@ИсклКомпл	Расход.НомерСтроки КАК НомерСтроки
	|//@ИсклКомплПОМЕСТИТЬ ТаблИсклКомпл
	|//@ИсклКомплИЗ
	|//@ИсклКомпл	РегистрНакопления.ПартииТоваровНаСкладахБухгалтерскийУчет КАК Расход
	|//@ИсклКомпл		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладахБухгалтерскийУчет КАК Приход
	|//@ИсклКомпл		ПО Расход.Регистратор = Приход.Регистратор
	//начало изменений Ожиганов 20.10.2015 изменении качества при комплектации, учтем как перемещение 
	|//@ИсклКомпл			И Расход.Номенклатура = Приход.Номенклатура"+
  ?(Не ДопПараметры.ПРГ_УчитыватьКомплКакПеремИзмКачества,"
	|//@ИсклКомпл			И Расход.СчетУчета = Приход.СчетУчета
	|//@ИсклКомпл			И Расход.Склад = Приход.Склад
	|//@ИсклКомпл			И Расход.ДокументОприходования = Приход.ДокументОприходования
	|//@ИсклКомпл			И Расход.ХарактеристикаНоменклатуры = Приход.ХарактеристикаНоменклатуры
	|//@ИсклКомпл			И Расход.СерияНоменклатуры = Приход.СерияНоменклатуры
	|//@ИсклКомпл			И Расход.Качество = Приход.Качество
	|//@ИсклКомпл			И Расход.Количество = Приход.Количество"
	,"")+"
	//конец изменений 
	//начало изменений Ожиганов 21.10.2015 изменении качества при комплектации, учтем как перемещение 
	//|//@ИсклКомпл			И Расход.Количество = Приход.Количество
	//конец изменений 
	|//@ИсклКомпл			И (Расход.КодОперации = &_КодОперацииКоплектации)
	|//@ИсклКомпл			И (Расход.КодОперации = &_КодОперацииКоплектации)
	|//@ИсклКомпл			И Расход.Организация = Приход.Организация
	|//@ИсклКомпл			И Расход.НомерКорСтроки = Приход.НомерСтроки
	|//@ИсклКомпл			И (Расход.Активность)
	|//@ИсклКомпл			И (Приход.Активность)
	|//@ИсклКомплГДЕ
	|//@ИсклКомпл	Расход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|//@ИсклКомпл	И Приход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|//@ИсклКомпл	И Расход.ВидДвижения = Значение(ВидДвиженияНакопления.Расход)
	|"+?(МассивНоменклатуры<>Неопределено,"И Расход.Номенклатура в (&МассивНоменклатуры)","")+"	
	|//@ИсклКомплСГРУППИРОВАТЬ ПО
	|//@ИсклКомпл	
	|//@ИсклКомпл	Расход.Регистратор,
	|//@ИсклКомпл	Расход.НомерСтроки
	|//@ИсклКомплИНДЕКСИРОВАТЬ ПО
	|//@ИсклКомпл	Регистратор,
	|//@ИсклКомпл	НомерСтроки
	|//@ИсклКомпл;
	|
//начало изменений Ожиганов 16.03.2016 оптимизируем запрос 
//через временную таблицу и кластер
    | Выбрать Источник.Период, Источник.Регистратор,Источник.Номерстроки,Источник.КодОперации, Источник.КорСчет
	| 	Поместить Табпартий
	| ИЗ 
	|  РегистрНакопления.ПартииТоваровНаСкладахБухгалтерскийУчет КАК Источник
	|ГДЕ
	|//ГДЕ
	|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И Источник.ВидДвижения = &ВидДвиженияРасход
//начало изменений Ожиганов 28.01.2016 б/н исключение неактивных записей из р/с и корректировки стоимости 
	|	И Источник.Активность
//конец изменений 
	
	|//@ИсклКомпл	И НЕ ( 1 В
	|//@ИсклКомпл			(ВЫБРАТЬ Первые 1
	|//@ИсклКомпл	1
	|//@ИсклКомпл	ИЗ
	|//@ИсклКомпл	ТаблИсклКомпл КАК ТаблИсклКомпл	
	|//@ИсклКомпл	Где	
	|//@ИсклКомпл	ТаблИсклКомпл.Регистратор =Источник.Регистратор
	|//@ИсклКомпл	И ТаблИсклКомпл.НомерСтроки	 = Источник.НомерСтроки))	
	
	|	И Источник.КодОперации В(&КодыСписание)"
	+?(Не ПРГ_ТолькоНаЗатратыВлНаСеб,"","
	|  И ((Источник.КодОперации В(&КодыСписаниеСоСчетами) и Источник.КорСчет в (&СчетаЗатрат))
	|  или Источник.КодОперации В(&КодыСписаниеБезСчетов))
	|")+"
	|// ИНДЕКСИРОВАТЬ ПО Период,Регистратор,Номерстроки,КодОперации
	|;
//конец изменений 
//начало изменений Ожиганов 15.03.2016 оптимизируем запрос 
	| ВЫБРАТЬ
	|	""НаСкладах"" КАК СписаноИз,
	|	Источник.Организация КАК Организация,
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
	|	Источник.Заказ,
	|	СУММА(Источник.Количество) КАК Количество,
	|	СУММА(Источник.Стоимость) КАК Стоимость,
	|	0 КАК СтоимостьПоступление,
	|	МатериалыВЭксплуатации.ДокументПередачи КАК ДокументПередачи,
	|	NULL КАК ДоговорКонтрагента,
	|	Источник.КодОперации КАК КодОперацииПартииТоваров,
	|	Источник.Качество,
	|	БракВПроизводстве.Продукция,
	|	Источник.СчетУчета КАК СчетУчетаБУ,
	|	Источник.КорСчет КАК КорСчетБУ,
	|	Источник.КорСубконто1 КАК КорСубконтоБУ1,
	|	Источник.КорСубконто2 КАК КорСубконтоБУ2,
	|	Источник.КорСубконто3 КАК КорСубконтоБУ3,
	|	ВЫБОР
	|		КОГДА (НЕ Затраты.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА Затраты.СтатьяЗатрат
	|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА НЗП.СтатьяЗатрат
	|		КОГДА (НЕ БракВПроизводстве.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.СтатьяЗатрат
	|		КОГДА (НЕ СписанныеТовары.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА СписанныеТовары.СтатьяЗатрат
	|		КОГДА (НЕ СписанныеТоварыПоДокументуДвижения.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА СписанныеТоварыПоДокументуДвижения.СтатьяЗатрат
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК СтатьяЗатрат,
	|	ВЫБОР
	|		КОГДА (НЕ Затраты.Подразделение ЕСТЬ NULL )
	|			ТОГДА Затраты.Подразделение
	|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	|			ТОГДА НЗП.Подразделение
	|		КОГДА (НЕ БракВПроизводстве.Подразделение ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.Подразделение
	|		КОГДА (НЕ МатериалыВЭксплуатации.Подразделение ЕСТЬ NULL )
	|			ТОГДА МатериалыВЭксплуатации.Подразделение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ПодразделениеОрганизации,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА НЗП.НоменклатурнаяГруппа
	|		КОГДА (НЕ Затраты.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА Затраты.НоменклатурнаяГруппа
	|		КОГДА (НЕ БракВПроизводстве.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.НоменклатурнаяГруппа
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК НоменклатурнаяГруппа,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	|			ТОГДА НЗП.Заказ
	|		КОГДА (НЕ Затраты.Заказ ЕСТЬ NULL )
	|			ТОГДА Затраты.Заказ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказСписания,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ КАК Регистратор,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ КАК Период,
	|	ВЫБОР
	|		КОГДА (НЕ БракВПроизводстве.ХарактеристикаПродукции ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.ХарактеристикаПродукции
	|		КОГДА (НЕ ИсточникДляКомплектации.ХарактеристикаНоменклатуры ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.ХарактеристикаНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ХарактеристикаНоменклатурыНовая,
	|	ВЫБОР
	|		КОГДА (НЕ БракВПроизводстве.СерияПродукции ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.СерияПродукции
	|		КОГДА (НЕ ИсточникДляКомплектации.СерияНоменклатуры ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.СерияНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК СерияНоменклатурыНовая,
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.Номенклатура ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.Номенклатура
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК НоменклатураНовая,
	//начало изменений
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.Качество ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.Качество
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК КачествоНовое,
	//конец изменений
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.ДокументОприходования ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.ДокументОприходования
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументОприходованияНовый,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям КАК ВестиПартионныйУчетПоСериям,
	|	ЕСТЬNULL(МатериалыВЭксплуатации.ФизЛицо, НЕОПРЕДЕЛЕНО) КАК ФизЛицо,
	|	ЕСТЬNULL(МатериалыВЭксплуатации.НазначениеИспользования, НЕОПРЕДЕЛЕНО) КАК НазначениеИспользования,
	|	ЕСТЬNULL(НЗП.СерияЗатраты, НЕОПРЕДЕЛЕНО) КАК СерияНоменклтатурыНЗП,
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_КорСчетБУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_КорСчетБУ,НЕОПРЕДЕЛЕНО)) как ПРГ_КорСчетБУ,
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ1,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоБУ1,Неопределено)) как ПРГ_СубконтоБУ1,
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ2,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоБУ2,Неопределено)) как ПРГ_СубконтоБУ2,
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ3,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоБУ3,Неопределено)) как ПРГ_СубконтоБУ3,
	//начало изменений Ожиганов 05.05.2015 изменения по браку 
	|	Источник.НомерСтрокиСписанныхТоваров КАК НомерСтрокиСписанныхТоваров,
	|   ЕСТЬNULL(СписанныеТовары.СчетДоходовБУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СчетДоходовБУ,Неопределено)) как ПРГСчетДоходов,
	|   ЕСТЬNULL(СписанныеТовары.СчетРасходовБУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СчетРасходовБУ,Неопределено)) как ПРГСчетРасходов,
	|   ЕСТЬNULL(СписанныеТовары.СтатьяДоходовИРасходов,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СтатьяДоходовИРасходов,Неопределено)) как ПРГСтатьяДоходовИРасходов,
	|   ЕСТЬNULL(СписанныеТовары.ПодразделениеОрганизации,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПодразделениеОрганизации,Неопределено)) как ПРГПодразделениеОрганизации
	//конец изменений 
	|ИЗ
	|	РегистрНакопления.ПартииТоваровНаСкладахБухгалтерскийУчет КАК Источник
	|  Внутреннее СОЕДИНЕНИЕ Табпартий как Табпартий по Табпартий.Период = Источник.Период и Табпартий.Регистратор = Источник.Регистратор и  Табпартий.НомерСтроки = Источник.НомерСтроки и Табпартий.КодОперации в (&КодыСписаниеИспВсеТабл)
	|"+?(Не ПРГ_ТолькоНаЗатратыВлНаСеб,"","
	|  И ((Табпартий.КодОперации В(&КодыСписаниеСоСчетами) и Табпартий.КорСчет в (&СчетаЗатрат))
	|  или Табпартий.КодОперации В(&КодыСписаниеБезСчетов))
	|")+"
	
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗатратыБухгалтерскийУчет КАК Затраты
	|		ПО Источник.Регистратор = Затраты.Регистратор
	|			И Источник.НомерКорСтроки = Затраты.НомерСтроки
	|			И Источник.КорСчет = Затраты.СчетУчета
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.НезавершенноеПроизводствоБухгалтерскийУчет КАК НЗП
	|		ПО Источник.Регистратор = НЗП.Регистратор
	|			И Источник.НомерКорСтроки = НЗП.НомерСтроки
	|			И Источник.КорСчет = НЗП.СчетУчета
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.БракВПроизводствеБухгалтерскийУчет КАК БракВПроизводстве
	|		ПО Источник.Регистратор = БракВПроизводстве.Регистратор
	|			И Источник.НомерКорСтроки = БракВПроизводстве.НомерСтроки
	|			И Источник.КорСчет = БракВПроизводстве.СчетУчета
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладахБухгалтерскийУчет КАК ИсточникДляКомплектации
	|		ПО Источник.Регистратор = ИсточникДляКомплектации.Регистратор
	|			И Источник.НомерКорСтроки = ИсточникДляКомплектации.НомерСтроки
	|			И (Источник.КодОперации В (&КодКомплектация))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииМатериаловВЭксплуатацииБухгалтерскийУчет КАК МатериалыВЭксплуатации
	|		ПО Источник.Регистратор = МатериалыВЭксплуатации.Регистратор
	|			И Источник.НомерКорСтроки = МатериалыВЭксплуатации.НомерСтроки
	|			И (Источник.КодОперации В (&КодПередачаМатериалов))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СписанныеТовары КАК СписанныеТовары
	|		ПО Источник.Регистратор = СписанныеТовары.Регистратор
	|			И Источник.НомерСтрокиСписанныхТоваров = СписанныеТовары.НомерСтрокиДокумента
	//начало изменений Ожиганов 05.05.2015 изменения по браку 
//начало изменений 53363 формирование проводок при возрате тары по залоговой стоимости  	
	//|			И (Источник.Регистратор ССЫЛКА Документ.ТребованиеНакладная или Источник.Регистратор ССЫЛКА Документ.СписаниеТоваров или Источник.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику  или (Источник.КодОперации=Значение(Перечисление.КодыОперацийПартииТоваров.ВозвратПоставщику) и Источник.Регистратор ССЫЛКА Документ.КорректировкаЗаписейРегистров) )
	|			И (Источник.Регистратор ССЫЛКА Документ.ТребованиеНакладная или Источник.Регистратор ССЫЛКА Документ.СписаниеТоваров или Источник.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику  или (Источник.КодОперации=Значение(Перечисление.КодыОперацийПартииТоваров.ВозвратПоставщику) и Источник.Регистратор ССЫЛКА Документ.КорректировкаЗаписейРегистров)  или Источник.КодОперации в (Значение(Перечисление.КодыОперацийПартииТоваров.ПередачаТарыЗалогСтоимость),Значение(Перечисление.КодыОперацийПартииТоваров.ВозвратТарыЗалогСтоимостьТекущийМесяц)) )
//конец изменений 	
	//конец изменений 
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СписанныеТовары КАК СписанныеТоварыПоДокументуДвижения
	|		ПО Источник.ДокументДвижения = СписанныеТоварыПоДокументуДвижения.Регистратор
	|			И Источник.НомерСтрокиСписанныхТоваров = СписанныеТоварыПоДокументуДвижения.НомерСтроки
	//начало изменений Ожиганов 05.05.2015 изменения по браку 
	//начало изменений 53363 формирование проводок при возрате тары по залоговой стоимости  	
	//|			И (Источник.ДокументДвижения ССЫЛКА Документ.ТребованиеНакладная или Источник.ДокументДвижения ССЫЛКА Документ.СписаниеТоваров или Источник.ДокументДвижения ССЫЛКА Документ.ВозвратТоваровПоставщику или (Источник.КодОперации=Значение(Перечисление.КодыОперацийПартииТоваров.ВозвратПоставщику) и Источник.ДокументДвижения ССЫЛКА Документ.КорректировкаЗаписейРегистров) )
	|			И (Источник.ДокументДвижения ССЫЛКА Документ.ТребованиеНакладная или Источник.ДокументДвижения ССЫЛКА Документ.СписаниеТоваров или Источник.ДокументДвижения ССЫЛКА Документ.ВозвратТоваровПоставщику или (Источник.КодОперации=Значение(Перечисление.КодыОперацийПартииТоваров.ВозвратПоставщику) и Источник.ДокументДвижения ССЫЛКА Документ.КорректировкаЗаписейРегистров) или Источник.КодОперации в (Значение(Перечисление.КодыОперацийПартииТоваров.ПередачаТарыЗалогСтоимость),Значение(Перечисление.КодыОперацийПартииТоваров.ВозвратТарыЗалогСтоимостьТекущийМесяц)) )
	//конец изменений 
	//конец изменений 
//	|ГДЕ
////	|//ГДЕ
//	|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
////	|	И Источник.ВидДвижения = &ВидДвиженияРасход
//////начало изменений Ожиганов 28.01.2016 б/н исключение неактивных записей из р/с и корректировки стоимости 
////	|	И Источник.Активность
//////конец изменений 
////	
////	|//@ИсклКомпл	И НЕ ( 1 В
////	|//@ИсклКомпл			(ВЫБРАТЬ Первые 1
////	|//@ИсклКомпл	1
////	|//@ИсклКомпл	ИЗ
////	|//@ИсклКомпл	ТаблИсклКомпл КАК ТаблИсклКомпл	
////	|//@ИсклКомпл	Где	
////	|//@ИсклКомпл	ТаблИсклКомпл.Регистратор =Источник.Регистратор
////	|//@ИсклКомпл	И ТаблИсклКомпл.НомерСтрокиСписанныхТоваров =Источник.НомерСтрокиСписанныхТоваров))	
//	
	//|	И Источник.КодОперации В(&КодыСписаниеИспВсеТабл)"
	//+?(Не ПРГ_ТолькоНаЗатратыВлНаСеб,"","
	//|  И ((Источник.КодОперации В(&КодыСписаниеСоСчетами) и Источник.КорСчет в (&СчетаЗатрат))
	//|  или Источник.КодОперации В(&КодыСписаниеБезСчетов))
	//|")+"
	|
	|СГРУППИРОВАТЬ ПО
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
	|	МатериалыВЭксплуатации.ДокументПередачи,
	|	Источник.Заказ,
	|	Источник.КодОперации,
	|	Источник.Качество,
	|	БракВПроизводстве.Продукция,
	|	Источник.Организация,
	|	Источник.СчетУчета,
	|	Источник.КорСчет,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	|	ВЫБОР
	|		КОГДА (НЕ Затраты.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА Затраты.СтатьяЗатрат
	|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА НЗП.СтатьяЗатрат
	|		КОГДА (НЕ БракВПроизводстве.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.СтатьяЗатрат
	|		КОГДА (НЕ СписанныеТовары.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА СписанныеТовары.СтатьяЗатрат
	|		КОГДА (НЕ СписанныеТоварыПоДокументуДвижения.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА СписанныеТоварыПоДокументуДвижения.СтатьяЗатрат
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	|			ТОГДА НЗП.Заказ
	|		КОГДА (НЕ Затраты.Заказ ЕСТЬ NULL )
	|			ТОГДА Затраты.Заказ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ БракВПроизводстве.ХарактеристикаПродукции ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.ХарактеристикаПродукции
	|		КОГДА (НЕ ИсточникДляКомплектации.ХарактеристикаНоменклатуры ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.ХарактеристикаНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ БракВПроизводстве.СерияПродукции ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.СерияПродукции
	|		КОГДА (НЕ ИсточникДляКомплектации.СерияНоменклатуры ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.СерияНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.Номенклатура ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.Номенклатура
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	//начало изменений	
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.Качество ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.Качество
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ ,
	//начало изменений
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.ДокументОприходования ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.ДокументОприходования
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ Затраты.Подразделение ЕСТЬ NULL )
	|			ТОГДА Затраты.Подразделение
	|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	|			ТОГДА НЗП.Подразделение
	|		КОГДА (НЕ БракВПроизводстве.Подразделение ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.Подразделение
	|		КОГДА (НЕ МатериалыВЭксплуатации.Подразделение ЕСТЬ NULL )
	|			ТОГДА МатериалыВЭксплуатации.Подразделение
    |		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА НЗП.НоменклатурнаяГруппа
	|		КОГДА (НЕ Затраты.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА Затраты.НоменклатурнаяГруппа
	|		КОГДА (НЕ БракВПроизводстве.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.НоменклатурнаяГруппа
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	|	ЕСТЬNULL(МатериалыВЭксплуатации.ФизЛицо, НЕОПРЕДЕЛЕНО),
	|	ЕСТЬNULL(МатериалыВЭксплуатации.НазначениеИспользования, НЕОПРЕДЕЛЕНО),
	|	ЕСТЬNULL(НЗП.СерияЗатраты, НЕОПРЕДЕЛЕНО),
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_КорСчетБУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_КорСчетБУ,НЕОПРЕДЕЛЕНО)),
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ1,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоБУ1,Неопределено)),
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ2,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоБУ2,Неопределено)),
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ3,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоБУ3,Неопределено)),
	//начало изменений Ожиганов 05.05.2015 изменения по браку 
	|	Источник.НомерСтрокиСписанныхТоваров,
	|   ЕСТЬNULL(СписанныеТовары.СчетДоходовБУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СчетДоходовБУ,Неопределено)),
	|   ЕСТЬNULL(СписанныеТовары.СчетРасходовБУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СчетРасходовБУ,Неопределено)),
	|   ЕСТЬNULL(СписанныеТовары.СтатьяДоходовИРасходов,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СтатьяДоходовИРасходов,Неопределено)) ,
	|   ЕСТЬNULL(СписанныеТовары.ПодразделениеОрганизации,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПодразделениеОрганизации,Неопределено)) 
	//конец изменений 
	|
	|ИМЕЮЩИЕ
	|	СУММА(Источник.Количество) <> 0
	| Объединить все
//начало изменений Ожиганов 15.03.2016 оптимизируем запрос 	
	| ВЫБРАТЬ
	|	""НаСкладах"" КАК СписаноИз,
	|	Источник.Организация КАК Организация,
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
	|	Источник.Заказ,
	|	СУММА(Источник.Количество) КАК Количество,
	|	СУММА(Источник.Стоимость) КАК Стоимость,
	|	0 КАК СтоимостьПоступление,
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 	
//	|	МатериалыВЭксплуатации.ДокументПередачи КАК ДокументПередачи,
	|	NULL КАК ДокументПередачи,
//конец изменений 	
	|	NULL КАК ДоговорКонтрагента,
	|	Источник.КодОперации КАК КодОперацииПартииТоваров,
	|	Источник.Качество,
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 	
	|	Null как Продукция,

//	|	БракВПроизводстве.Продукция,
//конец изменений 	
	|	Источник.СчетУчета КАК СчетУчетаБУ,
	|	Источник.КорСчет КАК КорСчетБУ,
	|	Источник.КорСубконто1 КАК КорСубконтоБУ1,
	|	Источник.КорСубконто2 КАК КорСубконтоБУ2,
	|	Источник.КорСубконто3 КАК КорСубконтоБУ3,
	|	ВЫБОР 
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 
	//|		КОГДА (НЕ Затраты.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА Затраты.СтатьяЗатрат
	//|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА НЗП.СтатьяЗатрат
	//|		КОГДА (НЕ БракВПроизводстве.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА БракВПроизводстве.СтатьяЗатрат
	//|		КОГДА (НЕ СписанныеТовары.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА СписанныеТовары.СтатьяЗатрат
	//|		КОГДА (НЕ СписанныеТоварыПоДокументуДвижения.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА СписанныеТоварыПоДокументуДвижения.СтатьяЗатрат
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ КАК СтатьяЗатрат,
	|	ВЫБОР
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 	
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|		КОГДА (НЕ Затраты.Подразделение ЕСТЬ NULL )
	//|			ТОГДА Затраты.Подразделение
	//|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	//|			ТОГДА НЗП.Подразделение
	//|		КОГДА (НЕ БракВПроизводстве.Подразделение ЕСТЬ NULL )
	//|			ТОГДА БракВПроизводстве.Подразделение
	//|		КОГДА (НЕ МатериалыВЭксплуатации.Подразделение ЕСТЬ NULL )
	//|			ТОГДА МатериалыВЭксплуатации.Подразделение
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ КАК ПодразделениеОрганизации,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 	
	//|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	//|			ТОГДА НЗП.НоменклатурнаяГруппа
	//|		КОГДА (НЕ Затраты.НоменклатурнаяГруппа ЕСТЬ NULL )
	//|			ТОГДА Затраты.НоменклатурнаяГруппа
	//|		КОГДА (НЕ БракВПроизводстве.НоменклатурнаяГруппа ЕСТЬ NULL )
	//|			ТОГДА БракВПроизводстве.НоменклатурнаяГруппа
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 	
	|	КОНЕЦ КАК НоменклатурнаяГруппа,
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 	
	//|	ВЫБОР
	//|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	//|			ТОГДА НЗП.Заказ
	//|		КОГДА (НЕ Затраты.Заказ ЕСТЬ NULL )
	//|			ТОГДА Затраты.Заказ
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|	КОНЕЦ 
	|  Неопределено  КАК ЗаказСписания,
//конец изменений 	
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ КАК Регистратор,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ КАК Период,
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 	
	//|	ВЫБОР
	//|		КОГДА (НЕ БракВПроизводстве.ХарактеристикаПродукции ЕСТЬ NULL )
	//|			ТОГДА БракВПроизводстве.ХарактеристикаПродукции
	//|		КОГДА (НЕ ИсточникДляКомплектации.ХарактеристикаНоменклатуры ЕСТЬ NULL )
	//|			ТОГДА ИсточникДляКомплектации.ХарактеристикаНоменклатуры
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|	КОНЕЦ КАК ХарактеристикаНоменклатурыНовая,
	| Неопределено КАК ХарактеристикаНоменклатурыНовая,
//конец изменений 	
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 
	//|	ВЫБОР
	//|		КОГДА (НЕ БракВПроизводстве.СерияПродукции ЕСТЬ NULL )
	//|			ТОГДА БракВПроизводстве.СерияПродукции
	//|		КОГДА (НЕ ИсточникДляКомплектации.СерияНоменклатуры ЕСТЬ NULL )
	//|			ТОГДА ИсточникДляКомплектации.СерияНоменклатуры
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|	КОНЕЦ КАК СерияНоменклатурыНовая,
	| НЕопределено КАК СерияНоменклатурыНовая,
//конец изменений 	
	//|	ВЫБОР
	//|		КОГДА (НЕ ИсточникДляКомплектации.Номенклатура ЕСТЬ NULL )
	//|			ТОГДА ИсточникДляКомплектации.Номенклатура
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|	КОНЕЦ КАК НоменклатураНовая,
	 | Неопределено КАК НоменклатураНовая,
//конец изменений 	
	//начало изменений
	//|	ВЫБОР
	//|		КОГДА (НЕ ИсточникДляКомплектации.Качество ЕСТЬ NULL )
	//|			ТОГДА ИсточникДляКомплектации.Качество
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|	КОНЕЦ КАК КачествоНовое,
	
	| Неопределено КАК КачествоНовое,
	//конец изменений
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 	
	//|	ВЫБОР
	//|		КОГДА (НЕ ИсточникДляКомплектации.ДокументОприходования ЕСТЬ NULL )
	//|			ТОГДА ИсточникДляКомплектации.ДокументОприходования
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|	КОНЕЦ КАК ДокументОприходованияНовый,
	| Неопределено КАК ДокументОприходованияНовый,
//конец изменений 	
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям КАК ВестиПартионныйУчетПоСериям,
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 	
	//|	ЕСТЬNULL(МатериалыВЭксплуатации.ФизЛицо, НЕОПРЕДЕЛЕНО) КАК ФизЛицо,
	//|	ЕСТЬNULL(МатериалыВЭксплуатации.НазначениеИспользования, НЕОПРЕДЕЛЕНО) КАК НазначениеИспользования,
	//|	ЕСТЬNULL(НЗП.СерияЗатраты, НЕОПРЕДЕЛЕНО) КАК СерияНоменклтатурыНЗП,
	//|   ЕСТЬNULL(СписанныеТовары.ПРГ_КорСчетБУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_КорСчетБУ,НЕОПРЕДЕЛЕНО)) как ПРГ_КорСчетБУ,
	//|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ1,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоБУ1,Неопределено)) как ПРГ_СубконтоБУ1,
	//|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ2,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоБУ2,Неопределено)) как ПРГ_СубконтоБУ2,
	//|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ3,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоБУ3,Неопределено)) как ПРГ_СубконтоБУ3,
	////начало изменений Ожиганов 05.05.2015 изменения по браку 
	//|	Источник.НомерСтрокиСписанныхТоваров КАК НомерСтрокиСписанныхТоваров,
	//|   ЕСТЬNULL(СписанныеТовары.СчетДоходовБУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СчетДоходовБУ,Неопределено)) как ПРГСчетДоходов,
	//|   ЕСТЬNULL(СписанныеТовары.СчетРасходовБУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СчетРасходовБУ,Неопределено)) как ПРГСчетРасходов,
	//|   ЕСТЬNULL(СписанныеТовары.СтатьяДоходовИРасходов,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СтатьяДоходовИРасходов,Неопределено)) как ПРГСтатьяДоходовИРасходов,
	//|   ЕСТЬNULL(СписанныеТовары.ПодразделениеОрганизации,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПодразделениеОрганизации,Неопределено)) как ПРГПодразделениеОрганизации
	
	|	НЕОПРЕДЕЛЕНО КАК ФизЛицо,
	|	НЕОПРЕДЕЛЕНО КАК НазначениеИспользования,
	|	НЕОПРЕДЕЛЕНО КАК СерияНоменклтатурыНЗП,
	|   НЕОПРЕДЕЛЕНО как ПРГ_КорСчетБУ,
	| 	НЕОПРЕДЕЛЕНО как ПРГ_СубконтоБУ1,
	|   НЕОПРЕДЕЛЕНО как ПРГ_СубконтоБУ2,
	|   НЕОПРЕДЕЛЕНО  как ПРГ_СубконтоБУ3,
	//начало изменений Ожиганов 05.05.2015 изменения по браку 
	|	Источник.НомерСтрокиСписанныхТоваров КАК НомерСтрокиСписанныхТоваров,
	|   НЕОПРЕДЕЛЕНО как ПРГСчетДоходов,
	|   НЕОПРЕДЕЛЕНО  как ПРГСчетРасходов,
	|   НЕОПРЕДЕЛЕНО  как ПРГСтатьяДоходовИРасходов,
	|   НЕОПРЕДЕЛЕНО  как ПРГПодразделениеОрганизации
	
//конец изменений 	
	//конец изменений 
	|ИЗ
	|	РегистрНакопления.ПартииТоваровНаСкладахБухгалтерскийУчет КАК Источник
	|  Внутреннее СОЕДИНЕНИЕ Табпартий как Табпартий по Табпартий.Период = Источник.Период и Табпартий.Регистратор = Источник.Регистратор и  Табпартий.НомерСтроки = Источник.НомерСтроки  и Табпартий.КодОперации в (&КодыСписаниеНеВсеТабл)
	|	И Табпартий.КодОперации В(&КодыСписаниеНеВсеТабл)"
	+?(Не ПРГ_ТолькоНаЗатратыВлНаСеб,"","
	|  И ((Табпартий.КодОперации В(&КодыСписаниеСоСчетами) и Табпартий.КорСчет в (&СчетаЗатрат))
	|  или Табпартий.КодОперации В(&КодыСписаниеБезСчетов))
	|")+"
	
	//|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗатратыБухгалтерскийУчет КАК Затраты
	//|		ПО Источник.Регистратор = Затраты.Регистратор
	//|			И Источник.НомерКорСтроки = Затраты.НомерСтроки
	//|			И Источник.КорСчет = Затраты.СчетУчета
	//|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.НезавершенноеПроизводствоБухгалтерскийУчет КАК НЗП
	//|		ПО Источник.Регистратор = НЗП.Регистратор
	//|			И Источник.НомерКорСтроки = НЗП.НомерСтроки
	//|			И Источник.КорСчет = НЗП.СчетУчета
	//|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.БракВПроизводствеБухгалтерскийУчет КАК БракВПроизводстве
	//|		ПО Источник.Регистратор = БракВПроизводстве.Регистратор
	//|			И Источник.НомерКорСтроки = БракВПроизводстве.НомерСтроки
	//|			И Источник.КорСчет = БракВПроизводстве.СчетУчета
	//|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладахБухгалтерскийУчет КАК ИсточникДляКомплектации
	//|		ПО Источник.Регистратор = ИсточникДляКомплектации.Регистратор
	//|			И Источник.НомерКорСтроки = ИсточникДляКомплектации.НомерСтроки
	//|			И (Источник.КодОперации В (&КодКомплектация))
	//|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииМатериаловВЭксплуатацииБухгалтерскийУчет КАК МатериалыВЭксплуатации
	//|		ПО Источник.Регистратор = МатериалыВЭксплуатации.Регистратор
	//|			И Источник.НомерКорСтроки = МатериалыВЭксплуатации.НомерСтроки
	//|			И (Источник.КодОперации В (&КодПередачаМатериалов))
	//|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СписанныеТовары КАК СписанныеТовары
	//|		ПО Источник.Регистратор = СписанныеТовары.Регистратор
	//|			И Источник.НомерСтрокиСписанныхТоваров = СписанныеТовары.НомерСтрокиДокумента
	////начало изменений Ожиганов 05.05.2015 изменения по браку 
	//|			И (Источник.Регистратор ССЫЛКА Документ.ТребованиеНакладная или Источник.Регистратор ССЫЛКА Документ.СписаниеТоваров или Источник.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику  или (Источник.КодОперации=Значение(Перечисление.КодыОперацийПартииТоваров.ВозвратПоставщику) и Источник.Регистратор ССЫЛКА Документ.КорректировкаЗаписейРегистров) )
	////конец изменений 
	//|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СписанныеТовары КАК СписанныеТоварыПоДокументуДвижения
	//|		ПО Источник.ДокументДвижения = СписанныеТоварыПоДокументуДвижения.Регистратор
	//|			И Источник.НомерСтрокиСписанныхТоваров = СписанныеТоварыПоДокументуДвижения.НомерСтроки
	////начало изменений Ожиганов 05.05.2015 изменения по браку 
	//|			И (Источник.ДокументДвижения ССЫЛКА Документ.ТребованиеНакладная или Источник.ДокументДвижения ССЫЛКА Документ.СписаниеТоваров или Источник.ДокументДвижения ССЫЛКА Документ.ВозвратТоваровПоставщику или (Источник.КодОперации=Значение(Перечисление.КодыОперацийПартииТоваров.ВозвратПоставщику) и Источник.ДокументДвижения ССЫЛКА Документ.КорректировкаЗаписейРегистров) )
	//конец изменений 
//	|ГДЕ


//	|//ГДЕ

//	|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
	
//	|	И Источник.ВидДвижения = &ВидДвиженияРасход
////начало изменений Ожиганов 28.01.2016 б/н исключение неактивных записей из р/с и корректировки стоимости 
//	|	И Источник.Активность
////конец изменений 
//	
//	|//@ИсклКомпл	И НЕ ( 1 В
//	|//@ИсклКомпл			(ВЫБРАТЬ Первые 1
//	|//@ИсклКомпл	1
//	|//@ИсклКомпл	ИЗ
//	|//@ИсклКомпл	ТаблИсклКомпл КАК ТаблИсклКомпл	
//	|//@ИсклКомпл	Где	
//	|//@ИсклКомпл	ТаблИсклКомпл.Регистратор =Источник.Регистратор
//	|//@ИсклКомпл	И ТаблИсклКомпл.НомерСтрокиСписанныхТоваров =Источник.НомерСтрокиСписанныхТоваров))	
//	
	//|	И Источник.КодОперации В(&КодыСписаниеНеВсеТабл)"
	//+?(Не ПРГ_ТолькоНаЗатратыВлНаСеб,"","
	//|  И ((Источник.КодОперации В(&КодыСписаниеСоСчетами) и Источник.КорСчет в (&СчетаЗатрат))
	//|  или Источник.КодОперации В(&КодыСписаниеБезСчетов))
	//|")+"
	|
	|СГРУППИРОВАТЬ ПО
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
//	|	МатериалыВЭксплуатации.ДокументПередачи,
	|	Источник.Заказ,
	|	Источник.КодОперации,
	|	Источник.Качество,
//	|	БракВПроизводстве.Продукция,
	|	Источник.Организация,
	|	Источник.СчетУчета,
	|	Источник.КорСчет,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	//|		КОГДА (НЕ Затраты.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА Затраты.СтатьяЗатрат
	//|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА НЗП.СтатьяЗатрат
	//|		КОГДА (НЕ БракВПроизводстве.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА БракВПроизводстве.СтатьяЗатрат
	//|		КОГДА (НЕ СписанныеТовары.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА СписанныеТовары.СтатьяЗатрат
	//|		КОГДА (НЕ СписанныеТоварыПоДокументуДвижения.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА СписанныеТоварыПоДокументуДвижения.СтатьяЗатрат
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	//|	ВЫБОР
	//|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	//|			ТОГДА НЗП.Заказ
	//|		КОГДА (НЕ Затраты.Заказ ЕСТЬ NULL )
	//|			ТОГДА Затраты.Заказ
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	//|	ВЫБОР
	//|		КОГДА (НЕ БракВПроизводстве.ХарактеристикаПродукции ЕСТЬ NULL )
	//|			ТОГДА БракВПроизводстве.ХарактеристикаПродукции
	//|		КОГДА (НЕ ИсточникДляКомплектации.ХарактеристикаНоменклатуры ЕСТЬ NULL )
	//|			ТОГДА ИсточникДляКомплектации.ХарактеристикаНоменклатуры
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|	КОНЕЦ,
	//|	ВЫБОР
	//|		КОГДА (НЕ БракВПроизводстве.СерияПродукции ЕСТЬ NULL )
	//|			ТОГДА БракВПроизводстве.СерияПродукции
	//|		КОГДА (НЕ ИсточникДляКомплектации.СерияНоменклатуры ЕСТЬ NULL )
	//|			ТОГДА ИсточникДляКомплектации.СерияНоменклатуры
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|	КОНЕЦ,
	//|	ВЫБОР
	//|		КОГДА (НЕ ИсточникДляКомплектации.Номенклатура ЕСТЬ NULL )
	//|			ТОГДА ИсточникДляКомплектации.Номенклатура
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|	КОНЕЦ,
	//начало изменений	
	//|	ВЫБОР
	//|		КОГДА (НЕ ИсточникДляКомплектации.Качество ЕСТЬ NULL )
	//|			ТОГДА ИсточникДляКомплектации.Качество
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|	КОНЕЦ ,
	//начало изменений
	//|	ВЫБОР
	//|		КОГДА (НЕ ИсточникДляКомплектации.ДокументОприходования ЕСТЬ NULL )
	//|			ТОГДА ИсточникДляКомплектации.ДокументОприходования
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|	КОНЕЦ,
	|	ВЫБОР
	//|		КОГДА (НЕ Затраты.Подразделение ЕСТЬ NULL )
	//|			ТОГДА Затраты.Подразделение
	//|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	//|			ТОГДА НЗП.Подразделение
	//|		КОГДА (НЕ БракВПроизводстве.Подразделение ЕСТЬ NULL )
	//|			ТОГДА БракВПроизводстве.Подразделение
	//|		КОГДА (НЕ МатериалыВЭксплуатации.Подразделение ЕСТЬ NULL )
	//|			ТОГДА МатериалыВЭксплуатации.Подразделение
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	
	//|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	//|			ТОГДА НЗП.НоменклатурнаяГруппа
	//|		КОГДА (НЕ Затраты.НоменклатурнаяГруппа ЕСТЬ NULL )
	//|			ТОГДА Затраты.НоменклатурнаяГруппа
	//|		КОГДА (НЕ БракВПроизводстве.НоменклатурнаяГруппа ЕСТЬ NULL )
	//|			ТОГДА БракВПроизводстве.НоменклатурнаяГруппа
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 	
	//|	ЕСТЬNULL(МатериалыВЭксплуатации.ФизЛицо, НЕОПРЕДЕЛЕНО),
	//|	ЕСТЬNULL(МатериалыВЭксплуатации.НазначениеИспользования, НЕОПРЕДЕЛЕНО),
	//|	ЕСТЬNULL(НЗП.СерияЗатраты, НЕОПРЕДЕЛЕНО),
	//|   ЕСТЬNULL(СписанныеТовары.ПРГ_КорСчетБУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_КорСчетБУ,НЕОПРЕДЕЛЕНО)),
	//|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ1,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоБУ1,Неопределено)),
	//|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ2,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоБУ2,Неопределено)),
	//|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ3,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоБУ3,Неопределено)),
	//начало изменений Ожиганов 05.05.2015 изменения по браку 
	|	Источник.НомерСтрокиСписанныхТоваров
	//|   ЕСТЬNULL(СписанныеТовары.СчетДоходовБУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СчетДоходовБУ,Неопределено)),
	//|   ЕСТЬNULL(СписанныеТовары.СчетРасходовБУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СчетРасходовБУ,Неопределено)),
	//|   ЕСТЬNULL(СписанныеТовары.СтатьяДоходовИРасходов,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СтатьяДоходовИРасходов,Неопределено)) ,
	//|   ЕСТЬNULL(СписанныеТовары.ПодразделениеОрганизации,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПодразделениеОрганизации,Неопределено)) 
//конец изменений 	
	//конец изменений 
	|
	|ИМЕЮЩИЕ
	|	СУММА(Источник.Количество) <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Переданные"",
	|	Источник.Организация,
	|	Источник.Номенклатура,
	|	NULL,
	|	Источник.ХарактеристикаНоменклатуры,
	|	NULL,
	|	Источник.ДокументОприходования,
	|	NULL,
	|	СУММА(Источник.Количество),
	|	СУММА(Источник.Стоимость),
	|	0,
	|	Источник.ДокументПередачи,
	|	Источник.ДоговорКонтрагента,
	|	Источник.КодОперации,
	|	NULL,
	|	NULL,
	|	Источник.СчетУчета,
	|	Источник.КорСчет,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	|	ВЫБОР
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	//|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА НЗП.СтатьяЗатрат
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ,
	|	ВЫБОР
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
//	|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
//	|			ТОГДА НЗП.Подразделение
//	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ,
	|	ВЫБОР
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	|		КОГДА ТипЗначения(Источник.КорСубконто1) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//	|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
//	|			ТОГДА НЗП.НоменклатурнаяГруппа
//	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ,
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	//|	ВЫБОР
	//|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	//|			ТОГДА НЗП.Заказ
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|	КОНЕЦ,
	| НЕОПРЕДЕЛЕНО,
//конец изменений 	
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	|	NULL,
	|	NULL,
	|	NULL,
	//начало изменений
	|	NULL,
	//конец изменений
	|	NULL,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	//начало изменений Ожиганов 05.05.2015 изменения по браку 
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL
	//конец изменений 
	|ИЗ
	|	РегистрНакопления.ПартииТоваровПереданныеБухгалтерскийУчет КАК Источник
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
//	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.НезавершенноеПроизводствоБухгалтерскийУчет КАК НЗП
//	|		ПО Источник.Регистратор = НЗП.Регистратор
//	|			И Источник.НомерКорСтроки = НЗП.НомерСтроки
//	|			И Источник.КорСчет = НЗП.СчетУчета
//конец изменений 	
	|ГДЕ
	|//ГДЕ
	|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И Источник.ВидДвижения = &ВидДвиженияРасход
	|	И Источник.КодОперации В(&КодыСписание)
//начало изменений Ожиганов 28.01.2016 б/н исключение неактивных записей из р/с и корректировки стоимости 
	|	И Источник.Активность
//конец изменений 
	|
	|СГРУППИРОВАТЬ ПО
	|	Источник.Номенклатура,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.ДокументОприходования,
	|	Источник.ДокументПередачи,
	|	Источник.ДоговорКонтрагента,
	|	Источник.КодОперации,
	|	Источник.СчетУчета,
	|	Источник.Организация,
	|	Источник.КорСчет,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	|	ВЫБОР
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//	|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
//	|			ТОГДА НЗП.СтатьяЗатрат
//	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ,
	|	ВЫБОР
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//	|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
//	|			ТОГДА НЗП.Подразделение
//	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ,
	|	ВЫБОР
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	|		КОГДА ТипЗначения(Источник.КорСубконто1) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//	|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
//	|			ТОГДА НЗП.НоменклатурнаяГруппа
//	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ,
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	//|	ВЫБОР
	//|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	//|			ТОГДА НЗП.Заказ
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|	КОНЕЦ,
//конец изменений 	
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям
//Партии материалов в эксплуатации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ВЭксплуатации"",
	|	Источник.Организация,
	|	Источник.Номенклатура,
	|	NULL,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	NULL,
	|	NULL,
	|	СУММА(Источник.Количество),
	|	СУММА(Источник.Стоимость),
	|	0,
	|	Источник.ДокументПередачи,
	|	NULL,
	|	Источник.КодОперации,
	|	NULL,
	|	NULL,
	|	Источник.СчетУчета,
	|	СписанныеТовары.КорСчетБУ,
	|	СписанныеТовары.КорСубконтоБУ1,
	|	СписанныеТовары.КорСубконтоБУ2,
	|	СписанныеТовары.КорСубконтоБУ3,
	|	NULL,
	|	Источник.Подразделение,
	|	NULL,
	|	NULL,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	|	Источник.ФизЛицо,
	|	Источник.НазначениеИспользования,
	|	NULL,
	|	NULL,
	|	NULL,
	//начало изменений
	|	NULL,
	//конец изменений
	|	NULL,
	|	NULL,
	//начало изменений Ожиганов 05.05.2015 изменения по браку 
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	//конец изменений 
	|	NULL
	|ИЗ
	|	РегистрНакопления.ПартииМатериаловВЭксплуатацииБухгалтерскийУчет КАК Источник
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СписанныеТовары КАК СписанныеТовары
	|		ПО Источник.Регистратор = СписанныеТовары.Регистратор
	|			И Источник.НомерСтрокиСписанныхТоваров = СписанныеТовары.НомерСтроки
	|ГДЕ
	|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И Источник.ВидДвижения = &ВидДвиженияРасход
	|	И Источник.КодОперации В(&КодыСписание)
	|"+?(МассивНоменклатуры <> Неопределено," И Источник.Номенклатура В (&МассивНоменклатуры) ","")+"
	|
	|СГРУППИРОВАТЬ ПО
	|	Источник.Номенклатура,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументПередачи,
	|	Источник.КодОперации,
	|	Источник.СчетУчета,
	|	Источник.Организация,
	|	СписанныеТовары.КорСчетБУ,
	|	СписанныеТовары.КорСубконтоБУ1,
	|	СписанныеТовары.КорСубконтоБУ2,
	|	СписанныеТовары.КорСубконтоБУ3,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	|	Источник.Подразделение,
	|	Источник.ФизЛицо,
	|	Источник.НазначениеИспользования,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям
	|
	|ИМЕЮЩИЕ
	|	СУММА(Источник.Количество) <> 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	Период,
//начало изменений Ожиганов 04.05.2016 б/н исправление ошибок округления в НУ 	
	|	Регистратор,
	|	Количество
//конец изменений 	
	
	|; 
	| Уничтожить ТаблИсклКомпл;
	| Уничтожить Табпартий;";
	
	//Добавим дополнительный отбор по счету
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ
	|	(НЕ Источник.СчетУчета В (&СписокИсключаемыхСчетовУчета)) И ");
	
	Запрос.УстановитьПараметр("СписокИсключаемыхСчетовУчета",ПолучитьМассивИсключаемыхСчетов());
	
	// Если задана организация, отбор по организации 
	Если ЗначениеЗаполнено(Организация) Тогда
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ 
		|	Источник.Организация = &Организация И ");
		
		Запрос.УстановитьПараметр("Организация", Организация);
		
	КонецЕсли;
	
	// Добавим дополнительный отбор по номенклатуре
	Если МассивНоменклатуры <> Неопределено Тогда
		
		ТекстОграничениеНаПартии = "";
		Если ЗначениеЗаполнено(Организация) Тогда
			СпособОценкиМПЗ = ВРег(Строка(УправлениеЗапасамиПартионныйУчет.ПолучитьПараметрУчетнойПолитикиПартионногоУчета("СпособОценкиМПЗ", "Бух", ДопПараметры)));
			Если СпособОценкиМПЗ = "ФИФО" 
				ИЛИ СпособОценкиМПЗ = "ЛИФО" Тогда
				
				ТекстОграничениеНаПартии = " И Источник.ДокументОприходования В (&МассивДокументовОприходования) ";
				
			КонецЕсли;
		КонецЕсли;
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ 
		|	Источник.Номенклатура В (&МассивНоменклатуры)
		|	" + ТекстОграничениеНаПартии + " И ");
		
	КонецЕсли;
	
	// Встречный выпуск
	Если ДопПараметры.ВстречныйВыпуск Тогда
		КодыОпераций = Перечисления.КодыОперацийПартииТоваров;
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ",
			" //ГДЕ 
			|	НЕ ( 1 В
			|	(ВЫБРАТЬ Первые 1
			|		1
			|	ИЗ
			|		РегистрСведений.КорректировкаВстречногоВыпускаПродукции КАК КорректировкаВстречногоВыпускаПродукции
			|	ГДЕ
			|		Источник.НомерСтрокиСписанныхТоваров = КорректировкаВстречногоВыпускаПродукции.НомерСтрокиСписанныхТоваров
			|		" + ДобавитьОтборПоВидуУчета("КорректировкаВстречногоВыпускаПродукции","Бух") + "
			|		И Источник.Регистратор = КорректировкаВстречногоВыпускаПродукции.Документ))
			| И");
		Запрос.УстановитьПараметр("СписаниеПартийВПроизводствоОперативно",КодыОпераций.СписаниеПартийВПроизводствоОперативно);
	КонецЕсли;
	
КонецПроцедуры // ЗапросПоСписаниюБух()

// Запрос по списанию: Нал учет 
//
// Параметры:
//	Нет.
//
Процедура ЗаполнитьЗапросПоСписаниюНал(Запрос, МассивНоменклатуры, ДопПараметры,ПРГ_ТолькоНаЗатратыВлНаСеб = Ложь)
	
	Организация = ДопПараметры.Организация;
	
	Запрос.Текст =" 
	|//@ИсклКомпл ВЫБРАТЬ
	|//@ИсклКомпл	Расход.Регистратор КАК Регистратор,
	|//@ИсклКомпл	Расход.НомерСтроки КАК НомерСтроки
	|//@ИсклКомпл ПОМЕСТИТЬ ТаблИсклКомпл
	|//@ИсклКомпл ИЗ
	|//@ИсклКомпл	РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК Расход
	|//@ИсклКомпл		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК Приход
	|//@ИсклКомпл		ПО Расход.Регистратор = Приход.Регистратор
	//начало изменений Ожиганов 20.10.2015 изменении качества при комплектации, учтем как перемещение 
	|//@ИсклКомпл			И Расход.Номенклатура = Приход.Номенклатура"+
	?(Не ДопПараметры.ПРГ_УчитыватьКомплКакПеремИзмКачества,"
	|//@ИсклКомпл			И Расход.СчетУчета = Приход.СчетУчета
	|//@ИсклКомпл			И Расход.Склад = Приход.Склад
	|//@ИсклКомпл			И Расход.ДокументОприходования = Приход.ДокументОприходования
	|//@ИсклКомпл			И Расход.ХарактеристикаНоменклатуры = Приход.ХарактеристикаНоменклатуры
	|//@ИсклКомпл			И Расход.СерияНоменклатуры = Приход.СерияНоменклатуры
	|//@ИсклКомпл			И Расход.Качество = Приход.Качество
	|//@ИсклКомпл			И Расход.Количество = Приход.Количество"
	,"")+"
	//конец изменений 
	//начало изменений Ожиганов 21.10.2015 изменении качества при комплектации, учтем как перемещение 
	//|//@ИсклКомпл			И Расход.Количество = Приход.Количество
	//конец изменений 
	|//@ИсклКомпл			И (Расход.КодОперации = &_КодОперацииКоплектации)
	|//@ИсклКомпл			И (Расход.КодОперации = &_КодОперацииКоплектации)
	|//@ИсклКомпл			И Расход.Организация = Приход.Организация
	|//@ИсклКомпл			И Расход.НомерКорСтроки = Приход.НомерСтроки
	|//@ИсклКомпл			И (Расход.Активность)
	|//@ИсклКомпл			И (Приход.Активность)
	|//@ИсклКомплГДЕ
	|//@ИсклКомпл	Расход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|//@ИсклКомпл	И Приход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|//@ИсклКомпл	И Расход.ВидДвижения = Значение(ВидДвиженияНакопления.Расход)
	|"+?(МассивНоменклатуры<>Неопределено,"И Расход.Номенклатура в (&МассивНоменклатуры)","")+"
	|//@ИсклКомплСГРУППИРОВАТЬ ПО
	|//@ИсклКомпл	
	|//@ИсклКомпл	Расход.Регистратор,
	|//@ИсклКомпл	Расход.НомерСтроки
	|//@ИсклКомплИНДЕКСИРОВАТЬ ПО
	|//@ИсклКомпл	Регистратор,
	|//@ИсклКомпл	НомерСтроки
	|//@ИсклКомпл;	

//через временную таблицу и кластер
	| Выбрать Источник.Период, Источник.Регистратор,Источник.Номерстроки,Источник.КодОперации, Источник.КорСчет
	| 	Поместить Табпартий
	| ИЗ 
	|  РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК Источник
	|ГДЕ
	|//ГДЕ
	|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И Источник.ВидДвижения = &ВидДвиженияРасход
//начало изменений Ожиганов 28.01.2016 б/н исключение неактивных записей из р/с и корректировки стоимости 
	|	И Источник.Активность
//конец изменений 
	
	|//@ИсклКомпл	И НЕ ( 1 В
	|//@ИсклКомпл			(ВЫБРАТЬ Первые 1
	|//@ИсклКомпл	1
	|//@ИсклКомпл	ИЗ
	|//@ИсклКомпл	ТаблИсклКомпл КАК ТаблИсклКомпл	
	|//@ИсклКомпл	Где	
	|//@ИсклКомпл	ТаблИсклКомпл.Регистратор =Источник.Регистратор
	|//@ИсклКомпл	И ТаблИсклКомпл.НомерСтроки =Источник.НомерСтроки))	
	
	|	И Источник.КодОперации В(&КодыСписание)"
	+?(Не ПРГ_ТолькоНаЗатратыВлНаСеб,"","
	|  И ((Источник.КодОперации В(&КодыСписаниеСоСчетами) и Источник.КорСчет в (&СчетаЗатрат))
	|  или Источник.КодОперации В(&КодыСписаниеБезСчетов))
	|")+"
	|// ИНДЕКСИРОВАТЬ ПО Период,Регистратор,Номерстроки,КодОперации
	|;
	
	|
	|ВЫБРАТЬ
	|	""НаСкладах"" КАК СписаноИз,
	|	Источник.Организация КАК Организация,
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
	|	Источник.Заказ,
	|	СУММА(Источник.Количество) КАК Количество,
	|	СУММА(Источник.Стоимость) КАК Стоимость,
	|	0 КАК СтоимостьПоступление,
	|	МатериалыВЭксплуатации.ДокументПередачи КАК ДокументПередачи,
	|	NULL КАК ДоговорКонтрагента,
	|	Источник.КодОперации КАК КодОперацииПартииТоваров,
	|	Источник.Качество,
	|	БракВПроизводстве.Продукция,
	|	Источник.СчетУчета КАК СчетУчетаНУ,
	|	Источник.КорСчет КАК КорСчетНУ,
	|	Источник.КорСубконто1 КАК КорСубконтоБУ1,
	|	Источник.КорСубконто2 КАК КорСубконтоБУ2,
	|	Источник.КорСубконто3 КАК КорСубконтоБУ3,
	|	Источник.КорСубконто1 КАК КорСубконтоНУ1,
	|	Источник.КорСубконто2 КАК КорСубконтоНУ2,
	|	Источник.КорСубконто3 КАК КорСубконтоНУ3,
	|	СУММА(Источник.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(Источник.ВременнаяРазница) КАК ВременнаяРазница,
	|	ВЫБОР
	|		КОГДА (НЕ Затраты.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА Затраты.СтатьяЗатрат
	|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА НЗП.СтатьяЗатрат
	|		КОГДА (НЕ БракВПроизводстве.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.СтатьяЗатрат
	|		КОГДА (НЕ СписанныеТовары.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА СписанныеТовары.СтатьяЗатрат
	|		КОГДА (НЕ СписанныеТоварыПоДокументуДвижения.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА СписанныеТоварыПоДокументуДвижения.СтатьяЗатрат
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК СтатьяЗатрат,
	|	ВЫБОР
	|		КОГДА (НЕ Затраты.Подразделение ЕСТЬ NULL )
	|			ТОГДА Затраты.Подразделение
	|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	|			ТОГДА НЗП.Подразделение
	|		КОГДА (НЕ БракВПроизводстве.Подразделение ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.Подразделение
	|		КОГДА (НЕ МатериалыВЭксплуатации.Подразделение ЕСТЬ NULL )
	|			ТОГДА МатериалыВЭксплуатации.Подразделение	
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ПодразделениеОрганизации,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА НЗП.НоменклатурнаяГруппа
	|		КОГДА (НЕ Затраты.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА Затраты.НоменклатурнаяГруппа
	|		КОГДА (НЕ БракВПроизводстве.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.НоменклатурнаяГруппа
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК НоменклатурнаяГруппа,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	|			ТОГДА НЗП.Заказ
	|		КОГДА (НЕ Затраты.Заказ ЕСТЬ NULL )
	|			ТОГДА Затраты.Заказ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказСписания,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ КАК Регистратор,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ КАК Период,
	|	ВЫБОР
	|		КОГДА (НЕ БракВПроизводстве.ХарактеристикаПродукции ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.ХарактеристикаПродукции
	|		КОГДА (НЕ ИсточникДляКомплектации.ХарактеристикаНоменклатуры ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.ХарактеристикаНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ХарактеристикаНоменклатурыНовая,
	|	ВЫБОР
	|		КОГДА (НЕ БракВПроизводстве.СерияПродукции ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.СерияПродукции
	|		КОГДА (НЕ ИсточникДляКомплектации.СерияНоменклатуры ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.СерияНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК СерияНоменклатурыНовая,
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.Номенклатура ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.Номенклатура
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК НоменклатураНовая,
	//начало изменений
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.Качество ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.Качество
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК КачествоНовое,
	//конец изменений
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.ДокументОприходования ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.ДокументОприходования
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументОприходованияНовый,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям КАК ВестиПартионныйУчетПоСериям,
	|	ЕСТЬNULL(МатериалыВЭксплуатации.ФизЛицо, НЕОПРЕДЕЛЕНО) КАК ФизЛицо,
	|	ЕСТЬNULL(МатериалыВЭксплуатации.НазначениеИспользования, НЕОПРЕДЕЛЕНО) КАК НазначениеИспользования,
	|	ЕСТЬNULL(НЗП.СерияЗатраты, НЕОПРЕДЕЛЕНО) КАК СерияНоменклтатурыНЗП,
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_КорСчетНУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_КорСчетНУ,НЕОПРЕДЕЛЕНО)) как ПРГ_КорСчетНУ,
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ1,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоНУ1,НЕОПРЕДЕЛЕНО)) как ПРГ_СубконтоНУ1,
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ2,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоНУ2,НЕОПРЕДЕЛЕНО)) как ПРГ_СубконтоНУ2,
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ3,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоНУ3,НЕОПРЕДЕЛЕНО)) как ПРГ_СубконтоНУ3,
	//начало изменений Ожиганов 06.05.2015 изменения по браку 
	|	Источник.НомерСтрокиСписанныхТоваров КАК НомерСтрокиСписанныхТоваров,
	|   ЕСТЬNULL(СписанныеТовары.СчетДоходовНУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СчетДоходовНУ,Неопределено)) как ПРГСчетДоходов,
	|   ЕСТЬNULL(СписанныеТовары.СчетРасходовНУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СчетРасходовНУ,Неопределено)) как ПРГСчетРасходов,
	|   ЕСТЬNULL(СписанныеТовары.СтатьяДоходовИРасходов,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СтатьяДоходовИРасходов,Неопределено)) как ПРГСтатьяДоходовИРасходов,
	|   ЕСТЬNULL(СписанныеТовары.ПодразделениеОрганизации,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПодразделениеОрганизации,Неопределено)) как ПРГПодразделениеОрганизации
	//конец изменений 
	|ИЗ
	|	РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК Источник
//начало изменений Ожиганов 22.03.2016 оптимизируем запрос 
	|  Внутреннее СОЕДИНЕНИЕ Табпартий как Табпартий по Табпартий.Период = Источник.Период и Табпартий.Регистратор = Источник.Регистратор и  Табпартий.НомерСтроки = Источник.НомерСтроки и Табпартий.КодОперации в (&КодыСписаниеИспВсеТабл)
	|"+?(Не ПРГ_ТолькоНаЗатратыВлНаСеб,"","
	|  И ((Табпартий.КодОперации В(&КодыСписаниеСоСчетами) и Табпартий.КорСчет в (&СчетаЗатрат))
	|  или Табпартий.КодОперации В(&КодыСписаниеБезСчетов))
	|")+"
//конец изменений 
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗатратыНалоговыйУчет КАК Затраты
	|		ПО Источник.Регистратор = Затраты.Регистратор
	|			И Источник.НомерКорСтроки = Затраты.НомерСтроки
	|			И Источник.КорСчет = Затраты.СчетУчета
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.НезавершенноеПроизводствоНалоговыйУчет КАК НЗП
	|		ПО Источник.Регистратор = НЗП.Регистратор
	|			И Источник.НомерКорСтроки = НЗП.НомерСтроки
	|			И Источник.КорСчет = НЗП.СчетУчета
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.БракВПроизводствеНалоговыйУчет КАК БракВПроизводстве
	|		ПО Источник.Регистратор = БракВПроизводстве.Регистратор
	|			И Источник.НомерКорСтроки = БракВПроизводстве.НомерСтроки
	|			И Источник.КорСчет = БракВПроизводстве.СчетУчета
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК ИсточникДляКомплектации
	|		ПО Источник.Регистратор = ИсточникДляКомплектации.Регистратор
	|			И Источник.НомерКорСтроки = ИсточникДляКомплектации.НомерСтроки
	|			И (Источник.КодОперации В (&КодКомплектация))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииМатериаловВЭксплуатацииНалоговыйУчет КАК МатериалыВЭксплуатации
	|		ПО Источник.Регистратор = МатериалыВЭксплуатации.Регистратор
	|			И (Источник.КодОперации В (&КодПередачаМатериалов))
	|			И Источник.НомерКорСтроки = МатериалыВЭксплуатации.НомерСтроки
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СписанныеТовары КАК СписанныеТовары
	|		ПО Источник.Регистратор = СписанныеТовары.Регистратор
	|			И Источник.НомерСтрокиСписанныхТоваров = СписанныеТовары.НомерСтроки
	//начало изменений Ожиганов 06.05.2015 изменения по браку 
//начало изменений 53363 формирование проводок при возрате тары по залоговой стоимости  	
	//|			И (Источник.Регистратор ССЫЛКА Документ.ТребованиеНакладная или Источник.Регистратор ССЫЛКА Документ.СписаниеТоваров или Источник.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику или (Источник.КодОперации=Значение(Перечисление.КодыОперацийПартииТоваров.ВозвратПоставщику) и Источник.Регистратор ССЫЛКА Документ.КорректировкаЗаписейРегистров))
	|			И (Источник.Регистратор ССЫЛКА Документ.ТребованиеНакладная или Источник.Регистратор ССЫЛКА Документ.СписаниеТоваров или Источник.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику или (Источник.КодОперации=Значение(Перечисление.КодыОперацийПартииТоваров.ВозвратПоставщику) и Источник.Регистратор ССЫЛКА Документ.КорректировкаЗаписейРегистров) или Источник.КодОперации в (Значение(Перечисление.КодыОперацийПартииТоваров.ПередачаТарыЗалогСтоимость),Значение(Перечисление.КодыОперацийПартииТоваров.ВозвратТарыЗалогСтоимостьТекущийМесяц)) )
	
//конец изменений 	
	//конец изменений 
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СписанныеТовары КАК СписанныеТоварыПоДокументуДвижения
	|		ПО Источник.ДокументДвижения = СписанныеТоварыПоДокументуДвижения.Регистратор
	|			И Источник.НомерСтрокиСписанныхТоваров = СписанныеТоварыПоДокументуДвижения.НомерСтроки
	//начало изменений Ожиганов 06.05.2015 изменения по браку 
//начало изменений 53363 формирование проводок при возрате тары по залоговой стоимости  	
//	|			И (Источник.ДокументДвижения ССЫЛКА Документ.ТребованиеНакладная или Источник.ДокументДвижения ССЫЛКА Документ.СписаниеТоваров или Источник.ДокументДвижения ССЫЛКА Документ.ВозвратТоваровПоставщику или (Источник.КодОперации=Значение(Перечисление.КодыОперацийПартииТоваров.ВозвратПоставщику) и Источник.ДокументДвижения ССЫЛКА Документ.КорректировкаЗаписейРегистров))
	|			И (Источник.ДокументДвижения ССЫЛКА Документ.ТребованиеНакладная или Источник.ДокументДвижения ССЫЛКА Документ.СписаниеТоваров или Источник.ДокументДвижения ССЫЛКА Документ.ВозвратТоваровПоставщику или (Источник.КодОперации=Значение(Перечисление.КодыОперацийПартииТоваров.ВозвратПоставщику) и Источник.ДокументДвижения ССЫЛКА Документ.КорректировкаЗаписейРегистров) или Источник.КодОперации в (Значение(Перечисление.КодыОперацийПартииТоваров.ПередачаТарыЗалогСтоимость),Значение(Перечисление.КодыОперацийПартииТоваров.ВозвратТарыЗалогСтоимостьТекущийМесяц)) )
//конец изменений 	
	//конец изменений 
//	|ГДЕ
//	|//ГДЕ
//	|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
//	|	И Источник.ВидДвижения = &ВидДвиженияРасход
////начало изменений Ожиганов 28.01.2016 б/н исключение неактивных записей из р/с и корректировки стоимости 
//	|	И Источник.Активность
////конец изменений 
//	|//@ИсклКомпл	И НЕ ( 1 В
//	|//@ИсклКомпл			(ВЫБРАТЬ Первые 1
//	|//@ИсклКомпл	1
//	|//@ИсклКомпл	ИЗ
//	|//@ИсклКомпл	ТаблИсклКомпл КАК ТаблИсклКомпл	
//	|//@ИсклКомпл	Где	
//	|//@ИсклКомпл	ТаблИсклКомпл.Регистратор =Источник.Регистратор
//	|//@ИсклКомпл	И ТаблИсклКомпл.НомерСтрокиСписанныхТоваров =Источник.НомерСтрокиСписанныхТоваров))	
//	
//	|	И Источник.КодОперации В(&КодыСписание)"
//	+?(Не ПРГ_ТолькоНаЗатратыВлНаСеб,"","
//	|  И ((Источник.КодОперации В(&КодыСписаниеСоСчетами) и Источник.КорСчет в (&СчетаЗатрат))
//	|  или Источник.КодОперации В(&КодыСписаниеБезСчетов))
//	|")+"
	|
	|СГРУППИРОВАТЬ ПО
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
	|	МатериалыВЭксплуатации.ДокументПередачи,
	|	Источник.Заказ,
	|	Источник.КодОперации,
	|	Источник.Качество,
	|	БракВПроизводстве.Продукция,
	|	Источник.Организация,
	|	Источник.СчетУчета,
	|	Источник.КорСчет,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	|	ВЫБОР
	|		КОГДА (НЕ Затраты.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА Затраты.СтатьяЗатрат
	|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА НЗП.СтатьяЗатрат
	|		КОГДА (НЕ БракВПроизводстве.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.СтатьяЗатрат
	|		КОГДА (НЕ СписанныеТовары.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА СписанныеТовары.СтатьяЗатрат
	|		КОГДА (НЕ СписанныеТоварыПоДокументуДвижения.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА СписанныеТоварыПоДокументуДвижения.СтатьяЗатрат
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ Затраты.Подразделение ЕСТЬ NULL )
	|			ТОГДА Затраты.Подразделение
	|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	|			ТОГДА НЗП.Подразделение
	|		КОГДА (НЕ БракВПроизводстве.Подразделение ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.Подразделение
	|		КОГДА (НЕ МатериалыВЭксплуатации.Подразделение ЕСТЬ NULL )
	|			ТОГДА МатериалыВЭксплуатации.Подразделение	
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА НЗП.НоменклатурнаяГруппа
	|		КОГДА (НЕ Затраты.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА Затраты.НоменклатурнаяГруппа
	|		КОГДА (НЕ БракВПроизводстве.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.НоменклатурнаяГруппа
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	|			ТОГДА НЗП.Заказ
	|		КОГДА (НЕ Затраты.Заказ ЕСТЬ NULL )
	|			ТОГДА Затраты.Заказ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ БракВПроизводстве.ХарактеристикаПродукции ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.ХарактеристикаПродукции
	|		КОГДА (НЕ ИсточникДляКомплектации.ХарактеристикаНоменклатуры ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.ХарактеристикаНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ БракВПроизводстве.СерияПродукции ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.СерияПродукции
	|		КОГДА (НЕ ИсточникДляКомплектации.СерияНоменклатуры ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.СерияНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.Номенклатура ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.Номенклатура
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	//начало изменений
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.Качество ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.Качество
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	//конец изменений
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.ДокументОприходования ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.ДокументОприходования
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	|	ЕСТЬNULL(МатериалыВЭксплуатации.ФизЛицо, НЕОПРЕДЕЛЕНО),
	|	ЕСТЬNULL(МатериалыВЭксплуатации.НазначениеИспользования, НЕОПРЕДЕЛЕНО),
	|	ЕСТЬNULL(НЗП.СерияЗатраты, НЕОПРЕДЕЛЕНО),
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_КорСчетНУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_КорСчетНУ,НЕОПРЕДЕЛЕНО)),
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ1,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоНУ1,НЕОПРЕДЕЛЕНО)),
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ2,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоНУ2,НЕОПРЕДЕЛЕНО)),
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ3,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоНУ3,НЕОПРЕДЕЛЕНО)),
	|	Источник.НомерСтрокиСписанныхТоваров,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	|   ЕСТЬNULL(СписанныеТовары.СчетДоходовНУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СчетДоходовНУ,Неопределено)) ,
	|   ЕСТЬNULL(СписанныеТовары.СчетРасходовНУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СчетРасходовНУ,Неопределено)) ,
	|   ЕСТЬNULL(СписанныеТовары.СтатьяДоходовИРасходов,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СтатьяДоходовИРасходов,Неопределено)) ,
	|   ЕСТЬNULL(СписанныеТовары.ПодразделениеОрганизации,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПодразделениеОрганизации,Неопределено))
	|
	|ИМЕЮЩИЕ
	|	СУММА(Источник.Количество) <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	| ВЫБРАТЬ
	|	""НаСкладах"" КАК СписаноИз,
	|	Источник.Организация КАК Организация,
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
	|	Источник.Заказ,
	|	СУММА(Источник.Количество) КАК Количество,
	|	СУММА(Источник.Стоимость) КАК Стоимость,
	|	0 КАК СтоимостьПоступление,
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 		
//		МатериалыВЭксплуатации.ДокументПередачи КАК ДокументПередачи,
	|	Неопределено  КАК ДокументПередачи,
//конец изменений		
	|	NULL КАК ДоговорКонтрагента,
	|	Источник.КодОперации КАК КодОперацииПартииТоваров,
	|	Источник.Качество,
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 		
//		БракВПроизводстве.Продукция,
	|	Неопределено как Продукция,
//конец изменений		
	|	Источник.СчетУчета КАК СчетУчетаНУ,
	|	Источник.КорСчет КАК КорСчетНУ,
	|	Источник.КорСубконто1 КАК КорСубконтоБУ1,
	|	Источник.КорСубконто2 КАК КорСубконтоБУ2,
	|	Источник.КорСубконто3 КАК КорСубконтоБУ3,
	|	Источник.КорСубконто1 КАК КорСубконтоНУ1,
	|	Источник.КорСубконто2 КАК КорСубконтоНУ2,
	|	Источник.КорСубконто3 КАК КорСубконтоНУ3,
	|	СУММА(Источник.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(Источник.ВременнаяРазница) КАК ВременнаяРазница,
	|	ВЫБОР 
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 
	//|		КОГДА (НЕ Затраты.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА Затраты.СтатьяЗатрат
	//|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА НЗП.СтатьяЗатрат
	//|		КОГДА (НЕ БракВПроизводстве.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА БракВПроизводстве.СтатьяЗатрат
	//|		КОГДА (НЕ СписанныеТовары.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА СписанныеТовары.СтатьяЗатрат
	//|		КОГДА (НЕ СписанныеТоварыПоДокументуДвижения.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА СписанныеТоварыПоДокументуДвижения.СтатьяЗатрат
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ КАК СтатьяЗатрат,
	|	ВЫБОР
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 	
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|		КОГДА (НЕ Затраты.Подразделение ЕСТЬ NULL )
	//|			ТОГДА Затраты.Подразделение
	//|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	//|			ТОГДА НЗП.Подразделение
	//|		КОГДА (НЕ БракВПроизводстве.Подразделение ЕСТЬ NULL )
	//|			ТОГДА БракВПроизводстве.Подразделение
	//|		КОГДА (НЕ МатериалыВЭксплуатации.Подразделение ЕСТЬ NULL )
	//|			ТОГДА МатериалыВЭксплуатации.Подразделение
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ КАК ПодразделениеОрганизации,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 	
	//|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	//|			ТОГДА НЗП.НоменклатурнаяГруппа
	//|		КОГДА (НЕ Затраты.НоменклатурнаяГруппа ЕСТЬ NULL )
	//|			ТОГДА Затраты.НоменклатурнаяГруппа
	//|		КОГДА (НЕ БракВПроизводстве.НоменклатурнаяГруппа ЕСТЬ NULL )
	//|			ТОГДА БракВПроизводстве.НоменклатурнаяГруппа
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 	
	|	КОНЕЦ КАК НоменклатурнаяГруппа,
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 			
		//ВЫБОР
		//	КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
		//		ТОГДА НЗП.Заказ
		//	КОГДА (НЕ Затраты.Заказ ЕСТЬ NULL )
		//		ТОГДА Затраты.Заказ
		//	ИНАЧЕ НЕОПРЕДЕЛЕНО
		//КОНЕЦ 
	|	неопределено КАК ЗаказСписания,
///конец изменений 		
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ КАК Регистратор,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ КАК Период,
		//ВЫБОР
		//	КОГДА (НЕ БракВПроизводстве.ХарактеристикаПродукции ЕСТЬ NULL )
		//		ТОГДА БракВПроизводстве.ХарактеристикаПродукции
		//	КОГДА (НЕ ИсточникДляКомплектации.ХарактеристикаНоменклатуры ЕСТЬ NULL )
		//		ТОГДА ИсточникДляКомплектации.ХарактеристикаНоменклатуры
		//	ИНАЧЕ НЕОПРЕДЕЛЕНО
		//КОНЕЦ 
	|	Неопределено КАК ХарактеристикаНоменклатурыНовая,
		//ВЫБОР
		//	КОГДА (НЕ БракВПроизводстве.СерияПродукции ЕСТЬ NULL )
		//		ТОГДА БракВПроизводстве.СерияПродукции
		//	КОГДА (НЕ ИсточникДляКомплектации.СерияНоменклатуры ЕСТЬ NULL )
		//		ТОГДА ИсточникДляКомплектации.СерияНоменклатуры
		//	ИНАЧЕ НЕОПРЕДЕЛЕНО
		//КОНЕЦ 
	|	Неопределено КАК СерияНоменклатурыНовая,
		//ВЫБОР
		//	КОГДА (НЕ ИсточникДляКомплектации.Номенклатура ЕСТЬ NULL )
		//		ТОГДА ИсточникДляКомплектации.Номенклатура
		//	ИНАЧЕ НЕОПРЕДЕЛЕНО
		//КОНЕЦ 
	|	Неопределено КАК НоменклатураНовая,
	//начало изменений
		//ВЫБОР
		//	КОГДА (НЕ ИсточникДляКомплектации.Качество ЕСТЬ NULL )
		//		ТОГДА ИсточникДляКомплектации.Качество
		//	ИНАЧЕ НЕОПРЕДЕЛЕНО
		//КОНЕЦ КАК 
	|	Неопределено КачествоНовое,
	//конец изменений
		//ВЫБОР
		//	КОГДА (НЕ ИсточникДляКомплектации.ДокументОприходования ЕСТЬ NULL )
		//		ТОГДА ИсточникДляКомплектации.ДокументОприходования
		//	ИНАЧЕ НЕОПРЕДЕЛЕНО
		//КОНЕЦ 
	|	Неопределено КАК ДокументОприходованияНовый,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям КАК ВестиПартионныйУчетПоСериям,
	   //ЕСТЬNULL(МатериалыВЭксплуатации.ФизЛицо, НЕОПРЕДЕЛЕНО) КАК ФизЛицо,
	   //ЕСТЬNULL(МатериалыВЭксплуатации.НазначениеИспользования, НЕОПРЕДЕЛЕНО) КАК НазначениеИспользования,
	   //ЕСТЬNULL(НЗП.СерияЗатраты, НЕОПРЕДЕЛЕНО) КАК СерияНоменклтатурыНЗП,
	   //ЕСТЬNULL(СписанныеТовары.ПРГ_КорСчетНУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_КорСчетНУ,НЕОПРЕДЕЛЕНО)) как ПРГ_КорСчетНУ,
	   //ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ1,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоНУ1,НЕОПРЕДЕЛЕНО)) как ПРГ_СубконтоНУ1,
	   //ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ2,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоНУ2,НЕОПРЕДЕЛЕНО)) как ПРГ_СубконтоНУ2,
	   //ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ3,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоНУ3,НЕОПРЕДЕЛЕНО)) как ПРГ_СубконтоНУ3,
	   //Источник.НомерСтрокиСписанныхТоваров КАК НомерСтрокиСписанныхТоваров,
	   //ЕСТЬNULL(СписанныеТовары.СчетДоходовНУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СчетДоходовНУ,Неопределено)) как ПРГСчетДоходов,
	   //ЕСТЬNULL(СписанныеТовары.СчетРасходовНУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СчетРасходовНУ,Неопределено)) как ПРГСчетРасходов,
	   //ЕСТЬNULL(СписанныеТовары.СтатьяДоходовИРасходов,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СтатьяДоходовИРасходов,Неопределено)) как ПРГСтатьяДоходовИРасходов,
	   //ЕСТЬNULL(СписанныеТовары.ПодразделениеОрганизации,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПодразделениеОрганизации,Неопределено)) как ПРГПодразделениеОрганизации
	 |  НЕОПРЕДЕЛЕНО КАК ФизЛицо,
	 |  НЕОПРЕДЕЛЕНО КАК НазначениеИспользования,
	 |  НЕОПРЕДЕЛЕНО КАК СерияНоменклтатурыНЗП,
	 |  НЕОПРЕДЕЛЕНО как ПРГ_КорСчетНУ,
	 |  НЕОПРЕДЕЛЕНО как ПРГ_СубконтоНУ1,
	 |  НЕОПРЕДЕЛЕНО как ПРГ_СубконтоНУ2,
	 |  НЕОПРЕДЕЛЕНО как ПРГ_СубконтоНУ3,
	 |  Источник.НомерСтрокиСписанныхТоваров КАК НомерСтрокиСписанныхТоваров,	   
	 |  Неопределено  как ПРГСчетДоходов,
	 |  Неопределено как ПРГСчетРасходов,
	 |  Неопределено как ПРГСтатьяДоходовИРасходов,
	 |  Неопределено как ПРГПодразделениеОрганизации
	   
	//конец изменений 
	| ИЗ
	|	РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК Источник
	|  Внутреннее СОЕДИНЕНИЕ Табпартий как Табпартий по Табпартий.Период = Источник.Период и Табпартий.Регистратор = Источник.Регистратор и  Табпартий.НомерСтроки = Источник.НомерСтроки  и Табпартий.КодОперации в (&КодыСписаниеНеВсеТабл)
	|	И Табпартий.КодОперации В(&КодыСписаниеНеВсеТабл)"
	+?(Не ПРГ_ТолькоНаЗатратыВлНаСеб,"","
	|  И ((Табпартий.КодОперации В(&КодыСписаниеСоСчетами) и Табпартий.КорСчет в (&СчетаЗатрат))
	|  или Табпартий.КодОперации В(&КодыСписаниеБезСчетов))
	|")+"	
	//		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗатратыНалоговыйУчет КАК Затраты
	//		ПО Источник.Регистратор = Затраты.Регистратор
	//			И Источник.НомерКорСтроки = Затраты.НомерСтроки
	//			И Источник.КорСчет = Затраты.СчетУчета
	//		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.НезавершенноеПроизводствоНалоговыйУчет КАК НЗП
	//		ПО Источник.Регистратор = НЗП.Регистратор
	//			И Источник.НомерКорСтроки = НЗП.НомерСтроки
	//			И Источник.КорСчет = НЗП.СчетУчета
	//		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.БракВПроизводствеНалоговыйУчет КАК БракВПроизводстве
	//		ПО Источник.Регистратор = БракВПроизводстве.Регистратор
	//			И Источник.НомерКорСтроки = БракВПроизводстве.НомерСтроки
	//			И Источник.КорСчет = БракВПроизводстве.СчетУчета
	//		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК ИсточникДляКомплектации
	//		ПО Источник.Регистратор = ИсточникДляКомплектации.Регистратор
	//			И Источник.НомерКорСтроки = ИсточникДляКомплектации.НомерСтроки
	//			И (Источник.КодОперации В (&КодКомплектация))
	//		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииМатериаловВЭксплуатацииНалоговыйУчет КАК МатериалыВЭксплуатации
	//		ПО Источник.Регистратор = МатериалыВЭксплуатации.Регистратор
	//			И (Источник.КодОперации В (&КодПередачаМатериалов))
	//			И Источник.НомерКорСтроки = МатериалыВЭксплуатации.НомерСтроки
	//		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СписанныеТовары КАК СписанныеТовары
	//		ПО Источник.Регистратор = СписанныеТовары.Регистратор
	//			И Источник.НомерСтрокиСписанныхТоваров = СписанныеТовары.НомерСтроки
	////начало изменений Ожиганов 06.05.2015 изменения по браку 
	//			И (Источник.Регистратор ССЫЛКА Документ.ТребованиеНакладная или Источник.Регистратор ССЫЛКА Документ.СписаниеТоваров или Источник.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику или (Источник.КодОперации=Значение(Перечисление.КодыОперацийПартииТоваров.ВозвратПоставщику) и Источник.Регистратор ССЫЛКА Документ.КорректировкаЗаписейРегистров))
	////конец изменений 
	//		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СписанныеТовары КАК СписанныеТоварыПоДокументуДвижения
	//		ПО Источник.ДокументДвижения = СписанныеТоварыПоДокументуДвижения.Регистратор
	//			И Источник.НомерСтрокиСписанныхТоваров = СписанныеТоварыПоДокументуДвижения.НомерСтроки
	////начало изменений Ожиганов 06.05.2015 изменения по браку 
	//			И (Источник.ДокументДвижения ССЫЛКА Документ.ТребованиеНакладная или Источник.ДокументДвижения ССЫЛКА Документ.СписаниеТоваров или Источник.ДокументДвижения ССЫЛКА Документ.ВозвратТоваровПоставщику или (Источник.КодОперации=Значение(Перечисление.КодыОперацийПартииТоваров.ВозвратПоставщику) и Источник.ДокументДвижения ССЫЛКА Документ.КорректировкаЗаписейРегистров))
	////конец изменений 
//	ГДЕ
//	//ГДЕ
//		Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
//		И Источник.ВидДвижения = &ВидДвиженияРасход
////начало изменений Ожиганов 28.01.2016 б/н исключение неактивных записей из р/с и корректировки стоимости 
//		И Источник.Активность
////конец изменений 
//	//@ИсклКомпл	И НЕ ( 1 В
//	//@ИсклКомпл			(ВЫБРАТЬ Первые 1
//	//@ИсклКомпл	1
//	//@ИсклКомпл	ИЗ
//	//@ИсклКомпл	ТаблИсклКомпл КАК ТаблИсклКомпл	
//	//@ИсклКомпл	Где	
//	//@ИсклКомпл	ТаблИсклКомпл.Регистратор =Источник.Регистратор
//	//@ИсклКомпл	И ТаблИсклКомпл.НомерСтрокиСписанныхТоваров =Источник.НомерСтрокиСписанныхТоваров))	
//	
//		И Источник.КодОперации В(&КодыСписание)"
//	+?(Не ПРГ_ТолькоНаЗатратыВлНаСеб,"","
//	  И ((Источник.КодОперации В(&КодыСписаниеСоСчетами) и Источник.КорСчет в (&СчетаЗатрат))
//	  или Источник.КодОперации В(&КодыСписаниеБезСчетов))
//	")+"
	
	|СГРУППИРОВАТЬ ПО
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
//		МатериалыВЭксплуатации.ДокументПередачи,
	|	Источник.Заказ,
	|	Источник.КодОперации,
	|	Источник.Качество,
//		БракВПроизводстве.Продукция,
	|	Источник.Организация,
	|	Источник.СчетУчета,
	|	Источник.КорСчет,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	|	ВЫБОР 
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 
	//|		КОГДА (НЕ Затраты.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА Затраты.СтатьяЗатрат
	//|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА НЗП.СтатьяЗатрат
	//|		КОГДА (НЕ БракВПроизводстве.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА БракВПроизводстве.СтатьяЗатрат
	//|		КОГДА (НЕ СписанныеТовары.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА СписанныеТовары.СтатьяЗатрат
	//|		КОГДА (НЕ СписанныеТоварыПоДокументуДвижения.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА СписанныеТоварыПоДокументуДвижения.СтатьяЗатрат
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ,
	|	ВЫБОР
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 	
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|		КОГДА (НЕ Затраты.Подразделение ЕСТЬ NULL )
	//|			ТОГДА Затраты.Подразделение
	//|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	//|			ТОГДА НЗП.Подразделение
	//|		КОГДА (НЕ БракВПроизводстве.Подразделение ЕСТЬ NULL )
	//|			ТОГДА БракВПроизводстве.Подразделение
	//|		КОГДА (НЕ МатериалыВЭксплуатации.Подразделение ЕСТЬ NULL )
	//|			ТОГДА МатериалыВЭксплуатации.Подразделение
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 	
	//|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	//|			ТОГДА НЗП.НоменклатурнаяГруппа
	//|		КОГДА (НЕ Затраты.НоменклатурнаяГруппа ЕСТЬ NULL )
	//|			ТОГДА Затраты.НоменклатурнаяГруппа
	//|		КОГДА (НЕ БракВПроизводстве.НоменклатурнаяГруппа ЕСТЬ NULL )
	//|			ТОГДА БракВПроизводстве.НоменклатурнаяГруппа
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//начало изменений Ожиганов 14.03.2016 оптимизируем запрос 	
	|	КОНЕЦ ,
		//ВЫБОР
		//	КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
		//		ТОГДА НЗП.Заказ
		//	КОГДА (НЕ Затраты.Заказ ЕСТЬ NULL )
		//		ТОГДА Затраты.Заказ
		//	ИНАЧЕ НЕОПРЕДЕЛЕНО
		//КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	//	ВЫБОР
	//		КОГДА (НЕ БракВПроизводстве.ХарактеристикаПродукции ЕСТЬ NULL )
	//			ТОГДА БракВПроизводстве.ХарактеристикаПродукции
	//		КОГДА (НЕ ИсточникДляКомплектации.ХарактеристикаНоменклатуры ЕСТЬ NULL )
	//			ТОГДА ИсточникДляКомплектации.ХарактеристикаНоменклатуры
	//		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//	КОНЕЦ,
	//	ВЫБОР
	//		КОГДА (НЕ БракВПроизводстве.СерияПродукции ЕСТЬ NULL )
	//			ТОГДА БракВПроизводстве.СерияПродукции
	//		КОГДА (НЕ ИсточникДляКомплектации.СерияНоменклатуры ЕСТЬ NULL )
	//			ТОГДА ИсточникДляКомплектации.СерияНоменклатуры
	//		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//	КОНЕЦ,
	//	ВЫБОР
	//		КОГДА (НЕ ИсточникДляКомплектации.Номенклатура ЕСТЬ NULL )
	//			ТОГДА ИсточникДляКомплектации.Номенклатура
	//		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//	КОНЕЦ,
	////начало изменений
	//	ВЫБОР
	//		КОГДА (НЕ ИсточникДляКомплектации.Качество ЕСТЬ NULL )
	//			ТОГДА ИсточникДляКомплектации.Качество
	//		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//	КОНЕЦ,
	////конец изменений
	//	ВЫБОР
	//		КОГДА (НЕ ИсточникДляКомплектации.ДокументОприходования ЕСТЬ NULL )
	//			ТОГДА ИсточникДляКомплектации.ДокументОприходования
	//		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//	КОНЕЦ,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	   // ЕСТЬNULL(МатериалыВЭксплуатации.ФизЛицо, НЕОПРЕДЕЛЕНО),
	   // ЕСТЬNULL(МатериалыВЭксплуатации.НазначениеИспользования, НЕОПРЕДЕЛЕНО),
	   // ЕСТЬNULL(НЗП.СерияЗатраты, НЕОПРЕДЕЛЕНО),
	   //ЕСТЬNULL(СписанныеТовары.ПРГ_КорСчетНУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_КорСчетНУ,НЕОПРЕДЕЛЕНО)),
	   //ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ1,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоНУ1,НЕОПРЕДЕЛЕНО)),
	   //ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ2,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоНУ2,НЕОПРЕДЕЛЕНО)),
	   //ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ3,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПРГ_СубконтоНУ3,НЕОПРЕДЕЛЕНО)),
	|	Источник.НомерСтрокиСписанныхТоваров,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3
	   //ЕСТЬNULL(СписанныеТовары.СчетДоходовНУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СчетДоходовНУ,Неопределено)) ,
	   //ЕСТЬNULL(СписанныеТовары.СчетРасходовНУ,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СчетРасходовНУ,Неопределено)) ,
	   //ЕСТЬNULL(СписанныеТовары.СтатьяДоходовИРасходов,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.СтатьяДоходовИРасходов,Неопределено)) ,
	   //ЕСТЬNULL(СписанныеТовары.ПодразделениеОрганизации,ЕСТЬNULL(СписанныеТоварыПоДокументуДвижения.ПодразделениеОрганизации,Неопределено))
	| ИМЕЮЩИЕ
	|	СУММА(Источник.Количество) <> 0	

	|ОБЪЕДИНИТЬ ВСЕ	
	|
	|ВЫБРАТЬ
	|	""Переданные"",
	|	Источник.Организация,
	|	Источник.Номенклатура,
	|	NULL,
	|	Источник.ХарактеристикаНоменклатуры,
	|	NULL,
	|	Источник.ДокументОприходования,
	|	NULL,
	|	СУММА(Источник.Количество),
	|	СУММА(Источник.Стоимость),
	|	0,
	|	Источник.ДокументПередачи,
	|	Источник.ДоговорКонтрагента,
	|	Источник.КодОперации,
	|	NULL,
	|	NULL,
	|	Источник.СчетУчета,
	|	Источник.КорСчет,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	|	СУММА(Источник.ПостояннаяРазница),
	|	СУММА(Источник.ВременнаяРазница),
	|	ВЫБОР
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	//|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА НЗП.СтатьяЗатрат
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ,
	|	ВЫБОР
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	//|			ТОГДА НЗП.Подразделение
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ,
	|	ВЫБОР
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	|		КОГДА ТипЗначения(Источник.КорСубконто1) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	//|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	//|			ТОГДА НЗП.НоменклатурнаяГруппа
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ,
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	//|	ВЫБОР
	//|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	//|			ТОГДА НЗП.Заказ
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|	КОНЕЦ,
	| НЕОПРЕДЕЛЕНО,
//конец изменений 	
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	//начало изменений Ожиганов 06.05.2015 изменения по браку 
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	//конец изменений 
	|	NULL
	|ИЗ
	|	РегистрНакопления.ПартииТоваровПереданныеНалоговыйУчет КАК Источник
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	//|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.НезавершенноеПроизводствоНалоговыйУчет КАК НЗП
	//|		ПО Источник.Регистратор = НЗП.Регистратор
	//|			И Источник.НомерКорСтроки = НЗП.НомерСтроки
	//|			И Источник.КорСчет = НЗП.СчетУчета
//конец изменений 	
	|ГДЕ
	|//ГДЕ
	|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И Источник.ВидДвижения = &ВидДвиженияРасход
	|	И Источник.КодОперации В(&КодыСписание)
//начало изменений Ожиганов 28.01.2016 б/н исключение неактивных записей из р/с и корректировки стоимости 
	|	И Источник.Активность
//конец изменений 
	|
	|СГРУППИРОВАТЬ ПО
	|	Источник.Номенклатура,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.ДокументОприходования,
	|	Источник.ДокументПередачи,
	|	Источник.ДоговорКонтрагента,
	|	Источник.КодОперации,
	|	Источник.СчетУчета,
	|	Источник.Организация,
	|	Источник.КорСчет,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	|	ВЫБОР
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	//|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	//|			ТОГДА НЗП.СтатьяЗатрат
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ,
	|	ВЫБОР
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	//|			ТОГДА НЗП.Подразделение
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ,
	|	ВЫБОР
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	|		КОГДА ТипЗначения(Источник.КорСубконто1) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	//|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	//|			ТОГДА НЗП.НоменклатурнаяГруппа
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
//конец изменений 	
	|	КОНЕЦ,
//начало изменений Ожиганов 04.04.2016 неверно формируются движения в части регистра затрат 	
	//|	ВЫБОР
	//|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	//|			ТОГДА НЗП.Заказ
	//|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	//|	КОНЕЦ,
//конец изменений 	
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3
	|
	|ИМЕЮЩИЕ
	|	СУММА(Источник.Количество) <> 0
	|
//Партии материалов в эксплуатации	
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ВЭксплуатации"" КАК СписаноИз,
	|	Источник.Организация КАК Организация,
	|	Источник.Номенклатура,
	|	NULL,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	NULL,
	|	NULL,
	|	СУММА(Источник.Количество) КАК Количество,
	|	СУММА(Источник.Стоимость) КАК Стоимость,
	|	0 КАК СтоимостьПоступление,
	|	Источник.ДокументПередачи КАК ДокументПередачи,
	|	NULL КАК ДоговорКонтрагента,
	|	Источник.КодОперации КАК КодОперацииПартииТоваров,
	|	NULL,
	|	NULL,
	|	Источник.СчетУчета КАК СчетУчетаНУ,
	|	СписанныеТовары.КорСчетНУ КАК КорСчетНУ,
	|	СписанныеТовары.КорСубконтоБУ1 КАК КорСубконтоБУ1,
	|	СписанныеТовары.КорСубконтоБУ2 КАК КорСубконтоБУ2,
	|	СписанныеТовары.КорСубконтоБУ3 КАК КорСубконтоБУ3,
	|	СписанныеТовары.КорСубконтоНУ1 КАК КорСубконтоНУ1,
	|	СписанныеТовары.КорСубконтоНУ2 КАК КорСубконтоНУ2,
	|	СписанныеТовары.КорСубконтоНУ3 КАК КорСубконтоНУ3,
	|	СУММА(Источник.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(Источник.ВременнаяРазница) КАК ВременнаяРазница,
	|	NULL,
	|	Источник.Подразделение КАК ПодразделениеОрганизации,
	|	NULL КАК НоменклатурнаяГруппа,
	|	NULL КАК ЗаказСписания,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ КАК Регистратор,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ КАК Период,
	|	NULL КАК ХарактеристикаНоменклатурыНовая,
	|	NULL КАК СерияНоменклатурыНовая,
	|	NULL КАК НоменклатураНовая,
	|	NULL,
	|	NULL КАК ДокументОприходованияНовый,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям КАК ВестиПартионныйУчетПоСериям,
	|	Источник.ФизЛицо КАК ФизЛицо,
	|	Источник.НазначениеИспользования КАК НазначениеИспользования,
	|	НЕОПРЕДЕЛЕНО КАК СерияНоменклтатурыНЗП,
	|   Null,
	|   Null,
	|   Null,
	|   Null,
	//начало изменений Ожиганов 06.05.2015 изменения по браку 
	|	Источник.НомерСтрокиСписанныхТоваров КАК НомерСтрокиСписанныхТоваров,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL
	//конец изменений 
	|ИЗ
	|	РегистрНакопления.ПартииМатериаловВЭксплуатацииНалоговыйУчет КАК Источник
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СписанныеТовары КАК СписанныеТовары
	|		ПО Источник.Регистратор = СписанныеТовары.Регистратор
	|			И Источник.НомерСтрокиСписанныхТоваров = СписанныеТовары.НомерСтроки
	|ГДЕ
	|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И Источник.ВидДвижения = &ВидДвиженияРасход
	|	И Источник.КодОперации В(&КодыСписание)
	|"+?(МассивНоменклатуры <> Неопределено," И Источник.Номенклатура В (&МассивНоменклатуры) ","")+"
	|
	|СГРУППИРОВАТЬ ПО
	|	Источник.Номенклатура,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументПередачи,
	|	Источник.КодОперации,
	|	Источник.Организация,
	|	Источник.СчетУчета,
	|	СписанныеТовары.КорСчетНУ,
	|	СписанныеТовары.КорСубконтоБУ1,
	|	СписанныеТовары.КорСубконтоБУ2,
	|	СписанныеТовары.КорСубконтоБУ3,
	|	Источник.Подразделение,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	|	Источник.ФизЛицо,
	|	Источник.НазначениеИспользования,
	|	Источник.НомерСтрокиСписанныхТоваров,
	|	СписанныеТовары.КорСубконтоНУ1,
	|	СписанныеТовары.КорСубконтоНУ2,
	|	СписанныеТовары.КорСубконтоНУ3
	|
	|ИМЕЮЩИЕ
	|	СУММА(Источник.Количество) <> 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	Период,
//начало изменений Ожиганов 04.05.2016 б/н исправление ошибок округления в НУ 	
	|	Регистратор,
	|	Количество
//конец изменений
	|";
	
	//Добавим дополнительный отбор по счету
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ 
	|	(НЕ Источник.СчетУчета В (&СписокИсключаемыхСчетовУчета)) И ");
	
	Запрос.УстановитьПараметр("СписокИсключаемыхСчетовУчета",ПолучитьМассивИсключаемыхСчетов());
	
	// Если задана организация, отбор по организации 
	Если ЗначениеЗаполнено(Организация) Тогда
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ
		|	Источник.Организация = &Организация И ");
		
		Запрос.УстановитьПараметр("Организация", Организация);
		
	КонецЕсли;
	
	// Добавим дополнительный отбор по номенклатуре
	Если МассивНоменклатуры <> Неопределено Тогда
		
		ТекстОграничениеНаПартии = "";
		Если ЗначениеЗаполнено(Организация) Тогда
			СпособОценкиМПЗ = ВРег(Строка(УправлениеЗапасамиПартионныйУчет.ПолучитьПараметрУчетнойПолитикиПартионногоУчета("СпособОценкиМПЗ", "Нал", ДопПараметры)));
			Если СпособОценкиМПЗ = "ФИФО" 
				ИЛИ СпособОценкиМПЗ = "ЛИФО" Тогда
				
				ТекстОграничениеНаПартии = " И Источник.ДокументОприходования В (&МассивДокументовОприходования) ";
				
			КонецЕсли;
		КонецЕсли;
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ 
		|	Источник.Номенклатура В (&МассивНоменклатуры)
		|	" + ТекстОграничениеНаПартии + " И ");
		
	КонецЕсли;
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ 
	|	Источник.Номенклатура В (&МассивНоменклатуры)
	|	" + ТекстОграничениеНаПартии + " И ");
	
	// Встречный выпуск
	Если ДопПараметры.ВстречныйВыпуск Тогда
		КодыОпераций = Перечисления.КодыОперацийПартииТоваров;
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ",
			" //ГДЕ
			|	НЕ ( 1 В
			|	(ВЫБРАТЬ Первые 1
			|		1
			|	ИЗ
			|		РегистрСведений.КорректировкаВстречногоВыпускаПродукции КАК КорректировкаВстречногоВыпускаПродукции
			|	ГДЕ
			|		Источник.НомерСтрокиСписанныхТоваров = КорректировкаВстречногоВыпускаПродукции.НомерСтрокиСписанныхТоваров
			|		" + ДобавитьОтборПоВидуУчета("КорректировкаВстречногоВыпускаПродукции","Нал") + "
			|		И Источник.Регистратор = КорректировкаВстречногоВыпускаПродукции.Документ))
			| И");
		Запрос.УстановитьПараметр("СписаниеПартийВПроизводствоОперативно",КодыОпераций.СписаниеПартийВПроизводствоОперативно);
		
	КонецЕсли;

КонецПроцедуры // ЗаполнитьЗапросПоСписаниюНал()

// Запрос по списанию: Меж
//
// Параметры:
//	Нет.
//
Процедура ЗаполнитьЗапросПоСписаниюМеж(Запрос, МассивНоменклатуры, ДопПараметры)
	
	Организация = ДопПараметры.Организация;
	
	//// is ЯннуровВФ нач 20150118
	//лИсключитьМатериалы = Ложь;
	//Если ДопПараметры.Свойство("ТипЗначенияРегистратора") 
	// И ДопПараметры.ТипЗначенияРегистратора = Тип("ДокументСсылка.РасчетСебестоимостиВыпуска") Тогда 
	//	лИсключитьМатериалы = Истина;
	//КонецЕсли;
	//// is ЯннуровВФ кон 20150118
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	""НаСкладах"" КАК СписаноИз,
	|	Источник.Организация КАК Организация,
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
	|	Источник.Заказ,
	|	СУММА(Источник.Количество) КАК Количество,
	|	СУММА(Источник.Стоимость) КАК Стоимость,
	|	0 КАК СтоимостьПоступление,
	|	NULL КАК ДокументПередачи,
	|	NULL КАК ДоговорКонтрагента,
	|	Источник.КодОперации КАК КодОперацииПартииТоваров,
	|	Источник.Качество,
	|	БракВПроизводстве.Продукция,
	|	Источник.СчетУчета КАК СчетУчетаМУ,
	|	Источник.КорСчет КАК КорСчетМУ,
	|	Источник.КорСубконто1 КАК КорСубконтоМУ1,
	|	Источник.КорСубконто2 КАК КорСубконтоМУ2,
	|	Источник.КорСубконто3 КАК КорСубконтоМУ3,
	|	ВЫБОР
	|		КОГДА (НЕ Затраты.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА Затраты.СтатьяЗатрат
	|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА НЗП.СтатьяЗатрат
	|		КОГДА (НЕ БракВПроизводстве.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.СтатьяЗатрат
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК СтатьяЗатрат,
	|	ВЫБОР
	|		КОГДА (НЕ Затраты.Подразделение ЕСТЬ NULL )
	|			ТОГДА Затраты.Подразделение
	|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	|			ТОГДА НЗП.Подразделение
	|		КОГДА (НЕ БракВПроизводстве.Подразделение ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.Подразделение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ПодразделениеОрганизации,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА НЗП.НоменклатурнаяГруппа
	|		КОГДА (НЕ Затраты.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА Затраты.НоменклатурнаяГруппа
	|		КОГДА (НЕ БракВПроизводстве.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.НоменклатурнаяГруппа
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК НоменклатурнаяГруппа,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	|			ТОГДА НЗП.Заказ
	|		КОГДА (НЕ Затраты.Заказ ЕСТЬ NULL )
	|			ТОГДА Затраты.Заказ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказСписания,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ КАК Регистратор,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ КАК Период,
	// is ЯннуровВФ нач 20150604
	//|	БракВПроизводстве.ХарактеристикаПродукции КАК ХарактеристикаНоменклатурыНовая,
	//|	БракВПроизводстве.СерияПродукции КАК СерияНоменклатурыНовая,
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.Номенклатура ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.Номенклатура
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК НоменклатураНовая,
	|	ВЫБОР
	|		КОГДА (НЕ БракВПроизводстве.ХарактеристикаПродукции ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.ХарактеристикаПродукции
	|		КОГДА (НЕ ИсточникДляКомплектации.ХарактеристикаНоменклатуры ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.ХарактеристикаНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ХарактеристикаНоменклатурыНовая,
	|	ВЫБОР
	|		КОГДА (НЕ БракВПроизводстве.СерияПродукции ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.СерияПродукции
	|		КОГДА (НЕ ИсточникДляКомплектации.СерияНоменклатуры ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.СерияНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК СерияНоменклатурыНовая,
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.Качество ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.Качество
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК КачествоНовое,
	// is ЯннуровВФ кон 20150604
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям КАК ВестиПартионныйУчетПоСериям,
	|	НЕОПРЕДЕЛЕНО КАК ФизЛицо,
	|	НЕОПРЕДЕЛЕНО КАК НазначениеИспользования,
	|	ЕСТЬNULL(НЗП.СерияЗатраты, НЕОПРЕДЕЛЕНО) КАК СерияНоменклтатурыНЗП,
	|	Источник.НомерСтрокиСписанныхТоваров КАК НомерСтрокиСписанныхТоваров
	|ИЗ
	|	РегистрНакопления.ПартииТоваровНаСкладахМеждународныйУчет КАК Источник
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗатратыМеждународныйУчет КАК Затраты
	|		ПО Источник.Регистратор = Затраты.Регистратор
	|			И Источник.НомерКорСтроки = Затраты.НомерСтроки
	|			И Источник.КорСчет = Затраты.СчетУчета
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.НезавершенноеПроизводствоМеждународныйУчет КАК НЗП
	|		ПО Источник.Регистратор = НЗП.Регистратор
	|			И Источник.НомерКорСтроки = НЗП.НомерСтроки
	|			И Источник.КорСчет = НЗП.СчетУчета
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.БракВПроизводствеМеждународныйУчет КАК БракВПроизводстве
	|		ПО Источник.Регистратор = БракВПроизводстве.Регистратор
	|			И Источник.НомерКорСтроки = БракВПроизводстве.НомерСтроки
	|			И Источник.КорСчет = БракВПроизводстве.СчетУчета
	// is ЯннуровВФ нач 20150604
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладахМеждународныйУчет КАК ИсточникДляКомплектации
	|		ПО Источник.Регистратор = ИсточникДляКомплектации.Регистратор
	|			И Источник.НомерКорСтроки = ИсточникДляКомплектации.НомерСтроки
	|			И (Источник.КодОперации В (&КодКомплектация))
	// is ЯннуровВФ кон 20150604
	|ГДЕ
	|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И Источник.ВидДвижения = &ВидДвиженияРасход
	|	И Источник.КодОперации В(&КодыСписание)
//>> Степанов 12.02.2016 №48472 исключение неактивных записей из р/с и корректировки стоимости
    |	И Источник.Активность 
//<<	
	//// is ЯннуровВФ нач 20150118
	//|	"+?(лИсключитьМатериалы, "И Источник.СчетУчета НЕ В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Международный.СырьеИМатериалы))", "")+"
	//// is ЯннуровВФ кон 20150118
	|
	|СГРУППИРОВАТЬ ПО
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
	|	Источник.Заказ,
	|	Источник.КодОперации,
	|	Источник.Качество,
	|	БракВПроизводстве.Продукция,
	|	Источник.Организация,
	|	Источник.СчетУчета,
	|	Источник.КорСчет,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	|	ВЫБОР
	|		КОГДА (НЕ Затраты.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА Затраты.СтатьяЗатрат
	|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА НЗП.СтатьяЗатрат
	|		КОГДА (НЕ БракВПроизводстве.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.СтатьяЗатрат
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ Затраты.Подразделение ЕСТЬ NULL )
	|			ТОГДА Затраты.Подразделение
	|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	|			ТОГДА НЗП.Подразделение
	|		КОГДА (НЕ БракВПроизводстве.Подразделение ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.Подразделение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА НЗП.НоменклатурнаяГруппа
	|		КОГДА (НЕ Затраты.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА Затраты.НоменклатурнаяГруппа
	|		КОГДА (НЕ БракВПроизводстве.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.НоменклатурнаяГруппа
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	|			ТОГДА НЗП.Заказ
	|		КОГДА (НЕ Затраты.Заказ ЕСТЬ NULL )
	|			ТОГДА Затраты.Заказ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	// is ЯннуровВФ нач 20150604
	//|	БракВПроизводстве.ХарактеристикаПродукции,
	//|	БракВПроизводстве.СерияПродукции,
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.Номенклатура ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.Номенклатура
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ БракВПроизводстве.ХарактеристикаПродукции ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.ХарактеристикаПродукции
	|		КОГДА (НЕ ИсточникДляКомплектации.ХарактеристикаНоменклатуры ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.ХарактеристикаНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ БракВПроизводстве.СерияПродукции ЕСТЬ NULL )
	|			ТОГДА БракВПроизводстве.СерияПродукции
	|		КОГДА (НЕ ИсточникДляКомплектации.СерияНоменклатуры ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.СерияНоменклатуры
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ ИсточникДляКомплектации.Качество ЕСТЬ NULL )
	|			ТОГДА ИсточникДляКомплектации.Качество
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	// is ЯннуровВФ кон 20150604
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	|	ЕСТЬNULL(НЗП.СерияЗатраты, НЕОПРЕДЕЛЕНО),
	|	Источник.НомерСтрокиСписанныхТоваров
	|
	|ИМЕЮЩИЕ
	|	СУММА(Источник.Количество) <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Переданные"",
	|	Источник.Организация,
	|	Источник.Номенклатура,
	|	NULL,
	|	Источник.ХарактеристикаНоменклатуры,
	|	NULL,
	|	Источник.ДокументОприходования,
	|	NULL,
	|	СУММА(Источник.Количество),
	|	СУММА(Источник.Стоимость),
	|	0,
	|	Источник.ДокументПередачи,
	|	Источник.ДоговорКонтрагента,
	|	Источник.КодОперации,
	|	NULL,
	|	NULL,
	|	Источник.СчетУчета,
	|	Источник.КорСчет,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	// is ЯннуровВФ нач 20150604
	//|	NULL,
	//|	NULL,
	//|	NULL,
	//|	NULL,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА НЗП.СтатьяЗатрат
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	|			ТОГДА НЗП.Подразделение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА НЗП.НоменклатурнаяГруппа
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	|			ТОГДА НЗП.Заказ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	// is ЯннуровВФ кон 20150604
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	// is ЯннуровВФ нач 20150604
	//|	NULL,
	//|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	// is ЯннуровВФ кон 20150604
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL
	|ИЗ
	|	РегистрНакопления.ПартииТоваровПереданныеМеждународныйУчет КАК Источник
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.НезавершенноеПроизводствоМеждународныйУчет КАК НЗП
	|		ПО Источник.Регистратор = НЗП.Регистратор
	|			И Источник.НомерКорСтроки = НЗП.НомерСтроки
	|			И Источник.КорСчет = НЗП.СчетУчета
	|ГДЕ
	|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И Источник.ВидДвижения = &ВидДвиженияРасход
	|	И Источник.КодОперации В(&КодыСписание)
//>> Степанов 12.02.2016 №48472 исключение неактивных записей из р/с и корректировки стоимости
    |	И Источник.Активность
//<<	
	//// is ЯннуровВФ нач 20150118
	//|	"+?(лИсключитьМатериалы, "И Источник.СчетУчета НЕ В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Международный.СырьеИМатериалы))", "")+"
	//// is ЯннуровВФ кон 20150118
	|
	|СГРУППИРОВАТЬ ПО
	|	Источник.Номенклатура,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.ДокументОприходования,
	|	Источник.ДокументПередачи,
	|	Источник.ДоговорКонтрагента,
	|	Источник.КодОперации,
	|	Источник.СчетУчета,
	|	Источник.Организация,
	|	Источник.КорСчет,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	// is ЯннуровВФ нач 20150604
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.СтатьяЗатрат ЕСТЬ NULL )
	|			ТОГДА НЗП.СтатьяЗатрат
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.Подразделение ЕСТЬ NULL )
	|			ТОГДА НЗП.Подразделение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.НоменклатурнаяГруппа ЕСТЬ NULL )
	|			ТОГДА НЗП.НоменклатурнаяГруппа
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (НЕ НЗП.Заказ ЕСТЬ NULL )
	|			ТОГДА НЗП.Заказ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	// is ЯннуровВФ кон 20150604
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям
	|
	|ИМЕЮЩИЕ
	|	СУММА(Источник.Количество) <> 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	Период,
	|	Регистратор";
	
	//Добавим дополнительный отбор по счету
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "ГДЕ", "ГДЕ (НЕ Источник.СчетУчета В (&СписокИсключаемыхСчетовУчета)) И ");
	Запрос.УстановитьПараметр("СписокИсключаемыхСчетовУчета",ПолучитьМассивИсключаемыхСчетов());	
	
	// Если задана организация, отбор по организации 
	Если ЗначениеЗаполнено(Организация) Тогда
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ГДЕ", "ГДЕ Источник.Организация = &Организация И ");
		
		Запрос.УстановитьПараметр("Организация", Организация);
		
	КонецЕсли;
	
	// Добавим дополнительный отбор по номенклатуре
	Если МассивНоменклатуры <> Неопределено Тогда
		
		ТекстОграничениеНаПартии = "";
		Если ЗначениеЗаполнено(Организация) Тогда
			СпособОценкиМПЗ = ВРег(Строка(УправлениеЗапасамиПартионныйУчет.ПолучитьПараметрУчетнойПолитикиПартионногоУчета("СпособОценкиМПЗ", "Меж", ДопПараметры)));
			Если СпособОценкиМПЗ = "ФИФО" 
				ИЛИ СпособОценкиМПЗ = "ЛИФО" Тогда
				
				ТекстОграничениеНаПартии = " И Источник.ДокументОприходования В (&МассивДокументовОприходования) ";
				
			КонецЕсли;
		КонецЕсли;
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ГДЕ", "ГДЕ Источник.Номенклатура В (&МассивНоменклатуры)
		|	" + ТекстОграничениеНаПартии + " И ");
		
	КонецЕсли;
	
	// Встречный выпуск
	Если ДопПараметры.ВстречныйВыпуск Тогда
		КодыОпераций = Перечисления.КодыОперацийПартииТоваров;
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ГДЕ",
			" ГДЕ НЕ ( 1 В
			|	(ВЫБРАТЬ Первые 1
			|		1
			|	ИЗ
			|		РегистрСведений.КорректировкаВстречногоВыпускаПродукции КАК КорректировкаВстречногоВыпускаПродукции
			|	ГДЕ
			|		Источник.НомерСтрокиСписанныхТоваров = КорректировкаВстречногоВыпускаПродукции.НомерСтрокиСписанныхТоваров
			|		" + ДобавитьОтборПоВидуУчета("КорректировкаВстречногоВыпускаПродукции","Меж") + "
			|		И Источник.Регистратор = КорректировкаВстречногоВыпускаПродукции.Документ))
			| И");
		Запрос.УстановитьПараметр("СписаниеПартийВПроизводствоОперативно",КодыОпераций.СписаниеПартийВПроизводствоОперативно);
		
	КонецЕсли;
	
КонецПроцедуры // ЗаполнитьЗапросПоСписаниюМеж()



//конец изменений
//начало изменений
Функция ПРГ_ПолучитьКомплекты(ДатаНач,ДатаКон,РегламентныйДокумент,ДопПараметры) Экспорт
	
	Если ТипЗнч(РегламентныйДокумент) <> Тип("ДокументСсылка.РасчетСебестоимостиВыпуска")
	 или 
	НЕ ( ДопПараметры.ОтражатьВБухгалтерскомУчете или  ДопПараметры.ОтражатьВНалоговомУчете)
	Тогда
	 	возврат  ПолучитьТаблицуПартийПоКодуОперации(ДатаНач,ДатаКон,ДопПараметры,Перечисления.КодыОперацийПартииТоваров.Комплектация,ВидДвиженияНакопления.Приход);
	//Сообщить("Тута");
	КонецЕсли;	
	
	ВидОтраженияВУчете = ?(ДопПараметры.ОтражатьВБухгалтерскомУчете,Перечисления.ВидыОтраженияВУчете.ОтражатьВБухгалтерскомУчете,Перечисления.ВидыОтраженияВУчете.ОтражатьВНалоговомУчете);
	ВидРег  		   = ?(ДопПараметры.ОтражатьВБухгалтерскомУчете,"ПартииТоваровНаСкладахБухгалтерскийУчет","ПартииТоваровНаСкладахНалоговыйУчет");
	 ЗапросКомпл = Новый Запрос("ВЫБРАТЬ
	                            |	ТаблИсключ.Номенклатура
	                            |ПОМЕСТИТЬ ТаблИсключ
	                            |ИЗ
	                            |	&ТаблИсключ КАК ТаблИсключ
	                            |;
	                            |
	                            |////////////////////////////////////////////////////////////////////////////////
	                            |ВЫБРАТЬ
	                            |	ТаблИсточник.Номенклатура
	                            |ПОМЕСТИТЬ ТаблИсточник
	                            |ИЗ
	                            |	&ТаблИсточник КАК ТаблИсточник
	                            |;
	                            |
	                            |////////////////////////////////////////////////////////////////////////////////
	                            |ВЫБРАТЬ
	                            |	Приемник.Номенклатура как Номенклатура,
								|	Приемник.ДокументОприходования как ДокументОприходования
	                            |ИЗ
	                            |	РегистрНакопления.ПартииТоваровНаСкладах%СуффиксУчета% КАК Источник
	                            |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладах%СуффиксУчета% КАК Приемник
	                            |		ПО Источник.Период = Приемник.Период
	                            |			И Источник.Регистратор = Приемник.Регистратор
	                            |			И Источник.НомерКорСтроки = Приемник.НомерСтроки
	                            |			И (Источник.КодОперации = ЗНАЧЕНИЕ(Перечисление.КодыОперацийПартииТоваров.Комплектация))
	                            |			И (Источник.Период МЕЖДУ &Дата1 И &Дата2)
	                            |			И (Источник.Активность)
								|			И (Источник.Номенклатура <> Приемник.Номенклатура )
	                            |			И (Источник.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.расход))
	                            |			И (Приемник.КодОперации = ЗНАЧЕНИЕ(Перечисление.КодыОперацийПартииТоваров.Комплектация))
	                            |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблИсточник КАК ТаблИсточник
	                            |		ПО Источник.Номенклатура = ТаблИсточник.Номенклатура
	                            |ГДЕ
	                            |	НЕ Приемник.Номенклатура В
	                            |				(ВЫБРАТЬ
	                            |					ТаблИсключ.Номенклатура
	                            |				ИЗ
	                            |					ТаблИсключ)
	                            |
	                            |СГРУППИРОВАТЬ ПО
	                            |	Приемник.Номенклатура,
								|   Приемник.ДокументОприходования ");
								
		ЗапросКомпл.Текст = УправлениеЗатратами.ЗаменитьКомментарииВТекстеЗапроса(
		ЗапросКомпл.Текст, 
		ВидОтраженияВУчете
	);							
						   
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	ВыпускПродукцииБухгалтерскийУчет.Продукция КАК Номенклатура
	                      |ИЗ
	                      |	РегистрНакопления.ВыпускПродукции%СуффиксУчета% КАК ВыпускПродукцииБухгалтерскийУчет
	                      |ГДЕ
	                      |	ВыпускПродукцииБухгалтерскийУчет.Регистратор = &Регистратор
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	ВыпускПродукцииБухгалтерскийУчет.Продукция");
						  
	Запрос.Текст = УправлениеЗатратами.ЗаменитьКомментарииВТекстеЗапроса(
		Запрос.Текст, 
		ВидОтраженияВУчете
	);						  
						  
	Запрос.УстановитьПараметр("Регистратор",РегламентныйДокумент);
	
	
	ТабИсточник = Запрос.Выполнить().Выгрузить();
	
	ТаблИсключ = Новый ТаблицаЗначений;
	ТаблИсключ.Колонки.Добавить("Номенклатура",Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ТаблИсключ.Колонки.Добавить("ДокументОприходования",Метаданные.РегистрыНакопления[ВидРег].Измерения.ДокументОприходования.Тип);
	
	ЗапросКомпл.УстановитьПараметр("Дата1", ДатаНач);
	ЗапросКомпл.УстановитьПараметр("Дата2", ДатаКон);
	
	//начало изменений Ожиганов 01.03.2016 себестоимость продукции, на которую не распределяются косвенные затраты 
	МассРез = Новый Массив;
	//конец изменений 
	Пока Истина Цикл
		ЗапросКомпл.УстановитьПараметр("ТаблИсключ",ТаблИсключ);
		ЗапросКомпл.УстановитьПараметр("ТаблИсточник",ТабИсточник);
		//ОбработкаПрерыванияПользователя();
		Выборка = ЗапросКомпл.Выполнить().Выбрать();
		Если Выборка.Количество() = 0 Тогда
			Прервать;
		Иначе
			
			ТаблКомпл = Новый ТаблицаЗначений;
			ТаблКомпл.Колонки.Добавить("Номенклатура",Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
			ТаблКомпл.Колонки.Добавить("ДокументОприходования",Метаданные.РегистрыНакопления[ВидРег].Измерения.ДокументОприходования.Тип);
			
			МассРез.Добавить(ТаблКомпл);
			
			ТабИсточник.Очистить();
			Пока Выборка.Следующий() Цикл
				НоваяСтрока 			 = ТабИсточник.Добавить();
				НоваяСтрока.Номенклатура = Выборка.Номенклатура;
				
				НоваяСтрока 			 = ТаблИсключ.Добавить();
				НоваяСтрока.Номенклатура = Выборка.Номенклатура;
				НоваяСтрока.ДокументОприходования = Выборка.ДокументОприходования;
				
				//начало изменений Ожиганов 01.03.2016 себестоимость продукции, на которую не распределяются косвенные затраты 
				НоваяСтрока = ТаблКомпл.Добавить();
				НоваяСтрока.Номенклатура = Выборка.Номенклатура;
				НоваяСтрока.ДокументОприходования = Выборка.ДокументОприходования;
				//конец изменений 
				
			КонецЦикла;	
			//прервать;
		КонецЕсли;	
	КонецЦикла;	
	ТаблИсключ.Свернуть("Номенклатура,ДокументОприходования");
	ТаблИсключ.Сортировать("Номенклатура,ДокументОприходования");
	//начало изменений Ожиганов 01.03.2016 себестоимость продукции, на которую не распределяются косвенные затраты 
	возврат МассРез;
	//возврат ТаблИсключ;
	//конец изменений 
КонецФункции

//начало изменений Ожиганов 26.02.2016 б/н оптизация выборки по перемещениям  
//Функция ПРГ_ПолучитьВременнуюТаблицуВыпуска(ДатаНач,ДатаКон,НазваниеРегистраНаСкладах)
Функция ПРГ_ПолучитьВременнуюТаблицуВыпуска(ДатаНач,ДатаКон,НазваниеРегистраНаСкладах,Организация,ТолькоПолуфабрикатыВНУ=Ложь)
//конец изменений 	
	
   Запрос = Новый Запрос();
   
   Текст = 		"ВЫБРАТЬ
                         |	Выпуск.Номенклатура КАК Номенклатура
                         |ПОМЕСТИТЬ ВыпускПродукцииПромежут
                         |ИЗ
                         |	РегистрНакопления.ПартииТоваровНаСкладах КАК Выпуск
                         |ГДЕ
                         |	Выпуск.Период МЕЖДУ &ДатаНач И &ДатаКон
                         |	И Выпуск.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
//начало изменений Ожиганов А. 15.06.2017 66649 добавление в корр/стоимости возратных отходов, изменения по отрицательным материальным затратам 
						 | И Не (Выпуск.Регистратор Ссылка Документ.ОприходованиеМатериаловИзПроизводства или Выпуск.ДокументДвижения Ссылка Документ.ОприходованиеМатериаловИзПроизводства)
//конец изменений 
                         |	И Выпуск.КодОперации В(&КодОперацииВыпуска)
						 //начало изменений Ожиганов 26.02.2016 б/н оптизация выборки по перемещениям  
						 |	И Выпуск.Активность
						 //конец изменений 
						 //начало изменений Ожиганов 30.05.2016 выравнивание копеек по НУ, приведение остатков к БУ 
						 |"+?(ТолькоПолуфабрикатыВНУ," И Выпуск.СчетУчета в (&СписокСчетов) ","")+"
                         |
                         |СГРУППИРОВАТЬ ПО
                         |	Выпуск.Номенклатура
                         |
	//начало изменений Ожиганов 26.02.2016 б/н оптизация выборки по перемещениям  						 
	                     |;
//             	           |ИНДЕКСИРОВАТЬ ПО
//                         |	Номенклатура

						|ВЫБРАТЬ
						|	ВложенныйЗапрос.Номенклатура
						|ПОМЕСТИТЬ ВыпускПродукции
						|ИЗ
						|	(ВЫБРАТЬ
						|		ВыпускПродукцииПромежут.Номенклатура КАК Номенклатура
						|	ИЗ
						|		ВыпускПродукцииПромежут КАК ВыпускПродукцииПромежут
						|	
						|	СГРУППИРОВАТЬ ПО
						|		ВыпускПродукцииПромежут.Номенклатура
						|	
						|	ОБЪЕДИНИТЬ ВСЕ
						|	
						|	ВЫБРАТЬ
						|		Приемник.Номенклатура
						|	ИЗ
						|		РегистрНакопления.ПартииТоваровНаСкладах КАК Источник
						|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыпускПродукцииПромежут КАК ВыпускПродукцииПромежут
						|			ПО Источник.Номенклатура = ВыпускПродукцииПромежут.Номенклатура
						|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладах КАК Приемник
						|			ПО Источник.Период = Приемник.Период
						|				И Источник.Регистратор = Приемник.Регистратор
						|				И Источник.НомерКорСтроки = Приемник.НомерСтроки
						|				И (Источник.КодОперации = ЗНАЧЕНИЕ(Перечисление.КодыОперацийПартииТоваров.Комплектация))
						|	ГДЕ
						|		Источник.Активность
						|		И Источник.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
						|		И Источник.Организация = &Организация
						|		И Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
						|		И Источник.Организация = Приемник.Организация
						|		И Источник.Номенклатура <> Приемник.Номенклатура
						|	
						|	СГРУППИРОВАТЬ ПО
						|		Приемник.Номенклатура) КАК ВложенныйЗапрос

						|СГРУППИРОВАТЬ ПО
						|	ВложенныйЗапрос.Номенклатура
						|;
						| Уничтожить ВыпускПродукцииПромежут;
						|";
	//конец изменений 
						 
	Запрос.Текст = СтрЗаменить(Текст, "ПартииТоваровНаСкладах",НазваниеРегистраНаСкладах);
	
	//начало изменений Ожиганов 30.05.2016 выравнивание копеек по НУ, приведение остатков к БУ 
	Если ТолькоПолуфабрикатыВНУ Тогда
		СписокСчетов = Новый Массив;
		СписокСчетов.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("21"));
		Запрос.УстановитьПараметр("СписокСчетов",СписокСчетов);
	КонецЕсли;	
	//конец изменений 
	
	Запрос.УстановитьПараметр("ДатаНач",ДатаНач);
	Запрос.УстановитьПараметр("ДатаКон",ДатаКон);
	//начало изменений Ожиганов 26.02.2016 б/н оптизация выборки по перемещениям  
	Запрос.УстановитьПараметр("Организация",Организация);
	//конец изменений 
	
	КодОперацииВыпуска = Новый Массив;					 
	КодОперацииВыпуска.Добавить(Перечисления.КодыОперацийПартииТоваров.ВыпускПоОперацииСтоимость);
	КодОперацииВыпуска.Добавить(Перечисления.КодыОперацийПартииТоваров.ВыпускПродукцииФиксНаСклад);
	Запрос.УстановитьПараметр("КодОперацииВыпуска",КодОперацииВыпуска);
	
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	Запрос.Выполнить();
	
	возврат Запрос.МенеджерВременныхТаблиц;
	
	
КонецФункции	

//начало изменений
Функция ПРГ_ПолучитьЗапросДляРеглУчета(ЭтоКомпл=Ложь) Экспорт 
//начало изменений Ожиганов 26.02.2016 б/н оптизация выборки по перемещениям  	
	возврат "ВЫБРАТЬ
	        |	ТабТоваров.Номенклатура КАК Номенклатура,
	        |	ТабТоваров.ДокументОприходования КАК ДокументОприходования,
	        |	ВложенныйЗапрос.Порядок
	        |ПОМЕСТИТЬ ПРГ_ФильтрПоТоварам
	        |ИЗ
	        |	(ВЫБРАТЬ "+?(ЭтоКомпл,""," ПЕРВЫЕ 100 ")+"
	        |		ТаблНом.Номенклатура КАК Номенклатура,
	        |		ТаблНом.Порядок КАК Порядок
	        |	ИЗ
	        |		ПРГ_ТаблНом КАК ТаблНом
	        |	ГДЕ
	        |		ТаблНом.Порядок > &Порядок
	        |	"+?(ЭтоКомпл,"","
	        |	УПОРЯДОЧИТЬ ПО
	        |		Порядок
			| ")+"
			|) КАК ВложенныйЗапрос
	        |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПРГ_ТаблТоваров КАК ТабТоваров
	        |		ПО ВложенныйЗапрос.Номенклатура = ТабТоваров.Номенклатура
	        |
	        |СГРУППИРОВАТЬ ПО
	        |	ТабТоваров.Номенклатура,
	        |	ТабТоваров.ДокументОприходования,
	        |	ВложенныйЗапрос.Порядок
	        |
	        |ИНДЕКСИРОВАТЬ ПО
	        |	Номенклатура
	        |;
	        |
	        |////////////////////////////////////////////////////////////////////////////////
	        |ВЫБРАТЬ
	        |	ПРГ_ФильтрПоТоварам.Номенклатура
	        |ПОМЕСТИТЬ ПРГ_ФильтрТолькоПоТоварам
	        |ИЗ
	        |	ПРГ_ФильтрПоТоварам КАК ПРГ_ФильтрПоТоварам
	        |
	        |СГРУППИРОВАТЬ ПО
	        |	ПРГ_ФильтрПоТоварам.Номенклатура
	        |;
	        |
	        |////////////////////////////////////////////////////////////////////////////////
	        |ВЫБРАТЬ
	        |	ПРГ_ФильтрПоТоварам.Номенклатура КАК Номенклатура,
	        |	ПРГ_ФильтрПоТоварам.ДокументОприходования КАК ДокументОприходования,
	        |	ПРГ_ФильтрПоТоварам.Порядок КАК Порядок
	        |ИЗ
	        |	ПРГ_ФильтрПоТоварам КАК ПРГ_ФильтрПоТоварам
	        |
	        |УПОРЯДОЧИТЬ ПО
	        |	Порядок,
	        |	Номенклатура,
	        |	ДокументОприходования";
//конец изменений 
	возврат "ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 100
	          |	Подзапрос.Номенклатура КАК Номенклатура,
	          |	Подзапрос.ДокументОприходования КАК ДокументОприходования
	          |ИЗ
	          |	(ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 100
	          |		ПодзапросНаСкладах.Номенклатура КАК Номенклатура,
	          |		ПодзапросНаСкладах.ДокументОприходования КАК ДокументОприходования
	          |	ИЗ
	          |		(ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 100
	          |			НаСкладах.Номенклатура КАК Номенклатура,
	          |			НаСкладах.ДокументОприходования КАК ДокументОприходования
	          |		ИЗ
	          |			РегистрНакопления.ПартииТоваровНаСкладах КАК НаСкладах
	          |		ГДЕ
	          |			НаСкладах.Период МЕЖДУ &ДатаНач И &ДатаКон
			  |			И Не НаСкладах.СчетУчета в (&СписокИсключаемыхСчетовУчета)
			  |			И Не НаСкладах.Номенклатура в (выбрать ВыпускПродукции.номенклатура из ВыпускПродукции)
	          |			И (НаСкладах.Номенклатура > &Номенклатура
	          |					ИЛИ НаСкладах.Номенклатура = &Номенклатура
	          |						И НаСкладах.ДокументОприходования > &ДокументОприходования)
	          |			И (НаСкладах.ВидДвижения = &ВидДвижения
	          |					ИЛИ НаСкладах.ДокументОприходования ССЫЛКА Документ.КомплектацияНоменклатуры)
	          |		
	          |		УПОРЯДОЧИТЬ ПО
	          |			Номенклатура,
	          |			ДокументОприходования) КАК ПодзапросНаСкладах
	          |	
	          |	ОБЪЕДИНИТЬ ВСЕ
	          |	
	          |	ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 100
	          |		ПодзапросПереданные.Номенклатура,
	          |		ПодзапросПереданные.ДокументОприходования
	          |	ИЗ
	          |		(ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 100
	          |			Переданные.Номенклатура КАК Номенклатура,
	          |			Переданные.ДокументОприходования КАК ДокументОприходования
	          |		ИЗ
	          |			РегистрНакопления.ПартииТоваровПереданные КАК Переданные
	          |		ГДЕ
	          |			Переданные.Период МЕЖДУ &ДатаНач И &ДатаКон
			  |			И Не Переданные.СчетУчета в (&СписокИсключаемыхСчетовУчета)
			  |			И Не Переданные.Номенклатура в (выбрать ВыпускПродукции.номенклатура из ВыпускПродукции)
	          |			И (Переданные.Номенклатура > &Номенклатура
	          |					ИЛИ Переданные.Номенклатура = &Номенклатура
	          |						И Переданные.ДокументОприходования > &ДокументОприходования)
	          |			И (Переданные.ВидДвижения = &ВидДвижения
	          |					ИЛИ Переданные.ДокументОприходования ССЫЛКА Документ.КомплектацияНоменклатуры)
	          |		
	          |		УПОРЯДОЧИТЬ ПО
	          |			Номенклатура,
	          |			ДокументОприходования) КАК ПодзапросПереданные) КАК Подзапрос
	          |
	          |УПОРЯДОЧИТЬ ПО
	          |	Номенклатура,
	          |	ДокументОприходования";
КонецФункции	

//начало изменений оптим
Процедура ПРГ_КорректировкаСписанияКомплВозрваты(ДатаНач, ДатаКон, ТаблицаТоваров, РегламентныйДокумент,
								Организация, 
								ВидОтраженияВУчете,
								НеСписыватьНаПостоянныеЗатраты = Ложь, ДопПараметры = Неопределено, ПоследнийПередел = Ложь,
								ВстречныйВыпуск = Ложь,
								ОтладочныйРежим = Ложь,
								МенеджВрТаблиц,
								НомерПорции
								) Экспорт
	
	//Признак того, что в параметр ДопПараметры передана структура и ее необходимо вернуть из процедуры
	
	флТребуетсяВозвратДопПараметров = истина;
	Если ТипЗнч(ДопПараметры) <> Тип("Структура") Тогда
		флТребуетсяВозвратДопПараметров = Ложь;
		ДопПараметры = Новый Структура;
	КонецЕсли;
	
	//+ДС 10.01.14
	Если ДопПараметры.Свойство("СтрокаДействия") Тогда
		флТребуетсяВозвратДопПараметров = Истина;
	КонецЕсли;
	//-ДС

	Если ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВУправленческомУчете Тогда
		СпособВеденияПартионногоУчетаПоОрганизации = УправлениеЗапасами.ПолучитьСпособВеденияПартионногоУчетаПоОрганизации(Организация, ДатаКон);
		ДопПараметры.Вставить("Организация", УправлениеЗапасами.ПолучитьОрганизациюВСоответствииСоСпособомВеденияПартионногоУчетаПоОрганизациям(Организация,СпособВеденияПартионногоУчетаПоОрганизации));
	Иначе
		ДопПараметры.Вставить("Организация", Организация);
	КонецЕсли;	
	
	ДопПараметры.Вставить("НеСписыватьНаПостоянныеЗатраты", НеСписыватьНаПостоянныеЗатраты);
	
	
	// Приведение структуры доп.параметров к виду структуры параметров из основного алгоритма списания партий
	//
	ДопПараметры.Вставить("ОтражатьВУправленческомУчете" , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВУправленческомУчете));
	ДопПараметры.Вставить("ОтражатьВБухгалтерскомУчете"  , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВБухгалтерскомУчете));
	ДопПараметры.Вставить("ОтражатьВНалоговомУчете"      , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВНалоговомУчете));
	ДопПараметры.Вставить("ОтражатьВМеждународномУчете"  , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВМеждународномУчете));
	
	ДопПараметры.Вставить("ЕстьСтрокиОтражатьВУправленческомУчете" , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВУправленческомУчете));
	ДопПараметры.Вставить("ЕстьСтрокиОтражатьВБухгалтерскомУчете"  , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВБухгалтерскомУчете));
	ДопПараметры.Вставить("ЕстьСтрокиОтражатьВНалоговомУчете"      , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВНалоговомУчете));
	ДопПараметры.Вставить("ЕстьСтрокиОтражатьВМеждународномУчете"  , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВМеждународномУчете));
	
	ДопПараметры.Вставить("КэшПоВидамСубконто", Новый Соответствие);
	
	Если НЕ ДопПараметры.Свойство("КодыОпераций") тогда
		ДопПараметры.Вставить("КодыОпераций", Перечисления.КодыОперацийПартииТоваров);
	КонецЕсли;
	
	Если НЕ РегламентныйДокумент = Неопределено тогда
		ДопПараметры.Вставить("ТипЗначенияРегистратора", ТипЗнч(РегламентныйДокумент));
	КонецЕсли;
	
	ДопПараметры.Вставить("ВстречныйВыпуск",ВстречныйВыпуск);
	
	//начало изменений
	//Будем считать способ в течение периода не будет меняться для бух и нал
	ДопПараметры.Вставить("СпособВеденияПартионногоУчетаПоОрганизации",УправлениеЗапасами.ПолучитьСпособВеденияПартионногоУчетаПоОрганизации(Организация,ДатаКон));
	//конец изменений 
	
	// Корректировка стоимости реализации комплектов продукции должна выполняться только после последнего передела,
	// когда известна себестоимость всей продукции
	// Получим список номенклатуры появившейся в результате комплектации
	// Это упрощенный способ, имеющий свои ограничения
	// Так можно рассчитать только себестоимость реализации комплектов, скомплектованных одним документом "комплектация"
	// Более сложные схемы с многоуровневыми комплектациями - разукомплектациями и передачами комплектов в производство
	// обслуживаются только специализированными производственными документами
	
	
		
		//начало изменений  
		Если ОтладочныйРежим Тогда
			ТаблицаКомплектов = ПолучитьТаблицуПартийПоКодуОперации(ДатаНач,ДатаКон,ДопПараметры,Перечисления.КодыОперацийПартииТоваров.Комплектация,ВидДвиженияНакопления.Приход,ТаблицаТоваров.ВыгрузитьКолонку("Номенклатура"));
		//начало изменений
		ИначеЕсли ТипЗнч(РегламентныйДокумент) = Тип("ДокументСсылка.РасчетСебестоимостиВыпуска")Тогда
		//конец изменений
			ТаблицаКомплектов =  ПРГ_ПолучитьКомплекты(ДатаНач,ДатаКон,РегламентныйДокумент,ДопПараметры)
		Иначе
			//начало изменений Ожиганов 26.02.2016 б/н оптизация выборки по перемещениям  
			//ТаблицаКомплектов = ПолучитьТаблицуПартийПоКодуОперации(ДатаНач,ДатаКон,ДопПараметры,Перечисления.КодыОперацийПартииТоваров.Комплектация,ВидДвиженияНакопления.Приход);
			Если МенеджВрТаблиц = Неопределено Тогда
				вызватьисключение "неверные параметры по комплектам. Обратитесь к программисту.";
			Иначе
				Запрос = Новый Запрос;
				Запрос.МенеджерВременныхТаблиц = МенеджВрТаблиц;
				Если НомерПорции > 1 Тогда
					Запрос.Текст = "Уничтожить ПРГ_ФильтрПоТоварам;
					| Уничтожить ПРГ_ФильтрТолькоПоТоварам; ";
					Запрос.Выполнить();
				КонецЕсли;;	
				//конец изменений 
				//начало изменений Ожиганов 20.02.2016 б/н оптизация выборки по перемещениям  
				Запрос.Текст 	  =	ПРГ_ПолучитьЗапросДляРеглУчета(Истина); 
				Запрос.УстановитьПараметр("Порядок",999999);
				ТаблицаКомплектов = Запрос.Выполнить().Выгрузить();
				ДопПараметры.Вставить("ПРГ_ФильтрПоТоварам",Запрос.МенеджерВременныхТаблиц);
				//конец изменений 
			КонецЕсли;	
			//конец изменений 
		КонецЕсли;	
		//конец изменений  
		
		// Если комплектов нет - корректировать нечего
		Если ТаблицаКомплектов <> Неопределено тогда
			ДопПараметры.Вставить("КорректироватьКомплектыПродукции");
			//начало изменений Ожиганов 01.03.2016 себестоимость продукции, на которую не распределяются косвенные затраты 
			//СкорректироватьСписание(ДатаНач, ДатаКон, ТаблицаКомплектов, РегламентныйДокумент, ДопПараметры);
			Если  ТипЗнч(ТаблицаКомплектов) = Тип("Массив") Тогда
				Для Каждого ПРГ_Элемент Из ТаблицаКомплектов Цикл
					СкорректироватьСписание(ДатаНач, ДатаКон, ПРГ_Элемент, РегламентныйДокумент, ДопПараметры);
				КонецЦикла;	
			Иначе
				СкорректироватьСписание(ДатаНач, ДатаКон, ТаблицаКомплектов, РегламентныйДокумент, ДопПараметры);
			КонецЕсли;	
			//конец изменений 
		КонецЕсли;
		
		// Если возврат от покупателя текущего месяца осуществляется по документу поступления - стоимость соответствующего состояния
		// может быть уменьшена документом списания и стоимость возврата может не соотвествовать стоимости реализации
		// Поэтому корректировка стоимости возвратов от покупателя текущего месяца должна выполняться последней
		//начало изменений  
		
		//начало изменений оптим р/с
		//Если ОтладочныйРежим Тогда
		//	ТаблицаВозвратов = ПолучитьТаблицуПартийПоКодуОперации(ДатаНач,ДатаКон,ДопПараметры,Перечисления.КодыОперацийПартииТоваров.ВозвратОтПокупателяТекущийМесяц,ВидДвиженияНакопления.Расход,ТаблицаТоваров.ВыгрузитьКолонку("Номенклатура"));
		//Иначе 	
		//	ТаблицаВозвратов = ПРГ_ПолучитьТаблицуПартийПоКодуОперацииБезПродукции(ДатаНач,ДатаКон,ДопПараметры,Перечисления.КодыОперацийПартииТоваров.ВозвратОтПокупателяТекущийМесяц,ВидДвиженияНакопления.Расход,Неопределено,МенеджВрТаблиц);
		//КонецЕсли;
		//
		//Если ТаблицаВозвратов <> Неопределено тогда
		//	ДопПараметры.Вставить("КорректироватьСтоимостьВозвратовТекущегоМесяца");
		//	СкорректироватьСписание(ДатаНач, ДатаКон, ТаблицаВозвратов, РегламентныйДокумент, ДопПараметры);
		//КонецЕсли;
		//конец изменений 
	
	
	Если  флТребуетсяВозвратДопПараметров Тогда
		// Последних переделов может быть несколько 
		Если ДопПараметры.Свойство("КорректироватьКомплектыПродукции") тогда
			ДопПараметры.Удалить("КорректироватьКомплектыПродукции");
		КонецЕсли;
		
		Если ДопПараметры.Свойство("КорректироватьСтоимостьВозвратовТекущегоМесяца") тогда
			ДопПараметры.Удалить("КорректироватьСтоимостьВозвратовТекущегоМесяца");
		КонецЕсли;
	Иначе
		//необходимо для того, чтобы предотвратить возврат из процедуры мутабельных значений.
		//Если в ДопПараметры не надо ничего возвращать, то переменную необходимо удалить
		ДопПараметры = неопределено;
	КонецЕсли;
КонецПроцедуры // КорректировкаСписания


Функция ПРГ_ПолучитьТаблицуПартийПоКодуОперацииБезПродукции(ДатаНач, ДатаКон,ДопПараметры,КодОперации,ВидДвижения,
	МассНом = Неопределено,
	МенеджеВрТаблиц
	)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
				   |	НаСкладах.Номенклатура КАК Номенклатура,
				   |	НаСкладах.ДокументОприходования КАК ДокументОприходования
				   |ИЗ
				   |	РегистрНакопления.ПартииТоваровНаСкладах КАК НаСкладах
				   |ГДЕ
				   |	НаСкладах.Период МЕЖДУ &ДатаНач И &ДатаКон
				   |	И НаСкладах.ВидДвижения = &ВидДвижения
				   |	И НаСкладах.КодОперации = &КодОперации  
				   |	И Не НаСкладах.Номенклатура в (выбрать ВыпускПродукции.номенклатура из ВыпускПродукции)
				   | "+?(МассНом=Неопределено,""," И НаСкладах.Номенклатура в (&МассНом)") +"
				   |";
				   
	//начало изменений 
	Запрос.УстановитьПараметр("МассНом", МассНом);
	//конец изменений 
	
	Запрос.МенеджерВременныхТаблиц = МенеджеВрТаблиц;
	
	Запрос.УстановитьПараметр("КодОперации", КодОперации);
	Запрос.УстановитьПараметр("ВидДвижения", ВидДвижения);
	Запрос.УстановитьПараметр("ДатаНач", ДатаНач);
	Запрос.УстановитьПараметр("ДатаКон", ДатаКон);
	
	Если ДопПараметры.ОтражатьВБухгалтерскомУчете тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"ПартииТоваровНаСкладах", "ПартииТоваровНаСкладахБухгалтерскийУчет");	
	ИначеЕсли ДопПараметры.ОтражатьВНалоговомУчете тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"ПартииТоваровНаСкладах", "ПартииТоваровНаСкладахНалоговыйУчет");	
	ИначеЕсли ДопПараметры.ОтражатьВМеждународномУчете тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"ПартииТоваровНаСкладах", "ПартииТоваровНаСкладахМеждународныйУчет");	
	ИначеЕсли Не ДопПараметры.ОтражатьВУправленческомУчете тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос.Текст = Запрос.Текст + "
	|	И НаСкладах.Организация = &Организация";
	Запрос.УстановитьПараметр("Организация", ДопПараметры.Организация);		
	
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() тогда 
		Возврат Неопределено;
	Иначе
		Возврат РезультатЗапроса.Выгрузить();
	КонецЕсли;
	
КонецФункции	

//конец изменений
//начало изменений р/с

Процедура ПРГ_ЗаполнитьДопПарметрыЗапроса(Запрос,БУ)
	
	КодыСписаниеСоСчетами = Новый Массив;
	СчетаЗатрат  		  = Новый Массив;
	КодыСписаниеБезСчетов = Новый Массив;
	
	КодОперПартий = Перечисления.КодыОперацийПартииТоваров;
	
	КодыСписаниеБезСчетов.Добавить(КодОперПартий.Комплектация);
	КодыСписаниеБезСчетов.Добавить(КодОперПартий.СписаниеПартийВПроизводствоОперативно);
	КодыСписаниеБезСчетов.Добавить(КодОперПартий.СписаниеПартийПереданныхВПроизводство);
	КодыСписаниеБезСчетов.Добавить(КодОперПартий.ПередачаМатериаловВЭксплуатацию);
	
	КодыСписаниеСоСчетами.Добавить(КодОперПартий.СписаниеНаБрак);
	КодыСписаниеСоСчетами.Добавить(КодОперПартий.СписаниеНаЗатраты);
	
	СчетаЗатрат = БухгалтерскийУчет.ПолучитьМассивСчетов(?(БУ,"Хозрасчетный","Налоговый"),"20,23,25,28,29");
	
	Запрос.УстановитьПараметр("КодыСписаниеСоСчетами",КодыСписаниеСоСчетами);
	Запрос.УстановитьПараметр("КодыСписаниеБезСчетов",КодыСписаниеБезСчетов);
	Запрос.УстановитьПараметр("СчетаЗатрат",СчетаЗатрат);
	
		//МассивВнешСписание.Добавить(КодыОпераций.Комплектация);
		////начало изменений
		////МассивВнешСписание.Добавить(КодыОпераций.ПередачаТарыКонтрагенту);
		////конец изменений
		//МассивВнешСписание.Добавить(КодыОпераций.Реализация);
		//МассивВнешСписание.Добавить(КодыОпераций.РеализацияКомиссия);
		//МассивВнешСписание.Добавить(КодыОпераций.РеализацияРозница);

		//МассивВнешСписание.Добавить(КодыОпераций.СписаниеПоИнвентаризации);
		//МассивВнешСписание.Добавить(КодыОпераций.СписаниеПоОрдеру);
		//МассивВнешСписание.Добавить(КодыОпераций.СписаниеПартийВПроизводствоОперативно);

		//МассивВнешСписание.Добавить(КодыОпераций.СписаниеНаСтроительствоОбъектовОС);
		//МассивВнешСписание.Добавить(КодыОпераций.СписаниеНаВложенияВоВнеоборотныеАктивы);
		//МассивВнешСписание.Добавить(КодыОпераций.СписаниеПартийПереданныхВПроизводство);
		////МассивВнешСписание.Добавить(КодыОпераций.ПередачаМатериаловВЭксплуатацию);
		//МассивВнешСписание.Добавить(КодыОпераций.СписаниеНаБрак);
		//МассивВнешСписание.Добавить(КодыОпераций.СписаниеНаЗатраты);
		//
		//МассивВнешСписание.Добавить(Перечисления.КодыОперацийПартииМатериаловВЭксплуатации.СписаниеИзЭксплуатации);
	
	
	
КонецПроцедуры	


// is ЯннуровВФ 20150122
Функция ПолучитьКомплектыМУ(ДатаНач,ДатаКон,РегламентныйДокумент,ДопПараметры) Экспорт
	
	Если ТипЗнч(РегламентныйДокумент) <> Тип("ДокументСсылка.РасчетСебестоимостиВыпуска")
	 или НЕ ДопПараметры.ОтражатьВМеждународномУчете Тогда
	 	возврат  ПолучитьТаблицуПартийПоКодуОперации(ДатаНач,ДатаКон,ДопПараметры,Перечисления.КодыОперацийПартииТоваров.Комплектация,ВидДвиженияНакопления.Приход);
	//Сообщить("Тута");
	КонецЕсли;	
	
	ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВМеждународномУчете;
	ВидРег  		   = "ПартииТоваровНаСкладахМеждународныйУчет";
	 ЗапросКомпл = Новый Запрос("ВЫБРАТЬ
	                            |	ТаблИсключ.Номенклатура
	                            |ПОМЕСТИТЬ ТаблИсключ
	                            |ИЗ
	                            |	&ТаблИсключ КАК ТаблИсключ
	                            |;
	                            |
	                            |////////////////////////////////////////////////////////////////////////////////
	                            |ВЫБРАТЬ
	                            |	ТаблИсточник.Номенклатура
	                            |ПОМЕСТИТЬ ТаблИсточник
	                            |ИЗ
	                            |	&ТаблИсточник КАК ТаблИсточник
	                            |;
	                            |
	                            |////////////////////////////////////////////////////////////////////////////////
	                            |ВЫБРАТЬ
	                            |	Приемник.Номенклатура КАК Номенклатура,
	                            |	Приемник.ДокументОприходования КАК ДокументОприходования
	                            |ИЗ
	                            |	РегистрНакопления.ПартииТоваровНаСкладахМеждународныйУчет КАК Источник
	                            |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладахМеждународныйУчет КАК Приемник
	                            |		ПО Источник.Период = Приемник.Период
	                            |			И Источник.Регистратор = Приемник.Регистратор
	                            |			И Источник.НомерКорСтроки = Приемник.НомерСтроки
	                            |			И (Источник.КодОперации = ЗНАЧЕНИЕ(Перечисление.КодыОперацийПартииТоваров.Комплектация))
	                            |			И (Источник.Период МЕЖДУ &Дата1 И &Дата2)
	                            |			И (Источник.Активность)
	                            |			И (Источник.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.расход))
	                            |			И (Приемник.КодОперации = ЗНАЧЕНИЕ(Перечисление.КодыОперацийПартииТоваров.Комплектация))
	                            |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблИсточник КАК ТаблИсточник
	                            |		ПО Источник.Номенклатура = ТаблИсточник.Номенклатура
	                            |ГДЕ
	                            |	НЕ Приемник.Номенклатура В
	                            |				(ВЫБРАТЬ
	                            |					ТаблИсключ.Номенклатура
	                            |				ИЗ
	                            |					ТаблИсключ)
	                            |
	                            |СГРУППИРОВАТЬ ПО
	                            |	Приемник.Номенклатура,
	                            |	Приемник.ДокументОприходования");
								
		ЗапросКомпл.Текст = УправлениеЗатратами.ЗаменитьКомментарииВТекстеЗапроса(
		ЗапросКомпл.Текст, 
		ВидОтраженияВУчете
	);							
						   
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	ВыпускПродукцииМеждународныйУчет.Продукция КАК Номенклатура
	                      |ИЗ
	                      |	РегистрНакопления.ВыпускПродукцииМеждународныйУчет КАК ВыпускПродукцииМеждународныйУчет
	                      |ГДЕ
	                      |	ВыпускПродукцииМеждународныйУчет.Регистратор = &Регистратор
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	ВыпускПродукцииМеждународныйУчет.Продукция");
						  
	Запрос.Текст = УправлениеЗатратами.ЗаменитьКомментарииВТекстеЗапроса(
		Запрос.Текст, 
		ВидОтраженияВУчете
	);						  
						  
	Запрос.УстановитьПараметр("Регистратор",РегламентныйДокумент);
	
	
	ТабИсточник = Запрос.Выполнить().Выгрузить();
	
	ТаблИсключ = Новый ТаблицаЗначений;
	ТаблИсключ.Колонки.Добавить("Номенклатура",Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ТаблИсключ.Колонки.Добавить("ДокументОприходования",Метаданные.РегистрыНакопления[ВидРег].Измерения.ДокументОприходования.Тип);
	
	ЗапросКомпл.УстановитьПараметр("Дата1", ДатаНач);
	ЗапросКомпл.УстановитьПараметр("Дата2", ДатаКон);
	Пока Истина Цикл
		ЗапросКомпл.УстановитьПараметр("ТаблИсключ",ТаблИсключ);
		ЗапросКомпл.УстановитьПараметр("ТаблИсточник",ТабИсточник);
		//ОбработкаПрерыванияПользователя();
		Выборка = ЗапросКомпл.Выполнить().Выбрать();
		Если Выборка.Количество() = 0 Тогда
			Прервать;
		Иначе
			ТабИсточник.Очистить();
			Пока Выборка.Следующий() Цикл
				НоваяСтрока 			 = ТабИсточник.Добавить();
				НоваяСтрока.Номенклатура = Выборка.Номенклатура;
				
				НоваяСтрока 			 = ТаблИсключ.Добавить();
				НоваяСтрока.Номенклатура = Выборка.Номенклатура;
				НоваяСтрока.ДокументОприходования = Выборка.ДокументОприходования;
				
			КонецЦикла;	
			//прервать;
		КонецЕсли;	
	КонецЦикла;	
	ТаблИсключ.Свернуть("Номенклатура,ДокументОприходования");
	ТаблИсключ.Сортировать("Номенклатура,ДокументОприходования");
	возврат ТаблИсключ;
КонецФункции

//начало изменений Ожиганов 05.05.2015 изменения по браку 
Функция ПРГКорректироватьВозвратыПоставщику(ДопПараметры,ДатаДок)
	Рез = Ложь;
	Если ДопПараметры.ОтражатьВБухгалтерскомУчете или  ДопПараметры.ОтражатьВНалоговомУчете Тогда
			Если  Нрег(СокрЛП(Константы.ПРГ_СтрокаПодключения.Получить())) <> Нрег(СтрокаСоединенияИнформационнойБазы()) Тогда
				 Рез  = Истина;
			Иначе
				Если ДатаДок >= '20150501' Тогда
					  Рез   =  Истина;
				 Иначе
					  Рез   =  Ложь;
				КонецЕсли;	
			КонецЕсли; 
	КонецЕсли;	
	Возврат Рез;
КонецФункции	
//конец изменений 

Процедура КорректировкаСписанияКомплОтладка(ДатаНач, ДатаКон, ТаблицаТоваров, РегламентныйДокумент,
								Организация, 
								ВидОтраженияВУчете,
								НеСписыватьНаПостоянныеЗатраты = Ложь, ДопПараметры = Неопределено, ПоследнийПередел = Ложь,
								ВстречныйВыпуск = Ложь,
								ОтладочныйРежим = Ложь
								) Экспорт
	
	//Признак того, что в параметр ДопПараметры передана структура и ее необходимо вернуть из процедуры
	
	флТребуетсяВозвратДопПараметров = истина;
	Если ТипЗнч(ДопПараметры) <> Тип("Структура") Тогда
		флТребуетсяВозвратДопПараметров = Ложь;
		ДопПараметры = Новый Структура;
	//начало изменений оптим р/с
	ИначеЕсли ДопПараметры.Свойство("НеВозвращатьДопПарметры") Тогда
		флТребуетсяВозвратДопПараметров = Ложь;
	//конец изменений
	КонецЕсли;
	
	//+ДС 10.01.14
	Если ДопПараметры.Свойство("СтрокаДействия") Тогда
		флТребуетсяВозвратДопПараметров = Истина;
	КонецЕсли;
	//-ДС

	Если ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВУправленческомУчете Тогда
		СпособВеденияПартионногоУчетаПоОрганизации = УправлениеЗапасами.ПолучитьСпособВеденияПартионногоУчетаПоОрганизации(Организация, ДатаКон);
		ДопПараметры.Вставить("Организация", УправлениеЗапасами.ПолучитьОрганизациюВСоответствииСоСпособомВеденияПартионногоУчетаПоОрганизациям(Организация,СпособВеденияПартионногоУчетаПоОрганизации));
	Иначе
		ДопПараметры.Вставить("Организация", Организация);
	КонецЕсли;	
	
	ДопПараметры.Вставить("НеСписыватьНаПостоянныеЗатраты", НеСписыватьНаПостоянныеЗатраты);
	
	
	// Приведение структуры доп.параметров к виду структуры параметров из основного алгоритма списания партий
	//
	ДопПараметры.Вставить("ОтражатьВУправленческомУчете" , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВУправленческомУчете));
	ДопПараметры.Вставить("ОтражатьВБухгалтерскомУчете"  , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВБухгалтерскомУчете));
	ДопПараметры.Вставить("ОтражатьВНалоговомУчете"      , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВНалоговомУчете));
	ДопПараметры.Вставить("ОтражатьВМеждународномУчете"  , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВМеждународномУчете));
	
	ДопПараметры.Вставить("ЕстьСтрокиОтражатьВУправленческомУчете" , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВУправленческомУчете));
	ДопПараметры.Вставить("ЕстьСтрокиОтражатьВБухгалтерскомУчете"  , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВБухгалтерскомУчете));
	ДопПараметры.Вставить("ЕстьСтрокиОтражатьВНалоговомУчете"      , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВНалоговомУчете));
	ДопПараметры.Вставить("ЕстьСтрокиОтражатьВМеждународномУчете"  , (ВидОтраженияВУчете = Перечисления.ВидыОтраженияВУчете.ОтражатьВМеждународномУчете));
	
	ДопПараметры.Вставить("КэшПоВидамСубконто", Новый Соответствие);
	
	Если НЕ ДопПараметры.Свойство("КодыОпераций") тогда
		ДопПараметры.Вставить("КодыОпераций", Перечисления.КодыОперацийПартииТоваров);
	КонецЕсли;
	
	Если НЕ РегламентныйДокумент = Неопределено тогда
		ДопПараметры.Вставить("ТипЗначенияРегистратора", ТипЗнч(РегламентныйДокумент));
	КонецЕсли;
	
	ДопПараметры.Вставить("ВстречныйВыпуск",ВстречныйВыпуск);
	
	//начало изменений
	//Будем считать способ в течение периода не будет меняться для бух и нал
	ДопПараметры.Вставить("СпособВеденияПартионногоУчетаПоОрганизации",УправлениеЗапасами.ПолучитьСпособВеденияПартионногоУчетаПоОрганизации(Организация,ДатаКон));
	//конец изменений 
	
	ДопПараметры.Вставить("КорректироватьКомплектыПродукции");
	СкорректироватьСписание(ДатаНач, ДатаКон, ТаблицаТоваров, РегламентныйДокумент, ДопПараметры);
	
	// Корректировка стоимости реализации комплектов продукции должна выполняться только после последнего передела,
	// когда известна себестоимость всей продукции
	// Получим список номенклатуры появившейся в результате комплектации
	// Это упрощенный способ, имеющий свои ограничения
	// Так можно рассчитать только себестоимость реализации комплектов, скомплектованных одним документом "комплектация"
	// Более сложные схемы с многоуровневыми комплектациями - разукомплектациями и передачами комплектов в производство
	// обслуживаются только специализированными производственными документами
	
	Если ПоследнийПередел тогда
		
		//начало изменений  
		//Если ОтладочныйРежим Тогда
		//	ТаблицаКомплектов = ПолучитьТаблицуПартийПоКодуОперации(ДатаНач,ДатаКон,ДопПараметры,Перечисления.КодыОперацийПартииТоваров.Комплектация,ВидДвиженияНакопления.Приход,ТаблицаТоваров.ВыгрузитьКолонку("Номенклатура"));
		////начало изменений
		//ИначеЕсли ТипЗнч(РегламентныйДокумент) = Тип("ДокументСсылка.РасчетСебестоимостиВыпуска")  Тогда
		////конец изменений
		//// is ЯннуровВФ нач 20150122
		//// is ЯннуровВФ нач 20141014
		//// И Не ДопПараметры.ОтражатьВМеждународномУчете Тогда 
		//// is ЯннуровВФ кон 20141014
		//	Если ДопПараметры.ОтражатьВМеждународномУчете Тогда 
		//		ТаблицаКомплектов =  ПолучитьКомплектыМУ(ДатаНач,ДатаКон,РегламентныйДокумент,ДопПараметры);
		//	Иначе
		//// is ЯннуровВФ нач 20150122
		//		ТаблицаКомплектов =  ПРГ_ПолучитьКомплекты(ДатаНач,ДатаКон,РегламентныйДокумент,ДопПараметры)
		//	КонецЕсли;
		//Иначе
		//	ТаблицаКомплектов = ПолучитьТаблицуПартийПоКодуОперации(ДатаНач,ДатаКон,ДопПараметры,Перечисления.КодыОперацийПартииТоваров.Комплектация,ВидДвиженияНакопления.Приход);
		//КонецЕсли;	
		////конец изменений  
		//
		//// Если комплектов нет - корректировать нечего
		//Если ТаблицаКомплектов <> Неопределено тогда
		//	ДопПараметры.Вставить("КорректироватьКомплектыПродукции");
		//	СкорректироватьСписание(ДатаНач, ДатаКон, ТаблицаКомплектов, РегламентныйДокумент, ДопПараметры);
		//	//начало изменений Ожиганов 14.10.2015 б/н исправление ошибки при серверных вызовах 
		//	Если ВстречныйВыпуск Тогда // запустим второй раз пересчет
		//		СкорректироватьСписание(ДатаНач, ДатаКон, ТаблицаКомплектов, РегламентныйДокумент, ДопПараметры);
		//	КонецЕсли;	
		//	//конец изменений 
		//КонецЕсли;
		//
		//// Если возврат от покупателя текущего месяца осуществляется по документу поступления - стоимость соответствующего состояния
		//// может быть уменьшена документом списания и стоимость возврата может не соотвествовать стоимости реализации
		//// Поэтому корректировка стоимости возвратов от покупателя текущего месяца должна выполняться последней
		//
		////начало измененйи оптим р/с
		//Если ДопПараметры.ЕстьСтрокиОтражатьВБухгалтерскомУчете или ДопПараметры.ЕстьСтрокиОтражатьВНалоговомУчете Тогда
		//	ТаблицаВозвратов  = Неопределено;
		//Иначе
		//	//начало изменений  
		//	Если ОтладочныйРежим Тогда
		//		ТаблицаВозвратов = ПолучитьТаблицуПартийПоКодуОперации(ДатаНач,ДатаКон,ДопПараметры,Перечисления.КодыОперацийПартииТоваров.ВозвратОтПокупателяТекущийМесяц,ВидДвиженияНакопления.Расход,ТаблицаТоваров.ВыгрузитьКолонку("Номенклатура"));
		//	Иначе 	
		//		ТаблицаВозвратов = ПолучитьТаблицуПартийПоКодуОперации(ДатаНач,ДатаКон,ДопПараметры,Перечисления.КодыОперацийПартииТоваров.ВозвратОтПокупателяТекущийМесяц,ВидДвиженияНакопления.Расход);
		//	КонецЕсли;
		//КонецЕсли;	
		////конец изменений
		//
		//Если ТаблицаВозвратов <> Неопределено тогда
		//	ДопПараметры.Вставить("КорректироватьСтоимостьВозвратовТекущегоМесяца");
		//	СкорректироватьСписание(ДатаНач, ДатаКон, ТаблицаВозвратов, РегламентныйДокумент, ДопПараметры);
		//КонецЕсли;
		
	КонецЕсли;
	
	Если  флТребуетсяВозвратДопПараметров Тогда
		// Последних переделов может быть несколько 
		Если ДопПараметры.Свойство("КорректироватьКомплектыПродукции") тогда
			ДопПараметры.Удалить("КорректироватьКомплектыПродукции");
		КонецЕсли;
		
		Если ДопПараметры.Свойство("КорректироватьСтоимостьВозвратовТекущегоМесяца") тогда
			ДопПараметры.Удалить("КорректироватьСтоимостьВозвратовТекущегоМесяца");
		КонецЕсли;
	Иначе
		//необходимо для того, чтобы предотвратить возврат из процедуры мутабельных значений.
		//Если в ДопПараметры не надо ничего возвращать, то переменную необходимо удалить
		ДопПараметры = неопределено;
	КонецЕсли;
КонецПроцедуры // КорректировкаСписания

//начало изменений Ожиганов 19.02.2016 б/н оптизация выборки по перемещениям  
Функция ПРГ_ПолучитьПодготовЗапросДляРеглУчета() Экспорт 

	возврат "
		|ВЫБРАТЬ
		|	ТаблТоваров.Номенклатура,
		|	ТаблТоваров.ДокументОприходования
		|ПОМЕСТИТЬ ПРГ_ТаблТоваров
		|ИЗ
		|	(ВЫБРАТЬ
		|		НаСкладах.Номенклатура КАК Номенклатура,
		|		НаСкладах.ДокументОприходования КАК ДокументОприходования
		|	ИЗ
		|		РегистрНакопления.ПартииТоваровНаСкладах КАК НаСкладах
		|	ГДЕ
		|		НаСкладах.Период МЕЖДУ &ДатаНач И &ДатаКон
		|		И НЕ НаСкладах.СчетУчета В (&СписокИсключаемыхСчетовУчета)
		//|		И НЕ НаСкладах.Номенклатура В
		//|					(ВЫБРАТЬ
		//|						ВыпускПродукции.номенклатура
		//|					ИЗ
		//|						ВыпускПродукции)
		|		И (НаСкладах.ВидДвижения = &ВидДвижения
		|				ИЛИ НаСкладах.ДокументОприходования ССЫЛКА Документ.КомплектацияНоменклатуры)
		|	
		|	СГРУППИРОВАТЬ ПО
		|		НаСкладах.ДокументОприходования,
		|		НаСкладах.Номенклатура
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		Переданные.Номенклатура,
		|		Переданные.ДокументОприходования
		|	ИЗ
		|		РегистрНакопления.ПартииТоваровПереданные КАК Переданные
		|	ГДЕ
		|		Переданные.Период МЕЖДУ &ДатаНач И &ДатаКон
		|		И НЕ Переданные.СчетУчета В (&СписокИсключаемыхСчетовУчета)
		//|		И НЕ Переданные.Номенклатура В
		//|					(ВЫБРАТЬ
		//|						ВыпускПродукции.номенклатура
		//|					ИЗ
		//|						ВыпускПродукции)
		|		И (Переданные.ВидДвижения = &ВидДвижения
		|				ИЛИ Переданные.ДокументОприходования ССЫЛКА Документ.КомплектацияНоменклатуры)
		|	
		|	СГРУППИРОВАТЬ ПО
		|		Переданные.ДокументОприходования,
		|		Переданные.Номенклатура) КАК ТаблТоваров
		| Где 
		|		 НЕ ТаблТоваров.Номенклатура В
		|					(ВЫБРАТЬ
		|						ВыпускПродукции.номенклатура
		|					ИЗ
		|						ВыпускПродукции)
		|
		|	СГРУППИРОВАТЬ ПО
		|		ТаблТоваров.ДокументОприходования,
		|		ТаблТоваров.Номенклатура
		|
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТаблТоваров.Номенклатура
		|ПОМЕСТИТЬ ПРГ_ТаблНом_Промежут1
		|ИЗ
		|	ПРГ_ТаблТоваров КАК ТаблТоваров

		|СГРУППИРОВАТЬ ПО
		|	ТаблТоваров.Номенклатура
		|;

		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Приемник.Номенклатура,
		|	1000000 КАК Порядок
		|ПОМЕСТИТЬ ПРГ_ДанныеПоКомлектации
		|ИЗ
		|	РегистрНакопления.ПартииТоваровНаСкладах КАК Источник
		|     ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПРГ_ТаблНом_Промежут1 как  ПРГ_ТаблНом_Промежут1
		|      ПО ПРГ_ТаблНом_Промежут1.Номенклатура = Источник.Номенклатура
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладах КАК Приемник
		|		ПО Источник.Период = Приемник.Период
		|			И Источник.Регистратор = Приемник.Регистратор
		|			И Источник.НомерКорСтроки = Приемник.НомерСтроки
		|			И (Источник.КодОперации = ЗНАЧЕНИЕ(Перечисление.КодыОперацийПартииТоваров.Комплектация))
		|ГДЕ
		|	Источник.Активность
		|	И Источник.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И Источник.Организация = &Организация
		|	И Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
		|	И Источник.Организация = Приемник.Организация
		|	И Источник.Номенклатура <> Приемник.Номенклатура

		|СГРУППИРОВАТЬ ПО
		|	Приемник.Номенклатура
		|;

		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Источник.Номенклатура,
		|	СУММА(1) КАК Порядок
		|ПОМЕСТИТЬ ПРГ_ТаблНом_Промежут2
		|ИЗ
		|	ПРГ_ТаблНом_Промежут1 КАК Источник
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПРГ_ТаблНом_Промежут1 КАК Приемник
		|		ПО Источник.Номенклатура >= Приемник.Номенклатура

		|СГРУППИРОВАТЬ ПО
		|	Источник.Номенклатура
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ПРГ_ТаблНом_Промежут1.Номенклатура,
		|	ПРГ_ТаблНом_Промежут1.Порядок + ЕСТЬNULL(ПРГ_ДанныеПоКомлектации.Порядок, 0) КАК Порядок
		|	ПОМЕСТИТЬ ПРГ_ТаблНом
		|ИЗ
		|	ПРГ_ТаблНом_Промежут2 КАК ПРГ_ТаблНом_Промежут1
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПРГ_ДанныеПоКомлектации КАК ПРГ_ДанныеПоКомлектации
		|		ПО ПРГ_ТаблНом_Промежут1.Номенклатура = ПРГ_ДанныеПоКомлектации.Номенклатура

		|СГРУППИРОВАТЬ ПО
		|	ПРГ_ТаблНом_Промежут1.Номенклатура,
		|	ПРГ_ТаблНом_Промежут1.Порядок + ЕСТЬNULL(ПРГ_ДанныеПоКомлектации.Порядок, 0)
		|	;
		| Уничтожить ПРГ_ТаблНом_Промежут1; 
		| Уничтожить ПРГ_ТаблНом_Промежут2; 
		| Уничтожить ПРГ_ДанныеПоКомлектации;";	
КонецФункции	

Функция ПРГ_ПолучитьПодготовЗапросДляРеглУчетаОтладка() Экспорт 

возврат  "ВЫБРАТЬ
           |	ТаблТоваров.Номенклатура,
           |	ТаблТоваров.ДокументОприходования
           |ПОМЕСТИТЬ ПРГ_ТаблТоваров
           |ИЗ
           |	&ТаблТоваров КАК ТаблТоваров
           |;
           |
           |////////////////////////////////////////////////////////////////////////////////
           |ВЫБРАТЬ
           |	ТаблТоваров.Номенклатура
           |ПОМЕСТИТЬ ПРГ_ТаблНом_Промежут1
           |ИЗ
           |	ПРГ_ТаблТоваров КАК ТаблТоваров
           |
           |СГРУППИРОВАТЬ ПО
           |	ТаблТоваров.Номенклатура
           |;
           |
           |////////////////////////////////////////////////////////////////////////////////
           |ВЫБРАТЬ
           |	Приемник.Номенклатура,
           |	1000000 КАК Порядок
           |ПОМЕСТИТЬ ПРГ_ДанныеПоКомлектации
           |ИЗ
           |	РегистрНакопления.ПартииТоваровНаСкладах КАК Источник
           |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПРГ_ТаблНом_Промежут1 КАК ПРГ_ТаблНом_Промежут1
           |		ПО (ПРГ_ТаблНом_Промежут1.Номенклатура = Источник.Номенклатура)
           |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладах КАК Приемник
           |		ПО Источник.Период = Приемник.Период
           |			И Источник.Регистратор = Приемник.Регистратор
           |			И Источник.НомерКорСтроки = Приемник.НомерСтроки
           |			И (Источник.КодОперации = ЗНАЧЕНИЕ(Перечисление.КодыОперацийПартииТоваров.Комплектация))
           |ГДЕ
           |	Источник.Активность
           |	И Источник.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
           |	И Источник.Организация = &Организация
           |	И Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
           |	И Источник.Организация = Приемник.Организация
           |	И Источник.Номенклатура <> Приемник.Номенклатура
           |
           |СГРУППИРОВАТЬ ПО
           |	Приемник.Номенклатура
           |;
           |
           |////////////////////////////////////////////////////////////////////////////////
           |ВЫБРАТЬ
           |	Источник.Номенклатура,
           |	СУММА(1) КАК Порядок
           |ПОМЕСТИТЬ ПРГ_ТаблНом_Промежут2
           |ИЗ
           |	ПРГ_ТаблНом_Промежут1 КАК Источник
           |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПРГ_ТаблНом_Промежут1 КАК Приемник
           |		ПО Источник.Номенклатура >= Приемник.Номенклатура
           |
           |СГРУППИРОВАТЬ ПО
           |	Источник.Номенклатура
           |;
           |
           |////////////////////////////////////////////////////////////////////////////////
           |ВЫБРАТЬ
           |	ПРГ_ТаблНом_Промежут1.Номенклатура,
           |	ПРГ_ТаблНом_Промежут1.Порядок + ЕСТЬNULL(ПРГ_ДанныеПоКомлектации.Порядок, 0) КАК Порядок
           |ПОМЕСТИТЬ ПРГ_ТаблНом
           |ИЗ
           |	ПРГ_ТаблНом_Промежут2 КАК ПРГ_ТаблНом_Промежут1
           |		ЛЕВОЕ СОЕДИНЕНИЕ ПРГ_ДанныеПоКомлектации КАК ПРГ_ДанныеПоКомлектации
           |		ПО ПРГ_ТаблНом_Промежут1.Номенклатура = ПРГ_ДанныеПоКомлектации.Номенклатура
           |
           |СГРУППИРОВАТЬ ПО
           |	ПРГ_ТаблНом_Промежут1.Номенклатура,
           |	ПРГ_ТаблНом_Промежут1.Порядок + ЕСТЬNULL(ПРГ_ДанныеПоКомлектации.Порядок, 0)
           |;
           |
           |////////////////////////////////////////////////////////////////////////////////
           |УНИЧТОЖИТЬ ПРГ_ТаблНом_Промежут1
           |;
           |
           |////////////////////////////////////////////////////////////////////////////////
           |УНИЧТОЖИТЬ ПРГ_ТаблНом_Промежут2
           |;
           |
           |////////////////////////////////////////////////////////////////////////////////
           |УНИЧТОЖИТЬ ПРГ_ДанныеПоКомлектации";
КонецФункции	



Функция ПРГ_ПолучитьТекстЗапросаПредваритТаблицПоПеремещениям(СтруктураДопПараметров,
		СтруктураИзмерений,
		Учет,ДопРесурсы,
		ТекстУдалТабл,
		Запрос,
		КодыОперацийПередачаВЭксплуатацию,
		КодыОперацийПеремещенияВЭксплуатации,
		КодыОперацийВозвратПереданных,
		КодыОперацийПередача,
		КодыОперацийПеремещенияСклад)
	
   ТекстУдалТабл = "";
   Если Не СтруктураДопПараметров.Свойство("ПРГ_ФильтрПоТоварам") Тогда
	      возврат "";
   КонецЕсли;
   
   Запрос.МенеджерВременныхТаблиц = СтруктураДопПараметров.ПРГ_ФильтрПоТоварам;
   
	КодыДляПартий = Новый Массив;
	СовмКоды 	  = Новый Массив;
	СовмКоды.Добавить(КодыОперацийПередачаВЭксплуатацию);
	СовмКоды.Добавить(КодыОперацийПеремещенияВЭксплуатации);
	СовмКоды.Добавить(КодыОперацийВозвратПереданных);
	СовмКоды.Добавить(КодыОперацийПередача);
	СовмКоды.Добавить(КодыОперацийПеремещенияСклад);
	
	
	для н = 0 ПО СовмКоды.Количество()-1 Цикл
		Для Каждого  ТекЭлем Из СовмКоды[н] Цикл
			КодыДляПартий.Добавить(ТекЭлем);
		КонецЦикла;	
	КонеЦЦикла;	
	
    КодыДляПартий.Добавить(Перечисления.КодыОперацийПартииТоваров.Комплектация);
	
    Запрос.УстановитьПараметр("ПРГ_КодыОпераций",КодыДляПартий);
	  
   ПредТекстЗапроса = "";
   н = 0;
   Для Каждого Элемент Из СтруктураИзмерений Цикл
	     н = н + 1;
		 ТекстЗППОизм = "";
		 Для Каждого Измерение Из Элемент.Значение Цикл
				//СтруктураВсехИзмерений[Измерение+ПрефиксПараметровНовогоСостояния]="Приемник."+Измерение;
				ТекстЗППОизм = ТекстЗППОизм+"
				|, Источник."+Измерение;
		  КонецЦикла;
		ПредТекстЗапроса  = ПредТекстЗапроса+ "
		|ВЫБРАТЬ Различные
		|  Источник.Период
		| ,Источник.Активность
		| ,Источник.ВидДвижения
		| ,Источник.Регистратор
		| ,Источник.КодОперации "+ТекстЗППОизм+"
		| ,Источник.Количество
		| ,Источник.Стоимость "+ ДопРесурсы+"
		| ,Источник.НомерКорСтроки
		| ПОМЕСТИТЬ ПРГ_" + Элемент.Ключ+"
		| 	  ИЗ 
	    |		ПРГ_ФильтрПоТоварам КАК ПРГ_ФильтрПоТоварам
		|        ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
		|       РегистрНакопления."+ Элемент.Ключ +" КАК Источник 
		
	    |		ПО Источник.Номенклатура 		  = ПРГ_ФильтрПоТоварам.Номенклатура
		| ГДЕ 
		|  Источник.Период МЕЖДУ &ДатаНач И &ДатаКон И
		|  Источник.Активность И 
		|  Источник.ВидДвижения = &ВидДвиженияРасход И
		|  Источник.КодОперации в (&ПРГ_КодыОпераций) ";
		
		ТекстУдалТабл = ТекстУдалТабл+"
		| Уничтожить ПРГ_" + Элемент.Ключ + ";";
		
		Если Учет = "Бух" ИЛИ Учет = "Нал" ИЛИ Учет = "Меж" Тогда
			ПредТекстЗапроса = ПредТекстЗапроса  + "
			|	И (НЕ Источник.СчетУчета В (&СписокИсключаемыхСчетовУчета))
			|	И Источник.Организация = &Организация";
		ИначеЕсли Учет = "Упр"  И Элемент.Ключ <> СтруктураДопПараметров.ИмяРегистраВЭксплуатации Тогда
			ПредТекстЗапроса = ПредТекстЗапроса  + "
			|	И (НЕ Источник.СтатусПартии В (&ИсключаемыеСтатусыПартий))";
		КонецЕсли;	
		
		ПредТекстЗапроса  = ПредТекстЗапроса+ "
		|; ";
			
	КонецЦикла; 
	
	возврат ПредТекстЗапроса;
	  
КонецФункции	

//конец изменений 

//*******************************************************************************************
//начало изменений Ожиганов 21.04.2016 б/н приравнять движения по материалам БУ к НУ  
//начало изменений Ожиганов 30.05.2016 выравнивание копеек по НУ, приведение остатков к БУ 
Процедура ПРГ_ПопытатьсяПриравнятьНУкБУПоТМЦ(ДатаНач, ДатаКон, Организация, 
				ТаблицаТоваров, 
				ВидОтраженияВУчете, 
				РегламентныйДокумент, 
				МенВремТаблВыпПродукции = Неопределено, 
				СтруктДопПарметров = Неопределено,
				ВариантВыравниванияОтклонений=1
				) Экспорт 
				
	Если ВидОтраженияВУчете <> "НалоговыйУчет"  Тогда
		возврат;		
	КонецЕсли;	
	
	Если ТипЗнч(РегламентныйДокумент) = Тип("ДокументСсылка.КорректировкаСтоимостиСписанияТоваров") Тогда
		Если Не РегламентныйДокумент.ПРГ_ПопытатьсяПриранвнятьНУкБУ или Не РегламентныйДокумент.ОтражатьВНалоговомУчете Тогда
			возврат;
		КонецЕсли;	
	ИначеЕсли ТипЗнч(РегламентныйДокумент) = Тип("ДокументСсылка.РасчетСебестоимостиВыпуска") Тогда
		Если Не РегламентныйДокумент.ОтражатьВНалоговомУчете Тогда
			возврат;
		КонецЕсли;		
	ИначеЕсли ТипЗнч(РегламентныйДокумент) <> Тип("ДокументСсылка.КорректировкаЗаписейРегистров") Тогда
		возврат;		
	КонецЕсли;
	
	ДопПараметры = Новый Структура;
	Если СтруктДопПарметров <>  Неопределено Тогда
		Для Каждого ТекЗнч Из СтруктДопПарметров Цикл
			    ДопПараметры.Вставить(ТекЗнч.Ключ, ТекЗнч.Значение);
		КонецЦикла;	
	КонецЕсли;	
	
	ДопПараметры.Вставить("ОтражатьВУправленческомУчете",Ложь);
	ДопПараметры.Вставить("ОтражатьВБухгалтерскомУчете",Ложь);
	ДопПараметры.Вставить("ОтражатьВНалоговомУчете",Истина);
	ДопПараметры.Вставить("ОтражатьВМеждународномУчете",Ложь);
	
	ДопПараметры.Вставить("ЕстьСтрокиОтражатьВУправленческомУчете",ДопПараметры.ОтражатьВУправленческомУчете);
	ДопПараметры.Вставить("ЕстьСтрокиОтражатьВБухгалтерскомУчете",ДопПараметры.ОтражатьВБухгалтерскомУчете);
	ДопПараметры.Вставить("ЕстьСтрокиОтражатьВНалоговомУчете",ДопПараметры.ОтражатьВНалоговомУчете);
	ДопПараметры.Вставить("ЕстьСтрокиОтражатьВМеждународномУчете",ДопПараметры.ОтражатьВМеждународномУчете);
	
	ДопПараметры.Вставить("ДатаНач",НачалоМесяца(ДатаНач));
	ДопПараметры.Вставить("ДатаКон",КонецМесяца(ДатаКон));
	
	ДопПараметры.Вставить("ВидУчета",ВидОтраженияВУчете);
	ДопПараметры.Вставить("Организация",Организация);
	
	ДопПараметры.Вставить("ПериодЗаписей",РегламентныйДокумент.Дата);
	ДопПараметры.Вставить("Период",РегламентныйДокумент.Дата);
	ДопПараметры.Вставить("РегламентныйДокумент",РегламентныйДокумент);
	ДопПараметры.Вставить("КэшПоВидамСубконто", Новый Соответствие);
	ДопПараметры.Вставить("КодыОпераций", Перечисления.КодыОперацийПартииТоваров);
	
	//начало изменений Ожиганов 04.05.2016 б/н исправление ошибок округления в НУ 
	//определяем что приравниваем продукцию или прочеее
	//
	ЭтоПродукция = Ложь;
	Если ВариантВыравниванияОтклонений = 1 Тогда      // материалы и ПФ не участвующие выпуске и комплектациях
		ЭтоПродукция = Ложь;
		
	ИначеЕсли ВариантВыравниванияОтклонений = 2 Тогда // все ГП (43 счет)
		ЭтоПродукция = Истина;	
		ДопПараметры.Вставить("ВстречныйВыпуск",Истина);
	ИначеЕсли ВариантВыравниванияОтклонений = 3 Тогда // ПФ выпускаемые и комплектации
		ДопПараметры.Вставить("ВстречныйВыпуск",Истина);
	Иначе  			
		 возврат; 
	КонецЕсли;	
	
	ДопПараметры.Вставить("ВариантВыравниванияОтклонений", ВариантВыравниванияОтклонений);
	ДопПараметры.Вставить("ЭтоПродукция",ЭтоПродукция);
	
	Если МенВремТаблВыпПродукции = Неопределено и Не ЭтоПродукция  Тогда
		МенВремТаблВыпПродукции =  ПРГ_ПолучитьВременнуюТаблицуВыпуска(ДатаНач,ДатаКон,"ПартииТоваровНаСкладахНалоговыйУчет",Организация, ВариантВыравниванияОтклонений = 3);
	КонецЕсли;
	
	ДопПараметры.Вставить("МенВремТаблВыпПродукции",МенВремТаблВыпПродукции);
	
	ДопПараметры.Вставить("ТипЗначенияРегистратора", ТипЗнч(РегламентныйДокумент));
	
	//проверки когда возвможно 
    //в случае если введен документ корректировки по БУ
	//это корректировка по материалам
	//нужен отдельный запрос  по продукции
	//проверим есть ли р/с по бу 
	Запрос = Новый Запрос();
	Если ВариантВыравниванияОтклонений = 2 или ВариантВыравниванияОтклонений = 3 Тогда
		Запрос.Текст	  =  "ВЫБРАТЬ
		            	     |	РасчетСебестоимостиВыпуска.Ссылка
		            	     |ИЗ
		            	     |	Документ.РасчетСебестоимостиВыпуска КАК РасчетСебестоимостиВыпуска
		            	     |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладахБухгалтерскийУчет КАК ПартииТоваровНаСкладахБухгалтерскийУчет
		            	     |		ПО РасчетСебестоимостиВыпуска.Ссылка = ПартииТоваровНаСкладахБухгалтерскийУчет.Регистратор
		            	     |ГДЕ
		            	     |	РасчетСебестоимостиВыпуска.Дата МЕЖДУ &ДатаНач И &ДатаКон
		            	     |	И РасчетСебестоимостиВыпуска.Проведен
		            	     |	И РасчетСебестоимостиВыпуска.ОтражатьВБухгалтерскомУчете
		            	     |
		            	     |СГРУППИРОВАТЬ ПО
		            	     |	РасчетСебестоимостиВыпуска.Ссылка";	
							  
		Запрос.УстановитьПараметр("ДатаНач",ДопПараметры.ДатаНач);
		Запрос.УстановитьПараметр("ДатаКон",КонецДня(ДопПараметры.ДатаКон));
	Иначе
		Запрос.Текст	  =  "ВЫБРАТЬ
		                      |	КорректировкаСтоимостиСписанияТоваров.Ссылка
		                      |ИЗ
		                      |	Документ.КорректировкаСтоимостиСписанияТоваров КАК КорректировкаСтоимостиСписанияТоваров
		                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладахБухгалтерскийУчет КАК ПартииТоваровНаСкладахБухгалтерскийУчет
		                      |		ПО КорректировкаСтоимостиСписанияТоваров.Ссылка = ПартииТоваровНаСкладахБухгалтерскийУчет.Регистратор
		                      |ГДЕ
		                      |	КорректировкаСтоимостиСписанияТоваров.Проведен
		                      |	И КорректировкаСтоимостиСписанияТоваров.Дата МЕЖДУ &ДатаНач И &ДатаКон
		                      |	И КорректировкаСтоимостиСписанияТоваров.ОтражатьВБухгалтерскомУчете
		                      |
		                      |СГРУППИРОВАТЬ ПО
		                      |	КорректировкаСтоимостиСписанияТоваров.Ссылка";	
							  
		Запрос.УстановитьПараметр("ДатаНач",ДопПараметры.ДатаНач);
		Запрос.УстановитьПараметр("ДатаКон",КонецДня(ДопПараметры.ДатаКон));
	КонецЕсли;	
	
	РезЗапроса = Запрос.Выполнить();					  
	Если РезЗапроса.Пустой() Тогда
		возврат;
	Конецесли;	
	
	Если Не ДопПараметры.ОтражатьВНалоговомУчете Тогда
		 возврат;
	КонецЕсли;	
	//конец изменений 
	
	ТаблСчетов = ПРГ_ПолучитьТаблСчетовДляПриведенияНУкБУ(ВариантВыравниванияОтклонений);
	
	Если ТаблСчетов.Количество() = 0 Тогда
		возврат;
	КонецЕсли;	
	
	ДопПараметры.Вставить("ТаблицаТоваров",ТаблицаТоваров);
	
	Если ВариантВыравниванияОтклонений = 2 Тогда //Продукция
		ТаблРазницБУиНУ = ПРГ_ПолучитьТаблицуРазницБУиНУ(ТаблСчетов,ДопПараметры,100); //раз
	ИначеЕсли ВариантВыравниванияОтклонений = 3 Тогда //Полуфабрикаты выпускаемые
		ТаблРазницБУиНУ = ПРГ_ПолучитьТаблицуРазницБУиНУ(ТаблСчетов,ДопПараметры,100); 
	Иначе //материалы и ПФ не участвующие выпуске и комплектациях 
		Если ДатаКон >='20150501' Тогда
			ТаблРазницБУиНУ = ПРГ_ПолучитьТаблицуРазницБУиНУ(ТаблСчетов,ДопПараметры,10);
		Иначе 	
			//привести в соотвествие после
			ТаблРазницБУиНУ = ПРГ_ПолучитьТаблицуРазницБУиНУ(ТаблСчетов,ДопПараметры,10);
		КонецЕсли;	
	КонецЕсли;;	
	
	#Если Клиент Тогда
		ПРГ_ДопФункцииКлиентСервер.ПРГВывестиТаблЗнчВТабДок(ТаблРазницБУиНУ,"Разница между БУ и НУ");
	#КонецЕсли
	
	Если ТаблРазницБУиНУ.Количество() = 0 Тогда
		возврат;
	КонецЕсли;	
	
	///параметр определяющий на документ движения
	ДопПараметры.Вставить("ОпределятьДокДвиж",Истина);
	//посмотреть на результат и убрать вслучае необходимость
	ДопПараметры.Вставить("ОбъеденятьВозвратыИПродажи",Истина);
	
	ПРГ_ВыполнитьДвиженияПоСписаниюПриравниваниеНУкБУ(ДопПараметры,ТаблРазницБУиНУ);
	
	//начало изменений Ожиганов 25.04.2016 б/н приравнять движения по материалам БУ к НУ  
	//в случае если это качество не ок, по попытаемся за счет качества ок прировнять БУ к НУ
	//поскольку основной причиной могут быть перемещения в разрезе качества  - корректировка качества и.т.д
	//обработаем таблицу
	Если ВариантВыравниванияОтклонений = 1 или ВариантВыравниванияОтклонений = 3 Тогда //материалы и ПФ в том числе выпускаемые
		ПРГ_ПопытатьсяПриравнятьНУкБУЗаСчетКачесвтоОк(ДопПараметры,ТаблРазницБУиНУ,ТаблСчетов);
	КонецЕсли;	
	
КонецПроцедуры

Процедура ПРГ_ПопытатьсяПриравнятьНУкБУЗаСчетКачесвтоОк(СтруктДопПараметры,ТаблРазницБУиНУ,ТаблСчетов)
	
	ДопПараметры = Новый Структура;
	Для Каждого ТекЭлем Из СтруктДопПараметры Цикл
		ДопПараметры.Вставить(ТекЭлем.Ключ,ТекЭлем.Значение);
	КонецЦикла;	
	
	ТаблРазницБУиНУ.Колонки.Добавить("СтароеКачество",Новый ОписаниеТипов("СправочникСсылка.Качество"));
	к  = 0 ;
	КачествоОк = Справочники.Качество.Новый;
	Пока к < ТаблРазницБУиНУ.Количество() Цикл
		
		Если ТаблРазницБУиНУ[к].Качество = КачествоОк или ТаблРазницБУиНУ[к].СтоимостьОстаток = 0 
			//или ТаблРазницБУиНУ[к].Отработана 
			
			Тогда
			//	удаляем
			ТаблРазницБУиНУ.Удалить(ТаблРазницБУиНУ[к]);
		Иначе
			к = к + 1;
		КонецЕсли;	
	КонецЦикла;	
	//конец изменений 
	
	Если ТаблРазницБУиНУ.Количество() = 0  Тогда
		  возврат;
	КонецЕсли;	
	
	ТаблТоваров  = ТаблРазницБУиНУ.Скопировать(,"Номенклатура");
	ТаблТоваров.Свернуть("Номенклатура");
	
	ДопПараметры.Вставить("ТаблицаТоваров",ТаблТоваров);
	
	//Если СтруктДопПараметры.ВариантВыравниванияОтклонений = 1 Тогда
	ДопПараметры.Вставить("МенВремТаблВыпПродукции",Неопределено);
	//КонецЕсли;	
	
	//поскольку ранеее уже использовались фильтры по включению исключению выпуска
	//достаточно той таблицы котрая передано 
	//используем получение как у материлов без выпкса
	СтарыйВариантВыравниванияОтклонений = ДопПараметры.ВариантВыравниванияОтклонений;
	ДопПараметры.ВариантВыравниванияОтклонений = 1;
	
	ДопПараметры.Вставить("ВключатьНулевыеРасх",Истина);
	
	ТаблРазницБУиНУДляОпреленияОстатков = ПРГ_ПолучитьТаблицуРазницБУиНУ(ТаблСчетов,ДопПараметры,100);
	
	ДопПараметры.ВариантВыравниванияОтклонений = СтарыйВариантВыравниванияОтклонений;
	
	СтПоиска = Новый Структура("Номенклатура,ХарактеристикаНоменклатуры,Склад,СерияНоменклатуры,Качество,ДокументОприходования,Заказ,СчетНУ,Организация");
	
	//ТаблРазницБУиНУДляОпреленияОстатков.Колонки.СчетНУ
	//создадим две таблицы для перемещений и корректировки списаний
	
	ТаблСписаний 	 = ТаблРазницБУиНУ.СкопироватьКолонки("Номенклатура,ХарактеристикаНоменклатуры,Склад,СерияНоменклатуры,Качество,ДокументОприходования,Заказ,СчетНУ,Организация");
	ТаблСписаний.Колонки.Добавить("Стоимость",Новый ОписаниеТипов("Число",,,Новый КвалификаторыЧисла(15,2)));
	ТаблСписаний.Колонки.Добавить("ВременнаяРазница",Новый ОписаниеТипов("Число",,,Новый КвалификаторыЧисла(15,2)));
	ТаблСписаний.Колонки.Добавить("ПостояннаяРазница",Новый ОписаниеТипов("Число",,,Новый КвалификаторыЧисла(15,2)));
	ТаблПеремещений  = ТаблСписаний.Скопировать();
	
	Для Каждого ТекСтрокаРазницБУНУ Из ТаблРазницБУиНУ Цикл
		
		ЗаполнитьЗначенияСвойств(СтПоиска,ТекСтрокаРазницБУНУ,,"Качество");
		//Проверяем сколько о осталось
		СтПоиска.Качество  	=  ТекСтрокаРазницБУНУ.Качество;
		СтПоиска.СчетНУ 	=  ТекСтрокаРазницБУНУ.СчетНУ;
		
		НайдОстразницы  = ТаблРазницБУиНУДляОпреленияОстатков.НайтиСтроки(СтПоиска);
		
		Если НайдОстразницы.Количество() = 1 Тогда
			Если НайдОстразницы[0].СтоимостьОстаток = 0 Тогда
				продолжить;
			КонецЕсли;	
			ТекСтрокаРазниц = НайдОстразницы[0];
		Иначе
	 		продолжить;
		КонецЕсли;	
		
		СтПоиска.Качество  	=  КачествоОк;
//		СтПоиска.СчетНУ 	=  ТекСтрокаРазниц.СчетНУ;
		
		НайдОстатки 		=   ТаблРазницБУиНУДляОпреленияОстатков.НайтиСтроки(СтПоиска);
		
		Если НайдОстатки.Количество()  = 0  Тогда
			продолжить;
		КонецЕсли;	
		
	    ПогСтоим = 0;
		ПогВременнаяРазница = 0;
		ПогПостояннаяРазница = 0;
		//начало изменений Ожиганов 25.04.2016 б/н приравнять движения по материалам БУ к НУ
		//обработать если в сумме НУ будут равны 0
		
		РаспрСумма = ТекСтрокаРазниц.СтоимостьОстаток;
		Всего 	   = ТекСтрокаРазниц.СтоимостьНУ + ТекСтрокаРазниц.ПостояннаяРазница + ТекСтрокаРазниц.ВременнаяРазница;
		
		ПогСтоим  = Окр(ТекСтрокаРазниц.СтоимостьНУ/Всего*РаспрСумма,2);
		РаспрСумма = РаспрСумма - ПогСтоим;   Всего = Всего - ТекСтрокаРазниц.СтоимостьНУ;
		
		Если Всего <> 0 Тогда
			ПогВременнаяРазница  = Окр(ТекСтрокаРазниц.ВременнаяРазница/Всего*РаспрСумма,2);
			РаспрСумма = РаспрСумма - ПогВременнаяРазница;   Всего = Всего - ТекСтрокаРазниц.ВременнаяРазница;
		КонецЕслИ;	
		
		Если Всего <> 0 Тогда
			ПогПостояннаяРазница  = Окр(ТекСтрокаРазниц.ПостояннаяРазница/Всего*РаспрСумма,2);
			РаспрСумма = РаспрСумма - ПогПостояннаяРазница;   Всего = Всего - ТекСтрокаРазниц.ПостояннаяРазница;
		КонецЕслИ;	
		
		Если  ТекСтрокаРазниц.СтоимостьОстаток + НайдОстатки[0].СтоимостьОстаток = 0 
		 или  (НайдОстатки[0].СтоимостьОстаток > 0 и ТекСтрокаРазниц.СтоимостьОстаток + НайдОстатки[0].СтоимостьОстаток < НайдОстатки[0].СтоимостьОстаток)
		 или  (НайдОстатки[0].СтоимостьОстаток < 0 и ТекСтрокаРазниц.СтоимостьОстаток + НайдОстатки[0].СтоимостьОстаток > НайдОстатки[0].СтоимостьОстаток) Тогда
		 //это перемещение
		    НС  =  ТаблПеремещений.Добавить();
			ЗаполнитьЗначенияСвойств(НС,ТекСтрокаРазниц);
			НС.Стоимость        		=  ПогСтоим;
			НС.ВременнаяРазница         =  ПогВременнаяРазница;
			НС.ПостояннаяРазница        =  ПогПостояннаяРазница;
			//скорректируем остаток
			НайдОстатки[0].СтоимостьОстаток = НайдОстатки[0].СтоимостьОстаток+ НС.Стоимость+НС.ВременнаяРазница+НС.ПостояннаяРазница;
		Иначе
		    НС  =  ТаблСписаний.Добавить();
			ЗаполнитьЗначенияСвойств(НС,ТекСтрокаРазниц);
			НС.Стоимость        			= ПогСтоим;
			НС.ВременнаяРазница         	= ПогВременнаяРазница;
			НС.ПостояннаяРазница        	= ПогПостояннаяРазница;
			НайдОстатки[0].СтоимостьОстаток = НайдОстатки[0].СтоимостьОстаток+ НС.Стоимость+НС.ВременнаяРазница+НС.ПостояннаяРазница;
		   // перемещение и списание
		//   ПРГ_СформироватьДвижениеПоПеремещению(ТекСтрокаРазниц,ДопПараметры,ПогСтоим,ПогВременнаяРазница,ПогПостояннаяРазница,КачествоОк);
		КонецЕсли; 
	КонецЦикла;	
	
	ТаблСписаний.Колонки.Добавить("СтароеКачество",Новый ОписаниеТипов("СправочникСсылка.Качество"));
	
	Если ТаблСписаний.Количество() = 0 Тогда
		возврат;
	КонецЕсли;	
	
	Для Каждого ТекСтрока Из ТаблСписаний Цикл
		ТекСтрока.СтароеКачество  = ТекСтрока.Качество;
		ТекСтрока.Качество		  = КачествоОк;
	КонецЦикла;	
	
	Запрос 			   = Неопределено;
	МассивНоменклатуры = Неопределено;
	
	ПРГ_ПодготовитьПарметрыЗапросаНУкБУ(Запрос, ДопПараметры, ТаблСписаний, МассивНоменклатуры);
	ПРГ_ЗаполнитьЗапросПоСписаниюНалПриравниеНУкБУ(Запрос, МассивНоменклатуры, ДопПараметры, Ложь);
	
	ТаблицаРезультатаЗапроса = Запрос.Выполнить().Выгрузить();
	
	ТаблицаРезультатаЗапроса.Колонки.Добавить("ОтражатьВНалоговомУчете");	
	ТаблицаРезультатаЗапроса.Колонки.Добавить("ОтражатьВБухгалтерскомУчете");	
	ТаблицаРезультатаЗапроса.Колонки.Добавить("ОтражатьВУправленческомУчете");	
	ТаблицаРезультатаЗапроса.Колонки.Добавить("ОтражатьВМеждународномУчете");	
	
	ТаблицаРезультатаЗапроса.ЗаполнитьЗначения(ДопПараметры.ОтражатьВНалоговомУчете,	  "ОтражатьВНалоговомУчете");
	ТаблицаРезультатаЗапроса.ЗаполнитьЗначения(ДопПараметры.ОтражатьВУправленческомУчете, "ОтражатьВУправленческомУчете");
	ТаблицаРезультатаЗапроса.ЗаполнитьЗначения(ДопПараметры.ОтражатьВБухгалтерскомУчете,  "ОтражатьВБухгалтерскомУчете");
	ТаблицаРезультатаЗапроса.ЗаполнитьЗначения(ДопПараметры.ОтражатьВМеждународномУчете,  "ОтражатьВМеждународномУчете");
	
	ТаблицаРезультатаЗапроса.Колонки.Добавить("ПринятыеСчетУчетаНУ"); // колонка используется только для приведения к стандартному виду
	//******************** запись ********************************************
	
	ТаблДвиж =  ТаблицаРезультатаЗапроса.СкопироватьКолонки();
	
	УправлениеЗапасамиПартионныйУчет.СоздатьНаборыЗаписей(ДопПараметры, ТаблДвиж, ДопПараметры.РегламентныйДокумент);
	УправлениеЗапасамиПартионныйУчет.ПодготовитьНаборыЗаписей(ДопПараметры, ТаблДвиж, ДопПараметры.ПериодЗаписей, ДопПараметры.РегламентныйДокумент, Ложь);
	
	Для Каждого  ТекСтрокаРазниц из ТаблПеремещений Цикл
		ПРГ_СформироватьДвижениеПоПеремещению(ТекСтрокаРазниц,ДопПараметры,ТекСтрокаРазниц.Стоимость,ТекСтрокаРазниц.ВременнаяРазница,ТекСтрокаРазниц.ПостояннаяРазница,КачествоОк);
	КонецЦикла;	
	
	Для Каждого ТекСтрока Из ТаблСписаний Цикл
		ТекСтрока.Качество        = ТекСтрока.СтароеКачество;
	КонецЦикла;	
	
	СтПоиска = Новый Структура("Номенклатура,ХарактеристикаНоменклатуры,Склад,СерияНоменклатуры,Качество,ДокументОприходования,Заказ,СчетУчетаНУ,Организация");
	
	
	АСтруктДляДаты = Новый Структура("Дата");
	
	Для Каждого ТекСтрокаРазниц ИЗ ТаблСписаний Цикл
		
		
		ЗаполнитьЗначенияСвойств(СтПоиска, ТекСтрокаРазниц);
		СтПоиска.Качество 	   = КачествоОк;
		СтПоиска.СчетУчетаНУ   = ТекСтрокаРазниц.СчетНУ;
		
		
		
		ВыпДвижения  = ТаблицаРезультатаЗапроса.НайтиСтроки(СтПоиска);
		
		Если ВыпДвижения.Количество() > 0 Тогда
			
					ПогСтоим 				= ТекСтрокаРазниц.Стоимость;
					ПогВременнаяРазница 	= ТекСтрокаРазниц.ВременнаяРазница;
					ПогПостояннаяРазница 	= ТекСтрокаРазниц.ПостояннаяРазница;
					
//***************************************************************************************************************					

			    	ВсеКолВо  = 0;
					МаксКолВо = 0;
					
					КолВоВыпДвижения = ВыпДвижения.Количество();
					Для н = 0  ПО КолВоВыпДвижения - 1 Цикл  
						
						    ТекСтрокаДвиж = ВыпДвижения[н];
							ВсеКолВо = ВсеКолВо + ТекСтрокаДвиж.Количество;
							
							МаксКолВо = Макс(ТекСтрокаДвиж.Количество,-1*ТекСтрокаДвиж.Количество);
							
							Если ВсеКолВо = 0 и н < КолВоВыпДвижения - 1 Тогда
								ТекСтрокаДвиж.Количество = ТекСтрокаДвиж.Количество+1;
								ВсеКолВо = ВсеКолВо +1;
							КонецЕсли;
							
					КонецЦикла; 
					
					ПоложВсеКолВо = Макс(ВсеКолВо,-1*ВсеКолВо);
					
					Если НЕ (МаксКолВо > 1 и ПоложВсеКолВо < 0.1) и (ВсеКолВо <> 0) Тогда
						
						ПРГ_СформироватьДвижениеПоПеремещению(ТекСтрокаРазниц,ДопПараметры,ТекСтрокаРазниц.Стоимость,ТекСтрокаРазниц.ВременнаяРазница,ТекСтрокаРазниц.ПостояннаяРазница,КачествоОк);
						
					    Для Каждого ВыпДвижение из ВыпДвижения Цикл
						
						
							Если ВсеКолВо = 0 Тогда
							    //остановимся на том что удалось распределить
							   Прервать;
							КонецЕсли;
							
							
							Попытка
						
							  	ТекСтоимость  		 =  Окр(ПогСтоим * ВыпДвижение.Количество / ВсеКолВо,2);
								ТекВременнаяРазница  =  Окр(ПогВременнаяРазница * ВыпДвижение.Количество / ВсеКолВо,2);
								ТекПостояннаяРазница =  Окр(ПогПостояннаяРазница * ВыпДвижение.Количество / ВсеКолВо,2);
								
								ВсеКолВо 			  = ВсеКолВо 			 - ВыпДвижение.Количество;
								ПогСтоим			  = ПогСтоим 			 - ТекСтоимость;
								ПогВременнаяРазница	  = ПогВременнаяРазница  - ТекВременнаяРазница;
								ПогПостояннаяРазница  = ПогПостояннаяРазница - ТекПостояннаяРазница;
								
							Исключение 
								  Сообщить("Код "+ВыпДвижение.Номенклатура.Код+"
								  		|  "+ВыпДвижение.Номенклатура);
							КонецПопытки;	
							
							
							Если  ТекСтоимость <> 0 или ТекВременнаяРазница <> 0 или ТекПостояннаяРазница <> 0 тогда
								
									
								    //ВыпДвижение						    = ВыпДвижения[0];
								
									Движение              				= УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("ПартииТоваровНаСкладахНал", ДопПараметры);
									Движение.Период       			    = ДопПараметры.Период;
									Движение.ВидДвижения  				= ВидДвиженияНакопления.Расход;

									Движение.Номенклатура 				= ВыпДвижение.Номенклатура;
									Движение.ХарактеристикаНоменклатуры = ВыпДвижение.ХарактеристикаНоменклатуры;


									Движение.Склад      			= ВыпДвижение.Склад;
									Движение.Заказ      			= ВыпДвижение.Заказ;
									Движение.СерияНоменклатуры		= ВыпДвижение.СерияНоменклатуры;
									Движение.Качество				= ВыпДвижение.Качество;

									Движение.ДокументОприходования 	= ВыпДвижение.ДокументОприходования;
									Движение.Организация 			= ВыпДвижение.Организация;


									Движение.СчетУчета 				= ВыпДвижение.СчетУчетаНУ;

									Движение.Количество   			= 0;
									
									Движение.Стоимость				= ТекСтоимость;
									Движение.ПостояннаяРазница		= ТекПостояннаяРазница;
									Движение.ВременнаяРазница		= ТекВременнаяРазница;

									Движение.КодОперации 					= ВыпДвижение.КодОперацииПартииТоваров;
							
									// При внешнем списании оставляем ссылку на исходное движение
									Движение.ДокументДвиженияПериод 	  = ВыпДвижение.Период;
									Движение.ДокументДвижения 			  = ВыпДвижение.Регистратор;
									Движение.НомерСтрокиСписанныхТоваров  = ВыпДвижение.НомерСтрокиСписанныхТоваров;
									
									//добавим дату документа если заполнен документ движения и не заполнена дата 
									//движения
									Если  ЗначениеЗаполнено(Движение.ДокументДвижения) 
										и (Движение.ДокументДвиженияПериод = Неопределено или Движение.ДокументДвиженияПериод = '00010101')
										Тогда
										 СтруктураДата = ПРГ_ДопФункцииКлиентСервер.ПолучитьСтруктРевизитаЗаказа(Движение.ДокументДвижения,АСтруктДляДаты);
										 Если СтруктураДата <> Неопределено Тогда
											 Движение.ДокументДвиженияПериод = СтруктураДата.Дата;
										 КонецЕсли;	 
									КонецЕсли;	
									
							
									Если НЕ ВыпДвижение.СерияНоменклтатурыНЗП = Неопределено Тогда
										ВыпДвижение.СерияНоменклатуры = ВыпДвижение.СерияНоменклтатурыНЗП;
									КонецЕсли;
							
									КорректировкаСтоимости.ВыполнитьКорДвижение("НаСкладах", ВыпДвижение, ДопПараметры, Движение);
							Иначе
									
  								//получается все распределили
								Если  ВсеКолВо = 0 Тогда
									прервать;
								КонецЕсли;	
							 КонецЕсли;		
					
					     КонецЦикла;
						
						
						
				  КонецЕсли;	
		//*****************************************************************************			
		КонецЕсли;	
	КонецЦикла;
	
	УправлениеЗапасамиПартионныйУчет.ЗаписатьДвиженияДокумента(ДопПараметры, ТаблДвиж, Ложь);
	
КонецПроцедуры	

Процедура ПРГ_ВыполнитьДвиженияПоСписаниюПриравниваниеНУкБУ(СтруктДопПараметры,ТаблРазницБУиНУ)
	
	ДопПараметры = Новый Структура;
	Для Каждого ТекЭлем Из СтруктДопПараметры Цикл
		ДопПараметры.Вставить(ТекЭлем.Ключ,ТекЭлем.Значение);
	КонецЦикла;	
	
	Запрос = Неопределено;   
	МассивНоменклатуры=Неопределено;
	
	//удалить ниже
	//////ТаблРазницБУиНУДляТеста = ТаблРазницБУиНУ.Скопировать();
	//////МассСтрок = Новый Массив;
	//////н = 0;
	//////Пока н < ТаблРазницБУиНУДляТеста.Количество() Цикл
	//////	МассСтрок.Добавить(ТаблРазницБУиНУДляТеста[н]);
	//////	Если н > 3 Тогда
	//////		прервать;
	//////	КонецЕсли;	
	//////	 н = н  + 1;
	//////КонецЦикла;	
	//////ТаблРазницБУиНУ         =ТаблРазницБУиНУДляТеста.Скопировать(МассСтрок);
	//удалить выше
	
	ПРГ_ПодготовитьПарметрыЗапросаНУкБУ(Запрос, ДопПараметры, ТаблРазницБУиНУ, МассивНоменклатуры);
	ПРГ_ЗаполнитьЗапросПоСписаниюНалПриравниеНУкБУ(Запрос, МассивНоменклатуры, ДопПараметры,Ложь);
	
	ТаблицаРезультатаЗапроса = Запрос.Выполнить().Выгрузить();
	
	//начало изменений Ожиганов 04.05.2016 б/н исправление ошибок округления в НУ 
//	возврат;
	//конец изменений 
	
	Если ТаблицаРезультатаЗапроса.Количество()=0 Тогда
			// Пустая строка для создния требуемых наборов записей, когда есть перемещения без списания
			ТаблицаРезультатаЗапроса.Добавить();
	КонецЕсли;	
	
	ТаблицаРезультатаЗапроса.Колонки.Добавить("ОтражатьВНалоговомУчете");	
	ТаблицаРезультатаЗапроса.Колонки.Добавить("ОтражатьВБухгалтерскомУчете");	
	ТаблицаРезультатаЗапроса.Колонки.Добавить("ОтражатьВУправленческомУчете");	
	ТаблицаРезультатаЗапроса.Колонки.Добавить("ОтражатьВМеждународномУчете");	
	
	
	ТаблицаРезультатаЗапроса.ЗаполнитьЗначения(ДопПараметры.ОтражатьВНалоговомУчете,	  "ОтражатьВНалоговомУчете");
	ТаблицаРезультатаЗапроса.ЗаполнитьЗначения(ДопПараметры.ОтражатьВУправленческомУчете, "ОтражатьВУправленческомУчете");
	ТаблицаРезультатаЗапроса.ЗаполнитьЗначения(ДопПараметры.ОтражатьВБухгалтерскомУчете,  "ОтражатьВБухгалтерскомУчете");
	ТаблицаРезультатаЗапроса.ЗаполнитьЗначения(ДопПараметры.ОтражатьВМеждународномУчете,  "ОтражатьВМеждународномУчете");
	
	ТаблицаРезультатаЗапроса.Колонки.Добавить("ПринятыеСчетУчетаНУ"); // колонка используется только для приведения к стандартному виду
	//******************** запись ********************************************
	
	ТаблДвиж =  ТаблицаРезультатаЗапроса.СкопироватьКолонки();
	Если ТаблицаРезультатаЗапроса.Количество() > 0 тогда
		НС  = ТаблДвиж.Добавить();
		ЗаполнитьЗначенияСвойств(НС,ТаблицаРезультатаЗапроса[0]);
	КонецЕсли;
	
	УправлениеЗапасамиПартионныйУчет.СоздатьНаборыЗаписей(ДопПараметры, ТаблДвиж, ДопПараметры.РегламентныйДокумент);
	УправлениеЗапасамиПартионныйУчет.ПодготовитьНаборыЗаписей(ДопПараметры, ТаблДвиж, ДопПараметры.ПериодЗаписей, ДопПараметры.РегламентныйДокумент, Ложь);
	
//***********************************************************************************************
//***********************************************************************************************
//*************************************** расчет ************************************************
	
	Ст= Новый Структура("Номенклатура,ХарактеристикаНоменклатуры,Склад,СерияНоменклатуры,Качество,ДокументОприходования,Заказ,СчетУчетаНУ,Организация");
	
	АСтруктДляДаты = Новый Структура("Дата");
	
	ТаблРазницБУиНУ.Колонки.Добавить("Обработана");
	
	Для Каждого ТекСтрокаРазниц Из ТаблРазницБУиНУ Цикл
		
			//отладка
			//Если СокрЛП(ТекСтрокаРазниц.Номенклатура.Код) = "P543304" Тогда
			//	Сообщить("Тута " + ТекСтрокаРазниц.Номенклатура.Код);
			//КонецЕсли;	
	
			// Трансляция параметров состояния-источника в формат регистра СписанныеТовары
			Ст.Номенклатура					= ТекСтрокаРазниц.Номенклатура;
			Ст.ХарактеристикаНоменклатуры	= ТекСтрокаРазниц.ХарактеристикаНоменклатуры;
			
			Ст.Склад             			= ТекСтрокаРазниц.Склад;
			Ст.СерияНоменклатуры            = ТекСтрокаРазниц.СерияНоменклатуры;
			Ст.Качество             		= ТекСтрокаРазниц.Качество;
			Ст.ДокументОприходования        = ТекСтрокаРазниц.ДокументОприходования;
			Ст.Заказ             			= ТекСтрокаРазниц.Заказ;
			Ст.СчетУчетаНУ             	    = ТекСтрокаРазниц.СчетНУ;
			Ст.Организация 				    = ДопПараметры.Организация;
			
			// Найдем уже выполненные движения по списанию из этого состояния
			ВыпДвижения  = ТаблицаРезультатаЗапроса.НайтиСтроки(Ст);
			
		    ПогСтоим = 0;
			ПогВременнаяРазница = 0;
			ПогПостояннаяРазница = 0;
			
			
			Если  ТекСтрокаРазниц.СтоимНУ = 0 Тогда
				ПогСтоим =  ТекСтрокаРазниц.СтоимостьОстаток;
			Иначе
				РаспрСумма = ТекСтрокаРазниц.СтоимостьОстаток;
				Всего 	   = ТекСтрокаРазниц.СтоимостьНУ + ТекСтрокаРазниц.ПостояннаяРазница + ТекСтрокаРазниц.ВременнаяРазница;
				
				ПогСтоим  = Окр(ТекСтрокаРазниц.СтоимостьНУ/Всего*РаспрСумма,2);
				РаспрСумма = РаспрСумма - ПогСтоим;   Всего = Всего - ТекСтрокаРазниц.СтоимостьНУ;
				
				Если Всего <> 0 Тогда
					ПогВременнаяРазница  = Окр(ТекСтрокаРазниц.ВременнаяРазница/Всего*РаспрСумма,2);
					РаспрСумма = РаспрСумма - ПогВременнаяРазница;   Всего = Всего - ТекСтрокаРазниц.ВременнаяРазница;
				КонецЕслИ;	
				
				Если Всего <> 0 Тогда
					ПогПостояннаяРазница  = Окр(ТекСтрокаРазниц.ПостояннаяРазница/Всего*РаспрСумма,2);
					РаспрСумма = РаспрСумма - ПогПостояннаяРазница;   Всего = Всего - ТекСтрокаРазниц.ПостояннаяРазница;
				КонецЕслИ;	
				
			КонецЕсли;	
			
			Если ВыпДвижения.Количество() > 0 Тогда
				
				   //подсчитаем количество распр
			    ВсеКолВо  = 0;
				//Для каждого ТекСтрокаДвиж Из ВыпДвижения Цикл
				
				МаксКолВо = 0;
				
				КолВоВыпДвижения = ВыпДвижения.Количество();
				Для н = 0  ПО КолВоВыпДвижения - 1 Цикл  
					
					    ТекСтрокаДвиж = ВыпДвижения[н];
						ВсеКолВо = ВсеКолВо + ТекСтрокаДвиж.Количество;
						
						МаксКолВо = Макс(ТекСтрокаДвиж.Количество,-1*ТекСтрокаДвиж.Количество);
						
						Если ВсеКолВо = 0 и н < КолВоВыпДвижения - 1 Тогда
							ТекСтрокаДвиж.Количество = ТекСтрокаДвиж.Количество+1;
							ВсеКолВо = ВсеКолВо +1;
						КонецЕсли;
						
				КонецЦикла; 
				
				ПоложВсеКолВо = Макс(ВсеКолВо,-1*ВсеКолВо);
				
				Если ВсеКолВо <> 0 и не (МаксКолВо > 1 и ПоложВсеКолВо < 0.1 )  Тогда		
					
					ТекСтрокаРазниц.Обработана 			= Истина;
					
					Для Каждого ВыпДвижение из ВыпДвижения Цикл
						
						
							Если ВсеКолВо = 0 Тогда
							    //остановимся на том что удалось распределить
							   Прервать;
							КонецЕсли;
							
							
							Попытка
						
							  	ТекСтоимость  		 =  Окр(ПогСтоим * ВыпДвижение.Количество / ВсеКолВо,2);
								ТекВременнаяРазница  =  Окр(ПогВременнаяРазница * ВыпДвижение.Количество / ВсеКолВо,2);
								ТекПостояннаяРазница =  Окр(ПогПостояннаяРазница * ВыпДвижение.Количество / ВсеКолВо,2);
								
								ВсеКолВо 			  = ВсеКолВо 			 - ВыпДвижение.Количество;
								ПогСтоим			  = ПогСтоим 			 - ТекСтоимость;
								ПогВременнаяРазница	  = ПогВременнаяРазница  - ТекВременнаяРазница;
								ПогПостояннаяРазница  = ПогПостояннаяРазница - ТекПостояннаяРазница;
								
							Исключение 
								  Сообщить("Код "+ВыпДвижение.Номенклатура.Код+"
								  		|  "+ВыпДвижение.Номенклатура);
							КонецПопытки;	
							
							
							Если  ТекСтоимость <> 0 или ТекВременнаяРазница <> 0 или ТекПостояннаяРазница <> 0 тогда
								
								   
									
								    //ВыпДвижение						    = ВыпДвижения[0];
								
									Движение              				= УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("ПартииТоваровНаСкладахНал", ДопПараметры);
									Движение.Период       			    = ДопПараметры.Период;
									Движение.ВидДвижения  				= ВидДвиженияНакопления.Расход;

									Движение.Номенклатура 				= ВыпДвижение.Номенклатура;
									Движение.ХарактеристикаНоменклатуры = ВыпДвижение.ХарактеристикаНоменклатуры;


									Движение.Склад      			= ВыпДвижение.Склад;
									Движение.Заказ      			= ВыпДвижение.Заказ;
									Движение.СерияНоменклатуры		= ВыпДвижение.СерияНоменклатуры;
									Движение.Качество				= ВыпДвижение.Качество;

									Движение.ДокументОприходования 	= ВыпДвижение.ДокументОприходования;
									Движение.Организация 			= ВыпДвижение.Организация;


									Движение.СчетУчета 				= ВыпДвижение.СчетУчетаНУ;

									Движение.Количество   			= 0;
									
									Движение.Стоимость				= ТекСтоимость;
									Движение.ПостояннаяРазница		= ТекПостояннаяРазница;
									Движение.ВременнаяРазница		= ТекВременнаяРазница;

									Движение.КодОперации 					= ВыпДвижение.КодОперацииПартииТоваров;
							
									// При внешнем списании оставляем ссылку на исходное движение
									Движение.ДокументДвиженияПериод 	  = ВыпДвижение.Период;
									Движение.ДокументДвижения 			  = ВыпДвижение.Регистратор;
									Движение.НомерСтрокиСписанныхТоваров  = ВыпДвижение.НомерСтрокиСписанныхТоваров;
									
									//добавим дату документа если заполнен документ движения и не заполнена дата 
									//движения
									Если  ЗначениеЗаполнено(Движение.ДокументДвижения) 
										и (Движение.ДокументДвиженияПериод = Неопределено или Движение.ДокументДвиженияПериод = '00010101')
										Тогда
										 СтруктураДата = ПРГ_ДопФункцииКлиентСервер.ПолучитьСтруктРевизитаЗаказа(Движение.ДокументДвижения,АСтруктДляДаты);
										 Если СтруктураДата <> Неопределено Тогда
											 Движение.ДокументДвиженияПериод = СтруктураДата.Дата;
										 КонецЕсли;	 
									КонецЕсли;	
							
									Если НЕ ВыпДвижение.СерияНоменклтатурыНЗП = Неопределено Тогда
										ВыпДвижение.СерияНоменклатуры = ВыпДвижение.СерияНоменклтатурыНЗП;
									КонецЕсли;
							
									КорректировкаСтоимости.ВыполнитьКорДвижение("НаСкладах", ВыпДвижение, ДопПараметры, Движение);
							Иначе
									
  								//получается все распределили
								Если  ВсеКолВо = 0 Тогда
									прервать;
								КонецЕсли;	
								
							КонецЕсли;		
					
					КонецЦикла;
						 
				КонецЕсли;		
			КонецЕсли;	
			
	КонецЦикла;

   //***************************************************************************************************************
	УправлениеЗапасамиПартионныйУчет.ЗаписатьДвиженияДокумента(ДопПараметры, ТаблДвиж, Ложь);

КонецПроцедуры	

Процедура ПРГ_СформироватьДвижениеПоПеремещению(ТекСтрока,ДопПараметры,ПогСтоим,ПогВременнаяРазница,ПогПостояннаяРазница,КачествоОК)
	
	
	СтрокаДокумента= Новый Структура("Номенклатура,ХарактеристикаНоменклатуры,Склад,
								| СерияНоменклатуры,Качество,ДокументОприходования,
								| Заказ,Организация");
								
	СтрокаДокумента.Вставить("СчетУчетаНУ",ТекСтрока.СчетНУ);
								
	ЗаполнитьЗначенияСвойств(СтрокаДокумента,ТекСтрока);
	
	
	// Эти параметры добавляются на всякий случай, т.к. они используются процедурой заполнения субконто по счету
	СтрокаДокумента.Вставить("ПодразделениеОрганизации", Неопределено);
	СтрокаДокумента.Вставить("СтатьяЗатрат", Неопределено);
	СтрокаДокумента.Вставить("НоменклатурнаяГруппа", Неопределено);
	СтрокаДокумента.Вставить("ДоговорКонтрагента", Неопределено);
	
	СтрокаДокумента.Вставить("ИзменитьСерию", Ложь);
	СтрокаДокумента.Вставить("ИзменитьХарактеристику", Ложь);
	СтрокаДокумента.Вставить("ИзменитьСклад", Ложь);
	СтрокаДокумента.Вставить("ВидТабличнойЧасти");
	

	СтруктураРеквизитов = Новый Структура("ВестиПартионныйУчетПоСериям");
	УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(СтрокаДокумента.Номенклатура, СтруктураРеквизитов);
	
	СтрокаДокумента.Вставить("ВестиПартионныйУчетПоСериям", СтруктураРеквизитов.ВестиПартионныйУчетПоСериям);
	
	СтрокаДокумента.Вставить("Заказ", СтрокаДокумента.Заказ);
	СтрокаДокумента.Вставить("ДокументОприходования", СтрокаДокумента.ДокументОприходования);
	СтрокаДокумента.Вставить("ДокументОприходованияНовый", СтрокаДокумента.ДокументОприходования);
	СтрокаДокумента.Вставить("Организация", СтрокаДокумента.Организация);
		
	СтрокаДокумента.Вставить("КорСубконтоНУ1", Неопределено);
	СтрокаДокумента.Вставить("КорСубконтоНУ2", Неопределено);
	СтрокаДокумента.Вставить("КорСубконтоНУ3", Неопределено);
	
	СтрокаДокумента.Вставить("КорСубконтоБУ1", Неопределено);
	СтрокаДокумента.Вставить("КорСубконтоБУ2", Неопределено);
	СтрокаДокумента.Вставить("КорСубконтоБУ3", Неопределено);
	
	СтрокаДокумента.Вставить("ПринятыеСчетУчетаНУ", Неопределено);
	
	// Трансляция параметров состояния-приемника в формат регистра СписанныеТовары
	СтрокаДокумента.Вставить("НоменклатураНовая", СтрокаДокумента.Номенклатура);
	СтрокаДокумента.Вставить("ХарактеристикаНоменклатурыНовая", СтрокаДокумента.ХарактеристикаНоменклатуры);
	СтрокаДокумента.Вставить("СерияНоменклатурыНовая", СтрокаДокумента.СерияНоменклатуры);
	
	СтрокаДокумента.Вставить("ЗаказСписания", СтрокаДокумента.Заказ);
	
	СтрокаДокумента.Вставить("КорСчетНУ", СтрокаДокумента.СчетУчетаНУ);
	СтрокаДокумента.Вставить("Организация", СтрокаДокумента.Организация);
	
	СтрокаДокумента.Вставить("КачествоНовое", КачествоОК);
	СтрокаДокумента.Вставить("СкладПолучатель", СтрокаДокумента.Склад);

	
	СтрокаДокумента.Вставить("ОтражатьВУправленческомУчете", Ложь);
	СтрокаДокумента.Вставить("КоличествоПоступление", 0);

	СтрокаДокумента.Вставить("ОтражатьВУправленческомУчете", Ложь);
	СтрокаДокумента.Вставить("ОтражатьВБухгалтерскомУчете", Ложь);
	СтрокаДокумента.Вставить("ОтражатьВНалоговомУчете", Истина);
	СтрокаДокумента.Вставить("ОтражатьВМеждународномУчете", Ложь);
	
	Движение              			= УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("ПартииТоваровНаСкладахНал", ДопПараметры);
	Движение.Период       			= ДопПараметры.Период;
	Движение.ВидДвижения  			= ВидДвиженияНакопления.Расход;
	
	Движение.Номенклатура 			= СтрокаДокумента.Номенклатура;
	
	Движение.ХарактеристикаНоменклатуры = СтрокаДокумента.ХарактеристикаНоменклатуры;
	
	Движение.Склад      			= СтрокаДокумента.Склад;
	Движение.Заказ      			= СтрокаДокумента.Заказ;
	Движение.СерияНоменклатуры 	    = СтрокаДокумента.СерияНоменклатуры;
	Движение.Качество 				= СтрокаДокумента.Качество;
	Движение.ДокументОприходования  = СтрокаДокумента.ДокументОприходования;
	Движение.Организация 			= СтрокаДокумента.Организация;
	Движение.СчетУчета 				= СтрокаДокумента.СчетУчетаНУ;
	Движение.Количество   			= 0;
	
	// Суммы из структуры
	
	Движение.Стоимость 				= ПогСтоим;
	Движение.ВременнаяРазница		= ПогВременнаяРазница;
	Движение.ПостояннаяРазница		= ПогПостояннаяРазница;
	
	СтрокаДокумента.Вставить("КодОперацииПартииТоваров", Перечисления.КодыОперацийПартииТоваров.ПеремещениеМеждуСкладами); // по умолчанию

	Движение.КодОперации = СтрокаДокумента.КодОперацииПартииТоваров;
	
	КорректировкаСтоимости.ВыполнитьКорДвижение("НаСкладах", СтрокаДокумента, ДопПараметры, Движение);
	//ВыполнитьКорДвижение(Источник, СтрокаДокумента, СтруктураДопПараметров, Движение);
	
КонецПроцедуры	

Процедура ПРГ_ПодготовитьПарметрыЗапросаНУкБУ(Запрос, ДопПараметры, ТаблРазницБУиНУ, МассивНоменклатуры)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДатаНач", ДопПараметры.ДатаНач);
	Запрос.УстановитьПараметр("ДатаКон", ДопПараметры.ДатаКон);
	Запрос.УстановитьПараметр("ВидДвиженияРасход", ВидДвиженияНакопления.Расход);
	
	Запрос.УстановитьПараметр("ТаблРазниц", ТаблРазницБУиНУ);
	
	// Формирование запроса по списанию
	// Коды операции, применяются во всех учетах
	КодыОпераций = Перечисления.КодыОперацийПартииТоваров;
	
	МассивСписаниеНаСебестоимость = Новый Массив;
	МассивСписаниеНаСебестоимость.Добавить(КодыОпераций.Реализация);
	МассивСписаниеНаСебестоимость.Добавить(КодыОпераций.РеализацияКомиссия);
	МассивСписаниеНаСебестоимость.Добавить(КодыОпераций.РеализацияРозница);
	
	Запрос.УстановитьПараметр("КодыСписаниеНаСебестоимость", МассивСписаниеНаСебестоимость);
	
	Запрос.УстановитьПараметр("КодыСписаниеНаЗатраты", КодыОпераций.СписаниеНаЗатраты);
	
	Запрос.УстановитьПараметр("КодыСписаниеНаБрак", КодыОпераций.СписаниеНаБрак);
	
	МассивЗатратыОС = Новый Массив;
	МассивЗатратыОС.Добавить(КодыОпераций.СписаниеНаСтроительствоОбъектовОС);
	МассивЗатратыОС.Добавить(КодыОпераций.СписаниеНаВложенияВоВнеоборотныеАктивы);
	
	Запрос.УстановитьПараметр("КодыСтроительствоОбъектовОС", МассивЗатратыОС);
	Запрос.УстановитьПараметр("КодКомплектация", КодыОпераций.Комплектация);
	
	//начало изменений Ожиганов 05.05.2015 изменения по браку 
	//ДопПараметры.Вставить("ПРГРассчВозвратПост",ПРГКорректироватьВозвратыПоставщику(ДопПараметры,ДатаКон));
	//конец изменений 
	
	//начало изменений Ожиганов 22.03.2016 оптимизируем запрос 	
	КодыСписаниеИспВсеТабл = Новый Массив;
	КодыСписаниеНеВсеТабл = Новый Массив;
	//конец изменений 
	
	// Все коды внешних списаний
	МассивВнешСписание = Новый Массив;
	
	МассивВнешСписание.Добавить(КодыОпераций.ВозвратОтПокупателяТекущийМесяц);
	МассивВнешСписание.Добавить(КодыОпераций.Комплектация);
	
	МассивВнешСписание.Добавить(КодыОпераций.Реализация);
	МассивВнешСписание.Добавить(КодыОпераций.РеализацияКомиссия);
	МассивВнешСписание.Добавить(КодыОпераций.РеализацияРозница);
		
	//начало изменений Ожиганов 05.05.2015 изменения по браку 
	//Если ДопПараметры.ПРГРассчВозвратПост Тогда
	//	МассивВнешСписание.Добавить(КодыОпераций.ВозвратПоставщику);
	//КонецЕсли;	
	//конец изменений 

	//ограничим списание толь гп, чтобы не использовались доп корреспонденция
	Если  ДопПараметры.ВариантВыравниванияОтклонений = 2 Тогда // ГП 
		МассивВнешСписание.Добавить(КодыОпераций.СписаниеПоИнвентаризации);
	КонецЕсли;
	
	МассивВнешСписание.Добавить(КодыОпераций.СписаниеПоОрдеру);
	МассивВнешСписание.Добавить(КодыОпераций.СписаниеПартийВПроизводствоОперативно);
		
	МассивВнешСписание.Добавить(КодыОпераций.ВозвратОтПокупателяТекущийМесяц);

	МассивВнешСписание.Добавить(КодыОпераций.СписаниеНаСтроительствоОбъектовОС);
	МассивВнешСписание.Добавить(КодыОпераций.СписаниеНаВложенияВоВнеоборотныеАктивы);
	МассивВнешСписание.Добавить(КодыОпераций.СписаниеПартийПереданныхВПроизводство);
	МассивВнешСписание.Добавить(КодыОпераций.СписаниеНаБрак);
	МассивВнешСписание.Добавить(КодыОпераций.СписаниеНаЗатраты);
		
	МассивВнешСписание.Добавить(Перечисления.КодыОперацийПартииМатериаловВЭксплуатации.СписаниеИзЭксплуатации);
	
	КодыСписаниеНеВсеТабл 	= Новый Массив;
	КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.Реализация);
	КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.РеализацияКомиссия);
	КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.РеализацияРозница);
    КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.ВозвратОтПокупателяТекущийМесяц);
	КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.СписаниеПартийВПроизводствоОперативно);
	КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.СписаниеНаЗатраты);
	КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.СписаниеНаБрак);
	КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.СписаниеНаСтроительствоОбъектовОС);
	КодыСписаниеНеВсеТабл.Добавить(КодыОпераций.СписаниеНаВложенияВоВнеоборотныеАктивы);
	
	
	Запрос.УстановитьПараметр("КодыСписаниеНеВсеТабл", КодыСписаниеНеВсеТабл);	
	Запрос.УстановитьПараметр("КодыСписание", МассивВнешСписание);
	Запрос.УстановитьПараметр("_КодОперацииКоплектации", КодыОпераций.Комплектация);
	
	МассивКодов = Новый Массив;
	//ограничим списание толь гп, чтобы не использовались доп корреспонденция
	Если  ДопПараметры.ВариантВыравниванияОтклонений = 2 Тогда // ГП 
		МассивКодов.Добавить(КодыОпераций.СписаниеПоИнвентаризации);
	КонецЕсли;
	
	Запрос.УстановитьПараметр("_КодыДляСписанныхТоваров",МассивКодов);

	ДопПараметры.Вставить("УчетнаяПолитика", 
			УправлениеЗапасамиПартионныйУчет.ПолучитьУчетнуюПолитику(ДопПараметры.ДатаКон, 
					ДопПараметры.ОтражатьВУправленческомУчете, 
					ДопПараметры.ОтражатьВБухгалтерскомУчете,
					ДопПараметры.ОтражатьВНалоговомУчете,
					ДопПараметры.ОтражатьВМеждународномУчете,
					ДопПараметры.Организация));
					
	Если ДопПараметры.УчетнаяПолитика = Неопределено Тогда
		Возврат;
	КонецЕсли;	
	
	//начало изменений Ожиганов 20.10.2015 изменении качества при комплектации, учтем как перемещение
	ДопПараметры.Вставить("ПРГ_УчитыватьКомплКакПеремИзмКачества",Ложь);
	Если ДопПараметры.ОтражатьВБухгалтерскомУчете или ДопПараметры.ОтражатьВНалоговомУчете 
	 //  или  ДопПараметры.ОтражатьВМеждународномУчете
	 и ДопПараметры.ДатаКон >='20151001'
	 
	Тогда
	    //вставить ограничение по датам
		ДопПараметры.Вставить("ПРГ_УчитыватьКомплКакПеремИзмКачества",Истина);
	Иначе
	
	КонецЕслИ;
	//конец изменений 
	
	//Запрос.УстановитьПараметр("МассивНоменклатуры",МассивНоменклатуры);
КонецПроцедуры	

Процедура ПРГ_ЗаполнитьЗапросПоСписаниюНалПриравниеНУкБУ(Запрос, МассивНоменклатуры, ДопПараметры,ПРГ_ТолькоНаЗатратыВлНаСеб = Ложь)
	
	Организация = ДопПараметры.Организация;
	
	//начало изменений Ожиганов 05.05.2016 б/н исправление ошибок по возвратам ПР  
	//опробуем еще оду версию запроса
	
	МассивИсклКорСчетов = ПолучитьМассивИсключКорСчетов(ДопПараметры);
	
	ОпределятьДокДвиж  = Ложь;
	Если Не ДопПараметры.Свойство("ОпределятьДокДвиж",ОпределятьДокДвиж) Тогда
		ОпределятьДокДвиж = Ложь;
	КонецЕсли;	
	
	ОбъеденятьВозвратыИПродажи = Ложь;
	Если Не ДопПараметры.Свойство("ОбъеденятьВозвратыИПродажи",ОбъеденятьВозвратыИПродажи) Тогда
		ОбъеденятьВозвратыИПродажи = Ложь;
	КонецЕсли;	
	
	
	Запрос.Текст =" 
	|ВЫБРАТЬ
	|	ТаблНом.Номенклатура,
	|	ТаблНом.СчетНУ Как СчетУчета,
	|	ТаблНом.Организация как Организация,
	|	ТаблНом.Склад,
	|	ТаблНом.ДокументОприходования,
	|	ТаблНом.ХарактеристикаНоменклатуры,
	|	ТаблНом.СерияНоменклатуры,
	|	ТаблНом.Заказ,
	|	ТаблНом.Качество
	
	|  Поместить ТаблНом
	|ИЗ
	|	&ТаблРазниц КАК ТаблНом
	|;
//через временную таблицу и кластер
	| Выбрать Источник.Период, Источник.Регистратор,Источник.Номерстроки,Источник.КодОперации, Источник.КорСчет
	| 	Поместить Табпартий
	| ИЗ 
	|  ТаблНом	как ТаблНом
	| ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|  РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК Источник
	|	ПО ТаблНом.Номенклатура = Источник.Номенклатура
	|ГДЕ
	|//ГДЕ
	|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И Не Источник.Регистратор Ссылка Документ.КорректировкаСтоимостиСписанияТоваров
	|	И Не Источник.Регистратор Ссылка Документ.РасчетСебестоимостиВыпуска
	|	И ТаблНом.СчетУчета	   = Источник.СчетУчета
	|	И ТаблНом.Организация  = Источник.Организация
	|	И ТаблНом.Склад		   = Источник.Склад
	|	И ТаблНом.ДокументОприходования = Источник.ДокументОприходования
	|	И ТаблНом.ХарактеристикаНоменклатуры = Источник.ХарактеристикаНоменклатуры
	|	И ТаблНом.СерияНоменклатуры			 = Источник.СерияНоменклатуры
	|	И ТаблНом.Заказ						 = Источник.Заказ
	|	И ТаблНом.Качество					 = Источник.Качество
	|	И Источник.ВидДвижения = &ВидДвиженияРасход
//начало изменений Ожиганов 10.05.2016 б/н исправление ошибок по возвратам ПР  
	|" + ?(МассивИсклКорСчетов.Количество() > 0," 	И Не Источник.КорСчет в (&МассивИсклКорСчетов)","") + "
//конец изменений 
//начало изменений Ожиганов 28.01.2016 б/н исключение неактивных записей из р/с и корректировки стоимости 
	|	И Источник.Активность
//конец изменений 
	|	И Источник.КодОперации В(&КодыСписание)"
	+?(Не ПРГ_ТолькоНаЗатратыВлНаСеб,"","
	|  И ((Источник.КодОперации В(&КодыСписаниеСоСчетами) и Источник.КорСчет в (&СчетаЗатрат))
	|  или Источник.КодОперации В(&КодыСписаниеБезСчетов))
	|")+"
	|;
///*************************************************************первый запрос 	
	|ВЫБРАТЬ
	|	""НаСкладах"" КАК СписаноИз,
	|	Источник.Организация КАК Организация,
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
	|	Источник.Заказ,
	|	СУММА(Источник.Количество) КАК Количество,
	|	СУММА(ВЫБОР КОГДА  Источник.Количество < 0 ТОГДА -1* Источник.Количество Иначе  Источник.Количество Конец) КАК ПоложКоличество,
	|	0 КАК СтоимостьПоступление,
//	|	МатериалыВЭксплуатации.ДокументПередачи КАК ДокументПередачи,
    |   Неопределено КАК ДокументПередачи,
//конец изменений 
	|	NULL КАК ДоговорКонтрагента,
	|	Источник.КодОперации КАК КодОперацииПартииТоваров,
	|	Источник.Качество,
	|   Неопределено Как Продукция,
//	|	БракВПроизводстве.Продукция,
	|	Источник.СчетУчета КАК СчетУчетаНУ,
	|	Источник.КорСчет КАК КорСчетНУ,
	|	Источник.КорСубконто1 КАК КорСубконтоБУ1,
	|	Источник.КорСубконто2 КАК КорСубконтоБУ2,
	|	Источник.КорСубконто3 КАК КорСубконтоБУ3,
	|	Источник.КорСубконто1 КАК КорСубконтоНУ1,
	|	Источник.КорСубконто2 КАК КорСубконтоНУ2,
	|	Источник.КорСубконто3 КАК КорСубконтоНУ3,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ КАК СтатьяЗатрат,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ КАК ПодразделениеОрганизации,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ КАК НоменклатурнаяГруппа,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказСписания,
	
	//|	ВЫБОР
	//|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	//|			ТОГДА Источник.ДокументДвижения
	//|		ИНАЧЕ Источник.Регистратор
	//|	КОНЕЦ КАК Регистратор,
	//
	//|	ВЫБОР
	//|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	//|			ТОГДА Источник.ДокументДвиженияПериод
	//|		ИНАЧЕ Источник.Период
	//|	КОНЕЦ КАК Период,
	| "+?(ОпределятьДокДвиж," МАКСИМУМ(Источник.Регистратор) ",
	" Неопределено  ")+" Как Регистратор,
	|   
	|   ДАТАВРЕМЯ(1, 1, 1)  Как Период,
	
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_КорСчетНУ,НЕОПРЕДЕЛЕНО) как ПРГ_КорСчетНУ,
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ1,НЕОПРЕДЕЛЕНО) как ПРГ_СубконтоНУ1,
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ2,НЕОПРЕДЕЛЕНО) как ПРГ_СубконтоНУ2,
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ3,НЕОПРЕДЕЛЕНО) как ПРГ_СубконтоНУ3,
	//начало изменений Ожиганов 06.05.2015 изменения по браку 
	|   ЕСТЬNULL(СписанныеТовары.СчетДоходовНУ,НЕОПРЕДЕЛЕНО) как ПРГСчетДоходов,
	|   ЕСТЬNULL(СписанныеТовары.СчетРасходовНУ,НЕОПРЕДЕЛЕНО) как ПРГСчетРасходов,
	|   ЕСТЬNULL(СписанныеТовары.СтатьяДоходовИРасходов,НЕОПРЕДЕЛЕНО) как ПРГСтатьяДоходовИРасходов,
	|   ЕСТЬNULL(СписанныеТовары.ПодразделениеОрганизации,НЕОПРЕДЕЛЕНО) как ПРГПодразделениеОрганизации,
	
	|   НЕОПРЕДЕЛЕНО КАК ХарактеристикаНоменклатурыНовая,
	|   НЕОПРЕДЕЛЕНО КАК СерияНоменклатурыНовая,
	|	НЕОПРЕДЕЛЕНО КАК НоменклатураНовая,
	|	НЕОПРЕДЕЛЕНО КАК КачествоНовое,
	|   НЕОПРЕДЕЛЕНО КАК ДокументОприходованияНовый,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям КАК ВестиПартионныйУчетПоСериям,
	|	НЕОПРЕДЕЛЕНО КАК ФизЛицо,
	|	НЕОПРЕДЕЛЕНО КАК НазначениеИспользования,
	|	НЕОПРЕДЕЛЕНО КАК СерияНоменклтатурыНЗП,
	|   0 КАК НомерСтрокиСписанныхТоваров
	//|	Источник.НомерСтрокиСписанныхТоваров КАК НомерСтрокиСписанныхТоваров
	|ИЗ
	|	РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК Источник
//начало изменений Ожиганов 22.03.2016 оптимизируем запрос 
	|  Внутреннее СОЕДИНЕНИЕ Табпартий как Табпартий по Табпартий.Период = Источник.Период и Табпартий.Регистратор = Источник.Регистратор и  Табпартий.НомерСтроки = Источник.НомерСтроки и Табпартий.КодОперации в (&_КодыДляСписанныхТоваров)
	|"+?(Не ПРГ_ТолькоНаЗатратыВлНаСеб,"","
	|  И ((Табпартий.КодОперации В(&КодыСписаниеСоСчетами) и Табпартий.КорСчет в (&СчетаЗатрат))
	|  или Табпартий.КодОперации В(&КодыСписаниеБезСчетов))
	|")+"
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СписанныеТовары КАК СписанныеТовары
	|		ПО Источник.Регистратор = СписанныеТовары.Регистратор
	|			И Источник.НомерСтрокиСписанныхТоваров = СписанныеТовары.НомерСтроки
	|
	|СГРУППИРОВАТЬ ПО
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
//	|	МатериалыВЭксплуатации.ДокументПередачи,
	|	Источник.Заказ,
	|	Источник.КодОперации,
	|	Источник.Качество,
//	|	БракВПроизводстве.Продукция,
	|	Источник.Организация,
	|	Источник.СчетУчета,
	|	Источник.КорСчет,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ,
//	|	ВЫБОР
//	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
//	|			ТОГДА Источник.ДокументДвижения
//	|		ИНАЧЕ Источник.Регистратор
//	|	КОНЕЦ,
//	|	ВЫБОР
//	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
//	|			ТОГДА Источник.ДокументДвиженияПериод
//	|		ИНАЧЕ Источник.Период
//	|	КОНЕЦ,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	//|	Источник.НомерСтрокиСписанныхТоваров,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_КорСчетНУ,НЕОПРЕДЕЛЕНО),
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ1,НЕОПРЕДЕЛЕНО),
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ2,НЕОПРЕДЕЛЕНО),
	|   ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоНУ3,НЕОПРЕДЕЛЕНО),
	//начало изменений Ожиганов 06.05.2015 изменения по браку 
	|   ЕСТЬNULL(СписанныеТовары.СчетДоходовНУ,НЕОПРЕДЕЛЕНО),
	|   ЕСТЬNULL(СписанныеТовары.СчетРасходовНУ,НЕОПРЕДЕЛЕНО),
	|   ЕСТЬNULL(СписанныеТовары.СтатьяДоходовИРасходов,НЕОПРЕДЕЛЕНО),
	|   ЕСТЬNULL(СписанныеТовары.ПодразделениеОрганизации,НЕОПРЕДЕЛЕНО)	
	|
	|ИМЕЮЩИЕ
	|	СУММА(Источник.Количество) <> 0
	|
	|
	| Объединить Все 
	|ВЫБРАТЬ
	|	""НаСкладах"" КАК СписаноИз,
	|	Источник.Организация КАК Организация,
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
	|	Источник.Заказ,
	|	СУММА(Источник.Количество) КАК Количество,
	|   СУММА(ВЫБОР КОГДА  Источник.Количество < 0 ТОГДА -1* Источник.Количество Иначе  Источник.Количество Конец) КАК ПоложКоличество,
	|	0 КАК СтоимостьПоступление,
//	|	МатериалыВЭксплуатации.ДокументПередачи КАК ДокументПередачи,
    |   Неопределено КАК ДокументПередачи,
//конец изменений 
	|	NULL КАК ДоговорКонтрагента,
	| "+?(ОбъеденятьВозвратыИПродажи," выбор когда Источник.КодОперации =значение(Перечисление.КодыОперацийПартииТоваров.ВозвратОтПокупателя) 
	|  или Источник.КодОперации = значение(Перечисление.КодыОперацийПартииТоваров.ВозвратОтПокупателяТекущийМесяц)  Тогда
	|      значение(Перечисление.КодыОперацийПартииТоваров.Реализация)
	|  	Иначе
	|	   Источник.КодОперации
	|  Конец
	| ", "Источник.КодОперации ")+" КАК КодОперацииПартииТоваров,
	|	
	|	Источник.Качество,
	|   Неопределено Как Продукция,
//	|	БракВПроизводстве.Продукция,
	|	Источник.СчетУчета КАК СчетУчетаНУ,
	|	Источник.КорСчет КАК КорСчетНУ,
	|	Источник.КорСубконто1 КАК КорСубконтоБУ1,
	|	Источник.КорСубконто2 КАК КорСубконтоБУ2,
	|	Источник.КорСубконто3 КАК КорСубконтоБУ3,
	|	Источник.КорСубконто1 КАК КорСубконтоНУ1,
	|	Источник.КорСубконто2 КАК КорСубконтоНУ2,
	|	Источник.КорСубконто3 КАК КорСубконтоНУ3,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ КАК СтатьяЗатрат,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ КАК ПодразделениеОрганизации,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ КАК НоменклатурнаяГруппа,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказСписания,
	
	//|	ВЫБОР
	//|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	//|			ТОГДА Источник.ДокументДвижения
	//|		ИНАЧЕ Источник.Регистратор
	//|	КОНЕЦ КАК Регистратор,
	//
	//|	ВЫБОР
	//|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	//|			ТОГДА Источник.ДокументДвиженияПериод
	//|		ИНАЧЕ Источник.Период
	//|	КОНЕЦ КАК Период,
	| "+?(ОпределятьДокДвиж," МАКСИМУМ(Источник.Регистратор) ",
	" Неопределено  ")+" Как Регистратор,
	|   ДАТАВРЕМЯ(1, 1, 1)  Как Период,
	|   НЕОПРЕДЕЛЕНО как ПРГ_КорСчетНУ,
	|   НЕОПРЕДЕЛЕНО как ПРГ_СубконтоНУ1,
	|   НЕОПРЕДЕЛЕНО как ПРГ_СубконтоНУ2,
	|   НЕОПРЕДЕЛЕНО как ПРГ_СубконтоНУ3,
	//начало изменений Ожиганов 06.05.2015 изменения по браку 
	|   НЕОПРЕДЕЛЕНО как ПРГСчетДоходов,
	|   НЕОПРЕДЕЛЕНО как ПРГСчетРасходов,
	|   НЕОПРЕДЕЛЕНО как ПРГСтатьяДоходовИРасходов,
	|   НЕОПРЕДЕЛЕНО как ПРГПодразделениеОрганизации,
	|   НЕОПРЕДЕЛЕНО КАК ХарактеристикаНоменклатурыНовая,
	|   НЕОПРЕДЕЛЕНО КАК СерияНоменклатурыНовая,
	|	НЕОПРЕДЕЛЕНО КАК НоменклатураНовая,
	|	НЕОПРЕДЕЛЕНО КАК КачествоНовое,
	|   НЕОПРЕДЕЛЕНО КАК ДокументОприходованияНовый,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям КАК ВестиПартионныйУчетПоСериям,
	|	НЕОПРЕДЕЛЕНО КАК ФизЛицо,
	|	НЕОПРЕДЕЛЕНО КАК НазначениеИспользования,
	|	НЕОПРЕДЕЛЕНО КАК СерияНоменклтатурыНЗП,
	|   0 КАК НомерСтрокиСписанныхТоваров
	//|	Источник.НомерСтрокиСписанныхТоваров КАК НомерСтрокиСписанныхТоваров
	|ИЗ
	|	РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК Источник
//начало изменений Ожиганов 22.03.2016 оптимизируем запрос 
	|  Внутреннее СОЕДИНЕНИЕ Табпартий как Табпартий по Табпартий.Период = Источник.Период и Табпартий.Регистратор = Источник.Регистратор и  Табпартий.НомерСтроки = Источник.НомерСтроки и Табпартий.КодОперации в (&КодыСписаниеНеВсеТабл)
	|"+?(Не ПРГ_ТолькоНаЗатратыВлНаСеб,"","
	|  И ((Табпартий.КодОперации В(&КодыСписаниеСоСчетами) и Табпартий.КорСчет в (&СчетаЗатрат))
	|  или Табпартий.КодОперации В(&КодыСписаниеБезСчетов))
	|")+"
	|
	|СГРУППИРОВАТЬ ПО
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
//	|	МатериалыВЭксплуатации.ДокументПередачи,
	|	Источник.Заказ,
	| "+?(ОбъеденятьВозвратыИПродажи," выбор когда Источник.КодОперации =значение(Перечисление.КодыОперацийПартииТоваров.ВозвратОтПокупателя) 
	|  или Источник.КодОперации = значение(Перечисление.КодыОперацийПартииТоваров.ВозвратОтПокупателяТекущийМесяц)  Тогда
	|      значение(Перечисление.КодыОперацийПартииТоваров.Реализация)
	|  	Иначе
	|	   Источник.КодОперации
	|  Конец
	| ", "Источник.КодОперации ")+",
	|	Источник.Качество,
//	|	БракВПроизводстве.Продукция,
	|	Источник.Организация,
	|	Источник.СчетУчета,
	|	Источник.КорСчет,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ,
//	|	ВЫБОР
//	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
//	|			ТОГДА Источник.ДокументДвижения
//	|		ИНАЧЕ Источник.Регистратор
//	|	КОНЕЦ,
//	|	ВЫБОР
//	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
//	|			ТОГДА Источник.ДокументДвиженияПериод
//	|		ИНАЧЕ Источник.Период
//	|	КОНЕЦ,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	//|	Источник.НомерСтрокиСписанныхТоваров,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3
	|
	|ИМЕЮЩИЕ
	|	СУММА(Источник.Количество) <> 0
	|
	| УПОРЯДОЧИТЬ ПО
	|  Количество убыв
	//|	Период,
	//|	Регистратор
	|;
	| УНИЧТОЖИТЬ ТаблНом;
	| УНИЧТОЖИТЬ Табпартий;
	|";
	
	//Добавим дополнительный отбор по счету
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ 
	|	(НЕ Источник.СчетУчета В (&СписокИсключаемыхСчетовУчета)) И ");
	
	Запрос.УстановитьПараметр("СписокИсключаемыхСчетовУчета",ПолучитьМассивИсключаемыхСчетов());
	
	Если МассивИсклКорСчетов <> Неопределено Тогда
		Запрос.УстановитьПараметр("МассивИсклКорСчетов",МассивИсклКорСчетов);
	КонецЕсли;	
	
	// Если задана организация, отбор по организации 
	Если ЗначениеЗаполнено(Организация) Тогда
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ
		|	Источник.Организация = &Организация И ");
		
		Запрос.УстановитьПараметр("Организация", Организация);
		
	КонецЕсли;
	
	// Добавим дополнительный отбор по номенклатуре
	//Если МассивНоменклатуры <> Неопределено Тогда
	//	
	//	ТекстОграничениеНаПартии = "";
	//	Если ЗначениеЗаполнено(Организация) Тогда
	//		СпособОценкиМПЗ = ВРег(Строка(УправлениеЗапасамиПартионныйУчет.ПолучитьПараметрУчетнойПолитикиПартионногоУчета("СпособОценкиМПЗ", "Нал", ДопПараметры)));
	//		Если СпособОценкиМПЗ = "ФИФО" 
	//			ИЛИ СпособОценкиМПЗ = "ЛИФО" Тогда
	//			
	//			ТекстОграничениеНаПартии = " И Источник.ДокументОприходования В (&МассивДокументовОприходования) ";
	//			
	//		КонецЕсли;
	//	КонецЕсли;
	//	
	//	Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ 
	//	|	Источник.Номенклатура В (&МассивНоменклатуры)
	//	|	" + ТекстОграничениеНаПартии + " И ");
	//	
	//КонецЕсли;
	//Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ 
	//|	Источник.Номенклатура В (&МассивНоменклатуры)
	//|	" + ТекстОграничениеНаПартии + " И ");
	
	// Встречный выпуск
	ВстречныйВыпуск = Ложь;
	Если Не ДопПараметры.Свойство("ВстречныйВыпуск",ВстречныйВыпуск) Тогда
		ВстречныйВыпуск = Ложь;
	КонецЕсли; 
		 
	
	Если ВстречныйВыпуск Тогда
		КодыОпераций = Перечисления.КодыОперацийПартииТоваров;
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ",
			" //ГДЕ
			|	НЕ ( 1 В
			|	(ВЫБРАТЬ Первые 1
			|		1
			|	ИЗ
			|		РегистрСведений.КорректировкаВстречногоВыпускаПродукции КАК КорректировкаВстречногоВыпускаПродукции
			|	ГДЕ
			|		Источник.НомерСтрокиСписанныхТоваров = КорректировкаВстречногоВыпускаПродукции.НомерСтрокиСписанныхТоваров
			|		" + ДобавитьОтборПоВидуУчета("КорректировкаВстречногоВыпускаПродукции","Нал") + "
			|		И Источник.Регистратор = КорректировкаВстречногоВыпускаПродукции.Документ))
			| И");
		Запрос.УстановитьПараметр("СписаниеПартийВПроизводствоОперативно",КодыОпераций.СписаниеПартийВПроизводствоОперативно);
		
	КонецЕсли;
	
	возврат;
	//конец изменений 
	
	Запрос.Текст ="ВЫБРАТЬ
	              |	ТаблНом.Номенклатура,
	              |	ТаблНом.СчетНУ КАК СчетУчета,
	              |	ТаблНом.Организация КАК Организация,
	              |	ТаблНом.Склад,
	              |	ТаблНом.ДокументОприходования,
	              |	ТаблНом.ХарактеристикаНоменклатуры,
	              |	ТаблНом.СерияНоменклатуры,
	              |	ТаблНом.Заказ,
	              |	ТаблНом.Качество
	              |ПОМЕСТИТЬ ТаблНом
	              |ИЗ
	              |	&ТаблРазниц КАК ТаблНом
	              |;
	              |
	              |////////////////////////////////////////////////////////////////////////////////
	              |ВЫБРАТЬ
	              |	ТаблНом.Номенклатура,
	              |	МАКСИМУМ(ВЫБОР
	              |			КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	              |				ТОГДА Источник.ДокументДвижения
	              |			ИНАЧЕ Источник.Регистратор
	              |		КОНЕЦ) КАК Регистратор,
	              |	МАКСИМУМ(ВЫБОР
	              |			КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	              |				ТОГДА Источник.ДокументДвиженияПериод
	              |			ИНАЧЕ Источник.Период
	              |		КОНЕЦ) КАК Период,
	              |	Источник.КодОперации,
	              |	Источник.КорСчет,
	              |	ТаблНом.СчетУчета,
	              |	ТаблНом.Организация,
	              |	ТаблНом.Склад,
	              |	ТаблНом.ДокументОприходования,
	              |	ТаблНом.ХарактеристикаНоменклатуры,
	              |	ТаблНом.СерияНоменклатуры,
	              |	ТаблНом.Заказ,
	              |	ТаблНом.Качество,
	              |	Источник.КорСубконто1,
	              |	Источник.КорСубконто2,
	              |	Источник.КорСубконто3,
	              |	СУММА(Источник.Количество) КАК ВсеКолво,
				  | ЕСТЬNULL(СписанныеТовары.ПРГ_КорСчетБУ,НЕОПРЕДЕЛЕНО) как ПРГ_КорСчетБУ,
				  | ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ1,НЕОПРЕДЕЛЕНО) как ПРГ_СубконтоБУ1,
				  | ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ2,НЕОПРЕДЕЛЕНО) как ПРГ_СубконтоБУ2,
				  | ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ3,НЕОПРЕДЕЛЕНО) как ПРГ_СубконтоБУ3,
				  | ЕСТЬNULL(СписанныеТовары.СчетДоходовБУ, НЕОПРЕДЕЛЕНО) как ПРГСчетДоходов,
				  | ЕСТЬNULL(СписанныеТовары.СчетРасходовБУ, НЕОПРЕДЕЛЕНО) как ПРГСчетРасходов,
				  | ЕСТЬNULL(СписанныеТовары.СтатьяДоходовИРасходов, НЕОПРЕДЕЛЕНО) как ПРГСтатьяДоходовИРасходов,
				  | ЕСТЬNULL(СписанныеТовары.ПодразделениеОрганизации, НЕОПРЕДЕЛЕНО) как ПРГПодразделениеОрганизации
				  
	              | //ПОМЕСТИТЬ Табпартий
	              |ИЗ
	              |	ТаблНом КАК ТаблНом
	              |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК Источник
				  |		ПО ТаблНом.Номенклатура = Источник.Номенклатура
				  |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СписанныеТовары КАК СписанныеТовары
	              |		ПО СписанныеТовары.Регистратор = Источник.Регистратор и СписанныеТовары.НомерСтроки = Источник.НомерСтрокиСписанныхТоваров и Источник.КодОперации в (&_КодыДляСписанныхТоваров)
	              |ГДЕ
	              |	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
	              |	И ТаблНом.СчетУчета = Источник.СчетУчета
				  |	И Не Источник.Регистратор Ссылка Документ.КорректировкаСтоимостиСписанияТоваров
				  |	И Не Источник.Регистратор Ссылка Документ.РасчетСебестоимостиВыпуска
	              |	И ТаблНом.Организация = Источник.Организация
	              |	И ТаблНом.Склад = Источник.Склад
	              |	И ТаблНом.ДокументОприходования = Источник.ДокументОприходования
	              |	И ТаблНом.ХарактеристикаНоменклатуры = Источник.ХарактеристикаНоменклатуры
	              |	И ТаблНом.СерияНоменклатуры = Источник.СерияНоменклатуры
	              |	И ТаблНом.Заказ = Источник.Заказ
	              |	И ТаблНом.Качество = Источник.Качество
	              |	И Источник.ВидДвижения = &ВидДвиженияРасход
	              |	И Источник.Активность
				  |	И Источник.КодОперации в (&КодыСписаниеНеВсеТабл)
	              |
	              |СГРУППИРОВАТЬ ПО
				  |	ТаблНом.Номенклатура,
	              |	ТаблНом.СчетУчета,
	              |	ТаблНом.Организация,
	              |	ТаблНом.Склад,
	              |	ТаблНом.ДокументОприходования,
	              |	ТаблНом.ХарактеристикаНоменклатуры,
	              |	ТаблНом.СерияНоменклатуры,
	              |	ТаблНом.Заказ,
	              |	ТаблНом.Качество,
				  |	Источник.КорСчет,
				  |	Источник.КорСубконто1,
				  |	Источник.КорСубконто2,
				  |	Источник.КорСубконто3,
	              |	Источник.КодОперации,
				  | ЕСТЬNULL(СписанныеТовары.ПРГ_КорСчетБУ,НЕОПРЕДЕЛЕНО),
				  | ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ1,НЕОПРЕДЕЛЕНО),
				  | ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ2,НЕОПРЕДЕЛЕНО),
				  | ЕСТЬNULL(СписанныеТовары.ПРГ_СубконтоБУ3,НЕОПРЕДЕЛЕНО),
				  | ЕСТЬNULL(СписанныеТовары.СчетДоходовБУ, НЕОПРЕДЕЛЕНО),
				  | ЕСТЬNULL(СписанныеТовары.СчетРасходовБУ, НЕОПРЕДЕЛЕНО),
				  | ЕСТЬNULL(СписанныеТовары.СтатьяДоходовИРасходов, НЕОПРЕДЕЛЕНО),
				  | ЕСТЬNULL(СписанныеТовары.ПодразделениеОрганизации, НЕОПРЕДЕЛЕНО)
                  |";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ 
	|	(НЕ Источник.СчетУчета В (&СписокИсключаемыхСчетовУчета)) И ");
	
	Запрос.УстановитьПараметр("СписокИсключаемыхСчетовУчета",ПолучитьМассивИсключаемыхСчетов());
	
	// Если задана организация, отбор по организации 
	Если ЗначениеЗаполнено(Организация) Тогда
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ
		|	Источник.Организация = &Организация И ");
		
		Запрос.УстановитьПараметр("Организация", Организация);
		
	КонецЕсли;
	
	
	возврат;
	
	Запрос.Текст =" 
	|ВЫБРАТЬ
	|	ТаблНом.Номенклатура,
	|	ТаблНом.СчетНУ Как СчетУчета,
	|	ТаблНом.Организация как Организация,
	|	ТаблНом.Склад,
	|	ТаблНом.ДокументОприходования,
	|	ТаблНом.ХарактеристикаНоменклатуры,
	|	ТаблНом.СерияНоменклатуры,
	|	ТаблНом.Заказ,
	|	ТаблНом.Качество
	
	|  Поместить ТаблНом
	|ИЗ
	|	&ТаблРазниц КАК ТаблНом
	|;
	|//@ИсклКомпл ВЫБРАТЬ
	|//@ИсклКомпл	Расход.Регистратор КАК Регистратор,
	|//@ИсклКомпл	Расход.НомерСтроки КАК НомерСтроки
	|//@ИсклКомпл ПОМЕСТИТЬ ТаблИсклКомпл
	|//@ИсклКомпл ИЗ
	|//@ИсклКомпл	РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК Расход
	|//@ИсклКомпл		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК Приход
	|//@ИсклКомпл		ПО Расход.Регистратор = Приход.Регистратор
	//начало изменений Ожиганов 20.10.2015 изменении качества при комплектации, учтем как перемещение 
	|//@ИсклКомпл			И Расход.Номенклатура = Приход.Номенклатура"+
	?(Не ДопПараметры.ПРГ_УчитыватьКомплКакПеремИзмКачества,"
	|//@ИсклКомпл			И Расход.СчетУчета = Приход.СчетУчета
	|//@ИсклКомпл			И Расход.Склад = Приход.Склад
	|//@ИсклКомпл			И Расход.ДокументОприходования = Приход.ДокументОприходования
	|//@ИсклКомпл			И Расход.ХарактеристикаНоменклатуры = Приход.ХарактеристикаНоменклатуры
	|//@ИсклКомпл			И Расход.СерияНоменклатуры = Приход.СерияНоменклатуры
	|//@ИсклКомпл			И Расход.Качество = Приход.Качество
	|//@ИсклКомпл			И Расход.Количество = Приход.Количество"
	,"")+"
	//конец изменений 
	//начало изменений Ожиганов 21.10.2015 изменении качества при комплектации, учтем как перемещение 
	//|//@ИсклКомпл			И Расход.Количество = Приход.Количество
	//конец изменений 
	|//@ИсклКомпл			И (Расход.КодОперации = &_КодОперацииКоплектации)
	|//@ИсклКомпл			И (Расход.КодОперации = &_КодОперацииКоплектации)
	|//@ИсклКомпл			И Расход.Организация = Приход.Организация
	|//@ИсклКомпл			И Расход.НомерКорСтроки = Приход.НомерСтроки
	|//@ИсклКомпл			И (Расход.Активность)
	|//@ИсклКомпл			И (Приход.Активность)
	|//@ИсклКомплГДЕ
	|//@ИсклКомпл	Расход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|//@ИсклКомпл	И Приход.Период МЕЖДУ &ДатаНач И &ДатаКон
	|//@ИсклКомпл	И Расход.ВидДвижения = Значение(ВидДвиженияНакопления.Расход)
	|"+?(МассивНоменклатуры<>Неопределено,"//@ИсклКомпл И Расход.Номенклатура в (&МассивНоменклатуры)","")+"
	|//@ИсклКомплСГРУППИРОВАТЬ ПО
	|//@ИсклКомпл	
	|//@ИсклКомпл	Расход.Регистратор,
	|//@ИсклКомпл	Расход.НомерСтроки
	|//@ИсклКомплИНДЕКСИРОВАТЬ ПО
	|//@ИсклКомпл	Регистратор,
	|//@ИсклКомпл	НомерСтроки
	|//@ИсклКомпл;	

//через временную таблицу и кластер
	| Выбрать Источник.Период, Источник.Регистратор,Источник.Номерстроки,Источник.КодОперации, Источник.КорСчет
	| 	Поместить Табпартий
	| ИЗ 
	|  ТаблНом	как ТаблНом
	| ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|  РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК Источник
	|	ПО ТаблНом.Номенклатура = Источник.Номенклатура
	|ГДЕ
	|//ГДЕ
	|	Источник.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И ТаблНом.СчетУчета	   = Источник.СчетУчета
	|	И ТаблНом.Организация  = Источник.Организация
	|	И ТаблНом.Склад		   = Источник.Склад
	|	И ТаблНом.ДокументОприходования = Источник.ДокументОприходования
	|	И ТаблНом.ХарактеристикаНоменклатуры = Источник.ХарактеристикаНоменклатуры
	|	И ТаблНом.СерияНоменклатуры			 = Источник.СерияНоменклатуры
	|	И ТаблНом.Заказ						 = Источник.Заказ
	|	И ТаблНом.Качество					 = Источник.Качество
	|	И Источник.ВидДвижения = &ВидДвиженияРасход
//начало изменений Ожиганов 28.01.2016 б/н исключение неактивных записей из р/с и корректировки стоимости 
	|	И Источник.Активность
//конец изменений 
	
	|//@ИсклКомпл	И НЕ ( 1 В
	|//@ИсклКомпл			(ВЫБРАТЬ Первые 1
	|//@ИсклКомпл	1
	|//@ИсклКомпл	ИЗ
	|//@ИсклКомпл	ТаблИсклКомпл КАК ТаблИсклКомпл	
	|//@ИсклКомпл	Где	
	|//@ИсклКомпл	ТаблИсклКомпл.Регистратор =Источник.Регистратор
	|//@ИсклКомпл	И ТаблИсклКомпл.НомерСтроки =Источник.НомерСтроки))	
	
	|	И Источник.КодОперации В(&КодыСписание)"
	+?(Не ПРГ_ТолькоНаЗатратыВлНаСеб,"","
	|  И ((Источник.КодОперации В(&КодыСписаниеСоСчетами) и Источник.КорСчет в (&СчетаЗатрат))
	|  или Источник.КодОперации В(&КодыСписаниеБезСчетов))
	|")+"
	|// ИНДЕКСИРОВАТЬ ПО Период,Регистратор,Номерстроки,КодОперации
	|;
	
	|
	|ВЫБРАТЬ
	|	""НаСкладах"" КАК СписаноИз,
	|	Источник.Организация КАК Организация,
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
	|	Источник.Заказ,
	|	СУММА(Источник.Количество) КАК Количество,
	|	СУММА(Источник.Стоимость) КАК Стоимость,
	|	0 КАК СтоимостьПоступление,
//	|	МатериалыВЭксплуатации.ДокументПередачи КАК ДокументПередачи,
    |   Неопределено КАК ДокументПередачи,
//конец изменений 
	|	NULL КАК ДоговорКонтрагента,
	|	Источник.КодОперации КАК КодОперацииПартииТоваров,
	|	Источник.Качество,
	|   Неопределено Как Продукция,
//	|	БракВПроизводстве.Продукция,
	|	Источник.СчетУчета КАК СчетУчетаНУ,
	|	Источник.КорСчет КАК КорСчетНУ,
	|	Источник.КорСубконто1 КАК КорСубконтоБУ1,
	|	Источник.КорСубконто2 КАК КорСубконтоБУ2,
	|	Источник.КорСубконто3 КАК КорСубконтоБУ3,
	|	Источник.КорСубконто1 КАК КорСубконтоНУ1,
	|	Источник.КорСубконто2 КАК КорСубконтоНУ2,
	|	Источник.КорСубконто3 КАК КорСубконтоНУ3,
	|	СУММА(Источник.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(Источник.ВременнаяРазница) КАК ВременнаяРазница,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ КАК СтатьяЗатрат,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ КАК ПодразделениеОрганизации,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ КАК НоменклатурнаяГруппа,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказСписания,
	
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ КАК Регистратор,
	
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ КАК Период,
	|   НЕОПРЕДЕЛЕНО КАК ХарактеристикаНоменклатурыНовая,
	|   НЕОПРЕДЕЛЕНО КАК СерияНоменклатурыНовая,
	|	НЕОПРЕДЕЛЕНО КАК НоменклатураНовая,
	|	НЕОПРЕДЕЛЕНО КАК КачествоНовое,
	|   НЕОПРЕДЕЛЕНО КАК ДокументОприходованияНовый,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям КАК ВестиПартионныйУчетПоСериям,
	|	НЕОПРЕДЕЛЕНО КАК ФизЛицо,
	|	НЕОПРЕДЕЛЕНО КАК НазначениеИспользования,
	|	НЕОПРЕДЕЛЕНО КАК СерияНоменклтатурыНЗП,
	|	Источник.НомерСтрокиСписанныхТоваров КАК НомерСтрокиСписанныхТоваров
	|ИЗ
	|	РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет КАК Источник
//начало изменений Ожиганов 22.03.2016 оптимизируем запрос 
	|  Внутреннее СОЕДИНЕНИЕ Табпартий как Табпартий по Табпартий.Период = Источник.Период и Табпартий.Регистратор = Источник.Регистратор и  Табпартий.НомерСтроки = Источник.НомерСтроки и Табпартий.КодОперации в (&КодыСписаниеНеВсеТабл)
	|"+?(Не ПРГ_ТолькоНаЗатратыВлНаСеб,"","
	|  И ((Табпартий.КодОперации В(&КодыСписаниеСоСчетами) и Табпартий.КорСчет в (&СчетаЗатрат))
	|  или Табпартий.КодОперации В(&КодыСписаниеБезСчетов))
	|")+"
	|
	|СГРУППИРОВАТЬ ПО
	|	Источник.Номенклатура,
	|	Источник.Склад,
	|	Источник.ХарактеристикаНоменклатуры,
	|	Источник.СерияНоменклатуры,
	|	Источник.ДокументОприходования,
//	|	МатериалыВЭксплуатации.ДокументПередачи,
	|	Источник.Заказ,
	|	Источник.КодОперации,
	|	Источник.Качество,
//	|	БракВПроизводстве.Продукция,
	|	Источник.Организация,
	|	Источник.СчетУчета,
	|	Источник.КорСчет,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = Тип(Справочник.СтатьиЗатрат) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) = ТИП(Справочник.ПодразделенияОрганизаций) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТипЗначения(Источник.КорСубконто1) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто1
	|		КОГДА ТипЗначения(Источник.КорСубконто2) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто2
	|		КОГДА ТипЗначения(Источник.КорСубконто3) =  ТИП(Справочник.НоменклатурныеГруппы) Тогда
	|				Источник.КорСубконто3
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО	
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвижения
	|		ИНАЧЕ Источник.Регистратор
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Источник.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Источник.ДокументДвиженияПериод
	|		ИНАЧЕ Источник.Период
	|	КОНЕЦ,
	|	Источник.Номенклатура.ВестиПартионныйУчетПоСериям,
	|	Источник.НомерСтрокиСписанныхТоваров,
	|	Источник.КорСубконто1,
	|	Источник.КорСубконто2,
	|	Источник.КорСубконто3
	|
	|ИМЕЮЩИЕ
	|	СУММА(Источник.Количество) <> 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	Стоимость Убыв,
	|	Период,
	|	Регистратор";
	
	//Добавим дополнительный отбор по счету
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ 
	|	(НЕ Источник.СчетУчета В (&СписокИсключаемыхСчетовУчета)) И ");
	
	Запрос.УстановитьПараметр("СписокИсключаемыхСчетовУчета",ПолучитьМассивИсключаемыхСчетов());
	
	// Если задана организация, отбор по организации 
	Если ЗначениеЗаполнено(Организация) Тогда
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ
		|	Источник.Организация = &Организация И ");
		
		Запрос.УстановитьПараметр("Организация", Организация);
		
	КонецЕсли;
	
	// Добавим дополнительный отбор по номенклатуре
	//Если МассивНоменклатуры <> Неопределено Тогда
	//	
	//	ТекстОграничениеНаПартии = "";
	//	Если ЗначениеЗаполнено(Организация) Тогда
	//		СпособОценкиМПЗ = ВРег(Строка(УправлениеЗапасамиПартионныйУчет.ПолучитьПараметрУчетнойПолитикиПартионногоУчета("СпособОценкиМПЗ", "Нал", ДопПараметры)));
	//		Если СпособОценкиМПЗ = "ФИФО" 
	//			ИЛИ СпособОценкиМПЗ = "ЛИФО" Тогда
	//			
	//			ТекстОграничениеНаПартии = " И Источник.ДокументОприходования В (&МассивДокументовОприходования) ";
	//			
	//		КонецЕсли;
	//	КонецЕсли;
	//	
	//	Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ 
	//	|	Источник.Номенклатура В (&МассивНоменклатуры)
	//	|	" + ТекстОграничениеНаПартии + " И ");
	//	
	//КонецЕсли;
	//Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ", "//ГДЕ 
	//|	Источник.Номенклатура В (&МассивНоменклатуры)
	//|	" + ТекстОграничениеНаПартии + " И ");
	
	// Встречный выпуск
	Если ДопПараметры.ВстречныйВыпуск Тогда
		КодыОпераций = Перечисления.КодыОперацийПартииТоваров;
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ГДЕ",
			" //ГДЕ
			|	НЕ ( 1 В
			|	(ВЫБРАТЬ Первые 1
			|		1
			|	ИЗ
			|		РегистрСведений.КорректировкаВстречногоВыпускаПродукции КАК КорректировкаВстречногоВыпускаПродукции
			|	ГДЕ
			|		Источник.НомерСтрокиСписанныхТоваров = КорректировкаВстречногоВыпускаПродукции.НомерСтрокиСписанныхТоваров
			|		" + ДобавитьОтборПоВидуУчета("КорректировкаВстречногоВыпускаПродукции","Нал") + "
			|		И Источник.Регистратор = КорректировкаВстречногоВыпускаПродукции.Документ))
			| И");
		Запрос.УстановитьПараметр("СписаниеПартийВПроизводствоОперативно",КодыОпераций.СписаниеПартийВПроизводствоОперативно);
		
	КонецЕсли;

КонецПроцедуры // ПРГ_ЗаполнитьЗапросПоСписаниюНалПриравниеНУкБУ()

Функция  ПРГ_ПолучитьТаблицуРазницБУиНУ(ТаблСчетов, ДопПарметры,ДопРазница = 0.01) Экспорт
	Перем ТаблицаТоваров;
	Перем МенВремТаблВыпПродукции;
	
	ИспользоватьТаблТоваров = Ложь;
	
	Если ДопПарметры.Свойство("ТаблицаТоваров",ТаблицаТоваров) Тогда
		Если ТаблицаТоваров <> Неопределено и ТаблицаТоваров.Количество() > 0  Тогда
			 ИспользоватьТаблТоваров = Истина;
		КонецЕсли;	
	КонецЕсли;	
	
	ИсключатьВыпуск = Ложь;
	Если ДопПарметры.Свойство("МенВремТаблВыпПродукции",МенВремТаблВыпПродукции) Тогда
		Если МенВремТаблВыпПродукции <> Неопределено Тогда
			ИсключатьВыпуск = Истина;
		КонецЕсли;	
	КонецЕсли;
	
	ВключатьВыпуск  = Ложь;
	Если ДопПарметры.ВариантВыравниванияОтклонений  = 1 Тогда
		
	ИначеЕсли ДопПарметры.ВариантВыравниванияОтклонений  = 2 Тогда
		ИсключатьВыпуск = Ложь; //определя
	ИначеЕсли ДопПарметры.ВариантВыравниванияОтклонений = 3 Тогда
		ИсключатьВыпуск = Ложь;
		ВключатьВыпуск  = Истина;
	КонецЕслИ;	
	
	ВключатьНулевыеРасх = Ложь;
	Если Не ДопПарметры.Свойство("ВключатьНулевыеРасх",ВключатьНулевыеРасх) Тогда
		ВключатьНулевыеРасх = Ложь;
	КонецЕсли;	
	
	Запрос = ПРГ_ПолучитьЗапросПоРазницамБУНУ(ИспользоватьТаблТоваров, ИсключатьВыпуск, ВключатьВыпуск, ВключатьНулевыеРасх);
	
	Если ИсключатьВыпуск или ВключатьВыпуск Тогда
		Запрос.МенеджерВременныхТаблиц = ДопПарметры.МенВремТаблВыпПродукции; 
	КонецЕсли;	
	
	Запрос.УстановитьПараметр("ТаблСчетов",ТаблСчетов);
	Запрос.УстановитьПараметр("Дата",КонецДня(ДопПарметры.ДатаКон)+1);
	Запрос.УстановитьПараметр("Организация",ДопПарметры.Организация);
	
	Запрос.УстановитьПараметр("ДопРазница",ДопРазница);
	Запрос.УстановитьПараметр("ДопРазницаМинус",-1*ДопРазница);
	
	Если ИспользоватьТаблТоваров Тогда
		 Запрос.УстановитьПараметр("ТаблицаТоваров",ТаблицаТоваров);
	КонецЕсли;	
	
	возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Функция ПРГ_ПолучитьЗапросПоРазницамБУНУ(ИспользоватьТаблТоваров = Ложь, ИсключатьВыпуск = Истина,ВключатьВыпуск=Ложь,ПолучатьНулевыеРасх=Ложь)
	
	Запрос = Новый Запрос("
						  |"+?(ИспользоватьТаблТоваров,"
						  |	ВЫБРАТЬ
						  |		ТаблНом.Номенклатура
						  |		Поместить ТаблНом	
						  | ИЗ
						  | &ТаблицаТоваров КАК ТаблНом						  
						  |;","")+"
	                      |
						  |ВЫБРАТЬ
	                      |	ТаблСчетов.СчетБУ,
	                      |	ТаблСчетов.СчетНУ
	                      |ПОМЕСТИТЬ ТаблСчетов
	                      |ИЗ
	                      |	&ТаблСчетов КАК ТаблСчетов
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	РазницыПоПартиям.Номенклатура.Код,
	                      |	РазницыПоПартиям.Номенклатура,
	                      |	РазницыПоПартиям.Склад,
	                      |	РазницыПоПартиям.ДокументОприходования,
	                      |	РазницыПоПартиям.ХарактеристикаНоменклатуры,
	                      |	РазницыПоПартиям.СерияНоменклатуры,
	                      |	РазницыПоПартиям.Заказ,
	                      |	РазницыПоПартиям.Качество,
	                      |	СУММА(РазницыПоПартиям.КоличествоОстаток) КАК КоличествоОстаток,
	                      |	СУММА(РазницыПоПартиям.СтоимостьОстаток) КАК СтоимостьОстаток,
	                      |	СУММА(РазницыПоПартиям.КолВоБУ) КАК КолВоБУ,
	                      |	СУММА(РазницыПоПартиям.СтоимБУ) КАК СтоимБУ,
	                      |	СУММА(РазницыПоПартиям.КолВоНУ) КАК КолВоНУ,
	                      |	СУММА(РазницыПоПартиям.СттомНУ) КАК СтоимНУ,
	                      |	ТаблСчетов.СчетБУ,
	                      |	ТаблСчетов.СчетНУ,
	                      |	СУММА(РазницыПоПартиям.ПостояннаяРазница) КАК ПостояннаяРазница,
	                      |	СУММА(РазницыПоПартиям.ВременнаяРазница) КАК ВременнаяРазница,
	                      |	СУММА(РазницыПоПартиям.СтоимостьНУ) КАК СтоимостьНУ,
	                      |	РазницыПоПартиям.Организация
	                      |ИЗ
	                      |	(ВЫБРАТЬ
	                      |		БУостатки.Организация КАК Организация,
	                      |		БУостатки.Номенклатура КАК Номенклатура,
	                      |		БУостатки.Склад КАК Склад,
	                      |		БУостатки.ДокументОприходования КАК ДокументОприходования,
	                      |		БУостатки.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	                      |		БУостатки.СерияНоменклатуры КАК СерияНоменклатуры,
	                      |		БУостатки.Заказ КАК Заказ,
	                      |		БУостатки.Качество КАК Качество,
	                      |		-1 * БУостатки.КоличествоОстаток КАК КоличествоОстаток,
	                      |		-1 * БУостатки.СтоимостьОстаток КАК СтоимостьОстаток,
	                      |		БУостатки.КоличествоОстаток КАК КолВоБУ,
	                      |		БУостатки.СтоимостьОстаток КАК СтоимБУ,
	                      |		0 КАК КолВоНУ,
	                      |		0 КАК СттомНУ,
	                      |		0 КАК СтоимостьНУ,
	                      |		0 КАК ПостояннаяРазница,
	                      |		0 КАК ВременнаяРазница,
	                      |		БУостатки.СчетУчета КАК СчетУчетаБУ
	                      |	ИЗ
	                      |		РегистрНакопления.ПартииТоваровНаСкладахБухгалтерскийУчет.Остатки(
	                      |				&Дата,
	                      |				Организация = &Организация
	                      |					И СчетУчета В
	                      |						(ВЫБРАТЬ
	                      |							таблсчетов.СчетБУ
	                      |						ИЗ
	                      |							таблсчетов)
						  | "+?(ИспользоватьТаблТоваров," И (Номенклатура в (ВЫБРАТЬ ТаблНом.Номенклатура из ТаблНом сгруппировать по ТаблНом.Номенклатура)) ","")+" 
						  | "+?(ИсключатьВыпуск," И НЕ (Номенклатура в (ВЫБРАТЬ ВыпускПродукции.Номенклатура из ВыпускПродукции сгруппировать по ВыпускПродукции.Номенклатура)) ","")+"
						  | "+?(ВключатьВыпуск," И (Номенклатура в (ВЫБРАТЬ ВыпускПродукции.Номенклатура из ВыпускПродукции сгруппировать по ВыпускПродукции.Номенклатура)) ","")+"
						  |
						  |) КАК БУостатки
	                      |	
	                      |	ОБЪЕДИНИТЬ ВСЕ
	                      |	
	                      |	ВЫБРАТЬ
	                      |		НУОстатки.Организация,
	                      |		НУОстатки.Номенклатура,
	                      |		НУОстатки.Склад,
	                      |		НУОстатки.ДокументОприходования,
	                      |		НУОстатки.ХарактеристикаНоменклатуры,
	                      |		НУОстатки.СерияНоменклатуры,
	                      |		НУОстатки.Заказ,
	                      |		НУОстатки.Качество,
	                      |		НУОстатки.КоличествоОстаток,
	                      |		НУОстатки.СтоимостьОстаток + НУОстатки.ПостояннаяРазницаОстаток + НУОстатки.ВременнаяРазницаОстаток,
	                      |		0,
	                      |		0,
	                      |		НУОстатки.КоличествоОстаток,
	                      |		НУОстатки.СтоимостьОстаток + НУОстатки.ПостояннаяРазницаОстаток + НУОстатки.ВременнаяРазницаОстаток,
	                      |		НУОстатки.СтоимостьОстаток,
	                      |		НУОстатки.ПостояннаяРазницаОстаток,
	                      |		НУОстатки.ВременнаяРазницаОстаток,
	                      |		ТаблСчетов.СчетБУ
	                      |	ИЗ
	                      |		РегистрНакопления.ПартииТоваровНаСкладахНалоговыйУчет.Остатки(
	                      |				&Дата,
	                      |				Организация = &Организация
	                      |					И СчетУчета В
	                      |						(ВЫБРАТЬ
	                      |							таблсчетов.СчетНУ
	                      |						ИЗ
	                      |							таблсчетов)
						  | "+?(ИспользоватьТаблТоваров," И (Номенклатура в (ВЫБРАТЬ  ТаблНом.Номенклатура из ТаблНом сгруппировать по ТаблНом.Номенклатура) )","")+" 
						  | "+?(ИсключатьВыпуск," И НЕ (Номенклатура в (ВЫБРАТЬ ВыпускПродукции.Номенклатура из ВыпускПродукции сгруппировать по ВыпускПродукции.Номенклатура)) ","")+"
						  | "+?(ВключатьВыпуск," И (Номенклатура в (ВЫБРАТЬ ВыпускПродукции.Номенклатура из ВыпускПродукции сгруппировать по ВыпускПродукции.Номенклатура)) ","")+"
						  |
						  | ) КАК НУОстатки
	                      |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблСчетов КАК ТаблСчетов
	                      |			ПО НУОстатки.СчетУчета = ТаблСчетов.СчетНУ) КАК РазницыПоПартиям
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблСчетов КАК ТаблСчетов
	                      |		ПО РазницыПоПартиям.СчетУчетаБУ = ТаблСчетов.СчетБУ
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	РазницыПоПартиям.Номенклатура,
	                      |	РазницыПоПартиям.Склад,
	                      |	РазницыПоПартиям.ДокументОприходования,
	                      |	РазницыПоПартиям.ХарактеристикаНоменклатуры,
	                      |	РазницыПоПартиям.СерияНоменклатуры,
	                      |	РазницыПоПартиям.Заказ,
	                      |	РазницыПоПартиям.Качество,
	                      |	РазницыПоПартиям.Номенклатура.Код,
	                      |	ТаблСчетов.СчетБУ,
	                      |	ТаблСчетов.СчетНУ,
	                      |	РазницыПоПартиям.Организация
	                      |
	                      |ИМЕЮЩИЕ
	                      |	СУММА(РазницыПоПартиям.КоличествоОстаток) = 0 И СУММА(РазницыПоПартиям.КолВоБУ) > 0 И
	                      |	(СУММА(РазницыПоПартиям.СтоимостьОстаток) >"+?(ПолучатьНулевыеРасх,"=","")+" 0
	                      |			И СУММА(РазницыПоПартиям.СтоимостьОстаток) <= &ДопРазница
	                      |		ИЛИ СУММА(РазницыПоПартиям.СтоимостьОстаток) < 0
	                      |			И СУММА(РазницыПоПартиям.СтоимостьОстаток) >= &ДопРазницаМинус)");
	возврат Запрос;
	
КонецФункции	

Функция ПРГ_ПолучитьТаблСчетовДляПриведенияНУкБУ(ВариантВыравниванияОтклонений = 3)
	ТаблСчетов = Новый ТаблицаЗначений;
	ТаблСчетов.Колонки.Добавить("СчетБУ",Новый ОписаниеТипов("ПланСчетовСсылка.Хозрасчетный"));
	ТаблСчетов.Колонки.Добавить("СчетНУ",Новый ОписаниеТипов("ПланСчетовСсылка.Налоговый"));
	
	Если ВариантВыравниванияОтклонений = 2 Тогда //Продукция
		ПРГДобавитьВТаблСчетовДляПриведенияНУкБУ(ТаблСчетов,"43","43");
	ИначеЕсли ВариантВыравниванияОтклонений = 3 Тогда //Продукция
		ПРГДобавитьВТаблСчетовДляПриведенияНУкБУ(ТаблСчетов,"21","21");
	Иначе
		ПРГДобавитьВТаблСчетовДляПриведенияНУкБУ(ТаблСчетов,"10.01","10.01");
		ПРГДобавитьВТаблСчетовДляПриведенияНУкБУ(ТаблСчетов,"10.02","10.02");
		ПРГДобавитьВТаблСчетовДляПриведенияНУкБУ(ТаблСчетов,"10.03","10.03");
		ПРГДобавитьВТаблСчетовДляПриведенияНУкБУ(ТаблСчетов,"10.04","10.04");
		ПРГДобавитьВТаблСчетовДляПриведенияНУкБУ(ТаблСчетов,"10.05","10.05");
		ПРГДобавитьВТаблСчетовДляПриведенияНУкБУ(ТаблСчетов,"10.06","10.06");
		ПРГДобавитьВТаблСчетовДляПриведенияНУкБУ(ТаблСчетов,"10.08","10.08");
		ПРГДобавитьВТаблСчетовДляПриведенияНУкБУ(ТаблСчетов,"10.09","10.09");
		ПРГДобавитьВТаблСчетовДляПриведенияНУкБУ(ТаблСчетов,"41.04","41.04");
		ПРГДобавитьВТаблСчетовДляПриведенияНУкБУ(ТаблСчетов,"21","21");
	КонецЕсли;	
	
	возврат ТаблСчетов;
КонецФункции	

Процедура ПРГДобавитьВТаблСчетовДляПриведенияНУкБУ(ТаблСчетов,КодСчетаБУ,КодСчетаНУ)
	
	СчетБУ  = ПланыСчетов.Хозрасчетный.НайтиПоКоду(КодСчетаБУ);
	СчетНУ  = ПланыСчетов.Налоговый.НайтиПоКоду(КодСчетаНУ);
	
	Если ЗначениеЗаполнено(СчетБУ) и   ЗначениеЗаполнено(СчетНУ) Тогда
		
			НС = ТаблСчетов.Добавить();
			НС.СчетБУ  = СчетБУ;
			НС.СчетНУ  = СчетНУ;
			
	КонецЕсли;	
КонецПроцедуры	

Функция ПолучитьМассивИсключКорСчетов(ДопПараметры)
	
	Результат = Новый Массив;
	Если ДопПараметры.ВариантВыравниванияОтклонений = 2 Тогда // готовая продукция
		    Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("20.01.1"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("20.01.2"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("20.02"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("23.01"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("23.02"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("25.01"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("25.02"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("25.03"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("28.01"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("28.02"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("29.01"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("29.02"));
			//ниже пока под вопросом
			//Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("08.03.1"));
			//Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("08.03.2"));
			//
	ИначеЕсли ДопПараметры.ВариантВыравниванияОтклонений = 3 Тогда // ПФ выпускаемые		
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("23.01"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("23.02"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("25.01"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("25.02"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("25.03"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("28.01"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("28.02"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("29.01"));
			Результат.Добавить(ПланыСчетов.Налоговый.НайтиПоКоду("29.02"));
	КонецЕслИ;	
		
	возврат Результат;
	
КонецФункции	

//конец изменений 

//начало изменений Ожиганов 20.04.2016 б/н приравнять движения по материалам БУ к НУ  
// ВариантВыравниванияОтклонений 1- варианты материалы и пф, не выпускаемые 
// ВариантВыравниванияОтклонений 2- ГП вся
// ВариантВыравниванияОтклонений 3- ПФ выпускаемые
  Процедура УдалитьВызовПоодгонкиНУ(ДокКорр, ВариантВыравниванияОтклонений = 1,ФлажокВызовПроцедурыИзМодуля) Экспорт 
	
	//НашаОбработка = ВнешниеОбработки.Создать("E:\Обработки 1С\ПопыткаПодгонкиНУКБУПоматериалм.epf");
	НашаОбработка = ВнешниеОбработки.Создать("E:\Обработки 1С\ПродукцияПопыткаПодгонкиНУКБУ.epf");
	
	НашаОбработка.ДокКорректировки = ДокКорр;
	Попытка
	    НашаОбработка.ДействиеПриПодгонкеНУкБУ(ВариантВыравниванияОтклонений,ФлажокВызовПроцедурыИзМодуля);
	Исключение
		Сообщить(ОписаниеОшибки());
	КонецПопытки;
	
	НашаОбработка = Неопределено;
КонецПроцедуры	
//конец изменений 
