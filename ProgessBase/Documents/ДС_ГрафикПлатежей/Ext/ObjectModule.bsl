
Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	Если ТипЗнч(ДанныеЗаполнения) = Тип("СправочникСсылка.ДоговорыКонтрагентов") Тогда 
		Организация = ДанныеЗаполнения.Организация;
		Договор = ДанныеЗаполнения;
		Объект = ДанныеЗаполнения.ДС_ОбъектДоговора;
		ис_Продлен = ДанныеЗаполнения.ис_Продлен;
	КонецЕсли;

КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	Движения.ДС_ГрафикПлатежей.Записывать		= Истина;
	Движения.ДС_ФактическиеПлатежи.Записывать	= Истина;
	
	// is Зайцева нач 20140702 
	лДвиженияГрафикПлатежей = Движения.ДС_ГрафикПлатежей;
	лДвиженияГрафикПлатежей.ДополнительныеСвойства.Вставить("Договор", Договор);
	// is Зайцева кон 20140702
	
	/// Кунов О.В., 10.11.2014 - 
	Если ДополнительныеСвойства.Свойство("ЗагружаетсяИзОбработки") Тогда
		лДвиженияГрафикПлатежей.ДополнительныеСвойства.Вставить("ЗагружаетсяИзОбработки");
	КонецЕсли;
	///
	
	// is ЯннуровВФ нач 20140910 ЗР-0И-001397
	Если ис_Продлен Тогда 
		лСрокДоговора = Договор.ис_СрокПродления;
	Иначе
		лСрокДоговора = Договор.ДС_СрокДействияДоговора;
	КонецЕсли;
	// is ЯннуровВФ кон 20140910
	
	Для каждого Стр Из ГрафикПлатежей Цикл
		
		Движение				= Движения.ДС_ГрафикПлатежей.Добавить();
		ЗаполнитьЗначенияСвойств(Движение, Стр);
		Движение.ПериодПлатежа	= Стр.Период;
		Движение.Договор		= Договор;
		Движение.LeasePaymentProvided = - Стр.LeasePaymentProvided;
		
	// is ЯннуровВФ нач 20140815
	КонецЦикла;
	Движения.ДС_ГрафикПлатежей.Записать();
		
	Для каждого Стр Из ГрафикПлатежей Цикл
	// is ЯннуровВФ кон 20140815
		
		// is ЯннуровВФ нач 20140624 0И-001448
		//Если Договор.ВидВзаиморасчетов = Справочники.ВидыВзаиморасчетов.ЛизингОборудования Тогда
		// is ЯннуровВФ кон 20140624
		Если Стр.ВидПлатежа = Перечисления.ДС_ВидыПлатежейМСФО.ДополнительныйАванс Тогда
			
			Движение				= Движения.ДС_ФактическиеПлатежи.Добавить();
			ЗаполнитьЗначенияСвойств(Движение, Стр);
			Движение.Договор		= Договор;
			Движение.ПериодПлатежа	= Стр.Период;
			
			// is ЯннуровВФ нач 20140624 0И-001448
			//Движение.LIBOR = РегистрыСведений.ДС_СтавкаLIBOR.ПолучитьПоследнее(Стр.ДатаПлатежа, Новый Структура("Валюта, Периодичность", Договор.ВалютаВзаиморасчетов, Договор.ДС_ПериодВыплат)).Ставка;
			Если Договор.ВидВзаиморасчетов = Справочники.ВидыВзаиморасчетов.ЛизингОборудования Тогда
				Движение.LIBOR = РегистрыСведений.ДС_СтавкаLIBOR.ПолучитьПоследнее(Стр.ДатаПлатежа, Новый Структура("Валюта, Периодичность", Договор.ВалютаВзаиморасчетов, Договор.ДС_ПериодВыплат)).Ставка;
			КонецЕсли;
			// is ЯннуровВФ кон 20140624
			Движение.FinanceCost = Движение.CurrentBalanceOpening * (Договор.ДС_ФиксированнаяСтавка + Движение.LIBOR) / (?(Договор.ДС_ПериодВыплат = Перечисления.ДС_ПериодВыплат.Месяц, 12, 4) * 100);
			// is ЯннуровВФ нач 20140910 ЗР-0И-001397
			//Движение.LeasePaymentActual = (Движение.CurrentBalanceOpening * (Договор.ДС_ФиксированнаяСтавка + Движение.LIBOR)/(?(Договор.ДС_ПериодВыплат = Перечисления.ДС_ПериодВыплат.Месяц, 12, 4)*100))/(1 - Pow((1 + (Договор.ДС_ФиксированнаяСтавка + Движение.LIBOR)/(?(Договор.ДС_ПериодВыплат = Перечисления.ДС_ПериодВыплат.Месяц, 12, 4)*100)), -(Договор.ДС_СрокДействияДоговора - Движение.ПериодПлатежа + 1)));
			Движение.LeasePaymentActual = (Движение.CurrentBalanceOpening * (Договор.ДС_ФиксированнаяСтавка + Движение.LIBOR)/(?(Договор.ДС_ПериодВыплат = Перечисления.ДС_ПериодВыплат.Месяц, 12, 4)*100))/(1 - Pow((1 + (Договор.ДС_ФиксированнаяСтавка + Движение.LIBOR)/(?(Договор.ДС_ПериодВыплат = Перечисления.ДС_ПериодВыплат.Месяц, 12, 4)*100)), -(лСрокДоговора - Движение.ПериодПлатежа + 1)));
			// is ЯннуровВФ кон 20140910
			// is ЯннуровВФ нач 20140818
			//Движение.CurrentBalanceClosing = Движение.CurrentBalanceOpening + Движение.FinanceCost - Движение.LeasePaymentActual;
			// is ЯннуровВФ кон 20140818
			// is ЯннуровВФ нач 20140815
			Движение.FinanceCostПлан = Стр.FinanceCost;
			Движение.LeasePaymentПлан = -Стр.LeasePaymentProvided;
			Движение.CurrentBalanceClosingLT = ПолучитьCurrentBalanceClosingLT(Движение.ДатаПлатежа);
			Движение.CurrentBalanceClosingST = Движение.CurrentBalanceClosing - Движение.CurrentBalanceClosingLT;
			// is ЯннуровВФ кон 20140815

		ИначеЕсли Стр.ВидПлатежа = Перечисления.ДС_ВидыПлатежейМСФО.Предоплата Тогда
			
			Движение				= Движения.ДС_ФактическиеПлатежи.Добавить();
			Движение.Договор		= Договор;
			Движение.ПериодПлатежа	= Стр.Период;
			Движение.ВидПлатежа		= Стр.ВидПлатежа;
			Движение.ДатаПлатежа	= Стр.ДатаПлатежа;
			// is ЯннуровВФ нач 20140624 0И-001448
			//Движение.LIBOR = РегистрыСведений.ДС_СтавкаLIBOR.ПолучитьПоследнее(Стр.ДатаПлатежа, Новый Структура("Валюта, Периодичность", Договор.ВалютаВзаиморасчетов, Договор.ДС_ПериодВыплат)).Ставка;
			Если Договор.ВидВзаиморасчетов = Справочники.ВидыВзаиморасчетов.ЛизингОборудования Тогда
				Движение.LIBOR = РегистрыСведений.ДС_СтавкаLIBOR.ПолучитьПоследнее(Стр.ДатаПлатежа, Новый Структура("Валюта, Периодичность", Договор.ВалютаВзаиморасчетов, Договор.ДС_ПериодВыплат)).Ставка;
			КонецЕсли;
			// is ЯннуровВФ кон 20140624
            Движение.CurrentBalanceOpening = Стр.CurrentBalanceOpening;
			Движение.CurrentBalanceClosing = Стр.CurrentBalanceClosing;
			Движение.LeasePaymentActual = - Стр.LeasePaymentProvided;
			// is ЯннуровВФ нач 20140815
			Движение.FinanceCostПлан = Стр.FinanceCost;
			Движение.LeasePaymentПлан = -Стр.LeasePaymentProvided;
			Движение.CurrentBalanceClosingLT = ПолучитьCurrentBalanceClosingLT(Движение.ДатаПлатежа);
			Движение.CurrentBalanceClosingST = Движение.CurrentBalanceClosing - Движение.CurrentBalanceClosingLT;
			// is ЯннуровВФ кон 20140815
		
		КонецЕсли;	
		
	КонецЦикла;	
	
	
КонецПроцедуры


Функция ПолучитьCurrentBalanceClosingLT(ДатаПлатежа)
	лСумма = 0;
	
	лЗапрос = Новый Запрос;
	лЗапрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	|	ДС_ГрафикПлатежей.ДатаПлатежа КАК ДатаПлатежа,
	|	ДС_ГрафикПлатежей.CurrentBalanceClosing
	|ИЗ
	|	РегистрСведений.ДС_ГрафикПлатежей КАК ДС_ГрафикПлатежей
	|ГДЕ
	|	ДС_ГрафикПлатежей.Договор = &Договор
	|	И ДС_ГрафикПлатежей.ВидПлатежа = ЗНАЧЕНИЕ(Перечисление.ДС_ВидыПлатежейМСФО.РегулярныйПлатеж)
	|	И ДС_ГрафикПлатежей.ДатаПлатежа <= &ДатаПлатежа
	|
	|УПОРЯДОЧИТЬ ПО
	|	ДатаПлатежа УБЫВ";
	лЗапрос.УстановитьПараметр("Договор", Договор);
	лЗапрос.УстановитьПараметр("ДатаПлатежа", КонецМесяца(ДобавитьМесяц(НачалоМесяца(ДатаПлатежа),12)));
	лВыборка = лЗапрос.Выполнить().Выбрать();
	Если лВыборка.Следующий() Тогда 
		лСумма = лВыборка.CurrentBalanceClosing;
	КонецЕсли;
	
	Возврат лСумма;
КонецФункции
